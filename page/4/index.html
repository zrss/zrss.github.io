<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="领略了繁华沧桑谁人过往不相似">
<meta property="og:type" content="website">
<meta property="og:title" content="随风飘散的记忆">
<meta property="og:url" content="https://zrss.github.io/page/4/index.html">
<meta property="og:site_name" content="随风飘散的记忆">
<meta property="og:description" content="领略了繁华沧桑谁人过往不相似">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="tech">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zrss.github.io/page/4/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/4/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>随风飘散的记忆</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">随风飘散的记忆</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">领略了繁华沧桑<br>谁人过往不相似</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">114</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">58</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/f68a955a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/f68a955a.html" class="post-title-link" itemprop="url">spark-cluster-mode-on-k8s</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-12-08 10:16:51" itemprop="dateCreated datePublished" datetime="2019-12-08T10:16:51Z">2019-12-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 07:20:00" itemprop="dateModified" datetime="2020-11-22T07:20:00Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://spark.apache.org/docs/latest/cluster-overview.html">https://spark.apache.org/docs/latest/cluster-overview.html</a></p>
<p><a target="_blank" rel="noopener" href="https://spark.apache.org/docs/latest/cluster-overview.html#glossary">https://spark.apache.org/docs/latest/cluster-overview.html#glossary</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/GoogleCloudPlatform/spark-on-k8s-operator/blob/master/examples/spark-pi.yaml">https://github.com/GoogleCloudPlatform/spark-on-k8s-operator/blob/master/examples/spark-pi.yaml</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/GoogleCloudPlatform/spark-on-k8s-operator/blob/master/examples/spark-py-pi.yaml">https://github.com/GoogleCloudPlatform/spark-on-k8s-operator/blob/master/examples/spark-py-pi.yaml</a></p>
<p><code>KUBERNETES_SERVICE_HOST</code></p>
<p><code>KUBERNETES_SERVICE_PORT</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">--class=...</span><br><span class="line">--master k8s://https://%s:%s</span><br><span class="line">--deploy-mode cluster/client</span><br><span class="line">--conf spark.kubernetes.namespace=default</span><br><span class="line">--conf spark.app.name=spark-pi</span><br><span class="line">SparkPi.jar (MainApplicationFile: MainFile is the path to a bundled JAR, Python, or R file of the application.)</span><br></pre></td></tr></table></figure>

<p>SPARK_HOME/bin/spark-submit args</p>
<p>Spark-on-k8s-operator controller run the <code>spark-submit</code> scripts</p>
<p><a target="_blank" rel="noopener" href="https://spark.apache.org/docs/2.3.1/running-on-kubernetes.html">https://spark.apache.org/docs/2.3.1/running-on-kubernetes.html</a></p>
<p><a target="_blank" rel="noopener" href="https://spark.apache.org/docs/2.3.1/running-on-kubernetes.html#cluster-mode">https://spark.apache.org/docs/2.3.1/running-on-kubernetes.html#cluster-mode</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$ bin/spark-submit \</span><br><span class="line">    --master k8s://https://&lt;k8s-apiserver-host&gt;:&lt;k8s-apiserver-port&gt; \</span><br><span class="line">    --deploy-mode cluster</span><br><span class="line">    --name spark-pi \</span><br><span class="line">    --class org.apache.spark.examples.SparkPi \</span><br><span class="line">    --conf spark.executor.instances=5 \</span><br><span class="line">    --conf spark.kubernetes.container.image=&lt;spark-image&gt; \</span><br><span class="line">    <span class="built_in">local</span>:///path/to/examples.jar</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://spark.apache.org/docs/2.3.1/running-on-kubernetes.html#dependency-management">https://spark.apache.org/docs/2.3.1/running-on-kubernetes.html#dependency-management</a></p>
<p>client mode is not supported in 2.3.1 (cluster manager)</p>
<p>but it seems work in 2.4</p>
<p><a target="_blank" rel="noopener" href="https://spark.apache.org/docs/latest/running-on-kubernetes.html">https://spark.apache.org/docs/latest/running-on-kubernetes.html</a></p>
<p>Dependencies Jars and Files</p>
<p>logs</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl -n=&lt;namespace&gt; logs -f &lt;driver-pod-name&gt;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/GoogleCloudPlatform/spark-on-k8s-operator/blob/master/docs/design.md">https://github.com/GoogleCloudPlatform/spark-on-k8s-operator/blob/master/docs/design.md</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/cda86f18.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/cda86f18.html" class="post-title-link" itemprop="url">raft</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-11-09 10:20:59" itemprop="dateCreated datePublished" datetime="2019-11-09T10:20:59Z">2019-11-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 02:22:31" itemprop="dateModified" datetime="2020-11-22T02:22:31Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>852</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>CP</p>
<p>先写 log</p>
<p>再复制 log</p>
<p>一致性协议确保大多数都已成功复制 log 后，这个时候 log 也称为被 committed 了</p>
<p>执行状态机</p>
<p>三种角色</p>
<p>Leader / Follower / Candidate</p>
<p>Leader 负责周期性发起心跳</p>
<p>Follower 接收心跳</p>
<p>Follower 选举超时后，发起 Vote，状态转变为 Candidate</p>
<p>ETCD 的流程</p>
<p>写 WAL; raft 协议 ok; apply data to boltdb</p>
<p>使用 raft 来同步 WAL;</p>
<p>选举的限制</p>
<p>A candidate must contact a majority of the cluster in order to be elected, which means that every committed entry must be present in at least one of those servers</p>
<p>Raft determines which of two logs is more up-to-date by comparing the index and term of the last entries in the logs</p>
<p>简单来说，在发起选举投票时，需要携带最新的 log 信息，包括 index 及 term；term 越大越新，如果 term 相同，则 log 的长度越长越新；这可以保证新选举出来的 leader 包含了之前所有 commited 的信息</p>
<p>网络分区需要特殊考虑 (2PC)</p>
<blockquote>
<p>第一阶段先征求其他节点是否同意选举，如果同意选举则发起真正的选举操作，否则降为 Follower 角色</p>
</blockquote>
<p>例如当有 follow 被隔离时，其 term 会不断增大，当其重新加入集群时，会触发选举，影响集群稳定性；为避免如此情况，增加 preVote 阶段，即发起 vote 的前提为</p>
<ul>
<li>没有收到有效领导的心跳，至少有一次选举超时</li>
<li>Candidate的日志足够新（Term更大，或者Term相同raft index更大）</li>
</ul>
<p>才开始选举，避免网络隔离后，恢复加入的节点 term 较高，触发集群选举</p>
<p>客户端也需要考虑，网络分区，无法完成写入，需要 server 端返回特定的错误时，直接切换后端</p>
<p>Summary</p>
<ul>
<li>2PC 两阶段</li>
<li>Leader 一致性算法</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/6722211e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/6722211e.html" class="post-title-link" itemprop="url">aws sagemaker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-10-20 10:23:09" itemprop="dateCreated datePublished" datetime="2019-10-20T10:23:09Z">2019-10-20</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-12-12 07:42:19" itemprop="dateModified" datetime="2020-12-12T07:42:19Z">2020-12-12</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>800</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>没实际玩儿过 … 家里一直登陆不上 … 以下全凭看文档与代码</p>
<p>以 EC2 为基石设计，以镜像作为运行环境，完全面向镜像的设计</p>
<p>支持的 EC2 实例类型</p>
<p><a target="_blank" rel="noopener" href="https://amazonaws-china.com/sagemaker/pricing/instance-types/">https://amazonaws-china.com/sagemaker/pricing/instance-types/</a></p>
<p>性能最好的实例类型当前为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ml.p3dn.24xlarge</span><br><span class="line">vCPU: 96  </span><br><span class="line">GPUs: 8xV100  </span><br><span class="line">Mem(GiB): 768 </span><br><span class="line">GPU Mem(GiB): 256 </span><br><span class="line">Networking Performance: 100 Gigabit</span><br></pre></td></tr></table></figure>

<p>EC2 对应的实例类型为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">p3dn.24xlarge   </span><br><span class="line">GPUs: 8   </span><br><span class="line">vCPU: 96  </span><br><span class="line">Mem(GiB): 768 </span><br><span class="line">GPU Mem(GiB): 256 </span><br><span class="line">GPU P2P: NVLink  </span><br><span class="line">Storage(GB): 2 x 900 NVMe SSD    </span><br><span class="line">Dedicated EBS Bandwidth: 14 Gbps </span><br><span class="line">Networking Performance: 100 Gigabit</span><br></pre></td></tr></table></figure>

<p>100 Gigabit 由 AWS efa 提供，提供 OS-bypass 通信能力，应该就是 Infiniband 网络</p>
<p>启动训练过程 (Script Mode)</p>
<ul>
<li>上传本地代码至 S3</li>
<li>调用 Sagemaker 创建训练作业接口<ul>
<li>创建 EC2 实例</li>
<li>在 EC2 实例上启动 Sagemaker 系统进程</li>
<li>下载数据集</li>
<li>启动容器 (镜像)</li>
<li>下载训练代码</li>
<li>启动训练代码</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://github.com/aws/sagemaker-containers">https://github.com/aws/sagemaker-containers</a></p>
<p>下载</p>
<p><a target="_blank" rel="noopener" href="https://github.com/aws/sagemaker-containers/blob/master/src/sagemaker_containers/_files.py#L112">https://github.com/aws/sagemaker-containers/blob/master/src/sagemaker_containers/_files.py#L112</a></p>
<p>上传</p>
<p><a target="_blank" rel="noopener" href="https://github.com/aws/sagemaker-python-sdk/blob/master/src/sagemaker/fw_utils.py#L322">https://github.com/aws/sagemaker-python-sdk/blob/master/src/sagemaker/fw_utils.py#L322</a></p>
<p>因此完整流程</p>
<p>创建作业/版本</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/a83bebaf.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/a83bebaf.html" class="post-title-link" itemprop="url">play akka guideline</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-09-15 10:25:08" itemprop="dateCreated datePublished" datetime="2019-09-15T10:25:08Z">2019-09-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 02:25:30" itemprop="dateModified" datetime="2020-11-22T02:25:30Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>66</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://doc.akka.io/docs/akka/current/guide/actors-motivation.html">https://doc.akka.io/docs/akka/current/guide/actors-motivation.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/27a23804.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/27a23804.html" class="post-title-link" itemprop="url">hikari connection pool</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-09-14 10:25:47" itemprop="dateCreated datePublished" datetime="2019-09-14T10:25:47Z">2019-09-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 02:32:20" itemprop="dateModified" datetime="2020-11-22T02:32:20Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="hikari-轻量级数据库连接池"><a href="#hikari-轻量级数据库连接池" class="headerlink" title="hikari 轻量级数据库连接池"></a>hikari 轻量级数据库连接池</h1><p><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing#limited-resources">https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing#limited-resources</a></p>
<p>这句话挺有趣，言简意赅</p>
<blockquote>
<p>More threads only perform better when blocking creates opportunities for executing.</p>
</blockquote>
<p><strong>hikari 的理念，connections 并非越多越好，相反，可能只需要少量；太多的 connections 反而会导致性能下降</strong></p>
<p>一般而言，一个数据库操作由一个线程执行；而 CPU 一个核心，同时只能执行一个线程</p>
<p>基于该前提，在没有 IO 阻塞的情况，即线程只要启动，就能一直在处理工作，那多线程 (多 connections)，并不能提高性能</p>
<p>如果有 IO 阻塞等情况，使得线程在自己的时间片中，不能充分使用 CPU core，这样通过线程切换技术，可以提高 CPU core 的使用率，最终来看提高了性能 (吞吐量)</p>
<p>因此 PostgresSQL 项目给出了一个连接数计算的参考公式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">connections = ((core_count * 2) + effective_spindle_count)</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Effective spindle count is zero if<br>the active data set is fully cached, and approaches the actual number of spindles<br>as the cache hit rate falls</p>
</blockquote>
<p>effective_spindle_count 即 IO 等待时间的估计值</p>
<h1 id="hikari-特殊的优化手段介绍"><a href="#hikari-特殊的优化手段介绍" class="headerlink" title="hikari 特殊的优化手段介绍"></a>hikari 特殊的优化手段介绍</h1><p><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki/Down-the-Rabbit-Hole">https://github.com/brettwooldridge/HikariCP/wiki/Down-the-Rabbit-Hole</a></p>
<ul>
<li>修改代码: 生成更优的字节码</li>
<li>实现特定的数据结构: 更好的性能</li>
</ul>
<h1 id="连接池的一些问题"><a href="#连接池的一些问题" class="headerlink" title="连接池的一些问题"></a>连接池的一些问题</h1><p><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing#pool-locking">https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing#pool-locking</a></p>
<h2 id="一个线程获取多个数据库连接（饿死）"><a href="#一个线程获取多个数据库连接（饿死）" class="headerlink" title="一个线程获取多个数据库连接（饿死）"></a>一个线程获取多个数据库连接（饿死）</h2><p>可能的优化方案</p>
<ul>
<li>设置保证不会出现饿死情况的 pool size = Tn x (Cm - 1) + 1, Tn 为线程数, Cm 为每个线程最大获取的连接数</li>
<li>如果当前线程已经获取过数据库连接，再调用 getConnection 时，返回该线程当前的 connection，而不是返回新的 connection</li>
</ul>
<h1 id="hikari-的一些配置项"><a href="#hikari-的一些配置项" class="headerlink" title="hikari 的一些配置项"></a>hikari 的一些配置项</h1><p><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP#configuration-knobs-baby">https://github.com/brettwooldridge/HikariCP#configuration-knobs-baby</a></p>
<p><strong>leakDetectionThreshold</strong>: connection 泄漏告警，getConnection 后，在 leakDetectionThreshold 时间前，未调用 close 方法，会日志打印告警</p>
<p>慢 SQL (10s 以上执行时间) 会导致该告警</p>
<p><strong>idleTimeout</strong> = idleTimeout = 600s</p>
<blockquote>
<p>This property controls the maximum amount of time that a connection is allowed to sit idle in the pool</p>
</blockquote>
<p>此属性控制允许连接在池中空闲的最长时间，即空闲超过该时间后，该 Connection 将被 softEvictConnection</p>
<p><strong>maxLifetime</strong> = maxLifetime = 1800s</p>
<p>Hikari 新建 connection 时，使用 houseKeeperExecutor 线程池执行，maxLifeTime 后触发 softEvictConnection</p>
<p>maxLifetime 需要结合 DB 的 connection timeout 设置</p>
<p>maxLifetime 加了 2.5% 的抖动，防止同一时间有大量的 Connections 被关闭</p>
<p><strong>maximumPoolSize</strong> = maximumPoolSize = 10</p>
<blockquote>
<p>This property controls the maximum size that the pool is allowed to reach, including both idle and in-use connections. Basically this value will determine the maximum number of actual connections to the database backend.</p>
</blockquote>
<p>决定了最大 Connections 数 (idle and in-use)</p>
<p><strong>minimumIdle</strong> = maximumPoolSize</p>
<p>需要维持的最小 idle Connections 数</p>
<p><strong>validationTimeout</strong> = 5s</p>
<blockquote>
<p>This property controls the maximum amount of time that a connection will be tested for aliveness.</p>
</blockquote>
<p>getConnection 时会判断 Connection aliveness，设置检测 aliveness 的超时时间</p>
<p><strong>connectionTimeout</strong> = 30s</p>
<blockquote>
<p>This property controls the maximum number of milliseconds that a client (that’s you) will wait for a connection from the pool.</p>
</blockquote>
<p>getConnection 的超时时间</p>
<h1 id="与-Scala-Slick-结合"><a href="#与-Scala-Slick-结合" class="headerlink" title="与 Scala Slick 结合"></a>与 Scala Slick 结合</h1><p>增加 slick-hikari 依赖</p>
<p><a target="_blank" rel="noopener" href="http://slick.lightbend.com/doc/3.2.1/gettingstarted.html#adding-slick-to-your-project">http://slick.lightbend.com/doc/3.2.1/gettingstarted.html#adding-slick-to-your-project</a></p>
<p>增加 typesafe config 配置项</p>
<p><a target="_blank" rel="noopener" href="http://slick.lightbend.com/doc/3.2.1/database.html#connection-pools">http://slick.lightbend.com/doc/3.2.1/database.html#connection-pools</a></p>
<p>注意到 slick 将 hikari 的初始化方法封装了一层，另外该文档有一些错误，建议直接参考 hikari 的 readme.md 说明，也没几个核心参数</p>
<p><a target="_blank" rel="noopener" href="http://slick.lightbend.com/doc/3.2.1/api/index.html#slick.jdbc.JdbcBackend$DatabaseFactoryDef@forConfig(String,Config,Driver,ClassLoader):Database">http://slick.lightbend.com/doc/3.2.1/api/index.html#slick.jdbc.JdbcBackend$DatabaseFactoryDef@forConfig(String,Config,Driver,ClassLoader):Database</a></p>
<p>Slick 这个 O (or function) RM 怎么说呢，一言难尽，表达式太弱 (当然可能是我不熟悉如此灵魂的 function 写法)，生成的 SQL 语句非最优。举个例子</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="built_in">count</span>(<span class="number">1</span>), <span class="built_in">count</span>(<span class="keyword">distinct</span> job_name), <span class="operator">*</span> <span class="keyword">from</span> A, B, C</span><br></pre></td></tr></table></figure>

<p>就没法实现，要么写成子查询，要么只能分开并发执行，or 直接写 sql 语句 …</p>
<h2 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h2><p>注意到 slick 维护一个内部线程池，用于执行数据库相关的异步操作，通过 numThreads 参数指定最大线程数</p>
<h2 id="Database-forConfig"><a href="#Database-forConfig" class="headerlink" title="Database.forConfig()"></a>Database.forConfig()</h2><p>numThreads: 用于执行数据库相关的异步操作的线程数</p>
<p>maxConnections = numThreads * 5</p>
<p>minimumIdle = numThreads</p>
<p>因此以 Slick numThreads = 16 为例</p>
<ul>
<li>maximumPoolSize = 16 * 5 = 80</li>
<li>minimumIdle = 16</li>
</ul>
<h1 id="hikari-summary"><a href="#hikari-summary" class="headerlink" title="hikari summary"></a>hikari summary</h1><p>关键配置项</p>
<ul>
<li>minimumIdle 决定了连接池中的最小 idle 连接数，当 idle 连接少于该阈值时，hikari 会尽快补齐</li>
<li>idleTimeout (10min) 决定了 idle 连接的存活时间</li>
<li>maximumPoolSize 决定了连接池中的最大连接数</li>
<li>maxLifeTime (30min) 决定了连接最大存活时间</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/3ac56ec7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/3ac56ec7.html" class="post-title-link" itemprop="url">openmpi</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-02 10:36:50" itemprop="dateCreated datePublished" datetime="2019-06-02T10:36:50Z">2019-06-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 02:41:40" itemprop="dateModified" datetime="2020-11-22T02:41:40Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/open-mpi/ompi/issues/6691#issuecomment-497245597">https://github.com/open-mpi/ompi/issues/6691#issuecomment-497245597</a></p>
<p>ess_hnp_module.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">orte_set_attribute(&amp;transports, ORTE_RML_TRANSPORT_TYPE, ORTE_ATTR_LOCAL, orte_mgmt_transport, OPAL_STRING);</span><br><span class="line">orte_mgmt_conduit = orte_rml.open_conduit(&amp;transports);</span><br><span class="line">orte_set_attribute(&amp;transports, ORTE_RML_TRANSPORT_TYPE, ORTE_ATTR_LOCAL, orte_coll_transport, OPAL_STRING);</span><br><span class="line">orte_coll_conduit = orte_rml.open_conduit(&amp;transports);</span><br></pre></td></tr></table></figure>

<p>rml: resource message layer</p>
<p>根据 attr 选择 rtmod, 返回的为 mod 在 array 中的 index</p>
<blockquote>
<p>Open conduit - call each component and see if they can provide a<br>conduit that can satisfy all these attributes - return the conduit id<br>(a negative value indicates error)</p>
</blockquote>
<p>rml_base_stubs.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orte_rml_API_open_conduit</span><br></pre></td></tr></table></figure>

<p>遍历 active 的 rml mod, 调用各个 rml mod 的 open_conduit, 例如 oob (rml_oob_component.c), 返回 mod 之后，存入 array，返回 array index</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">open_conduit()</span><br><span class="line"></span><br><span class="line">orte_get_attribute(attributes, ORTE_RML_TRANSPORT_TYPE, (void**)&amp;comp_attrib, OPAL_STRING)</span><br></pre></td></tr></table></figure>

<p>从 attr 里获取 key 值，即 orte_mgmt_transport or orte_coll_transport, 确定是否指定了 oob</p>
<p>继续获取 routed mod</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">orte_get_attribute(attributes, ORTE_RML_ROUTED_ATTRIB, (<span class="keyword">void</span>**)&amp;comp_attrib, OPAL_STRING);</span><br></pre></td></tr></table></figure>

<p>根据设置的 routed mod (NULL 则按优先级) 分配 routed mod</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">md-&gt;routed = orte_routed.assign_module(comp_attrib);</span><br></pre></td></tr></table></figure>

<p>orte_mca_params.c</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">orte_mgmt_transport = &quot;oob&quot; // default</span><br><span class="line"></span><br><span class="line">--mca orte_mgmt_transport </span><br><span class="line"></span><br><span class="line">ORTE management messages</span><br><span class="line"></span><br><span class="line">orte_coll_transport = &quot;fabric,ethernet&quot; // default</span><br><span class="line"></span><br><span class="line">--mca orte_coll_transports</span><br><span class="line"></span><br><span class="line">ORTE collectives</span><br></pre></td></tr></table></figure>

<p>plm_base_launch_support.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">param = <span class="literal">NULL</span>;</span><br><span class="line"><span class="keyword">if</span> (ORTE_SUCCESS != (rc = orte_regx.nidmap_create(orte_node_pool, &amp;param))) &#123;</span><br><span class="line">    ORTE_ERROR_LOG(rc);</span><br><span class="line">    <span class="keyword">return</span> rc;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="literal">NULL</span> != orte_node_regex) &#123;</span><br><span class="line">    <span class="built_in">free</span>(orte_node_regex);</span><br><span class="line">&#125;</span><br><span class="line">orte_node_regex = param;</span><br><span class="line"><span class="comment">/* if this is too long, then we&#x27;ll have to do it with</span></span><br><span class="line"><span class="comment"> * a phone home operation instead */</span></span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">strlen</span>(param) &lt; orte_plm_globals.node_regex_threshold) &#123;</span><br><span class="line">    opal_argv_append(argc, argv, <span class="string">&quot;-&quot;</span>OPAL_MCA_CMD_LINE_ID);</span><br><span class="line">    opal_argv_append(argc, argv, <span class="string">&quot;orte_node_regex&quot;</span>);</span><br><span class="line">    opal_argv_append(argc, argv, orte_node_regex);</span><br><span class="line">    <span class="comment">/* mark that the nidmap has been communicated */</span></span><br><span class="line">    orte_nidmap_communicated = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>orte_node_pool</p>
<p><code>node_regex_threshold</code> = 1024 default len</p>
<p>Resource Allocation Subsystem (RAS)</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/ee6e3d9f.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/ee6e3d9f.html" class="post-title-link" itemprop="url">conda-dl</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-02 10:33:37" itemprop="dateCreated datePublished" datetime="2019-06-02T10:33:37Z">2019-06-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 02:36:13" itemprop="dateModified" datetime="2020-11-22T02:36:13Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>617</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://conda.io/projects/conda/en/latest/user-guide/getting-started.html#managing-python">managing python version</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda create --name dl python=3.6</span><br></pre></td></tr></table></figure>

<p>activate your env [dl]</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conda info --envs</span><br><span class="line">conda activate dl</span><br></pre></td></tr></table></figure>

<p>PyCharm with anaconda</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=building#easy-build">build the latest openmpi</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># download the openmpi-v4.0.0.tar.gz from the official website</span></span><br><span class="line"><span class="comment"># untar and run configure</span></span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/openmpi --enable-orterun-prefix-by-default</span><br><span class="line"><span class="comment"># make and install</span></span><br><span class="line">make -j $(nproc) all</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>

<p>verify openmpi</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpirun -np 4 --bind-to none --map-by slot hostname</span><br></pre></td></tr></table></figure>

<p>install tensorflow</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/anaconda3/envs/dl/bin/pip --proxy http://127.0.0.1:1081 install tensorflow==1.13.1</span><br></pre></td></tr></table></figure>

<p>install horovod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HOROVOD_WITH_TENSORFLOW=1 /anaconda3/envs/dl/bin/pip install -v --no-cache-dir horovod==0.16.2</span><br></pre></td></tr></table></figure>

<p>ref <a target="_blank" rel="noopener" href="https://github.com/horovod/horovod/blob/master/Dockerfile">horovod Dockerfile</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/acff1ae2.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/acff1ae2.html" class="post-title-link" itemprop="url">mxnet debug</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-06-01 10:42:52" itemprop="dateCreated datePublished" datetime="2019-06-01T10:42:52Z">2019-06-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 02:44:17" itemprop="dateModified" datetime="2020-11-22T02:44:17Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>227</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>recomplie mxnet</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DEBUG=1 <span class="keyword">in</span> comfig.mk, <span class="keyword">then</span> recompile the whole framework.</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/apache/incubator-mxnet/issues/6796#issuecomment-311310985">https://github.com/apache/incubator-mxnet/issues/6796#issuecomment-311310985</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -j $(nproc) YOU_OPTIONS will compile parallelly</span><br><span class="line">gdb --args python YOU_ARGS can debug with gdb</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/9ca10b5e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/9ca10b5e.html" class="post-title-link" itemprop="url">horovod-tf</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-19 10:44:40" itemprop="dateCreated datePublished" datetime="2019-05-19T10:44:40Z">2019-05-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 02:45:33" itemprop="dateModified" datetime="2020-11-22T02:45:33Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>408</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>0.16.2</p>
</blockquote>
<p>horovod 启动流程</p>
<p>hvd.init() 发生了什么</p>
<p>HorovodBasics -&gt; init -&gt; horovod_init -&gt; InitializeHorovodOnce</p>
<p>启动线程</p>
<p>BackgroundThreadLoop</p>
<p>MPI 初始化</p>
<p>MPI_Comm_dup</p>
<p>MPI_Comm_rank 获取当前进程的 RANK</p>
<p>MPI_Comm_size 获取 local size</p>
<p>两次 AllGather, 把 rank 与 size 分发到所有进程</p>
<p>检查是否同构，即 size 是否相同</p>
<p>rank 0 初始化 MessageTable</p>
<p>initialization_done = true 初始化结束</p>
<p>主线程等待</p>
<p>initialization_done = true</p>
<p>背景线程持续 RunLoopOnce</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> (<span class="built_in">RunLoopOnce</span>(state, is_coordinator));</span><br></pre></td></tr></table></figure>

<p>从 message_queue 中获取数据</p>
<p>DistributedOptimizer</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/efe6a532.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/efe6a532.html" class="post-title-link" itemprop="url">mxnet-network-and-infiniband</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2019-05-01 10:46:35" itemprop="dateCreated datePublished" datetime="2019-05-01T10:46:35Z">2019-05-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2020-11-22 02:50:14" itemprop="dateModified" datetime="2020-11-22T02:50:14Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="MXNet-分布式通信"><a href="#MXNet-分布式通信" class="headerlink" title="MXNet 分布式通信"></a>MXNet 分布式通信</h1><p>MXnet 使用了 dmlc/ps-lite 实现其分布式通信机制</p>
<p>ps-lite</p>
<p>van.h 父类，使用 Protocol buffer 定义了数据格式</p>
<p>zmq_van.h 继承 van.h，使用 zmq 做具体的数据传输</p>
<p>当前 MXnet 只能使用 IPoIB，不能直接使用 IB verbs 来通信；有个改动 ps-lite 也能直接使用 ib 来通信的 PR 挂了一年多了 …</p>
<h1 id="RDMA-in-kubernetes"><a href="#RDMA-in-kubernetes" class="headerlink" title="RDMA in kubernetes"></a>RDMA in kubernetes</h1><p>IB 这东西嘛，看起来是没服务发现的能力的；就是使用之前，需要使用 IP 网络通信一次，然后知道对端的 IB 的地址后，才能直接基于 IB 来通信</p>
<p>NCCL 就是这么干的</p>
<p>当然参考阿里云的说法</p>
<blockquote>
<p>RDMA通讯建连过程普遍分为 TCP 和 RDMA_CM 两种实现，如果应用程序使用RDMA_CM 的建连的方式，vpc网络插件中分配的pod ip 无法作为RDMA_CM 地址， 容器需要设置HostNetwork。并将bond0 ip 设置为CM的通讯地址</p>
</blockquote>
<p>这得看下 mlx device plugin 的实现和容器网络的实现，比较好奇，看一下吧</p>
<p>业界有两种实现 SR-IOV (single root io virtualization) 另一种就是直接共享设备 (HCA: host channel adapter)</p>
<h2 id="HCA"><a href="#HCA" class="headerlink" title="HCA"></a>HCA</h2><p>HCA 就没啥好说的了，device plugin allocate 时，给 kubelet 返回设备路径，直接整个把 /dev/infiniband 挂载入容器中即可 … 这点会比较误导，相当于可以用所有的 HCA ?</p>
<p>所以对于 HCA 来说，直接用原先的容器网络来初始化 IB 通信即可，即在容器网络上做 ib 设备地址的发现，随后再用 ib verbs api 来通信</p>
<p>当然如果实现时，不是使用 tcp 的方式来初始化 IB，使用的是 rdma_cm，会有区别，容器的 ip 不能用于通信，只能用主机上的 bond0 ip 来通信 （主网卡）</p>
<p>有点儿奇怪可能与 rdma_cm 的 api 有关 …</p>
<p>另外最好加个这个，让单机多卡的训练可以 IPC 通信</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">securityContext:</span></span><br><span class="line">  <span class="attr">capabilities:</span></span><br><span class="line">    <span class="attr">add:</span> [ <span class="string">&quot;IPC_LOCK&quot;</span> ]</span><br></pre></td></tr></table></figure>

<h2 id="SR-IOV"><a href="#SR-IOV" class="headerlink" title="SR-IOV"></a>SR-IOV</h2><p>PF -&gt; VF</p>
<p>需要 SR-IOV CNI plugin 及 device plugin 配合</p>
<p>device plugin 挂载 /dev/infiniband 到容器中</p>
<p>SR-IOV CNI plugin 负责将 VF 绑定到容器的 network namespace 中</p>
<p>假设 VF 事先创建好</p>
<p>逻辑是通的，CNI 记录每个节点哪些 VF 已被分配，每个节点记录剩余几个 VF，当有新的 pod 被调度到当前节点时，CNI 即可分配未使用的 VF 与 pod</p>
<h1 id="IP-over-Infiniband"><a href="#IP-over-Infiniband" class="headerlink" title="IP over Infiniband"></a>IP over Infiniband</h1><p>IPoIB 由 ipoib driver 实现，能像一般 NIC (ifconfig) 一样使用 ib 网络，当然性能差一些，在到达 NIC 之前，与 socket 通信的开销一致</p>
<ul>
<li>socket api</li>
<li>ib verbs api</li>
</ul>
<p>socket api 走 os 调用栈，CPU 参与</p>
<p>ib verbs 直接走 ib，相当于 bypass 了 os 与 CPU，硬件卸载</p>
<p>不过有个地方比较疑惑，IPoIB，infiniband 底层的传输方式是 datagram 即不可靠传输，不过上层应用（zmp）都是 tcp，应有自己的重传机制；其次 ps-lite van.h 里也有开关控制重传功能，在未收到当前消息的 ACK 时，不会处理该请求，这里展开说下</p>
<p>van.h 初始时，如果看到打开了重传开关，则初始化 resend.h</p>
<p>启动了一个线程，周期性 (Timeout) 的重传 send_buf 中的消息</p>
<p>van.h 在</p>
<ul>
<li>发送数据时，将数据加入 send_buf 中；</li>
<li>接收到数据时<ul>
<li>如果是 ACK，则从 send_buf 中移除该消息，并把数据交给上层处理</li>
<li>若当前数据仍不是 ack 数据，则查看是否已发送过 ACK<ul>
<li>是的话，则认为是重复消息，不交上层处理，并发送 ACK</li>
<li>否则 交上层处理，记录到 ACK set 中，并发送 ACK</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>不过这个重传的场景比较神奇，话说 TCP 已经有 ACK 和重传机制了 … 不懂 ps-lite 是遇到了什么具体的场景，再做了一次重传的增强设计</p>
<p>而且这个设计有个限制，收发数据越多，似乎内存消耗越大，因为记录是否收到过该消息的 ACK 的 set，并没有清理的机会，会一直增加</p>
<p>所以一般也未见开启这个功能，env.md 里都没说明这两环境变量，姑且认为是个废弃特性吧 …</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PS_RESEND=1</span><br><span class="line">PS_RESEND_TIMEOUT=1000 # ms</span><br></pre></td></tr></table></figure>

<h1 id="厂家"><a href="#厂家" class="headerlink" title="厂家"></a>厂家</h1><h2 id="Azure"><a href="#Azure" class="headerlink" title="Azure"></a>Azure</h2><p>只支持 RDMA on IB 不支持 IP over IB</p>
<p>In Azure, IP over IB is not supported. Only RDMA over IB is supported.</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/zh-cn/azure/virtual-machines/linux/sizes-hpc#rdma-capable-instances">https://docs.microsoft.com/zh-cn/azure/virtual-machines/linux/sizes-hpc#rdma-capable-instances</a></p>
<h2 id="Aliyun"><a href="#Aliyun" class="headerlink" title="Aliyun"></a>Aliyun</h2><p>k8s 目前只看到 RDMA on IB，IP over IB 没看到，看起来是直接主机网络之后，用 ib0 ip 就行？</p>
<h2 id="AWS"><a href="#AWS" class="headerlink" title="AWS"></a>AWS</h2><p>sagemaker 25Bbps/s 互联，看起来不像 IB or RoCE</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://community.mellanox.com/s/article/kubernetes-ipoib-ethernet-rdma-sr-iov-networking-with-connectx4-connectx5">https://community.mellanox.com/s/article/kubernetes-ipoib-ethernet-rdma-sr-iov-networking-with-connectx4-connectx5</a></p>
<p>在 Kubernetes 上使用 RDMA</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">261k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:57</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
