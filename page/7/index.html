<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>
<meta name="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
<meta property="og:type" content="website">
<meta property="og:title" content="éšé£é£˜æ•£çš„è®°å¿†">
<meta property="og:url" content="https://zrss.github.io/page/7/index.html">
<meta property="og:site_name" content="éšé£é£˜æ•£çš„è®°å¿†">
<meta property="og:description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="tech">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zrss.github.io/page/7/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/7/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>éšé£é£˜æ•£çš„è®°å¿†</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">éšé£é£˜æ•£çš„è®°å¿†</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">125</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">åˆ†ç±»</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">67</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/73c2c618.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/73c2c618.html" class="post-title-link" itemprop="url">client go informers</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-16 14:09:09" itemprop="dateCreated datePublished" datetime="2018-09-16T14:09:09Z">2018-09-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 06:09:55" itemprop="dateModified" datetime="2020-11-22T06:09:55Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>426</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>å ä¸ªå‘ï¼Œè¿˜æ˜¯åœ¨ ut çš„æ—¶å€™è¢«å‘åˆ°äº†ï¼Œåç»­æœ‰æ—¶é—´è¡¥ä¸Šï¼Œè¿™ä¸ªæˆ‘è®¤ä¸º k8s æœ€æˆåŠŸçš„åœ°æ–¹</p>
<p>ä¸æ˜¯å®¹å™¨è°ƒåº¦ï¼Œè€Œæ˜¯è¿™å¥—åŸºäº etcd æŠ½è±¡å‡ºæ¥çš„ api ğŸ˜ƒ</p>
<ul>
<li>informer</li>
<li>lister</li>
</ul>
<p>è¿™ informer å‘€ï¼Œå…¶å®å°±æ˜¯æä¾› add/update/create å›è°ƒçš„å°è£… (æ‰€è°“ informer)</p>
<p>è€Œè¿™ lister å‘¢ï¼Œæ˜¯å¯¹è±¡ cacheï¼Œä» lister ä¸­å¯ä»¥è·å–åˆ°å¯¹è±¡ã€‚lister ç”± informer æä¾›ã€‚</p>
<p>å…¶å®è¿˜æŒºè‡ªç„¶çš„ï¼Œæƒ³æƒ³ informer å›è°ƒ add/update/create çš„æ—¶å€™ï¼ŒåŸºæœ¬æ€è·¯</p>
<ul>
<li>list-watch kube-apiserver</li>
<li>watch åˆ°å¯¹è±¡å˜åŒ–ï¼Œæ ¹æ® cache è®¡ç®— diffï¼Œç„¶åç›¸åº”å›è°ƒ add/update/create</li>
</ul>
<p>æ‰€ä»¥å®ƒæ˜¯éœ€è¦ lister è¿™æ ·çš„ local cache çš„</p>
<p>æ‰€ä»¥å¦‚æœè‡ªå·±è¦å®ç°ä¸€ä¸ª k8s style çš„ controllerï¼Œéœ€è¦ä½¿ç”¨åˆ° informer æ—¶ï¼Œé¦–å…ˆåˆå§‹åŒ– informerï¼Œåˆå§‹åŒ– ok ä¹‹åï¼Œå¦‚æœéœ€è¦æŸ¥å¯¹è±¡ï¼Œé‚£å¯ä»¥é€šè¿‡ informer çš„ lister æ¥è·å–</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/bed8f754.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/bed8f754.html" class="post-title-link" itemprop="url">knative startup</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-01 14:26:45" itemprop="dateCreated datePublished" datetime="2018-09-01T14:26:45Z">2018-09-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 06:37:30" itemprop="dateModified" datetime="2020-11-22T06:37:30Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>4.5k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ä¹Ÿè®¸ kubernetes å¯¹äºå¼€å‘è€…æ¥è¯´ä»ç„¶è¿‡äºå¤æ‚ï¼Œå¦å¤–ç°å®ç³»ç»Ÿä¸­ï¼Œåˆå¯¹æœåŠ¡å‘å¸ƒåçš„æµé‡ç®¡ç†æœ‰è¯¸å¤šéœ€æ±‚</p>
<p>Knative çš„å‡ºç°ï¼Œä¼¼ä¹æ˜¯è¦çœŸæ­£å®ç° PAAS on the kubernetes</p>
<p>å¼€å‘è€…ä»…éœ€è¦å…³å¿ƒå¦‚ä½•ç¼–å†™ä»£ç  (write code) ï¼Œå…¶ä»–çš„æ‰€æœ‰ï¼Œäº¤ç»™ Knative å§ï¼ˆMaybeï¼‰</p>
<p><a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=F4_2gxTtLaQ&t=849s">One Platform for Your Functions, Applications, and Containers (Cloud Next â€˜18)</a></p>
<h1 id="Knative-serving"><a href="#Knative-serving" class="headerlink" title="Knative serving"></a>Knative serving</h1><h2 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h2><ul>
<li>revision</li>
<li>configuration</li>
<li>services</li>
<li>routes</li>
</ul>
<p>æŠ½è±¡äº†ä¸€å¥—ç»Ÿä¸€çš„æ¡†æ¶å»å®ç°å››ä¸ª controllerï¼Œä¸è¿‡å½“å‰å‘½åçš„ä¸æ˜¯å¾ˆç†æƒ³ï¼Œè™½ç„¶éƒ½åœ¨ controller package ä¸‹é¢ï¼Œç„¶è€Œæ–‡ä»¶åä»…ä¸º revision.go â€¦ ä¸å¦‚ kubernetes çš„ job_controller.go æ¥çš„ç›´æ¥ï¼Œä¹Ÿä¾¿äºæœç´¢</p>
<p>controller çš„ä¸»è¦æ–¹æ³•å‡ä¸º Reconsileï¼Œå³ä» kube-apiserver list-watch CRD çš„å¢é‡æ›´æ–°åï¼Œè°ƒç”¨ Reconsile æ‰§è¡Œç›¸åº”æ“ä½œï¼Œä½¿å¾—æœ€ç»ˆçŠ¶æ€ä¸ç”¨æˆ·æœŸæœ›çš„ä¸€è‡´</p>
<p>æåˆ° list-watch è€Œåˆä¸èƒ½ä¸æåˆ° kubernetes ä¸­çš„æ°å‡º api sdk å®ç°â€”â€”informer</p>
<p>åŸºäºå·²æ—¥æ¸ç¨³å®šçš„ kubernetesï¼Œknative ç›®å‰å®ç°çš„ç®€æ´ç›´æ¥</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ctrlr.Run(threadsPerController, stopCh)</span><br></pre></td></tr></table></figure>

<p>æ¯ä¸ª controller å¯åŠ¨ 2 (threadsPerController) ä¸ª goroutine å¤„ç† list-watch è·å¾—çš„ CRD æ›´æ–°ä¿¡æ¯</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> i := <span class="number">0</span>; i &lt; threadiness; i++ &#123;</span><br><span class="line">    <span class="keyword">go</span> wait.Until(<span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">for</span> c.processNextWorkItem(syncHandler) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, time.Second, stopCh)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>syncHandler ç”±å„ä¸ªä¸åŒçš„ controller ä¼ å…¥</p>
<p>ä¸‹é¢ç®€å•åˆ†æ knative serving æ¨¡å—çš„å‡ ä¸ª controller</p>
<h3 id="services"><a href="#services" class="headerlink" title="services"></a>services</h3><p>æ ¹æ® knative çš„ simple demo appï¼Œå¼€å§‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ yaml åˆ›å»ºä¸€ä¸ª serviceï¼Œè¿™æ˜¯æ‰€æœ‰ knative å¥‡å¦™ä¹‹æ—…çš„å¼€ç«¯ getting-started-knative-app</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">serving.knative.dev/v1alpha1</span> <span class="comment"># Current version of Knative</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">helloworld-go</span> <span class="comment"># The name of the app</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span> <span class="comment"># The namespace the app will use</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">runLatest:</span></span><br><span class="line">    <span class="attr">configuration:</span></span><br><span class="line">      <span class="attr">revisionTemplate:</span></span><br><span class="line">        <span class="attr">spec:</span></span><br><span class="line">          <span class="attr">container:</span></span><br><span class="line">            <span class="attr">image:</span> <span class="string">gcr.io/knative-samples/helloworld-go</span> <span class="comment"># The URL to the image of the app</span></span><br><span class="line">            <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">TARGET</span> <span class="comment"># The environment variable printed out by the sample app</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">&quot;Go Sample v1&quot;</span></span><br></pre></td></tr></table></figure>

<p>services çš„ reconcile é¦–å…ˆä¼šæŸ¥è¯¢</p>
<p>service å¯¹åº”çš„ configuration (its name is the same with service-name) æ˜¯å¦å­˜åœ¨</p>
<ul>
<li>ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¹‹</li>
<li>å­˜åœ¨ï¼Œreconcile ä¹‹</li>
</ul>
<p>service å¯¹åº”çš„ routes (its name is the same with service-name) æ˜¯å¦å­˜åœ¨</p>
<ul>
<li>ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¹‹</li>
<li>å­˜åœ¨ï¼Œreconcile ä¹‹</li>
</ul>
<h3 id="configuration"><a href="#configuration" class="headerlink" title="configuration"></a>configuration</h3><p>è·å–å¯¹åº”çš„ rev</p>
<p>[config-name]-[config.spec.Generation]: helloworld-go-00001</p>
<ul>
<li>ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¹‹</li>
</ul>
<p>éšåæ›´æ–° configuration çš„ status</p>
<p>æ‰€ä»¥å¯ä»¥çœ‹åˆ°åœ¨ configuration ä¸­å…¶å®å®ç°äº† app çš„å¤šç‰ˆæœ¬ç®¡ç†ï¼Œæ¯æ¬¡ configuration çš„ä¿®æ”¹ï¼ˆGeneration + 1ï¼‰å‡ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„ revision</p>
<h3 id="revision"><a href="#revision" class="headerlink" title="revision"></a>revision</h3><p>revision å…³æ³¨ä¸‹è¿°å‡ ç§èµ„æºï¼Œåœ¨ä¸‹è¿°èµ„æºæœ‰å˜åŒ–æ—¶ï¼Œå°†å˜åŒ–åŠ å…¥ queue ä¸­ï¼Œç­‰å¾… revision 2 ä¸ª goroutine å¤„ç†ä¹‹</p>
<ul>
<li>revisionInformer</li>
<li>deploymentInformer</li>
</ul>
<p>æš‚æ—¶ä»…å…³æ³¨ revisionInformerï¼ŒendpointsInformer åŠ deploymentInformer</p>
<p>revision controller è·å–åˆ° revision ä¹‹å</p>
<p>è‹¥æœªæ‰¾åˆ°å…¶å¯¹åº”çš„ deployment</p>
<p>[rev-name]-deployment</p>
<p>å°†å…¶ revision çš„ status æ›´æ–°ä¸º</p>
<ul>
<li>ResourcesAvailable [status: Unknown, reason: Deploying]</li>
<li>ContainerHealthy [status: Unknown, reason: Deploying]</li>
<li>Ready [status: Unknown, reason: Deploying]</li>
</ul>
<p>å¹¶è°ƒç”¨ kube-apiserver api åˆ›å»º deployment</p>
<p>æ³¨æ„åˆ°åœ¨åˆ›å»º deployment æ—¶ï¼Œrevision controller éœ€è¦è¿æ¥è‡³è¯¥ deployment çš„é•œåƒä»“åº“ï¼Œè·å–å…¶ digestï¼Œå› æ­¤å¦‚æœ revision controller æ‰€åœ¨èŠ‚ç‚¹çš„ç½‘ç»œå—é™çš„è¯ï¼Œrevision çš„ status å¯èƒ½ä¼šæç¤ºå¦‚ä¸‹ä¿¡æ¯</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-29T19:03:43Z</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Deploying</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Unknown</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ResourcesAvailable</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-29T19:04:13Z</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;Get https://gcr.io/v2/: dial tcp: i/o timeout&#x27;</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">ContainerMissing</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ContainerHealthy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-29T19:04:13Z</span></span><br><span class="line">    <span class="attr">message:</span> <span class="string">&#x27;Get https://gcr.io/v2/: dial tcp: i/o timeout&#x27;</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">ContainerMissing</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br></pre></td></tr></table></figure>

<p>å³è¿æ¥é•œåƒä»“åº“ï¼ˆå¦‚ç¤ºä¾‹ä¸­çš„è¿æ¥ gcr.io è¶…æ—¶ï¼‰ï¼Œå¯¼è‡´ revision notReadyï¼Œæ­£å¸¸å·¥ä½œçš„ revision çŠ¶æ€å¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-30T09:36:46Z</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ResourcesAvailable</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-30T09:36:46Z</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ContainerHealthy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-30T09:36:46Z</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;True&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br></pre></td></tr></table></figure>

<p>é active çš„ revision çŠ¶æ€å¦‚ä¸‹</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">status:</span></span><br><span class="line">  <span class="attr">conditions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-30T09:09:18Z</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Updating</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Unknown</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ResourcesAvailable</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-30T09:09:18Z</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Updating</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">Unknown</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">ContainerHealthy</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">lastTransitionTime:</span> <span class="number">2018-08-30T09:09:18Z</span></span><br><span class="line">    <span class="attr">reason:</span> <span class="string">Inactive</span></span><br><span class="line">    <span class="attr">status:</span> <span class="string">&quot;False&quot;</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Ready</span></span><br></pre></td></tr></table></figure>

<p>è‹¥æ‰¾åˆ°å…¶å¯¹åº”çš„ deployment</p>
<p>åˆ™æ ¹æ® rev çš„çŠ¶æ€ï¼Œå†³å®š deployment replica çš„æ•°é‡</p>
<ul>
<li>rev.spec.servingState çŠ¶æ€ä¸º Activeï¼Œä¸” deployment replica = 0 æ—¶ï¼Œéœ€å°†å…¶è°ƒæ•´ä¸º 1</li>
<li>rev.spec.servingState çŠ¶æ€ä¸º Reserveï¼Œä¸” deployment replica != 0 æ—¶ï¼Œéœ€å°†å…¶è°ƒæ•´ä¸º 0</li>
</ul>
<p>å¦‚æœæœŸæœ›çš„ deployment replica ä¸å®é™…çš„ replica ç›¸åŒï¼Œé‚£ä¹ˆå°† rev çš„ status æ›´æ–°ä¸º</p>
<ul>
<li>ResourcesAvailable [status: Unknown, reason: Updating]</li>
<li>ContainerHealthy [status: Unknown, reason: Updating]</li>
<li>Ready [status: Unknown, reason: Updating]</li>
</ul>
<p>å¦‚æœä¸ç›¸åŒï¼Œè°ƒç”¨ kube-apiserver api æ›´æ–° deployment</p>
<h3 id="routes"><a href="#routes" class="headerlink" title="routes"></a>routes</h3><p>routes è·å–å…¶å¯¹åº”çš„ kubernetes svc</p>
<p>[route-name] ä¾‹å¦‚ helloworld-go</p>
<ul>
<li>ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¹‹</li>
<li>å¦åˆ™ï¼Œæ›´æ–°ä¹‹</li>
</ul>
<p>éšåé€šè¿‡ istio CRD Istio VirtualService é…ç½®æµé‡</p>
<ul>
<li>ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¹‹</li>
<li>å¦åˆ™ï¼Œæ›´æ–°ä¹‹</li>
</ul>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>controller of serving</p>
<ul>
<li>services controller</li>
<li>configuration controller</li>
<li>routes controller</li>
<li>revision controller</li>
</ul>
<p>æ•°æ®æºå‡æ¥è‡ª list-watch ç›¸åº”çš„ CRDï¼Œå®ç°ç›¸åº”çš„ reconcile æ–¹æ³•</p>
<p>services controller è´Ÿè´£åˆ›å»º configuration å’Œ routes èµ„æº</p>
<p>configuration controller è´Ÿè´£åˆ›å»º revision èµ„æº</p>
<p>routes controller è´Ÿè´£åˆ›å»º Istio VirtualService èµ„æº</p>
<h1 id="Issues"><a href="#Issues" class="headerlink" title="Issues"></a>Issues</h1><p>Knative è¿˜å¤„äºè¾ƒä¸ºå¹´è½»çš„é˜¶æ®µï¼ŒèŠ±äº†ä¸¤å¤©æ—¶é—´æœ€åæˆåŠŸåœ¨å†…ç½‘ç¯å¢ƒä¸ŠæˆåŠŸè¿è¡Œäº†å…¶ simple demo appã€‚ç›®å‰åœ¨éœ€è¦ä½¿ç”¨ proxy è®¿é—®å…¬ç½‘ç½‘ç»œçš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•é…ç½® knativeï¼Œå…¶æ–‡æ¡£ä¸­è¿˜æ²¡æœ‰ç›¸å…³çš„è¯´æ˜</p>
<p>ç›®å‰ä¸ºæ­¢å°è¯• knative çš„ä¸€äº› debug ç»å†ï¼Œå¯å‚çœ‹ä¸‹è¿° issues</p>
<p><a target="_blank" rel="noopener" href="https://github.com/knative/docs/issues/365">Knative http proxy sample</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/knative/serving/issues/1954">istio-statsd-prom-bridge pod crash due to unknown short flag</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/knative/serving/issues/1971">Configuration is waiting for a Revision to become ready</a></p>
<p>to be cont â€¦</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/b5fa504c.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/b5fa504c.html" class="post-title-link" itemprop="url">kubelet workflow</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-08-25 14:38:42" itemprop="dateCreated datePublished" datetime="2018-08-25T14:38:42Z">2018-08-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 06:47:12" itemprop="dateModified" datetime="2020-11-22T06:47:12Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>7k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>6 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>kubelet ä¸ºè¿è¡Œåœ¨ node ä¸Šçš„ä¸»è¦ç»„ä»¶</p>
<p>å…¶ä¸€æ–¹é¢ list-watch kube-apiserver pod èµ„æºçš„å˜åŒ–</p>
<p>å¦ä¸€æ–¹é¢è°ƒç”¨ docker æ¥å£è·å–å½“å‰å®é™…å­˜åœ¨çš„ container æ¥ SyncLoop (PLEG)</p>
<p>æ‰€ä»¥ä¸‹é¢åˆ†ä¸¤æ¡è·¯çº¿æ¥åˆ†æ kubelet çš„ä¸€äº›ç»†èŠ‚ (ä»…å…³æ³¨ pod/containerï¼Œç•¥å»å…¶ä»–æ— å…³èµ„æº)</p>
<h1 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h1><ul>
<li>Run<ul>
<li>start a goroutine, one second trigger once podKiller method</li>
<li>call kl.statusManager.Start()</li>
<li>call kl.probeManager.Start()</li>
<li>call kl.pleg.Start()<ul>
<li>start a goroutine, one second trigger once relist method</li>
</ul>
</li>
<li>call kubelet main loop kl.syncLoop(updates, kl)<ul>
<li>syncLoopIteration</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>æ³¨æ„åˆ° kubelet main loop ä¼ é€’çš„ updates channel ä¸ºä» kube-apiserver list-watch åˆ°çš„ pod å˜åŒ–æ•°æ®ï¼Œå½“ kubelet é‡å¯æ—¶ï¼Œä¼šæ”¶åˆ°å½“å‰ node ä¸Šçš„æ‰€æœ‰ pod æ•°æ®</p>
<p>syncLoopIteration æ˜¯ kubelet çš„ main loopï¼Œå…¶ä¸»è¦å¤„ç†</p>
<ul>
<li>configCh channel: pod info with ADD / Update / Delete â€¦, this channelâ€™s data comes from kube-apiserver</li>
<li>plegCh channel: pod life cycle generator event, such as ContainerStart / ContainerDied â€¦, this channelâ€™s data comes from docker</li>
<li>syncCh channel: a one-second period time ticker</li>
<li>livenessManager.Updates() channel</li>
<li>housekeepingCh channel: a two-second period time ticker</li>
</ul>
<p>å½“ kubelet å¯åŠ¨æ—¶æŒ‡å®š -v=2 çš„æƒ…å†µä¸‹</p>
<p>kubelet å¤„ç† configCh æ•°æ®æ—¶ï¼Œä¼šæ˜¾ç¤ºå¦‚ä¸‹æ—¥å¿—</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">SyncLoop (ADD, api): podName_podNamespace(podUID),...</span><br><span class="line"></span><br><span class="line">or </span><br><span class="line"></span><br><span class="line">SyncLoop (UPDATE, api): podName_podNamespace(podUID),...</span><br><span class="line"></span><br><span class="line">and REMOVE / RECONCILE / DELETE / RESTORE type</span><br></pre></td></tr></table></figure>

<p>å…·ä½“å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyncLoop (ADD, &quot;api&quot;): &quot;nginx-deployment-6c54bd5869-wppm8_default(1336f9f0-a898-11e8-b01b-000d3a362518)&quot;</span><br></pre></td></tr></table></figure>

<p>kubelet å¤„ç† plegCh æ•°æ®æ—¶ï¼Œä¼šæ˜¾ç¤ºå¦‚ä¸‹æ—¥å¿—</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyncLoop (PLEG): podName_podNamespace(podUID),..., event:</span><br></pre></td></tr></table></figure>

<p>å…·ä½“å¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyncLoop (PLEG): &quot;nginx-deployment-6c54bd5869-9jsp5_default(1336d6cf-a898-11e8-b01b-000d3a362518)&quot;, event: &amp;pleg.PodLifecycleEvent&#123;ID:&quot;1336d6cf-a898-11e8-b01b-000d3a362518&quot;, Type:&quot;ContainerStarted&quot;, Data:&quot;7e06e4ce8ab3a4a0b8bbb84f35ac8ac078bb5ec9db4ce765e35a235664cb3dd7&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>Data ä¸º ContainerID ä¸ docker ps çœ‹åˆ°çš„ç›¸åŒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hzs@kubernetes:~/work/src/k8s.io/kubernetes$ docker ps | grep 7e06e4ce8ab3</span><br><span class="line">7e06e4ce8ab3        nginx                                      &quot;nginx -g &#x27;daemon ofâ€¦&quot;   3 minutes ago       Up 3 minutes                            k8s_nginx_nginx-deployment-6c54bd5869-9jsp5_default_1336d6cf-a898-11e8-b01b-000d3a362518_0</span><br></pre></td></tr></table></figure>

<p>ç»è¿‡ä¸Šè¿°åˆ†æï¼Œå¤§æ¦‚å¯¹ kubelet çš„å·¥ä½œåŸç†åŠæ•°æ®æ¥æºæœ‰äº†ä¸ªåŸºæœ¬è®¤è¯†ï¼Œä¸‹é¢è¯¦ç»†çœ‹ä¸€ä¸‹ kubelet å¯¹ configCh åŠ plegCh çš„æ•°æ®å¤„ç†</p>
<h1 id="configCh"><a href="#configCh" class="headerlink" title="configCh"></a>configCh</h1><p>list-watch from kube-apiserver in a independant goroutine, once there is events about pods, then these pod data will be put into configCh</p>
<p>syncLoopIteration -&gt; handle the pod data from list-watch from kube-apiserver pod resource -&gt; HandlePodAdditions/â€¦ -&gt; dispatchWork -&gt; podWorkers.UpdatePod</p>
<p>UpdatePod</p>
<ul>
<li>å¦‚æœä¹‹å‰æœªå¤„ç†è¯¥ podï¼Œåˆ™ä¸ºè¯¥ pod åˆ›å»ºä¸€ä¸ªå¤§å°ä¸º 1 çš„ UpdatePodOptions channelï¼Œå¹¶å¯åŠ¨ä¸€ä¸ªåç¨‹è°ƒç”¨ managePodLoop(podUpdates)</li>
<li>å¦‚æœå¤„ç†è¿‡äº†ï¼Œåˆ¤æ–­ isWorking<ul>
<li>è‹¥ falseï¼Œåˆ™ç½®ä¸º trueï¼Œå¹¶å°† *options ç½®å…¥ UpdatePodOptions channelï¼Œä»¥ä¾› managePodLoop å¤„ç†</li>
<li>è‹¥ trueï¼Œåˆ™è¿›ä¸€æ­¥åˆ¤æ–­ lastUndeliveredWorkUpdate æœªè¢«è®°å½•æˆ–è€… UpdateType ä¸ç­‰äº kubetypes.SyncPodKillï¼Œåˆ™æ›´æ–° lastUndeliveredWorkUpdate ä¸ºæœ¬æ¬¡ UpdatePod *options</li>
</ul>
</li>
</ul>
<p>managePodLoop -&gt; syncPodFn -&gt; kubelet.syncPod</p>
<h1 id="plegCh"><a href="#plegCh" class="headerlink" title="plegCh"></a>plegCh</h1><p>one second trigger once time relist -&gt; generate container event (Started/â€¦) -&gt; put the event into eventChannel channel</p>
<p>syncLoopIteration -&gt; handle the event from eventChannel -&gt; HandlePodSyncs -&gt; dispatchWork -&gt; podWorkers.UpdatePod</p>
<p>çœ‹åˆ°è¿™ï¼Œç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œä¸¤æ¡æ›´æ–°çš„è·¯ï¼Œæœ€ç»ˆå¾—åˆ°ç»Ÿä¸€ï¼Œå³æ¥è‡ªäº kube-apiserver pod æ›´æ–°ï¼Œåˆäº¦æˆ–æ˜¯æ¥è‡ªäºèŠ‚ç‚¹ä¸Š container status çš„å˜åŒ– (pleg)ï¼Œæœ€ç»ˆå‡ä¼šè°ƒç”¨ syncPod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SyncLoop (ADD, &quot;api&quot;): &quot;nginx-deployment-6c54bd5869-wppm8_default(1336f9f0-a898-11e8-b01b-000d3a362518)&quot;</span><br><span class="line">SyncLoop (PLEG): &quot;nginx-deployment-6c54bd5869-9jsp5_default(1336d6cf-a898-11e8-b01b-000d3a362518)&quot;, event: &amp;pleg.PodLifecycleEvent&#123;ID:&quot;1336d6cf-a898-11e8-b01b-000d3a362518&quot;, Type:&quot;ContainerStarted&quot;, Data:&quot;7e06e4ce8ab3a4a0b8bbb84f35ac8ac078bb5ec9db4ce765e35a235664cb3dd7&quot;&#125;</span><br></pre></td></tr></table></figure>

<h1 id="syncPod"><a href="#syncPod" class="headerlink" title="syncPod"></a>syncPod</h1><p>ä¸¾å‡ ä¸ªå…¸å‹çš„ä¾‹å­å§</p>
<h2 id="create-a-deployment-with-replica-1"><a href="#create-a-deployment-with-replica-1" class="headerlink" title="create a deployment with replica 1"></a>create a deployment with replica 1</h2><p>kubelet çš„å“åº”æµç¨‹</p>
<h3 id="configCh-1"><a href="#configCh-1" class="headerlink" title="configCh"></a>configCh</h3><ul>
<li>SyncLoop (ADD, â€œapiâ€): â€œpodName_namespace(podUID)â€</li>
<li>HandlePodAdditions</li>
</ul>
<p>ä» podManager ä¸­è·å–å·²å­˜åœ¨çš„ podï¼Œå¹¶å°†æ–°çš„ pod æ·»åŠ è‡³å…¶ä¸­ã€‚ä»å·²å­˜åœ¨çš„ pod ä¸­è¿‡æ»¤å‡º activePodsï¼Œå¹¶åˆ¤æ–­æ–°çš„ pod canAdmitPodã€‚ä¾‹å¦‚äº²å’Œæ€§ã€åäº²å’Œæ€§çš„åˆ¤æ–­</p>
<ul>
<li>dispatchWork</li>
</ul>
<p>è°ƒç”¨ podWorkers.UpdatePod</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">kl.podWorkers.UpdatePod(&amp;UpdatePodOptions&#123;</span><br><span class="line">    Pod:        pod,</span><br><span class="line">    MirrorPod:  mirrorPod,</span><br><span class="line">    UpdateType: syncType, <span class="comment">// SyncPodCreate</span></span><br><span class="line">    OnCompleteFunc: <span class="function"><span class="keyword">func</span><span class="params">(err error)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">            metrics.PodWorkerLatency.WithLabelValues(syncType.String()).Observe(metrics.SinceInMicroseconds(start))</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<ul>
<li>UpdatePod</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">åˆå§‹åŒ– podUID -&gt; UpdatePodOptions channel (<span class="number">1</span>)ï¼Œå¹¶å¯åŠ¨åç¨‹æ‰§è¡Œ p.managePodLoop(podUpdates)ã€‚p.isWorking[pod.UID] ä¸º <span class="literal">false</span>ï¼Œéšåè®¾ç½®å…¶ä¸º <span class="literal">true</span>ï¼Œå¹¶å°† *options ç½®å…¥ UpdatePodOptions channel</span><br></pre></td></tr></table></figure>

<ul>
<li>managePodLoop</li>
</ul>
<p>å¾ªç¯å¤„ç† UpdatePodOptions channel</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// This is a blocking call that would return only if the cache</span></span><br><span class="line"><span class="comment">// has an entry for the pod that is newer than minRuntimeCache</span></span><br><span class="line"><span class="comment">// Time. This ensures the worker doesn&#x27;t start syncing until</span></span><br><span class="line"><span class="comment">// after the cache is at least newer than the finished time of</span></span><br><span class="line"><span class="comment">// the previous sync.</span></span><br><span class="line">status, err := p.podCache.GetNewerThan(podUID, lastSyncTime)</span><br><span class="line">err = p.syncPodFn(syncPodOptions&#123;</span><br><span class="line">    mirrorPod:      update.MirrorPod,</span><br><span class="line">    pod:            update.Pod,</span><br><span class="line">    podStatus:      status,</span><br><span class="line">    killPodOptions: update.KillPodOptions,</span><br><span class="line">    updateType:     update.UpdateType,</span><br><span class="line">&#125;)</span><br><span class="line">lastSyncTime = time.Now()</span><br></pre></td></tr></table></figure>

<ul>
<li>syncPodFn(kubelet.syncPod)</li>
</ul>
<p>mkdir dir</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/kubelet/pods/[podUID]</span><br></pre></td></tr></table></figure>

<ul>
<li>volumeManager.WaitForAttachAndMount(pod)</li>
</ul>
<p>è·å– imagePullSecrets</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Fetch the pull secrets for the pod</span></span><br><span class="line">pullSecrets := kl.getPullSecretsForPod(pod)</span><br></pre></td></tr></table></figure>

<ul>
<li>containerRuntime.SyncPod</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Call the container runtime&#x27;s SyncPod callback</span><br><span class="line">result := kl.containerRuntime.SyncPod(pod, apiPodStatus, podStatus, pullSecrets, kl.backOff)</span><br></pre></td></tr></table></figure>

<ul>
<li>createPodSandBox</li>
</ul>
<p>mkdir logs dir</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/var/log/pods/[podUID]</span><br></pre></td></tr></table></figure>

<ul>
<li>run init container</li>
<li>run container</li>
</ul>
<h1 id="pleg"><a href="#pleg" class="headerlink" title="pleg"></a>pleg</h1><p>relist çš„æ—¶å€™ï¼Œå…ˆä» docker è·å–ä¸€æŠŠå…¨é‡çš„ pod æ•°æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// Get all the pods.</span><br><span class="line">podList, err := g.runtime.GetPods(true)</span><br></pre></td></tr></table></figure>

<p>å½“å‰çŠ¶æ€ä¸ä¹‹å‰çš„çŠ¶æ€ä¸€æ¯”ï¼Œç”Ÿæˆæ¯ä¸ª container çš„ PLE (pod life cycle event)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SyncLoop (PLEG): &quot;podName_Namespace(podUID)&quot;, event: &amp;pleg.PodLifecycleEvent&#123;ID:&quot;podUID&quot;, Type:&quot;ContainerStarted&quot;, Data:&quot;ContainerID&quot;&#125;</span><br></pre></td></tr></table></figure>

<p>å€¼å¾—æ³¨æ„çš„æ˜¯ ContainerDied å°±æ˜¯å®¹å™¨é€€å‡ºçš„æ„æ€</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">generateEvents</span><span class="params">(podID types.UID, cid <span class="keyword">string</span>, oldState, newState plegContainerState)</span> []*<span class="title">PodLifecycleEvent</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> newState == oldState &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    glog.V(<span class="number">4</span>).Infof(<span class="string">&quot;GenericPLEG: %v/%v: %v -&gt; %v&quot;</span>, podID, cid, oldState, newState)</span><br><span class="line">    <span class="keyword">switch</span> newState &#123;</span><br><span class="line">    <span class="keyword">case</span> plegContainerRunning:</span><br><span class="line">        <span class="keyword">return</span> []*PodLifecycleEvent&#123;&#123;ID: podID, Type: ContainerStarted, Data: cid&#125;&#125;</span><br><span class="line">    <span class="keyword">case</span> plegContainerExited:</span><br><span class="line">        <span class="keyword">return</span> []*PodLifecycleEvent&#123;&#123;ID: podID, Type: ContainerDied, Data: cid&#125;&#125;</span><br><span class="line">    <span class="keyword">case</span> plegContainerUnknown:</span><br><span class="line">        <span class="keyword">return</span> []*PodLifecycleEvent&#123;&#123;ID: podID, Type: ContainerChanged, Data: cid&#125;&#125;</span><br><span class="line">    <span class="keyword">case</span> plegContainerNonExistent:</span><br><span class="line">        <span class="keyword">switch</span> oldState &#123;</span><br><span class="line">        <span class="keyword">case</span> plegContainerExited:</span><br><span class="line">            <span class="comment">// We already reported that the container died before.</span></span><br><span class="line">            <span class="keyword">return</span> []*PodLifecycleEvent&#123;&#123;ID: podID, Type: ContainerRemoved, Data: cid&#125;&#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> []*PodLifecycleEvent&#123;&#123;ID: podID, Type: ContainerDied, Data: cid&#125;, &#123;ID: podID, Type: ContainerRemoved, Data: cid&#125;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="built_in">panic</span>(fmt.Sprintf(<span class="string">&quot;unrecognized container state: %v&quot;</span>, newState))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>plegCh</li>
</ul>
<p>plegCh æœ‰æ•°æ®åï¼Œè°ƒç”¨ HandlePodSyncs å¤„ç†ä¹‹</p>
<ul>
<li>UpdatePod</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if a request to kill a pod is pending, we do not let anything overwrite that request.</span></span><br><span class="line">update, found := p.lastUndeliveredWorkUpdate[pod.UID]</span><br><span class="line"><span class="keyword">if</span> !found || update.UpdateType != kubetypes.SyncPodKill &#123;</span><br><span class="line">    p.lastUndeliveredWorkUpdate[pod.UID] = *options</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å³æ›´æ–° lastUndeliveredWorkUpdate</p>
<p>HandlePodSyncs æ‰§è¡Œç»“æŸä¹‹åï¼ˆåŒæ­¥ï¼‰</p>
<p>å¦‚æœå®¹å™¨æŒ‚æ‰ï¼Œåˆ™æ‰§è¡Œæ¸…ç†åŠ¨ä½œ</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> e.Type == pleg.ContainerDied &#123;</span><br><span class="line">    <span class="keyword">if</span> containerID, ok := e.Data.(<span class="keyword">string</span>); ok &#123;</span><br><span class="line">        kl.cleanUpContainersInPod(e.ID, containerID)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é»˜è®¤é…ç½®ï¼Œåªä¿ç•™æœ€æ–°ä¸€ä¸ªã€‚è‹¥ pod è¢« evictedï¼Œæˆ–è€…æ˜¯ DeletionTimestamp != nil &amp;&amp; notRunning(apiPodStatus.ContainerStatuses)ï¼Œé‚£ä¹ˆå®ƒçš„æ‰€æœ‰å®¹å™¨å°†ä¼šè¢«åˆ é™¤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MaxPerPodContainerCount: 1</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/bdc66cb7.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/bdc66cb7.html" class="post-title-link" itemprop="url">Performance of golang (etcd)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-08-12 15:20:27" itemprop="dateCreated datePublished" datetime="2018-08-12T15:20:27Z">2018-08-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-12-12 07:33:48" itemprop="dateModified" datetime="2020-12-12T07:33:48Z">2020-12-12</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>2.9k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>3 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>golang profiling (å³å‰–æ)ï¼Œgolang åŸç”Ÿæä¾›äº† pprof æ€§èƒ½åˆ†æå·¥å…·</p>
<p>å‰æ®µæ—¶é—´åˆ†æäº†ä¸€ä¸ª apiserver å¤„ç†è¯·æ±‚æ€§èƒ½è¾ƒä½çš„é—®é¢˜ï¼Œæ­£æ˜¯ä½¿ç”¨äº† pprof ç¡®å®šäº†é—®é¢˜ç‚¹ï¼Œä»è€Œè§£å†³äº†è¯¥é—®é¢˜</p>
<p>è¿™æ¬¡ä½¿ç”¨ etcd <a target="_blank" rel="noopener" href="https://github.com/coreos/etcd">https://github.com/coreos/etcd</a> æ¥ä¸¾ä¸ªä¾‹å­ï¼Œå…³äº pprof çš„ä½¿ç”¨åŠå¯è§†åŒ–ï¼ŒRef ä¸­æåˆ°äº† golang æ€§èƒ½åˆ†æå¤§åé¼é¼çš„å‡ ç¯‡ blogï¼Œå»ºè®®å…ˆè¡Œå‚è€ƒï¼Œçœ‹äº†ä¹‹åä¼šå¯¹ golang æ€§èƒ½åˆ†ææœ‰ä¸ª overall çš„æ€è·¯</p>
<p>æ­¤ç¯‡å¹¶æ— å¤ªå¤š creative ä¹‹å¤„</p>
<h1 id="Show-time"><a href="#Show-time" class="headerlink" title="Show time"></a>Show time</h1><p>ä¹‹å‰æåˆ° golang ä¸­è‡ªå¸¦äº† pprof é‡‡é›†ä»£ç ï¼Œè€Œä¸”å¯ç”¨å®ƒä»¬ä¹Ÿéå¸¸ç®€å•</p>
<p>å¦‚æœæ˜¯ä¸€ä¸ª web server çš„è¯ï¼Œä»…éœ€è¦ import _ â€œnet/http/pprofâ€ï¼Œåˆ™ä¼šæ³¨å†Œ pprof ç›¸å…³çš„ handler</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> _ <span class="string">&quot;net/http/pprof&quot;</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">        log.Println(http.ListenAndServe(<span class="string">&quot;localhost:6060&quot;</span>, <span class="literal">nil</span>))</span><br><span class="line">    &#125;()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>web server å¯åŠ¨åï¼Œå³å¯è°ƒç”¨ pprof æ¥å£è·å–æ•°æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget http://localhost:6060/debug/pprof/profile -O profile-data</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ curl ä¹Ÿè¡Œ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:6060/debug/pprof/profile -o profile-data</span><br></pre></td></tr></table></figure>

<p>å¯¹äº etcd æ¥è¯´ï¼Œpprof ä¹Ÿå·²ç»é›†æˆï¼Œå¯é€šè¿‡å¯åŠ¨å‚æ•°æŒ‡å®šå¼€å¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./etcd --enable-pprof</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶å¯¹äºé web server ç±»çš„ appï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨ runtime/pprof åŒ…ä¸­çš„æ–¹æ³•è¾“å‡º pprof æ•°æ®</p>
<h1 id="go-tool-pprof"><a href="#go-tool-pprof" class="headerlink" title="go tool pprof"></a>go tool pprof</h1><blockquote>
<p>ä»¥ etcd v3.1.9 ä¸ºä¾‹å­, go1.10</p>
</blockquote>
<p>é‡‡æ · 10s cpu profile æ•°æ®</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:2379/debug/pprof/profile?seconds=10 -o etcd-profile-10</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ go tool pprof åˆ†æ</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">bash-3.2$ go tool pprof <span class="variable">$GOPATH</span>/src/github.com/coreos/etcd/bin/etcd etcd-profile-10</span><br><span class="line">File: etcd</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Aug 12, 2018 at 11:45am (CST)</span><br><span class="line">Duration: 10s, Total samples = 40ms (  0.4%)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„ä¼ å…¥å¯¹åº”çš„äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå¦åˆ™å¯èƒ½æ— æ³•æ‰¾åˆ°ç›¸åº”çš„æ–¹æ³•</p>
<p>go tool pprof å¸¸ç”¨å‘½ä»¤ top / listï¼Œå…¶ä¸­ list æ–¹æ³•æ˜¯æ­£åˆ™åŒ¹é…çš„ï¼Œèƒ½æ˜¾ç¤ºåŒ¹é…ä¸Šçš„æ–¹æ³•çš„ profile ä¿¡æ¯</p>
<h1 id="Secure-of-pprof"><a href="#Secure-of-pprof" class="headerlink" title="Secure of pprof"></a>Secure of pprof</h1><p>æ³¨æ„åˆ°ä¹‹å‰å‡ä½¿ç”¨çš„æ˜¯ http çš„ Protocol è®¿é—® pprof æ¥å£ï¼Œå¦‚æœ server æ˜¯ https è¯¥æ€ä¹ˆåŠï¼Ÿ</p>
<p>æœç´¢å¾—çŸ¥ golang å¾ˆå¿«ä¾¿ä¼šæ”¯æŒ go tool pprof with client certificates äº†</p>
<p>cmd/pprof: add HTTPS support with client certificates: <a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/20939">https://github.com/golang/go/issues/20939</a></p>
<p>Support HTTPS certs, keys and CAs: <a target="_blank" rel="noopener" href="https://github.com/google/pprof/pull/261">https://github.com/google/pprof/pull/261</a></p>
<p>å½“ç„¶å¦‚æœ server ä¸è¦æ±‚ client certificates çš„è¯ï¼Œå¯ä»¥å¦‚æ­¤ä½¿ç”¨ go tool pprof è·å–æ•°æ®ï¼ˆæ³¨æ„ https+insecureï¼‰</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go tool pprof -seconds 5 https+insecure://192.168.99.100:32473/debug/pprof/profile</span><br></pre></td></tr></table></figure>

<p>å¦‚æœè¦æ±‚ client certificates çš„è¯ï¼Œäº¦æˆ–æ˜¯æ—¥å¸¸ä½¿ç”¨æ—¶ï¼Œå…¶å®ä¹Ÿæ²¡å¿…è¦ç›´æ¥ç”¨ go tool pprof è·å–æ•°æ®ï¼Œä½¿ç”¨ wget / curl åŒæ ·å¯ä»¥ä¸‹è½½ï¼Œä¸‹è½½ä¹‹åå†ä½¿ç”¨ go tool pprof æˆ–è€…æ˜¯ go-torch åˆ†æå¥½äº†</p>
<p>è€Œ curl æ˜¾ç„¶æ˜¯æ”¯æŒä¼ å…¥ ca.crt / tls.crt / tls.key çš„</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --cacert ca.crt --cert ./tls.crt --key tls.key https://192.168.99.100:32473/debug/pprof/profile -O profile-data</span><br></pre></td></tr></table></figure>

<h1 id="Visual-pprof"><a href="#Visual-pprof" class="headerlink" title="Visual pprof"></a>Visual pprof</h1><p>go tool pprof å‘½ä»¤è¡Œæ¨¡å¼ï¼Œå¹¶ä¸æ˜¯ç‰¹åˆ«ç›´è§‚ï¼Œå¦‚æœå¯ä»¥å›¾å½¢åŒ–çš„å±•ç¤ºå„ä¸ªæ–¹æ³•çš„æ¶ˆè€—æƒ…å†µï¼Œé‚£ä¹ˆå°†èƒ½æ›´å¿«çš„ç¡®å®šé—®é¢˜æ‰€åœ¨</p>
<ul>
<li>graphviz</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">brew install graphviz</span><br></pre></td></tr></table></figure>

<p>å®‰è£… ok graphviz ä¹‹å</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">bash-3.2$ go tool pprof <span class="variable">$GOPATH</span>/src/github.com/coreos/etcd/bin/etcd etcd-profile-10</span><br><span class="line">File: etcd</span><br><span class="line">Type: cpu</span><br><span class="line">Time: Aug 12, 2018 at 11:45am (CST)</span><br><span class="line">Duration: 10s, Total samples = 40ms (  0.4%)</span><br><span class="line">Entering interactive mode (<span class="built_in">type</span> <span class="string">&quot;help&quot;</span> <span class="keyword">for</span> commands, <span class="string">&quot;o&quot;</span> <span class="keyword">for</span> options)</span><br><span class="line">(pprof) web</span><br></pre></td></tr></table></figure>

<p>å³å¯åœ¨æµè§ˆå™¨ä¸­æ˜¾ç¤º .svg æ–‡ä»¶ï¼Œæµè§ˆå™¨ä¸­ Ctrl+s ä¿å­˜åˆ°æœ¬åœ°ï¼Œå³å¯ä¼ é˜…</p>
<p><img src="/images/web-pprof.svg" alt="web-pprof"></p>
<ul>
<li>go-torch</li>
</ul>
<p>å¤§åé¼é¼çš„ç«ç„°å›¾ (flame-graph)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go get github.com/uber/go-torch</span><br></pre></td></tr></table></figure>

<p>clone brandangregg çš„ç«ç„°å›¾ç”Ÿæˆè„šæœ¬</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git clone git@github.com:brendangregg/FlameGraph.git</span><br></pre></td></tr></table></figure>

<p>ç”Ÿæˆç«ç„°å›¾</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bash-3.2$ <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$GOPATH</span>/src/github.com/brendangregg/FlameGraph</span><br><span class="line">bash-3.2$</span><br><span class="line">bash-3.2$ <span class="variable">$GOPATH</span>/bin/go-torch --file <span class="string">&quot;torch.svg&quot;</span> etcd-profile-10</span><br><span class="line">INFO[13:12:17] Run pprof <span class="built_in">command</span>: go tool pprof -raw -seconds 30 etcd-profile-10</span><br><span class="line">INFO[13:12:17] Writing svg to torch.svg</span><br></pre></td></tr></table></figure>

<p>æµè§ˆå™¨æ‰“å¼€ torch.svg å³å¯</p>
<p><img src="/images/torch.svg" alt="torch"></p>
<p>ä¸ªäººè§‰å¾— flame-graph æ›´ä¸ºç›´è§‚ï¼Œæ¨ªå‘ä¸ºå„ä¸ªæ–¹æ³•æ¶ˆè€—å æ¯”ï¼Œçºµå‘ä¸ºè°ƒç”¨æ ˆä¸Šçš„å„ä¸ªæ–¹æ³•æ¶ˆè€—å æ¯”ï¼Œä¸€ç›®äº†ç„¶ï¼Œå¯¹åº”åˆ†ææ¶ˆè€—è¾ƒå¤§çš„æ–¹æ³•å³å¯</p>
<h1 id="Ref"><a href="#Ref" class="headerlink" title="Ref"></a>Ref</h1><p>golang pprof <a target="_blank" rel="noopener" href="https://blog.golang.org/profiling-go-programs">https://blog.golang.org/profiling-go-programs</a></p>
<p>pprof tools <a target="_blank" rel="noopener" href="http://colobu.com/2017/03/02/a-short-survey-of-golang-pprof/">http://colobu.com/2017/03/02/a-short-survey-of-golang-pprof/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/d41c4586.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/d41c4586.html" class="post-title-link" itemprop="url">Memory of Tomcat</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-08-07 15:27:27" itemprop="dateCreated datePublished" datetime="2018-08-07T15:27:27Z">2018-08-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 07:29:08" itemprop="dateModified" datetime="2020-11-22T07:29:08Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>201</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="top"><a href="#top" class="headerlink" title="top"></a>top</h1><p>top æŒ‰ CPU æ’åº</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line"><span class="built_in">shift</span> + P</span><br></pre></td></tr></table></figure>

<p>top æŒ‰ MEM æ’åº</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">top</span><br><span class="line"><span class="built_in">shift</span> + M</span><br></pre></td></tr></table></figure>

<h1 id="java-utils"><a href="#java-utils" class="headerlink" title="java utils"></a>java utils</h1><p>ä¸º jdk è®¾ç½® JAVA_HOME<br>è®¾ç½® jdk bin è‡³ PATH ä¸­</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// æŸ¥çœ‹ java è¿›ç¨‹å †åŠ GC æƒ…å†µ</span><br><span class="line">jstat</span><br><span class="line">// æŸ¥çœ‹ java è¿›ç¨‹ä¸­çš„çº¿ç¨‹æƒ…å†µ</span><br><span class="line">jstack</span><br></pre></td></tr></table></figure>

<p>æœ€åä¸€é¡¿æ’æŸ¥ï¼Œjstat æŸ¥çœ‹äº†å †å†…å­˜æƒ…å†µï¼Œå‘ç°æ˜¯ tomcat å¯åŠ¨å‚æ•° <code>-Xms -Xmx</code> è®¾ç½®è¿‡å¤§äº†ï¼ŒåŒä¸€èŠ‚ç‚¹ä¸Šè¿˜æœ‰å…¶ä»–è¿›ç¨‹ï¼Œå…¶ä»–è¿›ç¨‹å ç”¨å†…å­˜æ¯”è¾ƒçŒ›</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/3d08d23a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/3d08d23a.html" class="post-title-link" itemprop="url">WebSocket in Tomcat 7 (part 5)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-07-15 11:24:39" itemprop="dateCreated datePublished" datetime="2018-07-15T11:24:39Z">2018-07-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-12-12 07:12:41" itemprop="dateModified" datetime="2020-12-12T07:12:41Z">2020-12-12</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>2.4k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>2 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Final, cheers !~</p>
<p>é€šè¿‡ part-1/2/3/4 çš„åˆ†æï¼Œå¯ä»¥ç¡®è®¤ Server è¿™è¾¹çš„é€»è¾‘ okï¼Œé‚£ä¹ˆç°åœ¨çš„ç¡®è®¤é—®é¢˜çš„æ‰‹æ®µåªèƒ½æ²¿ç€ç½‘ç»œè·¯å¾„é€çº§æŠ“åŒ…äº†ã€‚æ­¤ç¯‡é‡ç‚¹è®²è¿°å¦‚ä½•åœ¨ Wireshark <a target="_blank" rel="noopener" href="https://www.wireshark.org/download.html">https://www.wireshark.org/download.html</a> ä¸­åˆ†æ WebSocket æµé‡</p>
<p>å½“ç„¶ç½‘ä¸Šæœ‰æŒºå¤šä»‹ç»ï¼Œè¿™é‡Œè¿˜æ˜¯å†è¯´ä¸€éï¼Œæ˜¯ä¸ºå•¥ï¼Ÿå› ä¸ºå…¶ä»–æ–‡ç« å¤§å¤šæ•°éƒ½æ˜¯è®²è§£çš„ ws:// çš„ï¼Œè€Œç°åœ¨æˆ‘ä»¬é¢ä¸´çš„æ˜¯ wss:// çš„ï¼Œæ˜¾ç„¶æœ‰å¾ˆå¤§çš„ä¸åŒ</p>
<p>æ‰€ä»¥å‘¢ï¼Œç®€å•åœ¨ display filter ä¸­è¾“å…¥ websocket æ˜¯æ²¡æ³•è¿‡æ»¤å‡º WebSocket æµé‡çš„ï¼Œæ¯•ç«Ÿ TLS encrypted ä¹‹åçœ‹åˆ°çš„å…¨æ˜¯ TCP æµé‡</p>
<h1 id="ENV"><a href="#ENV" class="headerlink" title="ENV"></a>ENV</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Wireshark: 2.6.1</span><br><span class="line">OS: macOS Sierra 10.12.6</span><br><span class="line">WebSocketSite: https://www.websocket.org/echo.html</span><br></pre></td></tr></table></figure>

<h1 id="SSL-decryted-in-WireShark"><a href="#SSL-decryted-in-WireShark" class="headerlink" title="SSL decryted in WireShark"></a>SSL decryted in WireShark</h1><p>official docï¼š<a target="_blank" rel="noopener" href="https://wiki.wireshark.org/SSL#Usingthe.28Pre.29-Master-Secret">https://wiki.wireshark.org/SSL#Usingthe.28Pre.29-Master-Secret</a></p>
<p>step by step guide: <a target="_blank" rel="noopener" href="https://jimshaver.net/2015/02/11/decrypting-tls-browser-traffic-with-wireshark-the-easy-way/">https://jimshaver.net/2015/02/11/decrypting-tls-browser-traffic-with-wireshark-the-easy-way/</a></p>
<p>ç…§ç€é“¾æ¥äºŒé…ç½®ä¸€ä¸‹å³å¯</p>
<h1 id="Capture-network-trafic-through-WireShark"><a href="#Capture-network-trafic-through-WireShark" class="headerlink" title="Capture network trafic through WireShark"></a>Capture network trafic through WireShark</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export SSLKEYLOGFILE=/Users/zrss/Documents/BrowserSSLKeyLog/sslkeylog.log</span><br><span class="line">open -a &quot;Google Chrome&quot;</span><br><span class="line">wireshark</span><br></pre></td></tr></table></figure>

<p>è®¿é—® <a target="_blank" rel="noopener" href="https://www.websocket.org/echo.html%EF%BC%8Cloading">https://www.websocket.org/echo.htmlï¼Œloading</a> ok ä¹‹å</p>
<p>å¼€å¯ Wireshark æ•è·å½“å‰ç½‘å¡æµé‡</p>
<p>å•å‡» Connect è¿æ¥ Server WebSocketï¼Œè¿æ¥å»ºç«‹åï¼Œå‘é€ Rock it with HTML5 WebSocket æ¶ˆæ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="/images/websocket-echo.png" alt="echo WebSocket"></p>
<p>åœæ­¢ Wireshark æ•è·ï¼Œdisplay filter ä¸­è¾“å…¥ httpï¼Œå¯»æ‰¾åˆ° info ä¸­æœ‰ 101 Web Socket Protocol Handshake å­—æ ·çš„æŠ¥æ–‡ï¼Œå³é”® Follow é€‰ä¸­ SSL Stream å³å¯æŸ¥çœ‹ WebSocket çš„æµé‡ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º</p>
<p><img src="/images/websocket-link.png" alt="websocket traffic"></p>
<p>å¯è§ WebSocket ä¸º TCP ä¹‹ä¸Šä¸ HTTP åŒå±‚çš„åº”ç”¨å±‚åè®®</p>
<ul>
<li>TCP ä¸‰æ¬¡æ¡æ‰‹å»ºç«‹ TCP è¿æ¥</li>
<li>SSL æ¡æ‰‹åå•†åŠ å¯†æœºåˆ¶</li>
<li>WebSocket æ¡æ‰‹ (HTTP Upgrade) å»ºç«‹ WebSocket è¿æ¥</li>
<li>å®¢æˆ·ç«¯ send MASKED WebSocket ä¸Šè¡ŒæŠ¥æ–‡</li>
<li>æœåŠ¡ç«¯ echo WebSocket ä¸‹è¡ŒæŠ¥æ–‡</li>
</ul>
<p>å¦å¤–éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ SSL æ¡æ‰‹åå•†åŠ å¯†æœºåˆ¶æ—¶ï¼ŒæœåŠ¡å™¨ç«¯é€‰æ‹©çš„åŠ å¯†å¥—ä»¶ä¸º TLS_RSA_WITH_AES_128_CBC_SHA (åœ¨ Server Hello æŠ¥æ–‡ä¸­å¯è§)</p>
<p>ä¸ºå•¥æåˆ°è¿™ä¸ªç®—æ³•ï¼Œå› ä¸ºåœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œä¸€å¼€å§‹æ˜¯ä½¿ç”¨ <a target="_blank" rel="noopener" href="https://socket.io/demos/chat/">https://socket.io/demos/chat/</a> æµ‹è¯•çš„ï¼Œä» Chrome F12 æ§åˆ¶å°ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸¤ä¸ª WebSocket è¯·æ±‚ï¼Œç„¶è€Œ Wireshark ä¼¼ä¹åªèƒ½ decrypt å…¶ä¸­ä¸€ä¸ªè¯·æ±‚ï¼Œè€Œè¯¥è¯·æ±‚æœåŠ¡å™¨ç«¯é€‰æ‹©çš„åŠ å¯†å¥—ä»¶ä¸º TLS_AES_128_GCM_SHA256</p>
<p>å¦å¤–ä¸€ä¸ªè¯·æ±‚ (å®é™…ä¸Šçš„ chat è¯·æ±‚) æœªèƒ½ decryptï¼Œå‘ƒï¼Œä¸è¿‡ä¸çŸ¥é“ä¸ºå•¥ï¼Œåå¤å°è¯•äº†å‡ æ¬¡åï¼Œå•¥éƒ½ decrypt ä¸äº†äº†</p>
<h1 id="Best-Practice"><a href="#Best-Practice" class="headerlink" title="Best Practice"></a>Best Practice</h1><p>æ‰€ä»¥è¿™ä¸ª decrypt å®é™…ä¸Šä¸ä¸€å®šé è°±ï¼Œä¸»è¦è¿˜æ˜¯éœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒä¸Šä½¿ç”¨ tcpdump å·¥å…·æŠ“å–æ¥è‡ªç‰¹å®šæº IP çš„æµé‡ï¼Œç„¶åé€šè¿‡ä¸æ­£å¸¸æƒ…å†µä¸‹çš„æµé‡ç›¸æ¯”ï¼Œè¯†åˆ«å‡ºä¸º WebSocket çš„æµé‡ï¼Œé€çº§æ’æŸ¥ï¼Œæ‰¾åˆ°åœ¨å“ªä¸€çº§ç»„ä»¶ä¸Š WebSocket æŠ¥æ–‡ä¸¢æ‰å³å¯</p>
<p>æ³¨æ„åˆ° WebSocket RFC <a target="_blank" rel="noopener" href="https://tools.ietf.org/html/rfc6455">https://tools.ietf.org/html/rfc6455</a> ä¸­æåˆ°æ¯ä¸ª WebSocket è¯·æ±‚å‡è¦æ±‚å»ºç«‹ä¸€ä¸ªè¿æ¥ï¼Œå¦å¤–ä» Tomcat 7 WebSocket å®ç°ä¸Šï¼Œå¯çŸ¥æ¯ä¸ª WebSocket è¿æ¥å‡ä¼šå»ºç«‹ä¸€ä¸ªæ–°çš„ socket è¿æ¥</p>
<p>å› æ­¤åœ¨ Wireshark ä¸­é¦–å…ˆè¿‡æ»¤å‡º SSL çš„ Client Hello æŠ¥æ–‡</p>
<p>å†é€šè¿‡ Client Hello æŠ¥æ–‡ä¸­çš„ srcport å­—æ®µè¿‡æ»¤æŠ¥æ–‡ (æˆ–è€…å³é”® Follow -&gt; SSL Stream)ï¼Œæ­£å¸¸çš„ WebSocket æŠ¥æ–‡æ¨¡å¼ï¼Œå¦‚ä¸‹</p>
<ul>
<li>SSL Handshake</li>
<li>HTTP Upgrade</li>
<li>HTTP Continuation</li>
</ul>
<p>å½“ç„¶éœ€è¦å®¢æˆ·ç«¯æ„é€ å®¹æ˜“è¯†åˆ«çš„ WebSocket æµé‡æ¨¡å¼ï¼Œæˆ‘åœ¨æµ‹è¯•æ—¶ï¼Œä¸€èˆ¬ä¼šæŒç»­è¾“å…¥æŸä¸ªå­—ç¬¦ï¼Œå› æ­¤ä¼šæœ‰æŒç»­çš„ HTTP Continuation æŠ¥æ–‡</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>WebSocket åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ï¼Œæœ€å¥½ä¸å¤ç”¨ HTTPS 443 ç«¯å£ï¼Œå³ WebSocket ä½¿ç”¨ç‹¬ç«‹çš„ç½‘ç»œæ¶æ„ï¼Œä¸å¤ç”¨ä¹‹å‰ HTTP çš„ç½‘ç»œæ¶æ„ã€‚æ¯•ç«Ÿ HTTP çš„ç½‘ç»œè·¯å¾„ï¼Œä¸€è·¯ä¸Šæœ‰å„ç§é˜²ç«å¢™ï¼Œå¯å¾—å°å¿ƒäº†</p>
<p>å¦å¤–è¿˜å‘ç°äº†ä¸€ä¸ªæœ‰è¶£çš„é¡¹ç›® noVNC <a target="_blank" rel="noopener" href="https://github.com/novnc/noVNC%EF%BC%8C%E6%8F%90%E4%BE%9B%E4%BA%86%E5%9C%A8%E7%95%8C%E9%9D%A2%E4%B8%8A%E8%BF%9C%E7%A8%8B%E7%99%BB%E5%BD%95%E4%B8%BB%E6%9C%BA%E7%9A%84%E5%8A%9F%E8%83%BD%EF%BC%8C%E8%80%8C%E6%88%91%E4%BB%AC%E7%9F%A5%E9%81%93%E5%A4%A7%E5%A4%9A%E6%95%B0">https://github.com/novnc/noVNCï¼Œæä¾›äº†åœ¨ç•Œé¢ä¸Šè¿œç¨‹ç™»å½•ä¸»æœºçš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬çŸ¥é“å¤§å¤šæ•°</a> VNC Server ä¹Ÿæ”¯æŒ WebSocket åè®®ï¼Œå› æ­¤ noVNC ä¹Ÿä½¿ç”¨äº† WebSocket åè®®ä¼ è¾“æ•°æ®ï¼Œè¦ä¸æ”¯æŒçš„ Serverï¼ŒnoVNC æœ‰ä¸€ä¸ªå­é¡¹ç›®ï¼šwebsockify <a target="_blank" rel="noopener" href="https://github.com/novnc/websockify%EF%BC%8C%E5%B0%86">https://github.com/novnc/websockifyï¼Œå°†</a> WebSocket æµé‡è½¬ä¸º Socket æµé‡ï¼Œä»¥å…¼å®¹ä¸æ”¯æŒ WebSocket åè®®çš„ VNC Serverï¼Œæœ‰æ—¶é—´å†ç ”ç©¶ä¸€ä¸‹äº†</p>
<p>The end of WebSocket in Tomcat 7 series</p>
<h1 id="Other-Ref"><a href="#Other-Ref" class="headerlink" title="Other Ref"></a>Other Ref</h1><p><a target="_blank" rel="noopener" href="http://jsslkeylog.sourceforge.net/">http://jsslkeylog.sourceforge.net/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/2413e37b.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/2413e37b.html" class="post-title-link" itemprop="url">WebSocket in Tomcat 7 (part 4)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-07-08 11:21:05" itemprop="dateCreated datePublished" datetime="2018-07-08T11:21:05Z">2018-07-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-12-06 03:23:08" itemprop="dateModified" datetime="2020-12-06T03:23:08Z">2020-12-06</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>3 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ç°åœ¨æˆ‘ä»¬çŸ¥é“ Server ç«¯ä¼šé¦–å…ˆè¿›å…¥ onOpen çŠ¶æ€ï¼Œéšåä¼šæŒç»­ä» socket ä¸­è·å– WebSocket Frame ç»„è£…æˆ Message åï¼Œå›è°ƒä¸šåŠ¡å±‚ onMessage æ–¹æ³•</p>
<p>è€Œ Client ç«¯åœ¨æ¥æ”¶åˆ° 101 status code ä¹‹åï¼Œä¹Ÿä¼šè¿›å…¥ onOpen çŠ¶æ€ï¼Œå…¸å‹çš„ Client ç«¯å®ç°å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create WebSocket connection.</span></span><br><span class="line"><span class="keyword">const</span> socket = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;wss://remoteAddress:443&#x27;</span>);</span><br><span class="line"><span class="comment">// Connection opened</span></span><br><span class="line">socket.addEventListener(<span class="string">&#x27;open&#x27;</span>, function (event) &#123;</span><br><span class="line">    socket.send(<span class="string">&#x27;Hello Server!&#x27;</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// Listen for messages</span></span><br><span class="line">socket.addEventListener(<span class="string">&#x27;message&#x27;</span>, function (event) &#123;</span><br><span class="line">    console.log(<span class="string">&#x27;Message from server &#x27;</span>, event.data);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Web/API/WebSocket">https://developer.mozilla.org/en-US/docs/Web/API/WebSocket</a></p>
<p>è€Œæˆ‘é‡åˆ°çš„é—®é¢˜æ˜¯ï¼Œweb terminal ä¸€èˆ¬å®ç°ï¼Œä¼šåœ¨ onOpen ä¸­å‘é€ä¸€ä¸ªè®¾ç½® terminal size çš„ messageï¼Œä¾‹å¦‚ k8s ä¸­å¯ä»¥å‘é€å¦‚ä¸‹æ¶ˆæ¯</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Connection opened</span></span><br><span class="line">socket.addEventListener(<span class="string">&#x27;open&#x27;</span>, <span class="function"><span class="keyword">function</span> (<span class="params">event</span>) </span>&#123;</span><br><span class="line">    socket.send(<span class="string">&#x27;4&#123;&quot;Width&quot;:80,&quot;Height&quot;:20&#125;&#x27;</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>è¯¥æ¶ˆæ¯ä¸èƒ½è¢«ç«‹å³å‘é€ï¼Œè‹¥ç«‹å³å‘é€ï¼Œåˆ™ä¼šå¯¼è‡´ Tomcat side ServerEndpoint onMessage ä¸€ç›´æœªè¢«è°ƒç”¨</p>
<p>è€Œåç«¯ k8s side çš„æ•°æ®èƒ½æ¨é€è‡³ Client sideï¼Œå…·ä½“æ¥è¯´ Client side èƒ½æ¥æ”¶åˆ° k8s side æ¨é€å›æ¥çš„åˆå§‹åŒ–ç©ºæ•°æ®ï¼Œè€Œ Client side å‘é€çš„æ•°æ®å¸§ ServerEndpoint onMessage ä¸€ç›´æœªè¢«è°ƒç”¨</p>
<p>è¯´æ˜ WebSocket é“¾æ¥æ˜¯æ²¡é—®é¢˜çš„ï¼Œäºæ˜¯ä¹ Client å‘é€çš„æ•°æ®å¸§è¢«å‘é€åˆ°äº†å“ªé‡Œï¼Ÿ</p>
<p>ä¹‹å‰çš„å‡ ç¯‡è®¨è®ºä¸­ï¼Œå…¶å®æˆ‘æ˜¯åˆ¤å®šå¦‚æœ ServerEndpoint onOpen stuck ä½ï¼Œä¼šå‡ºç°è¯¥é—®é¢˜ã€‚ç„¶è€Œå®é™…æƒ…å†µå¯ä»¥è¯´æ˜ï¼Œæ—¢ç„¶åç«¯çš„æ•°æ®å¯ä»¥æ¨é€è‡³å®¢æˆ·ç«¯ï¼Œè¯æ˜ onOpen å·²ç»æ‰§è¡Œç»“æŸ</p>
<p>ServerEndpoint onOpen æ—¶æ‰§è¡Œçš„é€»è¾‘å¦‚ä¸‹</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> hashmap frontEndWsSessionMap;</span><br><span class="line"><span class="keyword">static</span> hashmap backEndWsSessionMap;</span><br><span class="line">onOpen(session) &#123;</span><br><span class="line">    wsBackEndSession = connectToBackEnd(...);</span><br><span class="line">    backEndWsSessionMap.put(wsBackEndSession.getId(), session);</span><br><span class="line">    frontEndWsSessionMap.put(session.getId(), wsBackEndSession);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œé€šè¿‡æŸ¥çœ‹ä»£ç çŸ¥é“ connectToBackEndï¼Œå³ Server side å®ç° WebSocket è¯·æ±‚æ—¶ï¼Œç”¨äº†ä¸¤ä¸ªæ–°çš„çº¿ç¨‹ï¼Œå…¶ä¸­ä¸€ä¸ªç”¨äºæ¥æ”¶æ•°æ®ï¼Œå¦ä¸€ä¸ªç”¨äºè·å–æ•°æ®</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Switch to WebSocket</span></span><br><span class="line">WsRemoteEndpointImplClient wsRemoteEndpointClient = <span class="keyword">new</span> WsRemoteEndpointImplClient(channel);</span><br><span class="line">WsSession wsSession = <span class="keyword">new</span> WsSession(endpoint, wsRemoteEndpointClient,</span><br><span class="line">        <span class="keyword">this</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, extensionsAgreed,</span><br><span class="line">        subProtocol, Collections.&lt;String,String&gt;emptyMap(), secure,</span><br><span class="line">        clientEndpointConfiguration);</span><br><span class="line">WsFrameClient wsFrameClient = <span class="keyword">new</span> WsFrameClient(response, channel,</span><br><span class="line">        wsSession, transformation);</span><br><span class="line"><span class="comment">// WsFrame adds the necessary final transformations. Copy the</span></span><br><span class="line"><span class="comment">// completed transformation chain to the remote end point.</span></span><br><span class="line">wsRemoteEndpointClient.setTransformation(wsFrameClient.getTransformation());</span><br><span class="line">endpoint.onOpen(wsSession, clientEndpointConfiguration);</span><br><span class="line">registerSession(endpoint, wsSession);</span><br><span class="line"><span class="comment">/* It is possible that the server sent one or more messages as soon as</span></span><br><span class="line"><span class="comment"> * the WebSocket connection was established. Depending on the exact</span></span><br><span class="line"><span class="comment"> * timing of when those messages were sent they could be sat in the</span></span><br><span class="line"><span class="comment"> * input buffer waiting to be read and will not trigger a &quot;data</span></span><br><span class="line"><span class="comment"> * available to read&quot; event. Therefore, it is necessary to process the</span></span><br><span class="line"><span class="comment"> * input buffer here. Note that this happens on the current thread which</span></span><br><span class="line"><span class="comment"> * means that this thread will be used for any onMessage notifications.</span></span><br><span class="line"><span class="comment"> * This is a special case. Subsequent &quot;data available to read&quot; events</span></span><br><span class="line"><span class="comment"> * will be handled by threads from the AsyncChannelGroup&#x27;s executor.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">wsFrameClient.startInputProcessing();</span><br></pre></td></tr></table></figure>

<p>é“¾æ¥å»ºç«‹ä¹‹åï¼Œä¼šç«‹å³è°ƒç”¨ wsFrameClient.startInputProcessing(); å¤„ç†å½“å‰ response ä¸­çš„æ•°æ®ï¼Œå³è°ƒç”¨ ClientEndpoint onMessage æ–¹æ³•</p>
<p>åç»­çš„æ•°æ®å¤„ç†ç”±çº¿ç¨‹æ± ä¸­çš„è¯»çº¿ç¨‹å®Œæˆ</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">onMessage(String message, session) &#123;</span><br><span class="line">    frontEndSession = backEndWsSessionMap.get(session.getId());</span><br><span class="line">    frontEndSession.getBasicRemote.sendText(message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¤§è‡´æµç¨‹ä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œä» socketOutput ä¸­æŒç»­è·å–æ•°æ®ï¼Œç»„è£… okay ä¹‹åï¼Œå›è°ƒ ClientEndpoint onMessage æ–¹æ³•</p>
<p>ç»¼ä¸Šï¼Œä¸Šè¿°é€»è¾‘ okayï¼Œå¹¶ä¸æ˜¯åœ¨ onOpen ä¸­ stuck</p>
<p>è‡³æ­¤ä¸é—®é¢˜ç°è±¡å¯¹æ¯”ä¹‹åï¼Œå¯ä»¥è®¤ä¸ºå¦‚æœé—®é¢˜å‡ºç° Tomcat ä¾§ï¼Œåˆ™ä»…å¯èƒ½ä¸º onDataAvailable ä¹‹åï¼Œä¸€ç›´æœªèƒ½ä» socketInputStream ä¸­è·å–åˆ°æ•°æ®</p>
<p>å¦‚æœå¯ä»¥æŠ“åŒ…åˆ†æçš„è¯ï¼ŒæŠ“åŒ…æœ€ä¸ºç®€å•ï¼Œä¹‹æ‰€ä»¥è´¹è¿™ä¹ˆå¤§åŠ²å„¿åˆ†æ Tomcat WebSocket çš„å®ç°ï¼Œå®é™…ä¸Šæ˜¯å› ä¸ºå…¨æ˜¯ TLS æµé‡ï¼Œso æŠ“åˆ°çš„å…¨æ˜¯ tcp åŒ…ï¼Œæ ¹æœ¬æ²¡æ³•åŒºåˆ†</p>
<p>å°è¯•è¿‡å¯¼å…¥ Nginx çš„ç§é’¥ï¼Œä¹Ÿæ²¡æ³•è§£ï¼Œå¬ Nginx çš„åŒäº‹è¯´æ˜¯ Nginx ä¸ Server ä¹‹é—´è¿˜ä¼šåŠ¨æ€åå•†ä¸€ä¸ªç§é’¥ â€¦ é†‰äº†</p>
<p>å¦‚æœèƒ½ç¡®å®š Client çš„ WebSocket åŒ…éƒ½å‘é€åˆ°è¾¾ Tomcat äº†ï¼Œè¿™ä¹Ÿå¯ä»¥ç¡®è®¤æ˜¯ Server side çš„é—®é¢˜ï¼Œç„¶é¹…</p>
<p>ç»æœ› â€¦ so sad</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/6b5275bc.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/6b5275bc.html" class="post-title-link" itemprop="url">WebSocket in Tomcat 7 (part 3)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-07-08 11:09:28" itemprop="dateCreated datePublished" datetime="2018-07-08T11:09:28Z">2018-07-08</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-12-06 03:13:48" itemprop="dateModified" datetime="2020-12-06T03:13:48Z">2020-12-06</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>4 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>å›ç­”ä¸Šç¯‡æœ«å°¾çš„è°ƒç”¨æ—¶åºé—®é¢˜</p>
<p>Tomcat 7 é»˜è®¤ä½¿ç”¨ BIO Http11Protocol</p>
<p>æ³¨æ„åˆ°åœ¨ Http11Protocol çš„ process æ–¹æ³•ä¸­ï¼ˆAbstractProtocolï¼‰æœ‰å¦‚ä¸‹é€»è¾‘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (processor.isUpgrade()) &#123;</span><br><span class="line">        <span class="comment">// Init WebSocket OPEN_READ processor httpUpgradeHandler is null</span></span><br><span class="line">        <span class="comment">// And when the second round came, upgradeDispatch will dispatch OPEN_READ status</span></span><br><span class="line">        <span class="comment">// ha, upgradeServletInputStream.onDataAvailable() will be called</span></span><br><span class="line">        state = processor.upgradeDispatch(status);</span><br><span class="line">        <span class="comment">// but, pay attention to that fact</span></span><br><span class="line">        <span class="comment">// WsFrameServer.onDataAvailable is a for loop so it will remain in it</span></span><br><span class="line">        <span class="comment">// that&#x27;s the reason why we can&#x27;t see the state of Upgraded return</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Init WebSocket OPEN_READ will go through here</span></span><br><span class="line">        state = processor.process(wrapper);</span><br><span class="line">        <span class="comment">// Finally adapter.service(request, response) will be called in processor.process</span></span><br><span class="line">        <span class="comment">// then the request will go through filter</span></span><br><span class="line">        <span class="comment">// Once it arrives the WsFilter</span></span><br><span class="line">        <span class="comment">// and it will call upgrade method with a WsHttpUpgradeHandler in WsFilter</span></span><br><span class="line">        <span class="comment">// That will instance a WsHttpUpgradeHandler and call action Upgrade hook</span></span><br><span class="line">        <span class="comment">// That&#x27;s the time httpUpgradeHandler be set to WsHttpUpgradeHandler and no more null value</span></span><br><span class="line">        <span class="comment">// So isUpgrade() return true and state will become</span></span><br><span class="line">        <span class="comment">// SocketState.UPGRADING</span></span><br><span class="line">        <span class="comment">// And it will create a new processor named upgradeProcessor to replace previous processor</span></span><br><span class="line">        <span class="comment">// in the state of SocketState.UPGRADING in following code</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (getLog().isDebugEnabled()) &#123;</span><br><span class="line">        getLog().debug(<span class="string">&quot;Socket: [&quot;</span> + wrapper +</span><br><span class="line">                <span class="string">&quot;], Status in: [&quot;</span> + status +</span><br><span class="line">                <span class="string">&quot;], State out: [&quot;</span> + state + <span class="string">&quot;]&quot;</span>);</span><br><span class="line">        <span class="comment">// it means that if it is a WebSocket Request</span></span><br><span class="line">        <span class="comment">// it turns out to be once debug info</span></span><br><span class="line">        <span class="comment">// Status in: OPEN_READ, State out: UPGRADING</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (state == SocketState.UPGRADING);</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">if</span> (state == SocketState.UPGRADING) &#123;</span><br><span class="line">    <span class="comment">// Get the HTTP upgrade handler</span></span><br><span class="line">    HttpUpgradeHandler httpUpgradeHandler =</span><br><span class="line">            processor.getHttpUpgradeHandler();</span><br><span class="line">    <span class="comment">// Release the Http11 processor to be re-used</span></span><br><span class="line">    release(wrapper, processor, <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">    <span class="comment">// Create the upgrade processor</span></span><br><span class="line">    processor = createUpgradeProcessor(</span><br><span class="line">            wrapper, httpUpgradeHandler);</span><br><span class="line">    <span class="comment">// Mark the connection as upgraded</span></span><br><span class="line">    wrapper.setUpgraded(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// Associate with the processor with the connection</span></span><br><span class="line">    connections.put(socket, processor);</span><br><span class="line">    <span class="comment">// Initialise the upgrade handler (which may trigger</span></span><br><span class="line">    <span class="comment">// some IO using the new protocol which is why the lines</span></span><br><span class="line">    <span class="comment">// above are necessary)</span></span><br><span class="line">    <span class="comment">// This cast should be safe. If it fails the error</span></span><br><span class="line">    <span class="comment">// handling for the surrounding try/catch will deal with</span></span><br><span class="line">    <span class="comment">// it.</span></span><br><span class="line">    httpUpgradeHandler.init((WebConnection) processor);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥ Tomcat 7 WebSocket å®ç°ä¸Šçš„æ—¶åºæ˜¯æ­£ç¡®çš„ï¼Œå¤§è‡´çš„è¯·æ±‚å¤„ç†æµç¨‹å¦‚ä¸‹</p>
<ul>
<li>Client ä¸ OS ç‰¹å®šç«¯å£å»ºç«‹ Connection â€¦</li>
<li>Http11Protocol.process è¢«è°ƒç”¨ï¼Œä¼ å…¥ OPEN_READ status</li>
<li>processor.process(wrapper) è¢«è°ƒç”¨</li>
<li>WsFilter è¢«è°ƒç”¨ï¼Œå‘ç°ä¸º HTTP Upgrade to websocket requestï¼Œè®¾ç½® httpUpgradeHandler ä¸º WsHttpUpgradeHandler</li>
<li>processor.process(wrapper) è¿”å› UPGRADING state</li>
<li>Http11Protocol.process åˆ›å»ºæ–°çš„ upgradeProcessor ä»¥ä»£æ›¿ä¹‹å‰çš„ processor</li>
<li>è°ƒç”¨ WsHttpUpgradeHandler.init æ–¹æ³•</li>
<li>init æ–¹æ³•æ‰§è¡Œ<ul>
<li>åœ¨ sos ä¸Šæ³¨å†Œ WsWriteListener æ–¹æ³•</li>
<li>è°ƒç”¨ onOpen æ–¹æ³•</li>
<li>åœ¨ sis ä¸Šæ³¨å†Œ WsReadListener æ–¹æ³•</li>
</ul>
</li>
<li>status ä»ç„¶ä¸º OPEN_READ</li>
<li>processor.upgradeDispatch(status) è¢«è°ƒç”¨ï¼Œfor loop socketInputStream</li>
</ul>
<p>ä¸Šè¿°è¿‡ç¨‹å‡åœ¨åŒä¸€çº¿ç¨‹ä¸­æ‰§è¡Œï¼ŒTomcat 7 Http11Protocol å®ç°çš„æ˜¯ç®€å•çš„å¤„ç†æ¨¡å‹ï¼ŒAcceptor è·å– socketï¼Œå½“æœ‰æ–°çš„ socket è¿æ¥æ—¶ï¼Œä½¿ç”¨ä¸€ä¸ªæ–°çº¿ç¨‹å»å¤„ç†ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å¯ä»¥ç»™å‡º WebSocket ServerEndpoint çš„ç²¾ç¡®æ—¶åºäº†</p>
<ul>
<li>SocketState OPEN_READ å ServerEndpoint onOpen è¢«è°ƒç”¨</li>
<li>WsFrameServer onDataAvailable è¢«è°ƒç”¨</li>
<li>onDataAvailable ç»„è£…å¥½ Message å ServerEndpoint onMessage è¢«è°ƒç”¨</li>
</ul>
<p>å› æ­¤å³ä½¿ onOpen æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œæ•°æ®ä¹Ÿåªæ˜¯è¢«ç´¯ç§¯åœ¨ socket è¾“å…¥ç¼“å†²åŒºä¸­ï¼Œä¸€æ—¦æ‰§è¡Œç»“æŸåï¼Œä¾ç„¶èƒ½è§¦å‘ onDataAvailableï¼Œä»è€Œå›è°ƒ ServerEndpoint onMessage</p>
<p>å¦ä¸€æ–¹é¢ä¹Ÿè¯´æ˜äº†ï¼ŒonOpen é¦–å…ˆè¢«æ‰§è¡Œï¼ŒonMessage å…¶æ¬¡è¢«æ‰§è¡Œçš„æ—¶åº</p>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ WebSocket ä¸€æ—¦æˆåŠŸ upgradeDispatch(OPEN_READ) state åï¼Œé€»è¾‘å°†ä¼šåœç•™åœ¨å¾ªç¯ä» socketInputStream è·å–æ•°æ®ä¸Š</p>
<p>è€Œæˆ‘ä»¬çŸ¥é“ WebSocket ä¸ºåŒå·¥åè®®ï¼Œé‚£ä¹ˆ OPEN_WRITE çŠ¶æ€ä»€ä¹ˆæ—¶å€™è¢« upgradeDispatch ? è¿™ä¸è¢« upgradeDispatch çš„è¯ï¼ŒServer side å°±æ²¡æ³•å‘ Client side æ¨é€æ•°æ®äº†ï¼Ÿ</p>
<p>WsRemoteEndpointImplServer onWritePossible</p>
<p>ä» byteBuffers ä¸­è¯»å–å­—èŠ‚ï¼Œå¹¶å†™å…¥ socketOutputStream ä¸­ï¼ŒbyteBuffers è¯»å– complete å‘é€å®Œæˆåï¼Œå¾ªç¯é€€å‡º</p>
<p>è¿™ä»…æ˜¯ onWritePossible è‡ªèº«çš„é€»è¾‘</p>
<p>è€Œå®é™…ä¸Šå¦‚æœæ˜¯ upgradeDispatch(OPEN_WRITE) trigger onWritePossible(useDispatch: false)</p>
<p>WsRemoteEndpointImplServer doWrite trigger onWritePossible(useDispatch: true)</p>
<p>è€äººå¯»å‘³</p>
<p>æ³¨æ„åˆ°æˆ‘ä»¬ä½¿ç”¨ wsSession.getBasicRemote().sendText() å‘é€æ¶ˆæ¯ï¼Œå®é™…ä¸Šæœ€åè°ƒç”¨çš„ä¸º doWrite æ–¹æ³•ï¼Œæ‰€ä»¥é€»è¾‘å°±æ¸…æ™°äº†ï¼Œå®é™…ä¸Šå¹¶ä¸ä¸€å®šéœ€è¦ upgradeDispatch(OPEN_WRITE) æ‰èƒ½å†™å…¥ï¼Œåªä¸è¿‡åœ¨å®ç°ä¸Šï¼Œé€šè¿‡ upgradeDispatch(OPEN_WRITE) æ‰§è¡Œçš„ doWrite ä¸åœ¨ onOpen / onMessage ä¸­ä½¿ç”¨ wsSession ç›´æ¥å†™å…¥çš„ doWrite ä¼ å…¥å‚æ•°ä¸åŒï¼Œå‡èƒ½å®Œæˆå†™å…¥</p>
<ul>
<li>upgradeDispatch(OPEN_WRITE): onWritePossible(useDispatch: false)</li>
<li>wsSession.getBasicRemote().sendText(â€¦): onWritePossible(useDispatch: true)</li>
</ul>
<h1 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h1><p>è¿™å—é€»è¾‘çœ‹çš„è¿˜ä¸æ˜¯ç‰¹åˆ«æ¸…æ™°ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ²¡æœ‰ OPEN_WRITE state ä¹Ÿæ˜¯å¯ä»¥å†™å…¥çš„è¿™ä¸ªç»“è®º</p>
<p>æ‰€ä»¥å®Œæ•´çš„ WebSocket è¯·æ±‚æµç¨‹</p>
<ul>
<li>å®¢æˆ·ç«¯å‘èµ· WebSocket è¯·æ±‚æ—¶ï¼Œéœ€è¦æ–°å»ºä¸€ä¸ªé“¾æ¥</li>
<li>Tomcat æ¥æ”¶åˆ° socket é“¾æ¥åï¼ŒæŒ‰é€šç”¨å¤„ç†æµç¨‹å¤„ç†ä¹‹</li>
<li>WebSocket çš„ç¬¬ä¸€ä¸ªè¯·æ±‚ä¸º HTTP GET Upgrade è¯·æ±‚ï¼Œè¿™ä¸ªè¯·æ±‚åœ¨é€šç”¨å¤„ç†æµç¨‹ä¸­ç»è¿‡ WsFilter</li>
<li>WsFilter è¯†åˆ«åˆ°è¯¥è¯·æ±‚ä¸º WebSocket è¯·æ±‚ï¼Œéšåè®¾ç½® WsHttpUpgradeHandler ä¸ºå…¶ httpUpgradeHandlerï¼Œè°ƒç”¨ upgrade æ–¹æ³•ï¼Œå¹¶ preInit WsHttpUpgradeHandler</li>
<li>Tomcat å‘ç°å½“å‰ socket state å˜ä¸º UPGRADINGï¼Œå› æ­¤åˆ›å»º upgradeProcessor ä»¥æ›¿æ¢ä¹‹å‰çš„ http processorï¼Œæ­¤æ—¶ä¼šæ‰§è¡Œ WsHttpUpgradeHandler init æ–¹æ³•</li>
<li>WsHttpUpgradeHandler init æ–¹æ³•ä¸­ä¼šå›è°ƒ <strong>ServerEndpoint onOpen</strong> æ–¹æ³•</li>
<li>Tomcat ç»§ç»­å¤„ç†æ—¶å‘ç° processor ä¸º upgradeProcessorï¼Œå› æ­¤è°ƒç”¨ upgradeDispatch(OPEN_READ)</li>
<li>è¿™æ—¶è§¦å‘ WsHttpUpgradeHandler.onDataAvailable()ï¼Œéšå³ç»§ç»­è°ƒç”¨è‡³ WsFrameServer.onDataAvailable()</li>
<li>WsFrameServer.onDataAvailable() å°è¯•è·å–å¯¹è±¡é”ä¹‹åï¼Œè¿›å…¥ for loop è·å– socketInputStream è¾“å…¥é€»è¾‘ï¼Œç»„è£…å¥½æ•°æ®åï¼Œå›è°ƒ <strong>ServerEndpoint onMessage</strong> æ–¹æ³•ï¼Œå³ä¸šåŠ¡å±‚æ­¤æ—¶å¯ä»¥æ„ŸçŸ¥åˆ° Client å‘é€çš„æ•°æ®</li>
<li>åˆ°è¿™é‡Œå½“å‰çº¿ç¨‹å°±ä¸€ç›´åœ¨å¹²è¯»å– socket ä¸­çš„æ•°æ®å¹¶è°ƒç”¨ onMessage è¿™ä»¶äº‹å„¿äº†</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/724944fd.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/724944fd.html" class="post-title-link" itemprop="url">WebSocket in Tomcat 7 (part 2)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-07-06 20:28:07" itemprop="dateCreated datePublished" datetime="2018-07-06T20:28:07Z">2018-07-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-12-06 03:18:54" itemprop="dateModified" datetime="2020-12-06T03:18:54Z">2020-12-06</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>6.1k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>6 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>æ¥ç€ä¸Šä¸€ç¯‡ï¼Œæ¥åˆ†æä¸€ä¸‹ Tomcat 7 ä¸­ WebSocket çš„å®ç°</p>
<h1 id="WsFilter"><a href="#WsFilter" class="headerlink" title="WsFilter"></a>WsFilter</h1><p>WebSocket çš„å®ç°å…¥å£å¤„ä¸º WsFilterï¼Œè¯¥ Filter æ£€æŸ¥ HTTP header ä¸­æ˜¯å¦åŒ…å«ä¸‹è¿°å­—æ®µ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Upgrade: websocket</span><br></pre></td></tr></table></figure>

<p>ä¸”ä¸º HTTP GET è¯·æ±‚ã€‚è‹¥ç¬¦åˆ WebSocket Handshake è¦æ±‚ï¼Œåˆ™ä» WebSocketContainer ä¸­æŸ¥æ‰¾è¯·æ±‚è·¯å¾„æ˜¯å¦æœ‰ filter æ‹¦æˆªï¼Œè‹¥æ²¡æœ‰åˆ™ç»§ç»­åç»­çš„ filterï¼Œè‹¥æœ‰åˆ™è¿›å…¥ UpgradeUtil.doUpgrade æ–¹æ³•</p>
<h1 id="WsServerContainer"><a href="#WsServerContainer" class="headerlink" title="WsServerContainer"></a>WsServerContainer</h1><p>å›å¤´æ¥çœ‹ WsServerContainer çš„åˆå§‹åŒ–ï¼Œå½“ç„¶æœ€ä¸ºé‡è¦çš„æ˜¯æ³¨å†Œäº† WsFilter</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">FilterRegistration.Dynamic fr = servletContext.addFilter(</span><br><span class="line">        <span class="string">&quot;Tomcat WebSocket (JSR356) Filter&quot;</span>, <span class="keyword">new</span> WsFilter());</span><br><span class="line">fr.setAsyncSupported(<span class="keyword">true</span>);</span><br><span class="line">EnumSet&lt;DispatcherType&gt; types = EnumSet.of(DispatcherType.REQUEST,</span><br><span class="line">        DispatcherType.FORWARD);</span><br><span class="line">fr.addMappingForUrlPatterns(types, <span class="keyword">true</span>, <span class="string">&quot;/*&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>å¯è§ WsFilter æ‹¦æˆªæ‰€æœ‰è¯·æ±‚ï¼Œå½“é‡åˆ° HTTP Upgrade to websocket åè®®çš„è¯·æ±‚æ—¶æ‰§è¡Œ doUpgrade é€»è¾‘</p>
<h1 id="UpgradeUtil-doUpgrade"><a href="#UpgradeUtil-doUpgrade" class="headerlink" title="UpgradeUtil.doUpgrade"></a>UpgradeUtil.doUpgrade</h1><p>doUpgrade åœ¨å„ç§æ£€æŸ¥åï¼Œå¯ä»¥æ¥å— Client Upgrade è¯·æ±‚æ—¶ï¼Œéœ€å‘ Client ç«¯è¿”å›çš„ HTTP æŠ¥æ–‡å¤´ä¸­æ·»åŠ å¦‚ä¸‹å­—æ®µï¼ˆSec-WebSocket-Protocol / Sec-WebSocket-Extensions å¯é€‰ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Upgrade: websocket</span><br><span class="line">Connection: upgrade</span><br><span class="line">Sec-WebSocket-Accept: [key]</span><br><span class="line">Sec-WebSocket-Protocol: [subProtocol]</span><br><span class="line">Sec-WebSocket-Extensions: [extensions]</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶è¿˜éœ€è¦åˆå§‹åŒ– ServerEndpoint å®ä¾‹ï¼ˆ@ServerEndpoint æ³¨è§£ï¼‰</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Endpoint ep;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Class&lt;?&gt; clazz = sec.getEndpointClass();</span><br><span class="line">    <span class="keyword">if</span> (Endpoint.class.isAssignableFrom(clazz)) &#123;</span><br><span class="line">        ep = (Endpoint) sec.getConfigurator().getEndpointInstance(</span><br><span class="line">                clazz);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ep = <span class="keyword">new</span> PojoEndpointServer();</span><br><span class="line">        <span class="comment">// Need to make path params available to POJO</span></span><br><span class="line">        perSessionServerEndpointConfig.getUserProperties().put(</span><br><span class="line">                PojoEndpointServer.POJO_PATH_PARAM_KEY, pathParams);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">catch</span> (InstantiationException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ServletException(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æœ€åå‘ Client è¿”å› HTTP Response</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">WsHttpUpgradeHandler wsHandler =</span><br><span class="line">        ((RequestFacade) inner).upgrade(WsHttpUpgradeHandler.class);</span><br><span class="line">wsHandler.preInit(ep, perSessionServerEndpointConfig, sc, wsRequest,</span><br><span class="line">        negotiatedExtensionsPhase2, subProtocol, transformation, pathParams,</span><br><span class="line">        req.isSecure());</span><br></pre></td></tr></table></figure>

<p>è€Œ WsHttpUpgradeHandler åˆ™ä¼šç”¨äºå¤„ç†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The handler for all further incoming data on the current connection.</span><br></pre></td></tr></table></figure>

<h1 id="WsHttpUpgradeHandler"><a href="#WsHttpUpgradeHandler" class="headerlink" title="WsHttpUpgradeHandler"></a>WsHttpUpgradeHandler</h1><p>WsHttpUpgradeHandler init æ–¹æ³•ä¸­å¹²äº†å¾ˆå¤šäº‹æƒ…</p>
<ul>
<li>é¦–å…ˆä» WebConnection ä¸­è·å–è¾“å…¥æµ/è¾“å‡ºæµ</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">this</span>.connection = connection;</span><br><span class="line">AbstractServletInputStream sis;</span><br><span class="line">AbstractServletOutputStream sos;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    sis = connection.getInputStream();</span><br><span class="line">    sos = connection.getOutputStream();</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>å®ä¾‹åŒ– WsSessionï¼Œæ³¨æ„ SessionId ä½¿ç”¨ä¸€ä¸ª static AtomicLong ç»´æŠ¤ï¼Œæ¯æ¬¡å¢åŠ  1</li>
<li>å®ä¾‹åŒ– WsFrameServerï¼Œç”¨äºè¯»å†™ Message</li>
<li>åœ¨ sos ä¸Šæ³¨å†Œ WsWriteListener</li>
<li>è°ƒç”¨ ServerEndpoint onOpen æ–¹æ³•</li>
<li>åœ¨ sis ä¸Šæ³¨å†Œ WsReadListener</li>
</ul>
<h2 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h2><p>æ‰€ä»¥ç»¼ä¸Šæ‰€è¿°ï¼Œæ¯ä¸€æ¬¡ HTTP Upgrade è¯·æ±‚å‡ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ ServerEndpoint å®ä¾‹ï¼Œå› æ­¤å®šä¹‰äº ServerEndpoint ä¸­çš„ static å˜é‡éœ€æ³¨æ„ç¡®ä¿çº¿ç¨‹å®‰å…¨</p>
<p>å¦å¤– ServerEndpoint ä¸­ onOpen å’Œ onMessage çš„æ‰§è¡Œé¡ºåºä¸º onOpen å¿…ç„¶é¦–å…ˆæ‰§è¡Œï¼Œè‹¥ onOpen æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œåˆ™å°±ç®— sis ä¸­æœ‰æ•°æ®ç­‰å¾…å¤„ç†ï¼Œä¹Ÿä¸ä¼šè§¦å‘ onMessageï¼Œå› ä¸ºä» WsHttpUpgradeHandler init æ–¹æ³•ä¸­å¯ä»¥çœ‹å‡º onOpen è°ƒç”¨ç»“æŸåï¼Œæ‰ä¼šåœ¨ sis ä¸Šæ³¨å†Œ WsReadListenerã€‚æ¥ä¸‹æ¥ç»§ç»­åˆ†æï¼Œå¦‚ä½•è§¦å‘ WsReadListener</p>
<h1 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h1><p>AbstractServiceInputStream.onDataAvailable() æ–¹æ³•ä¸­è°ƒç”¨ listener.onDataAvailable(); å³ WsReadListener.onDataAvailable()</p>
<p>è€Œ AbstractServiceInputStream.onDataAvailable() åˆç”± AbstractProcessor.upgradeDispatch(SocketStatus status) è°ƒç”¨</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> SocketState <span class="title">upgradeDispatch</span><span class="params">(SocketStatus status)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (status == SocketStatus.OPEN_READ) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            upgradeServletInputStream.onDataAvailable();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            <span class="comment">// The error handling within the ServletInputStream should have</span></span><br><span class="line">            <span class="comment">// marked the stream for closure which will get picked up below,</span></span><br><span class="line">            <span class="comment">// triggering the clean-up of this processor.</span></span><br><span class="line">            getLog().debug(sm.getString(<span class="string">&quot;abstractProcessor.onDataAvailableFail&quot;</span>), ioe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == SocketStatus.OPEN_WRITE) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            upgradeServletOutputStream.onWritePossible();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            <span class="comment">// The error handling within the ServletOutputStream should have</span></span><br><span class="line">            <span class="comment">// marked the stream for closure which will get picked up below,</span></span><br><span class="line">            <span class="comment">// triggering the clean-up of this processor.</span></span><br><span class="line">            getLog().debug(sm.getString(<span class="string">&quot;abstractProcessor.onWritePossibleFail&quot;</span>), ioe);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status == SocketStatus.STOP) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            upgradeServletInputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            getLog().debug(sm.getString(</span><br><span class="line">                    <span class="string">&quot;abstractProcessor.isCloseFail&quot;</span>, ioe));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            upgradeServletOutputStream.close();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">            getLog().debug(sm.getString(</span><br><span class="line">                    <span class="string">&quot;abstractProcessor.osCloseFail&quot;</span>, ioe));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Unexpected state</span></span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (upgradeServletInputStream.isCloseRequired() ||</span><br><span class="line">            upgradeServletOutputStream.isCloseRequired()) &#123;</span><br><span class="line">        <span class="keyword">return</span> SocketState.CLOSED;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> SocketState.UPGRADED;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Tomcat 7 é»˜è®¤ä½¿ç”¨ BIOï¼ŒHttp11Protocol.createUpgradeProcessorï¼Œå…¶ä¸­å°† socket è¶…æ—¶æ—¶é—´è®¾ç½®ä¸ºä¸è¶…æ—¶ï¼Œå¹¶è¿”å›ä¸€ä¸ª Processor</p>
<p>å› æ­¤ Tomcat å¤„ç† WebSocket è¯·æ±‚çš„å¤§è‡´æµç¨‹ä¸º</p>
<ul>
<li>JIOEndpoint accept socket and new a thread to handle it</li>
<li>Worker wait for the next socket to be assigned and call handler to process socket</li>
<li>Http11ConnectionHandler</li>
<li>Http11Processor</li>
</ul>
<p>å®¢æˆ·ç«¯é¦–å…ˆæ‰“å¼€ä¸€ä¸ª connectionï¼Œconnection å»ºç«‹åï¼Œå‘æœåŠ¡å™¨ç«¯å‘èµ· WebSocket Handshake è¯·æ±‚ï¼ŒæœåŠ¡å™¨æ¥å—åï¼Œè¿”å› 101 status codeï¼ŒåŒæ–¹å¯åœ¨å½“å‰ connection ä¸ŠåŒå·¥é€šä¿¡</p>
<p>å½“ SocketStatus ä¸º OPEN_READ æ—¶ï¼Œå›è°ƒ readListener çš„ onDataAvailable æ–¹æ³•ï¼Œæ­¤å¤„é€»è¾‘æœ‰ trick çš„åœ°æ–¹ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯å¦‚æœ SocketStatus.OPEN_READ æ—¶ï¼Œä»æœªå®Œæˆæ³¨å†Œ readListenerï¼Œåˆ™ä¸ä¼šè§¦å‘ listener.onDataAvailable() â€¦ æ˜¾ç„¶ï¼Œå› ä¸º listener ä¸º null</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">onDataAvailable</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123; <span class="comment">// it doesn&#x27;t have a listener</span></span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ready = Boolean.TRUE;</span><br><span class="line">    Thread thread = Thread.currentThread();</span><br><span class="line">    ClassLoader originalClassLoader = thread.getContextClassLoader();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        thread.setContextClassLoader(applicationLoader);</span><br><span class="line">        listener.onDataAvailable();</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        thread.setContextClassLoader(originalClassLoader);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åœ¨ WsFrameServer çš„ onDataAvailable æ–¹æ³•ä¸­é¦–å…ˆå°è¯•è·å–å¯¹è±¡é”ï¼Œè·å–æˆåŠŸåï¼Œfor loop ç›‘å¬ Servlet è¾“å…¥æµï¼Œå½“æœ‰æ•°æ®æ—¶è¯»å–æ•°æ®ä¾› WsFrameServer å¤„ç†ï¼Œå¤„ç† okay åï¼Œå›è°ƒ ServerEndpoint çš„ onMessage æ–¹æ³•ï¼Œä¸šåŠ¡å±‚å³æ„ŸçŸ¥åˆ°ä» ws è¿æ¥ä¸­è·å–åˆ°æ•°æ®</p>
<p>å¦å¤– ServerEndpoint onOpen æ˜¯åœ¨ WsHttpUpgradeHandler init æ–¹æ³•ä¸­è¢«å›è°ƒï¼Œçœ‹çœ‹å®˜æ–¹æ–‡æ¡£å¯¹ handler çš„ init æ–¹æ³•çš„æè¿°</p>
<blockquote>
<p>This method is called once the request/response pair where the upgrade is initiated has completed processing and is the point where control of the connection passes from the container to the HttpUpgradeHandler.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/tomcat/websocket/server/WsHttpUpgradeHandler.html">https://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/tomcat/websocket/server/WsHttpUpgradeHandler.html</a></p>
<p>so ç†è®ºä¸Šè¦æƒ³ä½¿å¾— Tomcat 7 WebSocket èƒ½æ­£å¸¸å·¥ä½œçš„å‰æä¸º</p>
<ul>
<li>WsHttpUpgradeHandler init æ–¹æ³•è¢«è°ƒç”¨ â€”â€” WsHttpUpgradeHandler</li>
<li>åœ¨ sos ä¸Šæ³¨å†Œ WsWriteListener æ–¹æ³•ç»“æŸ â€”â€” WsHttpUpgradeHandler</li>
<li>SocketStatus.OPEN_WRITE â€”â€” AbstractProcessor</li>
<li>onOpen æ–¹æ³•å›è°ƒç»“æŸ â€”â€” ServerEndpoint</li>
<li>åœ¨ sis ä¸Šæ³¨å†Œ WsReadListener æ–¹æ³•ç»“æŸ â€”â€” WsHttpUpgradeHandler</li>
<li>SocketStatus.OPEN_READ â€”â€” AbstractProcessor</li>
</ul>
<p>æ¥ä¸‹æ¥éœ€è¦ææ¸…æ¥šä¸€ä¸ªé—®é¢˜ï¼Œä¸Šè¿°è¿™äº›é€»è¾‘æ˜¯å•çº¿ç¨‹åœ¨è·‘ï¼Œè¿˜æ˜¯å¤šçº¿ç¨‹ï¼Œå•çº¿ç¨‹çš„è¯ï¼Œæ—¶åºé—®é¢˜ä¸å¤§ï¼Œä½†æ˜¯å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œå°±å¾ˆæœ‰è®²ç©¶äº†</p>
<p>To be cont. ä¸‹ä¸€éå›ç­”ä¸Šè¿°æ—¶åºé—®é¢˜</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/5964173e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/5964173e.html" class="post-title-link" itemprop="url">WebSocket in Tomcat 7 (part 1)</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-07-06 20:22:57" itemprop="dateCreated datePublished" datetime="2018-07-06T20:22:57Z">2018-07-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 12:27:16" itemprop="dateModified" datetime="2020-11-22T12:27:16Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>3.2k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>3 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>åˆæ˜¯ä¸€éƒ¨æŠ˜è…¾å²</p>
</blockquote>
<p>ä¹‹å‰æåˆ°äº†æœ€è¿‘åœ¨åŸºäº WebSocket åè®®å®ç° WebTerminal ç‰¹æ€§ï¼Œæ— å¥ˆç”Ÿäº§ç¯å¢ƒé‡åˆ°äº†ä¸€ä¸ª weired bugï¼Œç™¾æ€ä¸å¾—å…¶è§£ï¼Œåªå¥½çœ‹çœ‹ WebSocket åœ¨ Tomcat 7 ä¸­æ˜¯å¦‚ä½•å®ç°çš„</p>
<blockquote>
<p>ç¯å¢ƒ/ç‰ˆæœ¬ä¿¡æ¯</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">OS: macOS Sierra 10.12.6</span><br><span class="line">Tomcat: 7.0.88</span><br><span class="line">Intellij: 2016.2</span><br></pre></td></tr></table></figure>

<blockquote>
<p>jenv ç®¡ç† java ç‰ˆæœ¬</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt; jenv versions</span><br><span class="line">  system</span><br><span class="line">* 1.6.0.65 (set by /Users/zrss/.jenv/version)</span><br><span class="line">  1.7.0.181</span><br><span class="line">  1.8.0.172</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å½“å‰ java ç‰ˆæœ¬</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; jenv global</span><br><span class="line">1.6.0.65</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ant ç‰ˆæœ¬</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; ant -version</span><br><span class="line">Apache Ant(TM) version 1.9.12 compiled on June 19 2018</span><br></pre></td></tr></table></figure>

<h1 id="Set-up-Tomcat-src-code-in-Intellij"><a href="#Set-up-Tomcat-src-code-in-Intellij" class="headerlink" title="Set up Tomcat src code in Intellij"></a>Set up Tomcat src code in Intellij</h1><p>å‚è€ƒå¦‚ä¸‹å®˜æ–¹æ„å»ºæŒ‡å—å³å¯</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="http://tomcat.apache.org/tomcat-7.0-doc/building.html">http://tomcat.apache.org/tomcat-7.0-doc/building.html</a></p>
</blockquote>
<p>ç¬¬ä¸€æ­¥å½“ç„¶æ˜¯ä¸‹è½½æºç  <a target="_blank" rel="noopener" href="http://tomcat.apache.org/download-70.cgi#7.0.88">http://tomcat.apache.org/download-70.cgi#7.0.88</a><br>ï¼Œå½“å‰æºç åœ°å€ <a target="_blank" rel="noopener" href="http://mirrors.hust.edu.cn/apache/tomcat/tomcat-7/v7.0.88/src/apache-tomcat-7.0.88-src.tar.gz">http://mirrors.hust.edu.cn/apache/tomcat/tomcat-7/v7.0.88/src/apache-tomcat-7.0.88-src.tar.gz</a></p>
<p>è§£å‹åç›®å½•ç»“è®ºå¦‚ä¸‹</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">apache-tomcat-7.0.88-src</span><br><span class="line">â”œâ”€â”€ BUILDING.txt</span><br><span class="line">â”œâ”€â”€ CONTRIBUTING.md</span><br><span class="line">â”œâ”€â”€ KEYS</span><br><span class="line">â”œâ”€â”€ LICENSE</span><br><span class="line">â”œâ”€â”€ NOTICE</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ RELEASE-NOTES</span><br><span class="line">â”œâ”€â”€ RUNNING.txt</span><br><span class="line">â”œâ”€â”€ STATUS.txt</span><br><span class="line">â”œâ”€â”€ bin</span><br><span class="line">â”œâ”€â”€ build.properties.default</span><br><span class="line">â”œâ”€â”€ build.xml</span><br><span class="line">â”œâ”€â”€ conf</span><br><span class="line">â”œâ”€â”€ java</span><br><span class="line">â”œâ”€â”€ modules</span><br><span class="line">â”œâ”€â”€ res</span><br><span class="line">â”œâ”€â”€ test</span><br><span class="line">â””â”€â”€ webapps</span><br></pre></td></tr></table></figure>

<p>Tomcat è¯ç”Ÿçš„å¹´ä»£æ¯”è¾ƒä¹…è¿œï¼Œè¿˜æ˜¯ç”¨çš„æ¯”è¾ƒå¤è€çš„æ„å»ºå·¥å…· antï¼Œå¤åˆ¶ build.properties.default è‡³ build.properties</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp build.properties.default build.properties</span><br></pre></td></tr></table></figure>

<p>Tomcat7 WebSocket ä¾èµ– java7ï¼Œå› æ­¤éœ€è¦è®¾ç½® build.properties ä¸­çš„ java7 pathã€‚å–æ¶ˆè¯¥æ–‡ä»¶ä¸­çš„ä¸‹è¿°å®šä¹‰æ³¨é‡Šï¼ˆ54è¡Œï¼‰ï¼Œå¹¶å¡«å†™ç›¸åº” jdk è·¯å¾„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.7.home=/Library/Java/JavaVirtualMachines/zulu-7.jdk/Contents/Home</span><br></pre></td></tr></table></figure>

<blockquote>
<p>å¦‚æœä½¿ç”¨ jenv ç®¡ç† java ç‰ˆæœ¬ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æŸ¥çœ‹å½“å‰ java çš„ java_home path<br>/usr/libexec/java_home -v $(jenv version-name)</p>
</blockquote>
<p>ç¡®è®¤å½“å‰ java ç‰ˆæœ¬ä¸º 1.6</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; java -version</span><br><span class="line">java version &quot;1.6.0_65&quot;</span><br><span class="line">Java(TM) SE Runtime Environment (build 1.6.0_65-b14-468)</span><br><span class="line">Java HotSpot(TM) 64-Bit Server VM (build 20.65-b04-468, mixed mode)</span><br></pre></td></tr></table></figure>

<p>è®¾ç½® JAVA_HOMEï¼ˆmake sure it is a 1.6 javaâ€™s homeï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; export JAVA_HOME=$(/usr/libexec/java_home -v $(jenv version-name))</span><br><span class="line">&gt; echo $JAVA_HOME</span><br><span class="line">/Library/Java/JavaVirtualMachines/1.6.0.jdk/Contents/Home</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶å›½å†…çš„å°ä¼™ä¼´è¿˜è¦å¤šåšä¸€ä»¶äº‹å„¿ï¼Œé‚£å°±æ˜¯é…ç½® proxy</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">proxy.use=on</span><br><span class="line">proxy.host=127.0.0.1</span><br><span class="line">proxy.port=1081</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ª proxy æ–¹æ¡ˆä¹Ÿæ˜¯éå¸¸å¸¸è§çš„äº†ï¼Œshadowsocks (socks5) + privoxy (http)</p>
<p>æœ€åè¿›å…¥ Tomcat æºç ç›®å½•æ‰§è¡Œ ant å‘½ä»¤æ„å»º</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /Users/zrss/Documents/Code/Java/apache-tomcat-7.0.88-src</span><br><span class="line">ant</span><br></pre></td></tr></table></figure>

<p>jar åŒ…ä¸‹è½½é¡ºåˆ©çš„è¯ï¼Œæ— é—®é¢˜</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BUILD SUCCESSFUL</span><br><span class="line">Total time: 23 seconds</span><br></pre></td></tr></table></figure>

<h1 id="Import-Tomcat-src-to-Intellij"><a href="#Import-Tomcat-src-to-Intellij" class="headerlink" title="Import Tomcat src to Intellij"></a>Import Tomcat src to Intellij</h1><p>åœ¨ Tomcat æºç ç›®å½•æ‰§è¡Œï¼Œå¦‚è‹¥é‡åˆ°å› ä¸º SSL æ— æ³•ä¸‹è½½çš„ä¾èµ–ï¼Œæ‰‹åŠ¨ä¸‹è½½ä¹‹ï¼Œå¹¶æ”¾å…¥ testexist è·¯å¾„ï¼ˆè®²çœŸï¼Œæ˜¯ä¸ªä½“åŠ›æ´»å„¿ï¼Œå¾—æœ‰å…­ä¸ƒä¸ªåŒ…å§ï¼‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ant ide-eclipse</span><br></pre></td></tr></table></figure>

<p>æœ€åç»ˆäºæˆåŠŸäº†</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BUILD SUCCESSFUL</span><br><span class="line">Total time: 1 second</span><br></pre></td></tr></table></figure>

<p>æ„å»º websocket eclipse</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ant ide-eclipse-websocket</span><br></pre></td></tr></table></figure>

<p>é¡ºåˆ©æˆåŠŸ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BUILD SUCCESSFUL</span><br><span class="line">Total time: 1 second</span><br></pre></td></tr></table></figure>

<p>åˆ°æ­¤å¯ä»¥å¼€å§‹å¯¼å…¥ IntelliJ äº†</p>
<p>IntelliJ æ¬¢è¿é¡µé¢é€‰æ‹© Import Projectï¼Œåœ¨å¼¹å‡ºæ¡†ä¸­é€‰æ‹© Tomcat æºç æ ¹è·¯å¾„ï¼Œä¸€è·¯ Next è‡³ Select Eclipse projects to importï¼Œå‹¾é€‰ä¸Š tomcat-7.0.x ç»§ç»­ Nextï¼Œæœ€å Project SDK é€‰æ‹© 1.6 å³å¯</p>
<p>WebSocket ä»£ç åœ¨å¦‚ä¸‹è·¯å¾„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/Users/zrss/Documents/Code/Java/apache-tomcat-7.0.88-src/java/org/apache/tomcat/websocket</span><br></pre></td></tr></table></figure>

<p>æœ€åæŸ¥çœ‹ Tomcat version ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt; cd output/build/bin</span><br><span class="line">&gt; ./version.sh</span><br><span class="line">Using CATALINA_BASE:   /Users/zrss/Documents/Code/Java/apache-tomcat-7.0.88-src/output/build</span><br><span class="line">Using CATALINA_HOME:   /Users/zrss/Documents/Code/Java/apache-tomcat-7.0.88-src/output/build</span><br><span class="line">Using CATALINA_TMPDIR: /Users/zrss/Documents/Code/Java/apache-tomcat-7.0.88-src/output/build/temp</span><br><span class="line">Using JRE_HOME:        /Library/Java/JavaVirtualMachines/1.6.0.jdk/Contents/Home</span><br><span class="line">Using CLASSPATH:       /Users/zrss/Documents/Code/Java/apache-tomcat-7.0.88-src/output/build/bin/bootstrap.jar:/Users/zrss/Documents/Code/Java/apache-tomcat-7.0.88-src/output/build/bin/tomcat-juli.jar</span><br><span class="line">Server version: Apache Tomcat/7.0.88</span><br><span class="line">Server built:   Jul 6 2018 14:30:23 UTC</span><br><span class="line">Server number:  7.0.88.0</span><br><span class="line">OS Name:        Mac OS X</span><br><span class="line">OS Version:     10.12.6</span><br><span class="line">Architecture:   x86_64</span><br><span class="line">JVM Version:    1.6.0_65-b14-468</span><br><span class="line">JVM Vendor:     Apple Inc.</span><br></pre></td></tr></table></figure>

<p>è‡³æ­¤ Tomcat 7 å¯¼å…¥ IntelliJ ä¸­ okayï¼Œå¯ä»¥æ„‰å¿«çš„æŸ¥çœ‹ä»£ç äº†ã€‚å½“ç„¶æŸ¥çœ‹ WebSocket ç›¸å…³çš„å®ç°æ—¶ï¼Œåœ¨ IntelliJ Project Structure ä¸­åˆ‡æ¢ SDK è‡³ 1.7 å³å¯</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/6/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><span class="page-number current">7</span><a class="page-number" href="/page/8/">8</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/8/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">283k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">4:18</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
