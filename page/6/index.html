<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"æœç´¢...","empty":"æ²¡æœ‰æ‰¾åˆ°ä»»ä½•æœç´¢ç»“æœï¼š${query}","hits_time":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰","hits":"æ‰¾åˆ° ${hits} ä¸ªæœç´¢ç»“æœ"}}</script><script src="/js/config.js"></script>
<meta name="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
<meta property="og:type" content="website">
<meta property="og:title" content="éšé£é£˜æ•£çš„è®°å¿†">
<meta property="og:url" content="https://zrss.github.io/page/6/index.html">
<meta property="og:site_name" content="éšé£é£˜æ•£çš„è®°å¿†">
<meta property="og:description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="tech">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zrss.github.io/page/6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/6/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>éšé£é£˜æ•£çš„è®°å¿†</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="åˆ‡æ¢å¯¼èˆªæ " role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">éšé£é£˜æ•£çš„è®°å¿†</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          æ–‡ç« ç›®å½•
        </li>
        <li class="sidebar-nav-overview">
          ç«™ç‚¹æ¦‚è§ˆ
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">124</span>
          <span class="site-state-item-name">æ—¥å¿—</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">åˆ†ç±»</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">æ ‡ç­¾</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="è¿”å›é¡¶éƒ¨">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/e57ea50b.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/e57ea50b.html" class="post-title-link" itemprop="url">welcome to hpc</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-01-19 10:54:39" itemprop="dateCreated datePublished" datetime="2019-01-19T10:54:39Z">2019-01-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 03:00:26" itemprop="dateModified" datetime="2020-11-22T03:00:26Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>2.6k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>2 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>æœ€è¿‘æ¥è§¦äº†ä¸€äº› HPC (é«˜æ€§èƒ½è®¡ç®—) æ–°ç©æ„å„¿ï¼Œå…¥é—¨é¦–å…ˆè¦æŒæ¡ä¸€äº›åŸºæœ¬çš„æ¦‚å¿µ</p>
<h1 id="æœ¯è¯­"><a href="#æœ¯è¯­" class="headerlink" title="æœ¯è¯­"></a>æœ¯è¯­</h1><h2 id="MPI"><a href="#MPI" class="headerlink" title="MPI"></a>MPI</h2><p>Message passing interface</p>
<p>æ¶ˆæ¯ä¼ é€’æ¥å£ï¼Œå¯ä»¥ç†è§£ä¸ºåˆ†å¸ƒå¼æ¶ˆæ¯ä¼ é€’æ¡†æ¶</p>
<h2 id="OpenMPI"><a href="#OpenMPI" class="headerlink" title="OpenMPI"></a>OpenMPI</h2><p>MPI çš„ä¸€ç§å¼€æºå®ç°</p>
<h2 id="RDMA"><a href="#RDMA" class="headerlink" title="RDMA"></a>RDMA</h2><p>remote direct memory access</p>
<h2 id="Infiniband"><a href="#Infiniband" class="headerlink" title="Infiniband"></a>Infiniband</h2><p>IB</p>
<p>ç½‘ç»œè®¾å¤‡ï¼Œæ”¯æŒ RDMA</p>
<h1 id="OpenMPI-1"><a href="#OpenMPI-1" class="headerlink" title="OpenMPI"></a>OpenMPI</h1><p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=developers#ompi-terminology">Terminology</a></p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=tuning#mca-def">MCA</a></p>
<ul>
<li>framework</li>
<li>components</li>
<li>module</li>
</ul>
<blockquote>
<p>An easy example framework to discuss is the MPI framework named â€œbtlâ€, or the Byte Transfer Layer. It is used to send and receive data on different kinds of networks. Hence, Open MPI has btl components for shared memory, TCP, Infiniband, Myrinet, etc.</p>
</blockquote>
<p>ä¸åŒçš„ MCA æ”¯æŒä¸åŒçš„å‚æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å‚è€ƒå¦‚ä¸‹æŸ¥è¯¢æ”¯æŒçš„ MCA å‚æ•°</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=tuning#available-mca-params">available-mca-params</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ompi_info --param all all --level 9</span><br><span class="line"><span class="comment"># only btl</span></span><br><span class="line">ompi_info --param btl all --level 9</span><br><span class="line"><span class="comment"># only tcp of btl</span></span><br><span class="line">ompi_info --param btl tcp --level 9</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡ MCA å‚æ•°é€‰æ‹© Components</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=tuning#selecting-components">selecting-components</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpirun --mca btl ^tcp,openib</span><br></pre></td></tr></table></figure>

<p>ä¸ä½¿ç”¨ btl framework ä¸­çš„ tcp componentï¼Œä½¿ç”¨å…¶ä¸­çš„ openib</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/doc/v3.1/man1/mpirun.1.php">mpirun</a></p>
<p>mpirun çš„å¸¸ç”¨å‚æ•°</p>
<ul>
<li>-H: List of hosts on which to invoke processes.</li>
<li>-np: Run this many copies of the program on the given nodes. This option indicates that the specified file is an executable program and not an application context. If no value is provided for the number of copies to execute (i.e., neither the â€œ-npâ€ nor its synonyms are provided on the command line), Open MPI will automatically execute a copy of the program on each process slot (see below for description of a â€œprocess slotâ€). This feature, however, can only be used in the SPMD model and will return an error (without beginning execution of the application) otherwise.</li>
<li>â€“bind-to: Bind processes to the specified object, defaults to core. Supported options include slot, hwthread, core, l1cache, l2cache, l3cache, socket, numa, board, and none.</li>
<li>-x: Export the specified environment variables to the remote nodes before executing the program. Only one environment variable can be specified per -x option. Existing environment variables can be specified or new variable names specified with corresponding values. For example: % mpirun -x DISPLAY -x OFILE=/tmp/out â€¦ The parser for the -x option is not very sophisticated; it does not even understand quoted values. Users are advised to set variables in the environment, and then use -x to export (not define) them.</li>
<li>-mca: Send arguments to various MCA modules. See the â€œMCAâ€ section, below.</li>
</ul>
<p><code>--mca btl self</code> çš„ä½œç”¨</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=openfabrics#ib-btl">ib-btl</a></p>
<p>self ç”¨äºæœ¬åœ°è¿›ç¨‹é€šä¿¡ (å¯èƒ½ä½¿ç”¨ lo è®¾å¤‡ï¼Œä¹Ÿå¯èƒ½ä¸ç”¨ï¼Œä¾‹å¦‚å¯ä»¥ä½¿ç”¨å†…å­˜å…±äº«)</p>
<p>openmpiï¼Œå‡è®¾å¤šæœºåŒä¸€ä¸ªåœ°å€æ—çš„åœ°å€å¯é€šï¼Œå¦‚æœä¸»æœºä¸Šæœ‰å¤šä¸ªç½‘ç»œï¼Œopenmpi å‚è€ƒå¦‚ä¸‹é“¾æ¥è¿›è¡Œç½‘ç»œé€‰æ‹©</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=tcp#tcp-selection">tcp-selection</a></p>
<p>æ³¨æ„åˆ° openmpi ä¼šä½¿ç”¨æ‰€è§çš„æ‰€æœ‰ç½‘ç»œï¼Œå¦‚æœä½ ä¸æƒ³å…¶ä½¿ç”¨ ip networkï¼Œä½ å¯ä»¥æ˜¾å¼çš„ç¦ç”¨ä¹‹ï¼Œç„¶è€Œ</p>
<blockquote>
<p>Note that Open MPI will still use TCP for control messages, such as data between mpirun and the MPI processes, rendezvous information during MPI_INIT, etc. To disable TCP altogether, you also need to disable the tcp component from the OOB framework.</p>
</blockquote>
<p>è¿™å¥è¯æ¯”è¾ƒæœ‰æ„æ€ï¼Œä¸€èˆ¬æ¥è¯´ mpirun è¦æ±‚ node é—´å¯ä»¥ ssh å…å¯†ç™»å½•ï¼Œè€Œ ssh æ˜¯åº”ç”¨å±‚åè®®ï¼Œä¾èµ– TCP</p>
<p>openmpi ä¼šé€‰æ‹©æœ€ä¼˜çš„ç½‘ç»œ</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=tcp#tcp-routability">tcp-routability</a></p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=tcp#tcp-routability-1.3">tcp-routability-1.3</a></p>
<p>å¦‚ä½•æŸ¥çœ‹ mpirun è¿æ¥çš„è¿‡ç¨‹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mpirun --mca btl self,vader,tcp --mca btl_base_verbose 30 -np 2 -host NodeA,NodeB a.out</span><br></pre></td></tr></table></figure>

<p>a.out ä¸ºå¯æ‰§è¡Œç¨‹åº</p>
<p>å¦‚æœæœ‰ ib å¡ï¼Œtcp component ä¼šè‡ªåŠ¨ä¸‹çº¿</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=tcp#tcp-auto-disable">tcp-auto-disable</a></p>
<p>openmpi build default option</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=building#default-build">default-build</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--with-openib(=DIR) and --with-openib-libdir=DIR</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/2e8d2c8b.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/2e8d2c8b.html" class="post-title-link" itemprop="url">mpi operator</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2019-01-19 10:51:00" itemprop="dateCreated datePublished" datetime="2019-01-19T10:51:00Z">2019-01-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 02:54:17" itemprop="dateModified" datetime="2020-11-22T02:54:17Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>967</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>è®¡ç®— Replica åŠ Slot æ•°</li>
<li>åˆ›å»º ConfigMap</li>
</ol>
<ul>
<li>hostfile</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[mpiJobName]-worker-i slots=[8]</span><br></pre></td></tr></table></figure>

<p>[mpiJobName]-worker-i i.e. ${POD_NAME} of statefulsetâ€™s pod</p>
<p>kubexec.sh</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -x</span><br><span class="line">POD_NAME=<span class="variable">$1</span></span><br><span class="line"><span class="built_in">shift</span></span><br><span class="line">/opt/kube/kubectl <span class="built_in">exec</span> <span class="variable">$&#123;POD_NAME&#125;</span> -- /bin/sh -c <span class="string">&quot;$*&quot;</span></span><br></pre></td></tr></table></figure>

<ol>
<li>åˆ›å»º Statefulset</li>
</ol>
<p>Container Command: Sleep</p>
<ol start="2">
<li>åˆ›å»º Launcher (Job)</li>
</ol>
<p>Statefulset ready åï¼Œåˆ›å»º Launcher (Job)</p>
<p>è®¾ç½® env OMPI_MCA_plm_rsh_agent ä¸º kubexec.sh</p>
<p>å³ä½¿ç”¨ <code>kubectl exec $&#123;POD_NAME&#125; -- /bin/sh -c &quot;$*&quot;</code> ä½œä¸º ssh_agent</p>
<p><a target="_blank" rel="noopener" href="https://www.open-mpi.org/faq/?category=rsh#rsh-not-ssh">rsh-not-ssh</a></p>
<p>æ‰€ä»¥ openmpi æ˜¯æœ‰ä¸ªæ½œåœ¨è¦æ±‚çš„ï¼Œè¦ä¹ˆæ˜¯æ”¯æŒ IPoIBï¼Œor è¦æœ‰ IP ç½‘ç»œï¼Œçº¯ IB ç½‘ç»œä¸è¡Œ</p>
<p>å½“ç„¶ SDP (Socket Direct Protocol) èƒ½åŠ é€Ÿ Socket åˆæ˜¯å¦å¤–ä¸€ä¸ªè¯é¢˜äº†</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># server side</span></span><br><span class="line">/etc/init.d/sshd stop</span><br><span class="line">env LD_PRELOAD=/usr/lib64/libsdp.so</span><br><span class="line">LIBSDP_CONFIG_FILE=/u/etc/libsdp.conf /etc/init.d/sshd start</span><br><span class="line"><span class="comment"># client side</span></span><br><span class="line">LD_PRELOAD=/usr//lib64/libsdp.so</span><br><span class="line">LIBSDP_CONFIG_FILE=/etc/libsdp.conf scp &lt;file&gt; &lt;user&gt;@&lt;IPoIBaddr&gt;:&lt;dir&gt;</span><br></pre></td></tr></table></figure>

<p>Running ssh, scp over SDP</p>
<p><code>lsmod | grep sdp</code></p>
<p><code>sdpnetstat -S</code></p>
<p>è®¾ç½® env OMPI_MCA_orte_default_hostfile ä¸º hostfile</p>
<p>Container Command: mpirun</p>
<p>ç»¼ä¸Šï¼Œmpi-operator ä½¿ç”¨ kube-dns è·å¾— pod ipï¼Œmpirun ä½¿ç”¨ <code>kubectl exec</code> è¿œç¨‹ç™»å½• container</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/ac75c7e9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/ac75c7e9.html" class="post-title-link" itemprop="url">docker network</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-12-02 11:31:11" itemprop="dateCreated datePublished" datetime="2018-12-02T11:31:11Z">2018-12-02</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 03:39:04" itemprop="dateModified" datetime="2020-11-22T03:39:04Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Docker-Network"><a href="#Docker-Network" class="headerlink" title="Docker Network"></a>Docker Network</h1><p>IBM çš„å‡ ç¯‡ Blog overall çš„è®²äº†ä¸€ä¸‹</p>
<p><strong>å®¹å™¨å¦‚ä½•è®¿é—®å¤–éƒ¨ç½‘ç»œ</strong></p>
<p>é€šè¿‡ docker0 ç½‘æ¡¥çš„å¤–å‘åŒ…ç»è¿‡ NAT ä¹‹å src ip å˜ä¸ºä¸»æœº ip</p>
<p><strong>å¤–éƒ¨ç½‘ç»œå¦‚ä½•è®¿é—®å®¹å™¨</strong></p>
<p>å®¹å™¨å†…çš„ç«¯å£ï¼Œå¯åœ¨å®¹å™¨å¯åŠ¨æ—¶ï¼Œé€šè¿‡ -p å‚æ•°æ˜ å°„åˆ° host ä¸Šï¼Œè¿™æ—¶ host ä¸Šçš„ç«¯å£ä¼šéšæœºåˆ†é…ã€‚å½“ç„¶ä¹Ÿå¯ä»¥é€šè¿‡ -p [container-port]:[host-port] æ–¹å¼ï¼ŒæŒ‡å®šæ˜ å°„åˆ° host çš„ç‰¹å®šç«¯å£</p>
<p>è‡³äºå®ç°ä¸Šä¹Ÿè¾ƒä¸ºç›´æ¥ï¼Œè‹¥å®¹å™¨æœ‰ expose ç«¯å£ï¼Œåˆ™ docker ä¼šç›¸åº”å¯åŠ¨ä¸€ä¸ª docker-proxy ç›‘å¬ host ä¸Šçš„ host ç«¯å£ (å¦‚ä¸Šè¿°ä¾‹å­ä¸­çš„ host-port)ï¼Œå¤–éƒ¨æµé‡åˆ°è¾¾ host-port æ—¶ï¼Œç”± docker-proxy è½¬å‘è‡³æœ€ç»ˆå®¹å™¨</p>
<p>å½“ç„¶ä¸Šè¿°åªæ˜¯ docker network çš„åŸç”Ÿå®ç°ï¼Œdocker åŸç”Ÿå®ç°çš„ä¸åŒ host çš„ container ç•¥å»</p>
<h1 id="Flannel"><a href="#Flannel" class="headerlink" title="Flannel"></a>Flannel</h1><p>å¦‚æœåœ¨ k8s ç”Ÿæ€ä¸­ï¼Œdocker container è·¨ host é€šä¿¡ï¼Œæ—©æœŸç‰ˆæœ¬å¤šä½¿ç”¨ Flannel å®Œæˆ</p>
<p><a target="_blank" rel="noopener" href="https://www.hi-linux.com/posts/30481.html">Flannel åŸç†</a></p>
<p>Flannel å®ç°çš„æ˜¯ overlay networkï¼Œå³åŸºäºå·²æœ‰çš„ underlay networkï¼Œåœ¨å…¶ä¹‹ä¸Šæ‰©å±•æŠ¥æ–‡å­—æ®µï¼Œå®ŒæˆæŠ¥æ–‡è½¬å‘</p>
<p>åŸç†ä¹Ÿæ¯”è¾ƒå¥½ç†è§£</p>
<ul>
<li>åœ¨ ETCD ä¸­è®¾ç½® Flannel ç½‘æ®µåŠå­ç½‘èŒƒå›´</li>
<li>å¤šä¸ª Host ä¸Šè¿è¡Œ Flannel daemon</li>
<li>Flannel daemon æ ¹æ® ETCD ä¸­è®°å½•çš„å·²åˆ†é…å­ç½‘ï¼Œç¡®å®šè‡ªå·±çš„å­ç½‘ï¼Œå¹¶æ³¨å†Œè‡³ ETCD ä¸­</li>
<li>Docker æ ¹æ® Flannel åˆ’åˆ†çš„å­ç½‘å¯åŠ¨ï¼Œdocker0 åœ°å€ä» Flannel å­ç½‘ä¸­åˆ†é…å¾—åˆ°ï¼Œä¸€èˆ¬æ¥è¯´ Flannel0 åœ°å€ä¸ºå­ç½‘çš„ç¬¬ä¸€ä¸ªåœ°å€ (10.0.2.0)ï¼Œdocker0 åœ°å€ä¸ºå­ç½‘çš„ç¬¬äºŒä¸ªåœ°å€ (10.0.2.1)</li>
</ul>
<p>VM1 Container 1 è‡³ VM2 Container 2 çš„æŠ¥æ–‡è½¬å‘è¿‡ç¨‹</p>
<p><a target="_blank" rel="noopener" href="https://blog.laputa.io/kubernetes-flannel-networking-6a1cb1f8ec7c">å¯å‚çœ‹è¯¥ä½œè€…çš„ä¸€ç¯‡è¯¦ç»†åˆ†æ</a></p>
<p>çœ‹ä¸Šè¿°é“¾æ¥å§ï¼Œè®²çš„éå¸¸å¥½ï¼Œå›¾æ–‡å¹¶èŒ‚ï¼Œä¸‹é¢æˆ‘åªæ˜¯è‡ªæˆ‘æ¸©ä¹  ğŸ˜† åŠªåŠ›ç§¯ç´¯</p>
<p><strong>VM1 Container 1</strong></p>
<ul>
<li>Container 1 æŠ¥æ–‡ä¸­ src ip ä¸ºå®¹å™¨ ipï¼Œå‡è®¾ä¸º 10.1.15.2/24ï¼Œdst ip ä¸ºå¯¹ç«¯å®¹å™¨ ipï¼Œå‡è®¾ä¸º 10.1.20.3/24</li>
<li>æŠ¥æ–‡ä»å®¹å™¨ä¸­çš„ veth0 å‘å¾€ host ä¸Šçš„ veth pair (veth_XXX)</li>
<li>kernel æ ¹æ® route è¡¨å°†æŠ¥æ–‡è½¬å‘è‡³ Flannel0 TUN</li>
<li>Flannel0 æ¥æ”¶åˆ°ä¹‹å overlay çš„ä½œç”¨ä½“ç°äº†ï¼Œé¦–å…ˆæ ¹æ®ç›®çš„ ip æŸ¥è¯¢å…¶æ‰€åœ¨ host çš„ ipï¼Œå°è£…ä¸€å±‚ IP æŠ¥æ–‡ï¼Œéšåå°è£…ä¸€å±‚ UDP æŠ¥æ–‡ï¼ŒæŠ•é€’åˆ°å¯¹ç«¯ Flannel daemon ç›‘å¬ç«¯å£ 8285ã€‚è¿™ä¸ªæ—¶å€™æŠ¥æ–‡å°±èƒ½é€šè¿‡ underlay network è½¬å‘è‡³å¯¹ç«¯ host äº†</li>
</ul>
<p><strong>VM2 Container 2</strong></p>
<ul>
<li>æŠ¥æ–‡åˆ°è¾¾å½“å‰ host åï¼ŒUDP æŠ¥æ–‡äº¤ç”± Flannel daemon å¤„ç†</li>
<li>Flannel daemon äº¤ç”± Flannel0 TUN å¤„ç†</li>
<li>kernel ç›´æ¥æ ¹æ® route è¡¨å¤„ç†ï¼Œè½¬å‘è‡³ docker0</li>
<li>docker0 æ˜¯ç½‘æ¡¥è®¾å¤‡ï¼Œæ‰€æœ‰ docker container å‡è¿æ¥åœ¨å…¶ä¹‹ä¸Šï¼Œå› æ­¤æœ€åæ ¹æ® container dst ip è½¬å‘è‡³ dst container</li>
</ul>
<p>å½“ç„¶è¿™æ˜¯ Flannel æ—©æœŸçš„ç‰ˆæœ¬ï¼Œä½¿ç”¨äº† UDP çš„æŠ¥æ–‡å°è£…ï¼Œè¿™æ ·ä¼šæœ‰ä¸€äº› packet æ¥å›æ‹·è´çš„å¼€é”€</p>
<p>Flannel è¿˜æ”¯æŒ VxLan çš„æ¨¡å¼ï¼Œçœ‹ä¸‹å®ƒçš„åŸç†ï¼Œç½‘ç»œè¿™å—è¿˜æ˜¯æ¯”è¾ƒæœ‰æ„æ€</p>
<p>è¿™ç¯‡ä¹Ÿå¾ˆ nice <a target="_blank" rel="noopener" href="https://medium.com/@ApsOps/an-illustrated-guide-to-kubernetes-networking-part-2-13fdc6c4e24c">An illustrated guide to Kubernetes Networking [Part 2]</a></p>
<p>nice shot <a target="_blank" rel="noopener" href="https://medium.com/@ApsOps/an-illustrated-guide-to-kubernetes-networking-part-1-d1ede3322727">An illustrated guide to Kubernetes Networking [Part 1]</a></p>
<p>è¿™ç¯‡éå¸¸è¯¦ç»† â€¦ è›¤è›¤</p>
<p>ARP åè®®</p>
<p><a target="_blank" rel="noopener" href="https://www.geeksforgeeks.org/computer-network-arp-works/">ARP</a></p>
<p>Flannel <a target="_blank" rel="noopener" href="https://www.slideshare.net/enakai/how-vxlan-works-on-linux">VxLan</a></p>
<h1 id="Term"><a href="#Term" class="headerlink" title="Term"></a>Term</h1><p>ref <a target="_blank" rel="noopener" href="https://blog.laputa.io/kubernetes-flannel-networking-6a1cb1f8ec7c">Hanâ€™s blog</a></p>
<ul>
<li>TUN is a software interface implemented in linux kernel, it can pass raw ip packet between user program and the kernel</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/247bf619.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/247bf619.html" class="post-title-link" itemprop="url">neutron port</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-12-01 11:39:53" itemprop="dateCreated datePublished" datetime="2018-12-01T11:39:53Z">2018-12-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 03:42:46" itemprop="dateModified" datetime="2020-11-22T03:42:46Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.3k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Port"><a href="#Port" class="headerlink" title="Port"></a>Port</h1><h2 id="VIP"><a href="#VIP" class="headerlink" title="VIP"></a>VIP</h2><p>æŸ¥è¯¢è™šæ‹Ÿ IPï¼Œvia device_owner=neutron:VIP_PORT</p>
<p>è™šæ‹Ÿ IP ç»‘å®šçš„ IPï¼ˆç½‘å¡ï¼‰ allowed_address_pairs</p>
<p>ä¾‹å¦‚ VIP 192.168.186.192</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">allowed_address_pairs: [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ip_address&quot;</span>: <span class="string">&quot;192.168.129.104&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;mac_address&quot;</span>: <span class="string">&quot;fa:16:3e:6e:e0:d8&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;ip_address&quot;</span>: <span class="string">&quot;192.168.155.84&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;mac_address&quot;</span>: <span class="string">&quot;fa:16:3e:6e:e0:d8&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>VIP å¯æ‰‹åŠ¨é…ç½®è‡³ç½‘å¡ï¼Œä¾‹å¦‚ç»™ eth0 é…ç½® vipï¼ˆip åˆ«åï¼‰ï¼Œä½¿å¾— eth0 å­˜åœ¨å¤šä¸ª ip</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ifconfig eth0:1 192.168.0.107 netmask 255.255.0.0</span><br></pre></td></tr></table></figure>

<p>äº¦æˆ–è€…ç›´æ¥æ·»åŠ  ip è‡³ dev eth0</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ip addr add 192.168.2.105/24 dev eth0</span><br></pre></td></tr></table></figure>

<p>å¸¸è§åšæ³•æ˜¯å¤–éƒ¨é€šè¿‡ VIP è®¿é—®æœåŠ¡ï¼ŒæœåŠ¡ä½¿ç”¨ Keeplive ç»„ä»¶å®ç° VIP åœ¨å¤šä¸ªåç«¯èŠ‚ç‚¹æ¼‚ç§»ï¼Œä»è€Œå®ç°æœåŠ¡ HA</p>
<h2 id="ECS-IP"><a href="#ECS-IP" class="headerlink" title="ECS IP"></a>ECS IP</h2><p>æŸ¥è¯¢ ECS IPï¼ˆç½‘å¡ï¼‰ï¼Œvia device_id</p>
<p>ä¾‹å¦‚ device_id=fe6b212b-9b84-4c0a-8137-528be40f0b04ï¼Œå³ ECS ID</p>
<p>ä¸»ç½‘å¡æœ‰å¦‚ä¸‹å­—æ®µ</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;primary_interface&quot;</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>VIP è®¾è®¡ä¸ºç»‘å®šåœ¨å…¶ä»– IP ä¸Šï¼Œå› æ­¤å…¶ä¸å­˜åœ¨ port_id (ç½‘å¡ IP)ï¼Œä»…å­˜åœ¨è‡ªèº«çš„ vip_port_idï¼Œè‹¥ VIP è¢«å¤šä¸ª IP ç»‘å®šï¼Œåˆ™å…¶å¯¹åº”å¤šä¸ª port_id</p>
<p>openstack åˆ›å»º ECS è¿‡ç¨‹ï¼Œé¦–å…ˆä½¿ç”¨ neutron å‘½ä»¤åˆ›å»º port (ä¸»ç½‘å¡)ï¼Œå…¶æ¬¡ä½¿ç”¨ cinder å‘½ä»¤åˆ›å»ºç³»ç»Ÿç›˜ï¼Œæœ€åä½¿ç”¨ nova å‘½ä»¤æ ¹æ®ä¸»ç½‘å¡åŠç³»ç»Ÿç›˜åˆ›å»ºå‡º ECS å®ä¾‹</p>
<h2 id="ALL-IP"><a href="#ALL-IP" class="headerlink" title="ALL IP"></a>ALL IP</h2><p>æŸ¥è¯¢ ALL IPï¼Œvia network_id</p>
<p>ä¾‹å¦‚ network_id=8b8457ab-521a-4da0-9cd4-aee1688ee0f8ï¼Œå³ VPC ID</p>
<p>ç»“æœåŒ…æ‹¬ ECS IPã€VIP ç­‰</p>
<h2 id="Up-Down"><a href="#Up-Down" class="headerlink" title="Up / Down"></a>Up / Down</h2><ul>
<li>up å¯ç”¨ network interface</li>
<li>down åœç”¨ network interface</li>
</ul>
<h1 id="VPC"><a href="#VPC" class="headerlink" title="VPC"></a>VPC</h1><p>VPC è®¿é—®æ–¹æ¡ˆ</p>
<h2 id="VPC-Endpoint"><a href="#VPC-Endpoint" class="headerlink" title="VPC Endpoint"></a>VPC Endpoint</h2><p>ä¼˜åŠ¿</p>
<ul>
<li>å‘å¸ƒå¤„äº VPC ä¸­çš„æœåŠ¡ï¼Œä¾›å¤–éƒ¨ä½¿ç”¨</li>
</ul>
<p>é™åˆ¶</p>
<ul>
<li>æœåŠ¡å‘å¸ƒæ–¹å‘å¸ƒæœåŠ¡åï¼Œéœ€å°†æœåŠ¡æ ‡è¯†å‘ŠçŸ¥ä½¿ç”¨æ–¹</li>
<li>ä½¿ç”¨æ–¹åœ¨æœ¬ VPC ä¸­ï¼Œé€šè¿‡åˆ›å»º VPC Endpoint ä»¥è®¿é—®æœåŠ¡å‘å¸ƒæ–¹ VPC ä¸­æä¾›çš„æœåŠ¡ï¼ŒVPC Endpoint éœ€æ¶ˆè€— æœ¬ VPC çš„ä¸€ä¸ª IP èµ„æº</li>
</ul>
<h2 id="VPC-Peering"><a href="#VPC-Peering" class="headerlink" title="VPC Peering"></a>VPC Peering</h2><p>ä¼˜åŠ¿</p>
<ul>
<li>VPC å…¨äº’é€š</li>
</ul>
<p>é™åˆ¶</p>
<ul>
<li>å¯¹äº VPC Peering æ¥è¯´ï¼Œæœ‰ç½‘æ®µåŠå­ç½‘çš„é™åˆ¶ ï¼Œè‹¥å†²çªåˆ™æ— æ³• Peering</li>
<li>VPC Peering ä»…åœ¨ä¸»ç½‘å¡ç”Ÿæ•ˆï¼Œå¯¹äºå¤šç½‘å¡çš„ä¸»æœºï¼Œéœ€é¢å¤–è®¾ç½®è·¯ç”±è§„åˆ™ï¼Œä½¿å¾—ä¸ VPC Peering é€šä¿¡çš„æŠ¥æ–‡è¢«æ­£ç¡®è½¬å‘è‡³ä¸»ç½‘å¡</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/9df565e8.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/9df565e8.html" class="post-title-link" itemprop="url">finally storage driver in docker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-18 11:43:37" itemprop="dateCreated datePublished" datetime="2018-11-18T11:43:37Z">2018-11-18</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 03:45:22" itemprop="dateModified" datetime="2020-11-22T03:45:22Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>2 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>å½“ç„¶æœ‰ç‚¹å„¿æ ‡é¢˜å…šçš„æ„æ€</p>
</blockquote>
<p>å­¦ä¹ åˆ°è¿™å‘¢ï¼Œå·²ç»å¤§æ¦‚æœ‰ç‚¹å„¿æ„Ÿè§‰äº†</p>
<h1 id="union-fs"><a href="#union-fs" class="headerlink" title="union fs"></a>union fs</h1><p>docker container çš„ root fsï¼Œæœ¬è´¨ä¸Šå‘¢éƒ½å« ufs æŠ€æœ¯ï¼Œunion file system</p>
<p>docker ç”¨å®ƒæ¥å¹²å•¥çš„ï¼Œé•œåƒä¸æ˜¯åˆ†å±‚çš„å˜›ï¼Œdocker ç”¨è¿™ç©æ„å„¿æŠ€æœ¯æ¥æŠŠæ‰€æœ‰å±‚ union æˆä¸€ä¸ªå•ä¸€çš„ fsï¼Œç»™ç”¨æˆ·ä½¿ç”¨</p>
<p>è¿™å°±æ˜¯ docker container root fs çš„åŸºç¡€äº†</p>
<p>é—®é¢˜å°±æ¥äº†ï¼Œç°åœ¨ä¸ä¾èµ– dockerd å’‹ union file systemï¼Œäºæ˜¯ä¹åœ¨ google ä¸­æœç´¢äº†ä¸‹ union file system impl in golangï¼Œå‘ç°äº†ä¸ªé¡¹ç›®ï¼Œè¿˜æŒºæœ‰æ„æ€</p>
<p><a target="_blank" rel="noopener" href="https://github.com/spf13/afero">https://github.com/spf13/afero</a></p>
<p>readme ä¸­æåˆ°å®ƒå¯ä»¥å¹²</p>
<ul>
<li>Support for compositional (union) file systems by combining multiple file systems acting as one</li>
</ul>
<p>çœ‹çœ‹èƒ½ä¸èƒ½ç”¨å§</p>
<p>æ˜¾ç„¶ä¸èƒ½ â€¦ ç²—ç•¥ä¸€æ‰«ï¼Œå°±æ˜¯ä¸€äº› os api å°è£…ï¼Œæ–‡æ¡£ä¹Ÿä¸å‹å¥½ sigh</p>
<h1 id="still-docker-pull"><a href="#still-docker-pull" class="headerlink" title="still docker pull"></a>still docker pull</h1><p>docker pull çš„å¤§æ¦‚è¿‡ç¨‹ï¼Œpull é•œåƒï¼Œéšåä½¿ç”¨ graph driver union mountï¼Œæœ€åæŠŠ image æ³¨å†Œåˆ° layer store</p>
<p>æ€ä¹ˆçœ‹çš„ï¼Œåœ¨ daemon/graphdriver/aufs å¾€ä¸Šæœå°±è¡Œï¼Œæœ€åå‘ç° docker pull ä¹Ÿç”¨äº†å®ƒ</p>
<p>æ‰€ä»¥å›ç­”ä¸Šç¯‡çš„é—®é¢˜ æ‰«æé•œåƒæ—¶ï¼Œä¸ºä½•ä¸æŠŠ layer union ä¹‹åï¼Œå†æ‰«æï¼Œçœ‹åˆ°è¿™ï¼Œè¯¸ä½å¯èƒ½å·²ç»å‘ç°ä¸å¥½å®ç°å‘€</p>
<p>èƒ½ä¸èƒ½å®ç°ï¼Œå½“ç„¶èƒ½ï¼</p>
<ol>
<li>æŒ‰ç…§è¿™é‡Œæ‰€è¯´ loading-an-image-filesystem-changeset<br> 1.1 untar root layer to a dir (act as container root fs)<br> 1.2 untar each layer to the previous dir, and walk once, rm any file with .wh. prefix and its coresponding file<br> 1.3 continue this process<br> 1.4 â€¦ pay attention, å¯èƒ½æœ‰ç«¥é‹ä¼šè§‰å¾—è¿™ä¸ªç»†èŠ‚å¯èƒ½å›  storage driver è€Œå¼‚ï¼Œå®åˆ™ä¸ç„¶ï¼Œimage tar archive çš„æ ¼å¼æ˜¯ç‹¬ç«‹äº storage driver çš„</li>
<li>ç†Ÿæ‚‰ docker layer ä»£ç çš„è€é“ï¼Œæ²¡å‡†èƒ½æŠŠè¿™éƒ¨åˆ†ä»£ç ç»™æ•´å‡ºä¸ªç‹¬ç«‹çš„ lib æ¥ï¼Œå®ç°æŠŠ image layer union mount ä¹‹åï¼Œç»™æ‰«æç¨‹åºä¸€ä¸ªç»Ÿä¸€çš„ fs view, ä½†æ˜¯æ˜¾ç„¶å®ƒä¾èµ–äº storage driver çš„èƒ½åŠ›ï¼Œä½ è¦æƒ³åœ¨å®¹å™¨é‡Œé¢å¹²è¿™ä¸ªäº‹æƒ…ï¼Œæˆ‘å°± ğŸ™„ äº†ã€‚è¦æ˜¯éå¾—åœ¨å®¹å™¨é‡Œè¿™ä¹ˆæŠ˜è…¾ï¼Œä¸å¦‚ç›´æ¥æŒ‚ docker socket åˆ°å®¹å™¨é‡Œï¼Œç”¨å®¿ä¸»æœºçš„ dockerd ç›´æ¥ææ¥çš„å¿«äº›ï¼ŒåºŸè¿™å¤§åŠ²å„¿ sucks</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/storage/storagedriver/">https://docs.docker.com/storage/storagedriver/</a><br>Storage drivers allow you to create data in the writable layer of your container. The files wonâ€™t be persisted after the container is deleted, and both read and write speeds are low.</p>
</blockquote>
<p>ä¹Ÿæ˜¯å¤Ÿç²¾è¾Ÿ</p>
<p>ä¸è¿‡æˆ‘è¿˜æ˜¯æœ‰ä¸ªç–‘é—®ï¼Œä¸åŒ storage driver å®ç°åˆ†å±‚é•œåƒçš„ç»†èŠ‚ä¸åŒï¼Œdocker save çš„æ—¶å€™ï¼Œæ˜¯æ€ä¹ˆæŠŠä¸åŒ storage driver çš„ layer èƒ½ç»Ÿä¸€åˆ° Image Tar File Archive é‡Œé¢å»çš„</p>
<p>æ‰‹å¤´ä¸Šæ²¡æœ‰è¯•éªŒ devicemapper çš„æœºå™¨ï¼ŒæŒ‰è¯´ divicemapper å®ç°åˆ†å±‚é•œåƒç”¨çš„æ˜¯ snapshot æŠ€æœ¯ï¼Œæ‰€ä»¥åˆ é™¤æ–‡ä»¶çš„æ—¶å€™ï¼Œå½“å‰ layer å¹¶ä¸ä¼šæœ‰ .wh. æ–‡ä»¶æ‰å¯¹</p>
<p>è¿™ä¹ˆè¯´æ¥ï¼Œä¼¼ä¹æ˜¯ layer diff æ˜¯ docker è‡ªå·±ç®—å‡ºæ¥çš„äº†ï¼Œåˆ é™¤çš„æ–‡ä»¶ï¼Œç»™æ ‡è®°ä¸Š .wh. ?</p>
<p>whatever it needs time to cover it</p>
<p><a target="_blank" rel="noopener" href="https://learn-docker-the-hard-way.readthedocs.io/zh_CN/latest/">https://learn-docker-the-hard-way.readthedocs.io/zh_CN/latest/</a></p>
<p>æœ€åçš„æ—¶å€™ï¼Œå‘ç° google åˆä¸ºä¸–ç•Œé€ è½®å­äº†</p>
<p><a target="_blank" rel="noopener" href="https://github.com/GoogleContainerTools/container-diff">https://github.com/GoogleContainerTools/container-diff</a></p>
<p>è¡Œå§ï¼Œgoogle å¤§ä½¬å·²ç»åšäº†ï¼Œè€Œä¸”çš„ç¡®æœ‰ libï¼Œæ•ˆæœå¥½ä¸å¥½é‚£å°±å†è¯´äº†ï¼Œè¿™ä¸ªåº“åŸºæœ¬ä¸Šå®ç°äº† fundamental çš„ loading-an-image-filesystem-changeset æè¿°çš„è¿‡ç¨‹</p>
<p>å½“ç„¶å› ä¸ºæ˜¯ file diffï¼Œæ‰€ä»¥æƒé™æ¢å¤ä¸å‡ºæ¥çš„</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/1d091a1a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/1d091a1a.html" class="post-title-link" itemprop="url">docker image tar archieve</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-17 14:02:27" itemprop="dateCreated datePublished" datetime="2018-11-17T14:02:27Z">2018-11-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 06:05:41" itemprop="dateModified" datetime="2020-11-22T06:05:41Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>20k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>18 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>ç®€æ crane pull image è¿‡ç¨‹</p>
<p>è¯¦ç»†è¿‡ç¨‹åœ¨å†…ç½‘å†™äº†ï¼Œç²—ç•¥è¿‡ç¨‹ç½—åˆ—äºæ­¤</p>
<p>ä»¥ docker hub registry ä¸ºä¾‹</p>
<p>ä»¥ crane äºŒè¿›åˆ¶å·¥å…·ä¸ºå‚è€ƒ</p>
<p><a target="_blank" rel="noopener" href="https://github.com/google/go-containerregistry/blob/master/cmd/crane/doc/crane.md">https://github.com/google/go-containerregistry/blob/master/cmd/crane/doc/crane.md</a></p>
<p>google çš„åŒäº‹çœŸæ˜¯ä¸ºä¸–ç•Œé€ è½®å­ï¼Œmany thanks</p>
<h1 id="Target"><a href="#Target" class="headerlink" title="Target"></a>Target</h1><p>ä» registry ä¸‹è½½ nginx:latest é•œåƒ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull nginx:latest</span><br></pre></td></tr></table></figure>

<h1 id="Auth"><a href="#Auth" class="headerlink" title="Auth"></a>Auth</h1><p><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/spec/auth/token/#requesting-a-token">https://docs.docker.com/registry/spec/auth/token/#requesting-a-token</a></p>
<ol>
<li>ping registry</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">curl -i https://registry.hub.docker.com/v2/</span><br><span class="line">HTTP/1.1 401 Unauthorized</span><br><span class="line">Content-Type: application/json; charset=utf-8</span><br><span class="line">Docker-Distribution-Api-Version: registry/2.0</span><br><span class="line">Www-Authenticate: Bearer realm=<span class="string">&quot;https://auth.docker.io/token&quot;</span>,service=<span class="string">&quot;registry.docker.io&quot;</span></span><br><span class="line">Date: Sat, 17 Nov 2018 01:27:49 GMT</span><br><span class="line">Content-Length: 87</span><br><span class="line">Strict-Transport-Security: max-age=31536000</span><br></pre></td></tr></table></figure>

<p>åœ¨ Www-Authenticate è¯·æ±‚å¤´ä¸­å¯è§ Registry ä½¿ç”¨ Bearer è®¤è¯æ–¹å¼</p>
<ol start="2">
<li>refresh docker auth</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">curl &quot;https://auth.docker.io/token?service=registry.docker.io&amp;scope=repository:library/nginx:pull&quot; | python -mjson.tool</span><br><span class="line">&#123;</span><br><span class="line">    &quot;token&quot;: &quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsIng1YyI6WyJNSUlDK2pDQ0FwK2dBd0lCQWdJQkFEQUtCZ2dxaGtqT1BRUURBakJHTVVRd1FnWURWUVFERXpzeVYwNVpPbFZMUzFJNlJFMUVVanBTU1U5Rk9reEhOa0U2UTFWWVZEcE5SbFZNT2tZelNFVTZOVkF5VlRwTFNqTkdPa05CTmxrNlNrbEVVVEFlRncweE9EQXlNVFF5TXpBMk5EZGFGdzB4T1RBeU1UUXlNekEyTkRkYU1FWXhSREJDQmdOVkJBTVRPMVpCUTFZNk5VNWFNenBNTkZSWk9sQlFTbGc2VWsxQlZEcEdWalpQT2xZMU1sTTZRa2szV2pwU1REVk9PbGhXVDBJNlFsTmFSanBHVTFRMk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBMGtyTmgyZWxESnVvYjVERWd5Wi9oZ3l1ZlpxNHo0OXdvNStGRnFRK3VPTGNCMDRyc3N4cnVNdm1aSzJZQ0RSRVRERU9xNW5keEVMMHNaTE51UXRMSlNRdFY1YUhlY2dQVFRkeVJHUTl2aURPWGlqNFBocE40R0N0eFV6YTNKWlNDZC9qbm1YbmtUeDViOElUWXBCZzg2TGNUdmMyRFVUV2tHNy91UThrVjVPNFFxNlZKY05TUWRId1B2Mmp4YWRZa3hBMnhaaWNvRFNFQlpjWGRneUFCRWI2YkRnUzV3QjdtYjRRVXBuM3FXRnRqdCttKzBsdDZOR3hvenNOSFJHd3EwakpqNWtZbWFnWHpEQm5NQ3l5eDFBWFpkMHBNaUlPSjhsaDhRQ09GMStsMkVuV1U1K0thaTZKYVNEOFZJc2VrRzB3YXd4T1dER3U0YzYreE1XYUx3SURBUUFCbzRHeU1JR3ZNQTRHQTFVZER3RUIvd1FFQXdJSGdEQVBCZ05WSFNVRUNEQUdCZ1JWSFNVQU1FUUdBMVVkRGdROUJEdFdRVU5XT2pWT1dqTTZURFJVV1RwUVVFcFlPbEpOUVZRNlJsWTJUenBXTlRKVE9rSkpOMW82VWt3MVRqcFlWazlDT2tKVFdrWTZSbE5VTmpCR0JnTlZIU01FUHpBOWdEc3lWMDVaT2xWTFMxSTZSRTFFVWpwU1NVOUZPa3hITmtFNlExVllWRHBOUmxWTU9rWXpTRVU2TlZBeVZUcExTak5HT2tOQk5sazZTa2xFVVRBS0JnZ3Foa2pPUFFRREFnTkpBREJHQWlFQWdZTWF3Si9uMXM0dDlva0VhRjh2aGVkeURzbERObWNyTHNRNldmWTFmRTRDSVFEbzNWazJXcndiSjNmU1dwZEVjT3hNazZ1ZEFwK2c1Nkd6TjlRSGFNeVZ1QT09Il19.eyJhY2Nlc3MiOlt7InR5cGUiOiJyZXBvc2l0b3J5IiwibmFtZSI6ImxpYnJhcnkvbmdpbngiLCJhY3Rpb25zIjpbInB1bGwiXX1dLCJhdWQiOiJyZWdpc3RyeS5kb2NrZXIuaW8iLCJleHAiOjE1NDI0MTg2MjgsImlhdCI6MTU0MjQxODMyOCwiaXNzIjoiYXV0aC5kb2NrZXIuaW8iLCJqdGkiOiI1SG5JQllqVkluZERFYlRkRlUzOSIsIm5iZiI6MTU0MjQxODAyOCwic3ViIjoiIn0.zzVk9t-govqoyzQCwHfivOAkdIG0D6r5RoMS7HRq4vOBj1bQdASOfB6YqVLGWP6G-4cf6ESCDTxdidREgZYnklpApX7dYdrAf6OpxA5HXP5MYDMTE7PEZueoUpBipz0UsPI4lzMC1j80UjjgTVHyjiIMcwgxPXpT6-zPJJFp9EjDrLsBHtj2cdmPv_54KA0j50VQLZKccUvC67z0iT5KpSRvKyFcWLEActeCnmuZjkJgySmaVduVfLiDLFbboBOw0mNLeTFIodfHoEdFqYBooBK1d_x37GFCSunYH8fFZ0XkfS7OFDyaYiOlQzafbnz0TxLIUU-jOEsJkaofOnHF2Q&quot;,</span><br><span class="line">    &quot;access_token&quot;: &quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsIng1YyI6WyJNSUlDK2pDQ0FwK2dBd0lCQWdJQkFEQUtCZ2dxaGtqT1BRUURBakJHTVVRd1FnWURWUVFERXpzeVYwNVpPbFZMUzFJNlJFMUVVanBTU1U5Rk9reEhOa0U2UTFWWVZEcE5SbFZNT2tZelNFVTZOVkF5VlRwTFNqTkdPa05CTmxrNlNrbEVVVEFlRncweE9EQXlNVFF5TXpBMk5EZGFGdzB4T1RBeU1UUXlNekEyTkRkYU1FWXhSREJDQmdOVkJBTVRPMVpCUTFZNk5VNWFNenBNTkZSWk9sQlFTbGc2VWsxQlZEcEdWalpQT2xZMU1sTTZRa2szV2pwU1REVk9PbGhXVDBJNlFsTmFSanBHVTFRMk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBMGtyTmgyZWxESnVvYjVERWd5Wi9oZ3l1ZlpxNHo0OXdvNStGRnFRK3VPTGNCMDRyc3N4cnVNdm1aSzJZQ0RSRVRERU9xNW5keEVMMHNaTE51UXRMSlNRdFY1YUhlY2dQVFRkeVJHUTl2aURPWGlqNFBocE40R0N0eFV6YTNKWlNDZC9qbm1YbmtUeDViOElUWXBCZzg2TGNUdmMyRFVUV2tHNy91UThrVjVPNFFxNlZKY05TUWRId1B2Mmp4YWRZa3hBMnhaaWNvRFNFQlpjWGRneUFCRWI2YkRnUzV3QjdtYjRRVXBuM3FXRnRqdCttKzBsdDZOR3hvenNOSFJHd3EwakpqNWtZbWFnWHpEQm5NQ3l5eDFBWFpkMHBNaUlPSjhsaDhRQ09GMStsMkVuV1U1K0thaTZKYVNEOFZJc2VrRzB3YXd4T1dER3U0YzYreE1XYUx3SURBUUFCbzRHeU1JR3ZNQTRHQTFVZER3RUIvd1FFQXdJSGdEQVBCZ05WSFNVRUNEQUdCZ1JWSFNVQU1FUUdBMVVkRGdROUJEdFdRVU5XT2pWT1dqTTZURFJVV1RwUVVFcFlPbEpOUVZRNlJsWTJUenBXTlRKVE9rSkpOMW82VWt3MVRqcFlWazlDT2tKVFdrWTZSbE5VTmpCR0JnTlZIU01FUHpBOWdEc3lWMDVaT2xWTFMxSTZSRTFFVWpwU1NVOUZPa3hITmtFNlExVllWRHBOUmxWTU9rWXpTRVU2TlZBeVZUcExTak5HT2tOQk5sazZTa2xFVVRBS0JnZ3Foa2pPUFFRREFnTkpBREJHQWlFQWdZTWF3Si9uMXM0dDlva0VhRjh2aGVkeURzbERObWNyTHNRNldmWTFmRTRDSVFEbzNWazJXcndiSjNmU1dwZEVjT3hNazZ1ZEFwK2c1Nkd6TjlRSGFNeVZ1QT09Il19.eyJhY2Nlc3MiOlt7InR5cGUiOiJyZXBvc2l0b3J5IiwibmFtZSI6ImxpYnJhcnkvbmdpbngiLCJhY3Rpb25zIjpbInB1bGwiXX1dLCJhdWQiOiJyZWdpc3RyeS5kb2NrZXIuaW8iLCJleHAiOjE1NDI0MTg2MjgsImlhdCI6MTU0MjQxODMyOCwiaXNzIjoiYXV0aC5kb2NrZXIuaW8iLCJqdGkiOiI1SG5JQllqVkluZERFYlRkRlUzOSIsIm5iZiI6MTU0MjQxODAyOCwic3ViIjoiIn0.zzVk9t-govqoyzQCwHfivOAkdIG0D6r5RoMS7HRq4vOBj1bQdASOfB6YqVLGWP6G-4cf6ESCDTxdidREgZYnklpApX7dYdrAf6OpxA5HXP5MYDMTE7PEZueoUpBipz0UsPI4lzMC1j80UjjgTVHyjiIMcwgxPXpT6-zPJJFp9EjDrLsBHtj2cdmPv_54KA0j50VQLZKccUvC67z0iT5KpSRvKyFcWLEActeCnmuZjkJgySmaVduVfLiDLFbboBOw0mNLeTFIodfHoEdFqYBooBK1d_x37GFCSunYH8fFZ0XkfS7OFDyaYiOlQzafbnz0TxLIUU-jOEsJkaofOnHF2Q&quot;,</span><br><span class="line">    &quot;expires_in&quot;: 300,</span><br><span class="line">    &quot;issued_at&quot;: &quot;2018-11-17T01:32:08.367366757Z&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è®¾ç½® token var</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCIsIng1YyI6WyJNSUlDK2pDQ0FwK2dBd0lCQWdJQkFEQUtCZ2dxaGtqT1BRUURBakJHTVVRd1FnWURWUVFERXpzeVYwNVpPbFZMUzFJNlJFMUVVanBTU1U5Rk9reEhOa0U2UTFWWVZEcE5SbFZNT2tZelNFVTZOVkF5VlRwTFNqTkdPa05CTmxrNlNrbEVVVEFlRncweE9EQXlNVFF5TXpBMk5EZGFGdzB4T1RBeU1UUXlNekEyTkRkYU1FWXhSREJDQmdOVkJBTVRPMVpCUTFZNk5VNWFNenBNTkZSWk9sQlFTbGc2VWsxQlZEcEdWalpQT2xZMU1sTTZRa2szV2pwU1REVk9PbGhXVDBJNlFsTmFSanBHVTFRMk1JSUJJakFOQmdrcWhraUc5dzBCQVFFRkFBT0NBUThBTUlJQkNnS0NBUUVBMGtyTmgyZWxESnVvYjVERWd5Wi9oZ3l1ZlpxNHo0OXdvNStGRnFRK3VPTGNCMDRyc3N4cnVNdm1aSzJZQ0RSRVRERU9xNW5keEVMMHNaTE51UXRMSlNRdFY1YUhlY2dQVFRkeVJHUTl2aURPWGlqNFBocE40R0N0eFV6YTNKWlNDZC9qbm1YbmtUeDViOElUWXBCZzg2TGNUdmMyRFVUV2tHNy91UThrVjVPNFFxNlZKY05TUWRId1B2Mmp4YWRZa3hBMnhaaWNvRFNFQlpjWGRneUFCRWI2YkRnUzV3QjdtYjRRVXBuM3FXRnRqdCttKzBsdDZOR3hvenNOSFJHd3EwakpqNWtZbWFnWHpEQm5NQ3l5eDFBWFpkMHBNaUlPSjhsaDhRQ09GMStsMkVuV1U1K0thaTZKYVNEOFZJc2VrRzB3YXd4T1dER3U0YzYreE1XYUx3SURBUUFCbzRHeU1JR3ZNQTRHQTFVZER3RUIvd1FFQXdJSGdEQVBCZ05WSFNVRUNEQUdCZ1JWSFNVQU1FUUdBMVVkRGdROUJEdFdRVU5XT2pWT1dqTTZURFJVV1RwUVVFcFlPbEpOUVZRNlJsWTJUenBXTlRKVE9rSkpOMW82VWt3MVRqcFlWazlDT2tKVFdrWTZSbE5VTmpCR0JnTlZIU01FUHpBOWdEc3lWMDVaT2xWTFMxSTZSRTFFVWpwU1NVOUZPa3hITmtFNlExVllWRHBOUmxWTU9rWXpTRVU2TlZBeVZUcExTak5HT2tOQk5sazZTa2xFVVRBS0JnZ3Foa2pPUFFRREFnTkpBREJHQWlFQWdZTWF3Si9uMXM0dDlva0VhRjh2aGVkeURzbERObWNyTHNRNldmWTFmRTRDSVFEbzNWazJXcndiSjNmU1dwZEVjT3hNazZ1ZEFwK2c1Nkd6TjlRSGFNeVZ1QT09Il19.eyJhY2Nlc3MiOlt7InR5cGUiOiJyZXBvc2l0b3J5IiwibmFtZSI6ImxpYnJhcnkvbmdpbngiLCJhY3Rpb25zIjpbInB1bGwiXX1dLCJhdWQiOiJyZWdpc3RyeS5kb2NrZXIuaW8iLCJleHAiOjE1NDI0MTg2MjgsImlhdCI6MTU0MjQxODMyOCwiaXNzIjoiYXV0aC5kb2NrZXIuaW8iLCJqdGkiOiI1SG5JQllqVkluZERFYlRkRlUzOSIsIm5iZiI6MTU0MjQxODAyOCwic3ViIjoiIn0.zzVk9t-govqoyzQCwHfivOAkdIG0D6r5RoMS7HRq4vOBj1bQdASOfB6YqVLGWP6G-4cf6ESCDTxdidREgZYnklpApX7dYdrAf6OpxA5HXP5MYDMTE7PEZueoUpBipz0UsPI4lzMC1j80UjjgTVHyjiIMcwgxPXpT6-zPJJFp9EjDrLsBHtj2cdmPv_54KA0j50VQLZKccUvC67z0iT5KpSRvKyFcWLEActeCnmuZjkJgySmaVduVfLiDLFbboBOw0mNLeTFIodfHoEdFqYBooBK1d_x37GFCSunYH8fFZ0XkfS7OFDyaYiOlQzafbnz0TxLIUU-jOEsJkaofOnHF2Q</span><br></pre></td></tr></table></figure>

<h1 id="Pull"><a href="#Pull" class="headerlink" title="Pull"></a>Pull</h1><ol>
<li>Get Image Manifest</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">curl -v -H &quot;Authorization: Bearer $token&quot; -H &quot;Accept: application/vnd.docker.distribution.manifest.v2+json&quot; &quot;https://registry.hub.docker.com/v2/library/nginx/manifests/latest&quot;</span><br><span class="line">resp</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;schemaVersion&quot;: 2,</span><br><span class="line">    &quot;mediaType&quot;: &quot;application/vnd.docker.distribution.manifest.v2+json&quot;,</span><br><span class="line">    &quot;config&quot;: &#123;</span><br><span class="line">        &quot;mediaType&quot;: &quot;application/vnd.docker.container.image.v1+json&quot;,</span><br><span class="line">        &quot;size&quot;: 6022,</span><br><span class="line">        &quot;digest&quot;: &quot;sha256:e81eb098537d6c4a75438eacc6a2ed94af74ca168076f719f3a0558bd24d646a&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;layers&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;mediaType&quot;: &quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;,</span><br><span class="line">            &quot;size&quot;: 22486277,</span><br><span class="line">            &quot;digest&quot;: &quot;sha256:a5a6f2f73cd8abbdc55d0df0d8834f7262713e87d6c8800ea3851f103025e0f0&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;mediaType&quot;: &quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;,</span><br><span class="line">            &quot;size&quot;: 22204196,</span><br><span class="line">            &quot;digest&quot;: &quot;sha256:67da5fbcb7a04397eda35dccb073d8569d28de13172fbd569fbb7a3e30b5886b&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;mediaType&quot;: &quot;application/vnd.docker.image.rootfs.diff.tar.gzip&quot;,</span><br><span class="line">            &quot;size&quot;: 203,</span><br><span class="line">            &quot;digest&quot;: &quot;sha256:e82455fa5628738170735528c8db36567b5423ec59802a1e2c084ed42b082527&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>Get Image Config</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">curl -i -H &quot;Authorization: Bearer $token&quot; &quot;https://registry.hub.docker.com/v2/library/nginx/blobs/sha256:e81eb098537d6c4a75438eacc6a2ed94af74ca168076f719f3a0558bd24d646a&quot;</span><br><span class="line">HTTP/1.1 307 Temporary Redirect</span><br><span class="line">Content-Type: text/html; charset=utf-8</span><br><span class="line">Docker-Distribution-Api-Version: registry/2.0</span><br><span class="line">Location: https://production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/e8/e81eb098537d6c4a75438eacc6a2ed94af74ca168076f719f3a0558bd24d646a/data?verify=1542423249-8ogA6RSAc3PlmtNd%2FOuiIuAUo3c%3D</span><br><span class="line">Date: Sat, 17 Nov 2018 02:04:09 GMT</span><br><span class="line">Content-Length: 244</span><br><span class="line">Strict-Transport-Security: max-age=31536000</span><br><span class="line">redirect</span><br><span class="line"></span><br><span class="line">curl https://production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/e8/e81eb098537d6c4a75438eacc6a2ed94af74ca168076f719f3a0558bd24d646a/data?verify=1542423249-8ogA6RSAc3PlmtNd%2FOuiIuAUo3c%3D | python -mjson.tool</span><br><span class="line">config json file</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;architecture&quot;: &quot;amd64&quot;,</span><br><span class="line">    &quot;config&quot;: &#123;</span><br><span class="line">        &quot;Hostname&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">        &quot;User&quot;: &quot;&quot;,</span><br><span class="line">        &quot;AttachStdin&quot;: false,</span><br><span class="line">        &quot;AttachStdout&quot;: false,</span><br><span class="line">        &quot;AttachStderr&quot;: false,</span><br><span class="line">        &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">            &quot;80/tcp&quot;: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Tty&quot;: false,</span><br><span class="line">        &quot;OpenStdin&quot;: false,</span><br><span class="line">        &quot;StdinOnce&quot;: false,</span><br><span class="line">        &quot;Env&quot;: [</span><br><span class="line">            &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;,</span><br><span class="line">            &quot;NGINX_VERSION=1.15.6-1~stretch&quot;,</span><br><span class="line">            &quot;NJS_VERSION=1.15.6.0.2.5-1~stretch&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Cmd&quot;: [</span><br><span class="line">            &quot;nginx&quot;,</span><br><span class="line">            &quot;-g&quot;,</span><br><span class="line">            &quot;daemon off;&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;ArgsEscaped&quot;: true,</span><br><span class="line">        &quot;Image&quot;: &quot;sha256:eb4657966d3e92498b450e24969a0a2808f254ab44102f31674543f642e35ed7&quot;,</span><br><span class="line">        &quot;Volumes&quot;: null,</span><br><span class="line">        &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Entrypoint&quot;: null,</span><br><span class="line">        &quot;OnBuild&quot;: [],</span><br><span class="line">        &quot;Labels&quot;: &#123;</span><br><span class="line">            &quot;maintainer&quot;: &quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;StopSignal&quot;: &quot;SIGTERM&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;container&quot;: &quot;d4fa15093ad8ad3df60d7403c1752a379503686e32a76b70771b3ea268ec5d66&quot;,</span><br><span class="line">    &quot;container_config&quot;: &#123;</span><br><span class="line">        &quot;Hostname&quot;: &quot;d4fa15093ad8&quot;,</span><br><span class="line">        &quot;Domainname&quot;: &quot;&quot;,</span><br><span class="line">        &quot;User&quot;: &quot;&quot;,</span><br><span class="line">        &quot;AttachStdin&quot;: false,</span><br><span class="line">        &quot;AttachStdout&quot;: false,</span><br><span class="line">        &quot;AttachStderr&quot;: false,</span><br><span class="line">        &quot;ExposedPorts&quot;: &#123;</span><br><span class="line">            &quot;80/tcp&quot;: &#123;&#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;Tty&quot;: false,</span><br><span class="line">        &quot;OpenStdin&quot;: false,</span><br><span class="line">        &quot;StdinOnce&quot;: false,</span><br><span class="line">        &quot;Env&quot;: [</span><br><span class="line">            &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;,</span><br><span class="line">            &quot;NGINX_VERSION=1.15.6-1~stretch&quot;,</span><br><span class="line">            &quot;NJS_VERSION=1.15.6.0.2.5-1~stretch&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Cmd&quot;: [</span><br><span class="line">            &quot;/bin/sh&quot;,</span><br><span class="line">            &quot;-c&quot;,</span><br><span class="line">            &quot;#(nop) &quot;,</span><br><span class="line">            &quot;CMD [\&quot;nginx\&quot; \&quot;-g\&quot; \&quot;daemon off;\&quot;]&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;ArgsEscaped&quot;: true,</span><br><span class="line">        &quot;Image&quot;: &quot;sha256:eb4657966d3e92498b450e24969a0a2808f254ab44102f31674543f642e35ed7&quot;,</span><br><span class="line">        &quot;Volumes&quot;: null,</span><br><span class="line">        &quot;WorkingDir&quot;: &quot;&quot;,</span><br><span class="line">        &quot;Entrypoint&quot;: null,</span><br><span class="line">        &quot;OnBuild&quot;: [],</span><br><span class="line">        &quot;Labels&quot;: &#123;</span><br><span class="line">            &quot;maintainer&quot;: &quot;NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;StopSignal&quot;: &quot;SIGTERM&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;created&quot;: &quot;2018-11-16T13:32:10.147294787Z&quot;,</span><br><span class="line">    &quot;docker_version&quot;: &quot;17.06.2-ce&quot;,</span><br><span class="line">    &quot;history&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-15T22:45:06.938205528Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop) ADD file:dab9baf938799c515ddce14c02f899da5992f0b76a432fa10a2338556a3cb04f in / &quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-15T22:45:07.243453424Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  CMD [\&quot;bash\&quot;]&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-16T13:31:11.175776557Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  LABEL maintainer=NGINX Docker Maintainers &lt;docker-maint@nginx.com&gt;&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-16T13:31:11.487598267Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  ENV NGINX_VERSION=1.15.6-1~stretch&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-16T13:31:11.783900832Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  ENV NJS_VERSION=1.15.6.0.2.5-1~stretch&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-16T13:32:07.382613887Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c set -x \t&amp;&amp; apt-get update \t&amp;&amp; apt-get install --no-install-recommends --no-install-suggests -y gnupg1 apt-transport-https ca-certificates \t&amp;&amp; \tNGINX_GPGKEY=573BFD6B3D8FBC641079A6ABABF5BD827BD9BF62; \tfound=&#x27;&#x27;; \tfor server in \t\tha.pool.sks-keyservers.net \t\thkp://keyserver.ubuntu.com:80 \t\thkp://p80.pool.sks-keyservers.net:80 \t\tpgp.mit.edu \t; do \t\techo \&quot;Fetching GPG key $NGINX_GPGKEY from $server\&quot;; \t\tapt-key adv --keyserver \&quot;$server\&quot; --keyserver-options timeout=10 --recv-keys \&quot;$NGINX_GPGKEY\&quot; &amp;&amp; found=yes &amp;&amp; break; \tdone; \ttest -z \&quot;$found\&quot; &amp;&amp; echo &gt;&amp;2 \&quot;error: failed to fetch GPG key $NGINX_GPGKEY\&quot; &amp;&amp; exit 1; \tapt-get remove --purge --auto-remove -y gnupg1 &amp;&amp; rm -rf /var/lib/apt/lists/* \t&amp;&amp; dpkgArch=\&quot;$(dpkg --print-architecture)\&quot; \t&amp;&amp; nginxPackages=\&quot; \t\tnginx=$&#123;NGINX_VERSION&#125; \t\tnginx-module-xslt=$&#123;NGINX_VERSION&#125; \t\tnginx-module-geoip=$&#123;NGINX_VERSION&#125; \t\tnginx-module-image-filter=$&#123;NGINX_VERSION&#125; \t\tnginx-module-njs=$&#123;NJS_VERSION&#125; \t\&quot; \t&amp;&amp; case \&quot;$dpkgArch\&quot; in \t\tamd64|i386) \t\t\techo \&quot;deb https://nginx.org/packages/mainline/debian/ stretch nginx\&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list \t\t\t&amp;&amp; apt-get update \t\t\t;; \t\t*) \t\t\techo \&quot;deb-src https://nginx.org/packages/mainline/debian/ stretch nginx\&quot; &gt;&gt; /etc/apt/sources.list.d/nginx.list \t\t\t\t\t\t&amp;&amp; tempDir=\&quot;$(mktemp -d)\&quot; \t\t\t&amp;&amp; chmod 777 \&quot;$tempDir\&quot; \t\t\t\t\t\t&amp;&amp; savedAptMark=\&quot;$(apt-mark showmanual)\&quot; \t\t\t\t\t\t&amp;&amp; apt-get update \t\t\t&amp;&amp; apt-get build-dep -y $nginxPackages \t\t\t&amp;&amp; ( \t\t\t\tcd \&quot;$tempDir\&quot; \t\t\t\t&amp;&amp; DEB_BUILD_OPTIONS=\&quot;nocheck parallel=$(nproc)\&quot; \t\t\t\t\tapt-get source --compile $nginxPackages \t\t\t) \t\t\t\t\t\t&amp;&amp; apt-mark showmanual | xargs apt-mark auto &gt; /dev/null \t\t\t&amp;&amp; &#123; [ -z \&quot;$savedAptMark\&quot; ] || apt-mark manual $savedAptMark; &#125; \t\t\t\t\t\t&amp;&amp; ls -lAFh \&quot;$tempDir\&quot; \t\t\t&amp;&amp; ( cd \&quot;$tempDir\&quot; &amp;&amp; dpkg-scanpackages . &gt; Packages ) \t\t\t&amp;&amp; grep &#x27;^Package: &#x27; \&quot;$tempDir/Packages\&quot; \t\t\t&amp;&amp; echo \&quot;deb [ trusted=yes ] file://$tempDir ./\&quot; &gt; /etc/apt/sources.list.d/temp.list \t\t\t&amp;&amp; apt-get -o Acquire::GzipIndexes=false update \t\t\t;; \tesac \t\t&amp;&amp; apt-get install --no-install-recommends --no-install-suggests -y \t\t\t\t\t\t$nginxPackages \t\t\t\t\t\tgettext-base \t&amp;&amp; apt-get remove --purge --auto-remove -y apt-transport-https ca-certificates &amp;&amp; rm -rf /var/lib/apt/lists/* /etc/apt/sources.list.d/nginx.list \t\t&amp;&amp; if [ -n \&quot;$tempDir\&quot; ]; then \t\tapt-get purge -y --auto-remove \t\t&amp;&amp; rm -rf \&quot;$tempDir\&quot; /etc/apt/sources.list.d/temp.list; \tfi&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-16T13:32:08.778195069Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c ln -sf /dev/stdout /var/log/nginx/access.log \t&amp;&amp; ln -sf /dev/stderr /var/log/nginx/error.log&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-16T13:32:09.22115772Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  EXPOSE 80/tcp&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-16T13:32:09.696803649Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  STOPSIGNAL [SIGTERM]&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;created&quot;: &quot;2018-11-16T13:32:10.147294787Z&quot;,</span><br><span class="line">            &quot;created_by&quot;: &quot;/bin/sh -c #(nop)  CMD [\&quot;nginx\&quot; \&quot;-g\&quot; \&quot;daemon off;\&quot;]&quot;,</span><br><span class="line">            &quot;empty_layer&quot;: true</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">    &quot;rootfs&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;layers&quot;,</span><br><span class="line">        &quot;diff_ids&quot;: [</span><br><span class="line">            &quot;sha256:ef68f6734aa485edf13a8509fe60e4272428deaf63f446a441b79d47fc5d17d3&quot;,</span><br><span class="line">            &quot;sha256:876456b964239fb297770341ec7e4c2630e42b64b7bbad5112becb1bd2c72795&quot;,</span><br><span class="line">            &quot;sha256:9a8f339aeebe1e8bcef322376e1274360653fb802abd4b94c69ea45a54f71a2b&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>Get Image Layers</li>
</ol>
<p>æ ¹æ® Image Manifest Layers ä¸‹è½½ Image Layers</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">curl -i -H &quot;Authorization: Bearer $token&quot; -H &quot;Accept: application/vnd.docker.distribution.manifest.v2+json&quot; &quot;https://registry.hub.docker.com/v2/library/nginx/blobs/sha256:a5a6f2f73cd8abbdc55d0df0d8834f7262713e87d6c8800ea3851f103025e0f0&quot;</span><br><span class="line">curl -o a5a6f2f73cd8abbdc55d0df0d8834f7262713e87d6c8800ea3851f103025e0f0.tar.gz https://production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/a5/a5a6f2f73cd8abbdc55d0df0d8834f7262713e87d6c8800ea3851f103025e0f0/data?verify=1542424303-e8ERUR8oG%2BoBh41TGIpCy7iFeYg%3D</span><br><span class="line">curl -i -H &quot;Authorization: Bearer $token&quot; -H &quot;Accept: application/vnd.docker.distribution.manifest.v2+json&quot; &quot;https://registry.hub.docker.com/v2/library/nginx/blobs/sha256:67da5fbcb7a04397eda35dccb073d8569d28de13172fbd569fbb7a3e30b5886b&quot;</span><br><span class="line">curl -o 67da5fbcb7a04397eda35dccb073d8569d28de13172fbd569fbb7a3e30b5886b.tar.gz https://production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/67/67da5fbcb7a04397eda35dccb073d8569d28de13172fbd569fbb7a3e30b5886b/data\?verify\=1542424505-PVOE52Er6OY7iKDTx5QZSZxI99I%3D</span><br><span class="line">curl -i -H &quot;Authorization: Bearer $token&quot; -H &quot;Accept: application/vnd.docker.distribution.manifest.v2+json&quot; &quot;https://registry.hub.docker.com/v2/library/nginx/blobs/sha256:e82455fa5628738170735528c8db36567b5423ec59802a1e2c084ed42b082527&quot;</span><br><span class="line">curl -o e82455fa5628738170735528c8db36567b5423ec59802a1e2c084ed42b082527.tar.gz https://production.cloudflare.docker.com/registry-v2/docker/registry/v2/blobs/sha256/e8/e82455fa5628738170735528c8db36567b5423ec59802a1e2c084ed42b082527/data\?verify\=1542424575-kXRXCIAWm%2FXyHHfrhI1yOIPt4FA%3D</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Generated Image Tar Archive Description (manifest.json)</li>
</ol>
<p>æ ¹æ® Config file åŠ Layers files çš„ç»„ç»‡ç›®å½•ç»“æ„ï¼Œç”Ÿæˆ Image Tar Archive Manifest</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">    &#123;</span><br><span class="line">        &quot;Config&quot;: &quot;sha256:e81eb098537d6c4a75438eacc6a2ed94af74ca168076f719f3a0558bd24d646a&quot;,</span><br><span class="line">        &quot;RepoTags&quot;: [</span><br><span class="line">            &quot;index.docker.io/library/nginx:latest&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;Layers&quot;: [</span><br><span class="line">            &quot;a5a6f2f73cd8abbdc55d0df0d8834f7262713e87d6c8800ea3851f103025e0f0.tar.gz&quot;,</span><br><span class="line">            &quot;67da5fbcb7a04397eda35dccb073d8569d28de13172fbd569fbb7a3e30b5886b.tar.gz&quot;,</span><br><span class="line">            &quot;e82455fa5628738170735528c8db36567b5423ec59802a1e2c084ed42b082527.tar.gz&quot;</span><br><span class="line">        ]</span><br><span class="line">    &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>Tar Archive File Structure Summary</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ 67da5fbcb7a04397eda35dccb073d8569d28de13172fbd569fbb7a3e30b5886b.tar.gz --- Layer file</span><br><span class="line">â”œâ”€â”€ a5a6f2f73cd8abbdc55d0df0d8834f7262713e87d6c8800ea3851f103025e0f0.tar.gz --- Layer file</span><br><span class="line">â”œâ”€â”€ e82455fa5628738170735528c8db36567b5423ec59802a1e2c084ed42b082527.tar.gz --- Layer file</span><br><span class="line">â”œâ”€â”€ manifest.json --- Image Tar Archive Description</span><br><span class="line">â””â”€â”€ sha256:e81eb098537d6c4a75438eacc6a2ed94af74ca168076f719f3a0558bd24d646a --- Image Config</span><br><span class="line">0 directories, 5 files</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/9d1faa5.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/9d1faa5.html" class="post-title-link" itemprop="url">docker load tar archive</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-17 13:58:45" itemprop="dateCreated datePublished" datetime="2018-11-17T13:58:45Z">2018-11-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 06:07:05" itemprop="dateModified" datetime="2020-11-22T06:07:05Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>3.6k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>3 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>åœ¨ä¸Šä¸€éæ–‡ç« ä¸­æˆ‘ä»¬ get åˆ°äº† crane pull çš„è¿‡ç¨‹ï¼Œç„¶è€Œå¥½å¥‡çš„æˆ‘ä»ç„¶æœ‰ä¸ªç–‘é—®ï¼Œé‚£å°±æ˜¯ tar archive ä¸­å¹¶æœªå®šä¹‰äº† layer çš„ stack å…³ç³»ï¼Œå¦‚æ­¤ docker load å¦‚ä½•èƒ½æ­£ç¡®ç»„ç»‡ image çš„ fs changeset å‘¢ ï¼Ÿ</p>
</blockquote>
<p>docker load</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/load/">https://docs.docker.com/engine/reference/commandline/load/</a></p>
<p>docker (moby)</p>
<p><a target="_blank" rel="noopener" href="https://github.com/moby/moby">https://github.com/moby/moby</a></p>
<p>Layer æ˜¯å¦‚ä½•ä¸²è”èµ·æ¥çš„</p>
<p><a target="_blank" rel="noopener" href="https://www.hi-linux.com/posts/44544.html">https://www.hi-linux.com/posts/44544.html</a></p>
<h1 id="Study"><a href="#Study" class="headerlink" title="Study"></a>Study</h1><p>æŒ‰è¯´ç†è®ºä¸Šæ¯å±‚ï¼Œåº”æœ‰é•œåƒå±‚ idï¼Œå¹¶ä¸”æœ‰æŒ‡å‘ parent layer çš„æŒ‡é’ˆï¼Œå½“ç„¶åŸºç¡€é•œåƒæ²¡æœ‰ parent layer</p>
<p>å¦åˆ™æ— æ³•å°† layer ç»„ç»‡èµ·æ¥</p>
<p>æ—¢ç„¶å¦‚æ­¤é‚£åœ¨ image tar archive ä¸­ï¼Œæ˜¯å¦‚ä½•ä½“ç°è¿™ç§ layer stack å…³ç³»çš„ ?</p>
<p>docker save</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ 2daafd635a629218204652bd3b10ddd23ae5e33abe1ebc3c26c01103e33369de</span><br><span class="line">â”‚   â”œâ”€â”€ VERSION</span><br><span class="line">â”‚   â”œâ”€â”€ json</span><br><span class="line">â”‚   â””â”€â”€ layer.tar</span><br><span class="line">â”œâ”€â”€ 9fbc75679caed833594370d2effbdbba4e09eb6ee7a87f9d2e94b41627d56831</span><br><span class="line">â”‚   â”œâ”€â”€ VERSION</span><br><span class="line">â”‚   â”œâ”€â”€ json</span><br><span class="line">â”‚   â””â”€â”€ layer.tar</span><br><span class="line">â”œâ”€â”€ e81eb098537d6c4a75438eacc6a2ed94af74ca168076f719f3a0558bd24d646a.json</span><br><span class="line">â”œâ”€â”€ ecfed8505473c79ab6831d6272a1adff68a42cd102e9992e60b2f8925df01927</span><br><span class="line">â”‚   â”œâ”€â”€ VERSION</span><br><span class="line">â”‚   â”œâ”€â”€ json</span><br><span class="line">â”‚   â””â”€â”€ layer.tar</span><br><span class="line">â”œâ”€â”€ manifest.json</span><br><span class="line">â””â”€â”€ repositories</span><br><span class="line">3 directories, 12 files</span><br></pre></td></tr></table></figure>

<p>å¯è§ docker save æ—¶ä¼šå°† layer çš„ metadata æ–‡ä»¶è¾“å‡ºï¼ŒæŸ¥çœ‹ json æ–‡ä»¶åå‘ç°å…¶çš„ç¡®æœ‰ parent çš„å®šä¹‰</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;id&quot;: &quot;2daafd635a629218204652bd3b10ddd23ae5e33abe1ebc3c26c01103e33369de&quot;,</span><br><span class="line">    &quot;parent&quot;: &quot;9fbc75679caed833594370d2effbdbba4e09eb6ee7a87f9d2e94b41627d56831&quot;,</span><br><span class="line">    &quot;created&quot;: &quot;2018-11-16T13:32:10.147294787Z&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘è¿˜åšäº†ä¸ªå®éªŒï¼Œå°†æ¯å±‚çš„ json, VERSION åŠ repositories æ–‡ä»¶åˆ é™¤ï¼Œæ£€æŸ¥æ˜¯å¦ä»ç„¶èƒ½ç»§ç»­ docker loadï¼Œå‘ƒå½“ç„¶æ˜¯è‚¯å®šçš„</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ 2daafd635a629218204652bd3b10ddd23ae5e33abe1ebc3c26c01103e33369de</span><br><span class="line">â”‚   â””â”€â”€ layer.tar --- Layer File</span><br><span class="line">â”œâ”€â”€ 9fbc75679caed833594370d2effbdbba4e09eb6ee7a87f9d2e94b41627d56831</span><br><span class="line">â”‚   â””â”€â”€ layer.tar --- Layer File</span><br><span class="line">â”œâ”€â”€ e81eb098537d6c4a75438eacc6a2ed94af74ca168076f719f3a0558bd24d646a.json --- Config file</span><br><span class="line">â”œâ”€â”€ ecfed8505473c79ab6831d6272a1adff68a42cd102e9992e60b2f8925df01927</span><br><span class="line">â”‚   â””â”€â”€ layer.tar --- Layer File</span><br><span class="line">â””â”€â”€ manifest.json --- Image Tar Archive Description</span><br><span class="line">3 directories, 5 files</span><br></pre></td></tr></table></figure>

<p>docker load ä¸€æŠŠ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">tar -cf nginx-new.tar *</span><br><span class="line">&gt; docker load -i nginx-new.tar</span><br><span class="line">ef68f6734aa4: Loading layer [==================================================&gt;]  58.44MB/58.44MB</span><br><span class="line">876456b96423: Loading layer [==================================================&gt;]  54.38MB/54.38MB</span><br><span class="line">9a8f339aeebe: Loading layer [==================================================&gt;]  3.584kB/3.584kB</span><br><span class="line">Loaded image: nginx:latest</span><br></pre></td></tr></table></figure>

<p>docker load å„ layer, å…¶ä¸­å·¦ä¾§çš„ hex å€¼ä¸º layer sha256 hash value</p>
<p>å¯è§çš„ç¡®æœªå—å½±å“ï¼Œæ‰€ä»¥ docker load å¹¶æœªä¾èµ– docker save æ—¶ä¿ç•™çš„ layer metadata ä¿¡æ¯</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&quot;os&quot;: &quot;linux&quot;,</span><br><span class="line">&quot;rootfs&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;layers&quot;,</span><br><span class="line">    &quot;diff_ids&quot;: [</span><br><span class="line">        &quot;sha256:ef68f6734aa485edf13a8509fe60e4272428deaf63f446a441b79d47fc5d17d3&quot;,</span><br><span class="line">        &quot;sha256:876456b964239fb297770341ec7e4c2630e42b64b7bbad5112becb1bd2c72795&quot;,</span><br><span class="line">        &quot;sha256:9a8f339aeebe1e8bcef322376e1274360653fb802abd4b94c69ea45a54f71a2b&quot;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦å¤–å¯¹äºé•œåƒ Config file ä¸­è¯´æ˜çš„ rootfs.diff_ids, å…¶ä¸­çš„ sha256 hash å€¼å‡ä¸ºå„ layer çš„ sha256 hash å€¼</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ef68f6734aa485edf13a8509fe60e4272428deaf63f446a441b79d47fc5d17d3  ecfed8505473c79ab6831d6272a1adff68a42cd102e9992e60b2f8925df01927/layer.tar</span><br><span class="line">876456b964239fb297770341ec7e4c2630e42b64b7bbad5112becb1bd2c72795  9fbc75679caed833594370d2effbdbba4e09eb6ee7a87f9d2e94b41627d56831/layer.tar</span><br><span class="line">9a8f339aeebe1e8bcef322376e1274360653fb802abd4b94c69ea45a54f71a2b  2daafd635a629218204652bd3b10ddd23ae5e33abe1ebc3c26c01103e33369de/layer.tar</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.huweihuang.com/article/docker/docker-commands-principle/">https://www.huweihuang.com/article/docker/docker-commands-principle/</a></p>
<blockquote>
<p>å¦‚æœä½ è¦æŒä¹…åŒ–ä¸€ä¸ªé•œåƒï¼Œå¯ä»¥ä½¿ç”¨ docker save æŒ‡ä»¤<br>å®ƒä¸ docker export çš„åŒºåˆ«åœ¨äºå…¶ä¿ç•™äº†æ‰€æœ‰å…ƒæ•°æ®å’Œå†å²å±‚<br>å¦å¤– docker export ç”¨äºå®¹å™¨ï¼Œè€Œä¸æ˜¯é•œåƒ</p>
</blockquote>
<p>docker inspect ç”¨äºæŸ¥çœ‹é•œåƒæœ€é¡¶å±‚çš„ metadata</p>
<p>docker images -a è¯¥æŒ‡ä»¤ç”¨ä½œåˆ—å‡ºé•œåƒçš„æ‰€æœ‰é•œåƒå±‚ã€‚é•œåƒå±‚çš„æ’åºä»¥æ¯ä¸ªé¡¶å±‚é•œåƒ ID ä¸ºé¦–ï¼Œä¾æ¬¡åˆ—å‡ºæ¯ä¸ªé•œåƒä¸‹çš„æ‰€æœ‰é•œåƒå±‚</p>
<p>docker history æŸ¥çœ‹è¯¥é•œåƒ ID ä¸‹çš„æ‰€æœ‰å†å²é•œåƒ</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>å¯¹æ¯”å‘ç°ï¼Œå…¶å®åœ¨ Image Tar Archive ä¸­ï¼Œlayer çš„ parent-child å…³ç³»å®é™…ä¸Šå°±æ˜¯å®šä¹‰äºé•œåƒ Config file ä¸­çš„ rootfs.diff_ids é¡ºåº</p>
<p>[0] &lt;- [1] &lt;- [2] &lt;- â€¦</p>
<p>ä»¥ nginx:latest ä¸ºä¾‹</p>
<ol>
<li>ef68f6734aa485edf13a8509fe60e4272428deaf63f446a441b79d47fc5d17d3 (base layer)</li>
<li>876456b964239fb297770341ec7e4c2630e42b64b7bbad5112becb1bd2c72795</li>
<li>9a8f339aeebe1e8bcef322376e1274360653fb802abd4b94c69ea45a54f71a2b</li>
<li>â€¦</li>
</ol>
<p>è¿™ä¸‹å°±æç„¶å¤§æ‚Ÿäº†</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/b0559197.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/b0559197.html" class="post-title-link" itemprop="url">Layer files Content</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-11-17 11:47:49" itemprop="dateCreated datePublished" datetime="2018-11-17T11:47:49Z">2018-11-17</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 03:51:34" itemprop="dateModified" datetime="2020-11-22T03:51:34Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>2 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Creating-an-Image-Filesystem-Changeset"><a href="#Creating-an-Image-Filesystem-Changeset" class="headerlink" title="Creating an Image Filesystem Changeset"></a>Creating an Image Filesystem Changeset</h1><p><a target="_blank" rel="noopener" href="https://github.com/moby/moby/blob/master/image/spec/v1.md#creating-an-image-filesystem-changeset">https://github.com/moby/moby/blob/master/image/spec/v1.md#creating-an-image-filesystem-changeset</a></p>
<p>æè¿°äº†å¦‚ä½• Creating an Image Filesystem Changeset</p>
<p>æ¯å±‚ layers file ä»…å¯èƒ½æœ‰å¦‚ä¸‹çš„æƒ…å†µ</p>
<ul>
<li>add</li>
<li>update</li>
<li>deleted</li>
</ul>
<p>ä¾‹å¦‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Added:      /etc/my-app.d/default.cfg</span><br><span class="line">Modified:   /bin/my-app-tools</span><br><span class="line">Deleted:    /etc/my-app-config</span><br></pre></td></tr></table></figure>

<p>å¯¹äº changeset æ¥è¯´ï¼Œä¼šç”Ÿæˆå¦‚ä¸‹æ–‡ä»¶</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/my-app.d/default.cfg</span><br><span class="line">/bin/my-app-tools</span><br><span class="line">/etc/.wh.my-app-config</span><br></pre></td></tr></table></figure>

<blockquote>
<p>.wh. i.e. without</p>
</blockquote>
<h1 id="Loading-an-Image-Filesystem-Changeset"><a href="#Loading-an-Image-Filesystem-Changeset" class="headerlink" title="Loading an Image Filesystem Changeset"></a>Loading an Image Filesystem Changeset</h1><p>é‚£ä¹ˆæˆ‘ä»¬åˆå¦‚ä½• Loading an Image Filesystem Changeset</p>
<p><a target="_blank" rel="noopener" href="https://github.com/moby/moby/blob/master/image/spec/v1.md#loading-an-image-filesystem-changeset">https://github.com/moby/moby/blob/master/image/spec/v1.md#loading-an-image-filesystem-changeset</a></p>
<ol>
<li>æ‰¾åˆ° the root ancestor changeset</li>
<li>ä» root ancestor changeset å¼€å§‹ï¼Œé€çº§è§£å‹ layerâ€™s filesystem changeset archive åˆ°ç›®å½• (å°†è¢«ä½¿ç”¨æ¥ä½œä¸º the root of a container filesystem)<br> 1.1 æ¯å±‚è§£å‹ä¹‹åå†éå†ä¸€æ¬¡ç›®å½•ï¼Œåˆ é™¤å·²è¢«æ ‡è®°åˆ é™¤çš„ç›®å½• removing any files with the prefix .wh. and the corresponding file or directory named without this prefix</li>
</ol>
<h1 id="Owner-and-Group"><a href="#Owner-and-Group" class="headerlink" title="Owner and Group"></a>Owner and Group</h1><p>å¦å¤–å°è¯•æ”¹å˜æ–‡ä»¶å±ä¸»</p>
<p>changeset ä¹Ÿç®—ä½œæ–‡ä»¶ update</p>
<p>untar çš„æ—¶å€™æ³¨æ„ â€“same-owner</p>
<p>è¿™é‡Œæœ‰ä¸ªæ–°é—®é¢˜ï¼Œå°±æ˜¯ docker load æ˜¯å¦‚ä½•å¤„ç† Image Filesystem Changeset ä¸­çš„å±ä¸»çš„</p>
<p>å®é™…æµ‹è¯•å¾—éœ€è¦ root ç”¨æˆ· <code>tar --same-owner -xvf</code> æ‰è¡Œ, è§£å‹å‡ºæ¥çš„å±ä¸»å’Œ group ä¹Ÿä»…ä¸º id å€¼ï¼Œæ¯•ç«Ÿå®¿ä¸»æœºä¸Šä¸ä¸€å®šæœ‰è¯¥ owner å’Œ group</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ash-3.2$ ls -al</span><br><span class="line">total 0</span><br><span class="line">drwxr-xr-x   3 zrss  staff  102 11 17 19:24 .</span><br><span class="line">drwxr-xr-x  10 zrss  staff  340 11 17 18:39 ..</span><br><span class="line">drwxr-xr-x  13 101   101    442 11 17 19:25 var</span><br></pre></td></tr></table></figure>

<blockquote>
<p>101 nginx</p>
</blockquote>
<h1 id="Permission"><a href="#Permission" class="headerlink" title="Permission"></a>Permission</h1><p>æ”¹å˜æ–‡ä»¶æƒé™</p>
<p>changeset ä¹Ÿç®—ä½œæ–‡ä»¶ update</p>
<p>ç›´æ¥è§£å‹å³å¯ï¼Œå¯ä»¥ä¿ç•™åŸæƒé™</p>
<h1 id="Scan-Image-Tar-Archive"><a href="#Scan-Image-Tar-Archive" class="headerlink" title="Scan Image Tar Archive"></a>Scan Image Tar Archive</h1><p>ä¸šç•Œåšæ³•æ‰«æ layerï¼Œ</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/ee/dtr/user/manage-images/scan-images-for-vulnerabilities/">https://docs.docker.com/ee/dtr/user/manage-images/scan-images-for-vulnerabilities/</a></p>
<p>è€Œä¸æ˜¯å°† layer combine æˆ container root fs ä¹‹åï¼Œå†å…¨æ–‡ä»¶æ‰«æ</p>
<p>å½“ç„¶å¯èƒ½å› ä¸ºæ˜¯ç—…æ¯’æ‰«æï¼Œè¿™æ ·åšæ¯”è¾ƒç®€å•</p>
<p>è¯è¯´æœ‰æ²¡æœ‰å¿…è¦ç»„æˆ root fs ä¹‹åå†æ‰«æå‘¢ï¼Œå› ä¸ºæ¯•ç«Ÿå¯èƒ½ä¹‹å‰ layer çš„æ¼æ´ï¼Œåœ¨ä¸‹ä¸€ layer è¢«ä¿®å¤äº†ï¼Œæ„Ÿè§‰å¯èƒ½æ˜¯ä¼šè¯¯æŠ¥çš„ ? ç»†èŠ‚ä¸Šä¸çŸ¥é“å¯ä»¥å¦‚ä½•å®ç°</p>
<p>å€’æ˜¯å¯ä»¥çœ‹ä¸‹ coreos clair æ˜¯å¦‚ä½•å®ç°çš„</p>
<p>ğŸ™„ å…¶å®ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼ŒæŠŠ layer è§£å‹ä¹‹åï¼Œæ‰«æ–‡ä»¶ï¼Œæ¯”å¯¹æ•°æ®åº“</p>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>å…¶å®æ˜¯æœ‰ç‚¹å„¿ç–‘æƒ‘çš„, ä¸šç•Œé•œåƒæ‰«æè§£å†³æ–¹æ¡ˆ (å½“ç„¶æ˜¯é’ˆå¯¹ç—…æ¯’æ‰«æ) éƒ½æ˜¯ç›´æ¥æ‰«æ image layer</p>
<p>æš‚æœªå‘ç°æœ‰æŒ‰ç…§ Loading an Image Filesystem Changeset æè¿°çš„è¿‡ç¨‹é‚£æ ·ï¼ŒæŒ‚è½½å‡º container root fs ä¹‹åï¼Œå†æ‰«æçš„è§£å†³æ–¹æ¡ˆ</p>
<p>å½“ç„¶æè¿°çš„è¿‡ç¨‹æ„Ÿè§‰å…¶å®åªæ˜¯å¥½ç†è§£ï¼Œå®é™…ä¸Š dockerd å†ç»„ç»‡é•œåƒ root fs æ—¶ï¼Œæ˜¯éœ€è¦æ ¹æ®ä¸åŒçš„ storage driver çš„å®ç°ï¼Œè°ƒç”¨ä¸åŒçš„å‘½ä»¤å®ç°çš„æŒ‚è½½ (æˆ–è€…æ¢ä¸€ä¸ªè¯´æ³•ï¼Œstorage driver æœ¬è´¨ä¸Šå®ç°äº†æè¿°çš„è¿‡ç¨‹ â€¦)</p>
<ol>
<li>overlay2</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://terriblecode.com/blog/how-docker-images-work-union-file-systems-for-dummies/">https://terriblecode.com/blog/how-docker-images-work-union-file-systems-for-dummies/</a></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mkdir base diff overlay workdir</span><br><span class="line">sudo mount \</span><br><span class="line">    -t overlay \</span><br><span class="line">    -o lowerdir=base,upperdir=diff,workdir=workdir \</span><br><span class="line">    overlay \</span><br><span class="line">    overlay</span><br></pre></td></tr></table></figure>

<p>è¿™å“¥ä»¬æ²¡è®²å¤ªç»†</p>
<ol start="2">
<li>aufs</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/17061.html?spm=a2c4e.11153940.blogcont62949.21.53a61eearfeDBm">https://coolshell.cn/articles/17061.html?spm=a2c4e.11153940.blogcont62949.21.53a61eearfeDBm</a></p>
<p>æœ‰æ–‡ä»¶åˆ é™¤çš„è¯ï¼Œåœ¨å¯å†™å±‚æ”¾ä¸ª .wh.[file-name]ï¼Œæ–‡ä»¶å°±è¢«éšè—äº†ã€‚å’Œç›´æ¥ rm æ˜¯ä¸€æ ·çš„</p>
<ol start="3">
<li>devicemapper</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://coolshell.cn/articles/17200.html?spm=a2c4e.11153940.blogcont62949.22.53a61eearfeDBm">https://coolshell.cn/articles/17200.html?spm=a2c4e.11153940.blogcont62949.22.53a61eearfeDBm</a></p>
<p>æè¿°å¦‚ä½•ç”¨ devicemapper å®ç° layers æŒ‚è½½æˆ union file system çš„ï¼Œå„å±‚å¯ä»¥é€šè¿‡ devicemapper çš„ snapshot æŠ€æœ¯å®ç°ï¼Œå¯¹ç”¨æˆ·æ¥è¯´å°±æ˜¯å•ä¸€çš„ fs</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/8a17de67.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/8a17de67.html" class="post-title-link" itemprop="url">client go queues</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-16 14:12:30" itemprop="dateCreated datePublished" datetime="2018-09-16T14:12:30Z">2018-09-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 06:22:55" itemprop="dateModified" datetime="2020-11-22T06:22:55Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>9.9k</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>9 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>æœ€è¿‘çœ‹äº†çœ‹ <code>knative-build-controller</code> ä¸­ä½¿ç”¨çš„ workqueueï¼Œä¸å¾—ä¸è¯´æ˜¯ä¸ªè®¾è®¡å¤æ‚</p>
<p>è€Œä¸”å¯¹äº controller æ¥è¯´ï¼Œéå¸¸å¥½ç”¨çš„ä¸€ä¸ªä¸œè¥¿ã€‚å› ä¸º controller ä¸­ä¼šä½¿ç”¨åˆ° <code>informer</code>ï¼Œè€Œ <code>informer</code> äº§ç”Ÿçš„å¾… <code>reconcile</code> key å¯ä»¥æ”¾å…¥ workqueue ä¸­ï¼Œç­‰å¾… controller é€ä¸€å¤„ç†</p>
<p>workqueue çš„å®ç°æ˜¯ç”± <code>client-go</code> <a target="_blank" rel="noopener" href="https://github.com/kubernetes/client-go">https://github.com/kubernetes/client-go</a> åº“æä¾›çš„ï¼Œç›®å½•ä½äº <code>util/workqueue</code></p>
<p>å…¶ä¸­ knative-build-controller ä½¿ç”¨çš„ä¸º <code>rate_limitting_queue.go</code>ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRateLimitingQueue</span><span class="params">(rateLimiter RateLimiter)</span> <span class="title">RateLimitingInterface</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &amp;rateLimitingType&#123;</span><br><span class="line">        DelayingInterface: NewDelayingQueue(),</span><br><span class="line">        rateLimiter:       rateLimiter,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå‡ºæ¥çš„ queue</p>
<p>ä½¿ç”¨ <code>default_rate_limiters.go</code>ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">DefaultControllerRateLimiter</span><span class="params">()</span> <span class="title">RateLimiter</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> NewMaxOfRateLimiter(</span><br><span class="line">        NewItemExponentialFailureRateLimiter(<span class="number">5</span>*time.Millisecond, <span class="number">1000</span>*time.Second),</span><br><span class="line">        <span class="comment">// 10 qps, 100 bucket size.  This is only for retry speed and its only the overall factor (not per item)</span></span><br><span class="line">        &amp;BucketRateLimiter&#123;Limiter: rate.NewLimiter(rate.Limit(<span class="number">10</span>), <span class="number">100</span>)&#125;,</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ›å»ºå‡ºæ¥çš„ limiterï¼Œç”¨æ¥è®¡ç®—é™æµæ—¶é—´çš„ï¼Œä¼šå– <code>NewItemExponentialFailureRateLimiter</code> å’Œ <code>BucketRateLimiter</code> ä¸­é™æµæ—¶é—´çš„å¤§è€…</p>
<p>å’±ä»¬é‡ç‚¹çœ‹ queue çš„å®ç°</p>
<p>RateLimitingQueue æä¾›äº† rate limit (é™æµ) çš„åŠŸèƒ½ï¼Œè€Œæˆ‘ä»¬çŸ¥é“ knative-build-controller (å½“ç„¶ k8s ä¸­è®¸å¤šå…¶ä»–çš„ controller ä¹Ÿæ˜¯å¦‚æ­¤æ¨¡å‹) çš„å¤„ç†æ¨¡å‹ä¸ºå¾ªç¯ä» queue ä¸­è·å– itemï¼Œå¹¶ reconcile ä¹‹</p>
<p>ä» api æ¥çœ‹ï¼Œ<code>rate_limitting_queue</code> ç»„åˆäº† <code>DelayingInterface</code> æ¥å£ï¼Œå¹¶æä¾›äº†</p>
<ul>
<li>AddRateLimited</li>
<li>Forget</li>
<li>NumRequeues</li>
</ul>
<p>æ–¹æ³•</p>
<p>å…¶ä¸­ <code>DelayingInterface</code> æ¥å£åˆç»„åˆäº† <code>Interface</code> æ¥å£ï¼Œå¹¶æä¾›äº†</p>
<ul>
<li>AddAfter</li>
</ul>
<p>æ–¹æ³•</p>
<p>æœ€å <code>Interface</code> æ¥å£æä¾›åŸºæœ¬çš„ queue åŠŸèƒ½</p>
<ul>
<li>Add</li>
<li>Len</li>
<li>Get</li>
<li>Done</li>
<li>Shutdown</li>
<li>ShuttingDown</li>
</ul>
<h1 id="RateLimittingQueue"><a href="#RateLimittingQueue" class="headerlink" title="RateLimittingQueue"></a>RateLimittingQueue</h1><blockquote>
<p>é™æµé˜Ÿåˆ—</p>
</blockquote>
<h2 id="AddRateLimited"><a href="#AddRateLimited" class="headerlink" title="AddRateLimited"></a>AddRateLimited</h2><p>å®é™…ä¸Šæ˜¯è°ƒç”¨äº†é™æµç®—æ³•ï¼Œæ ¹æ®é‡è¯•æ¬¡æ•°è®¡ç®—å‡ºå½“å‰é™æµæ—¶é—´ï¼Œåœ¨è¯¥æ—¶é—´ä¹‹åï¼Œå†å°† item åŠ å…¥ queue ä¸­</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *rateLimitingType)</span> <span class="title">AddRateLimited</span><span class="params">(item <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    q.DelayingInterface.AddAfter(item, q.rateLimiter.When(item))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å› æ­¤è¿™ä¸ªå®ç°ä¾èµ–äº DelayingQueue çš„ AddAfter æ–¹æ³•</p>
<h2 id="Forget"><a href="#Forget" class="headerlink" title="Forget"></a>Forget</h2><p>è¿™ä¸ªæ–¹æ³•æœ‰ç‚¹å„¿ç‰¹æ®Šï¼ŒForget æ˜¯å•¥è¯­ä¹‰ï¼Ÿå¿˜äº†ï¼Ÿæˆ‘ item å¥½ç«¯ç«¯çš„ï¼Œä¸ºå•¥è¦å¿˜äº†æˆ‘</p>
<p>ğŸ˜‚ ä¸€å¼€å§‹æˆ‘ä¹Ÿæ˜¯ä¸€è„¸æ‡µé€¼ï¼Œä¸è¿‡æƒ³æƒ³å‘ï¼Œå’±ä»¬è°ƒç”¨äº† AddRateLimitedï¼Œè€Œè¿™ä¸ªæ–¹æ³•åœ¨è®¡ç®—é™æµæ—¶é—´æ—¶ï¼Œéœ€è¦ä½¿ç”¨åˆ° item çš„é‡è¯•æ¬¡æ•°çš„ï¼Œæ²¡æœ‰è¿™ä¸ªé‡è¯•æ¬¡æ•°ï¼Œå½“ç„¶è®¡ç®—é™æµæ—¶é—´å°±æ²¡æœ‰æ„ä¹‰äº†</p>
<p>æ‰€ä»¥ Forget å‘¢ï¼Œå®é™…ä¸Šæ˜¯æ¸…é™¤ item çš„é‡è¯•æ¬¡æ•°ï¼Œè¿™æ ·ä¸‹æ¬¡å†å°†è¿™ä¸ª item AddRateLimited æ—¶ï¼Œå°±ä¸ä¼šå—é™æµçš„å½±å“äº†</p>
<p>Forget åœ¨ <code>ItemExponentialFailureRateLimiter</code> ä¸­çš„å®ç°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *ItemExponentialFailureRateLimiter)</span> <span class="title">Forget</span><span class="params">(item <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    r.failuresLock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> r.failuresLock.Unlock()</span><br><span class="line">    <span class="built_in">delete</span>(r.failures, item) <span class="comment">// ä»é‡è¯•ç»Ÿè®¡æ¬¡æ•°è¡¨ä¸­åˆ é™¤ item</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä»¥åŠè®¡ç®—é™æµæ—¶é—´çš„å®ç°</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *ItemExponentialFailureRateLimiter)</span> <span class="title">When</span><span class="params">(item <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">time</span>.<span class="title">Duration</span></span> &#123;</span><br><span class="line">    r.failuresLock.Lock()</span><br><span class="line">    <span class="keyword">defer</span> r.failuresLock.Unlock()</span><br><span class="line">    exp := r.failures[item] <span class="comment">// å½“ item ä¸åœ¨è¡¨ä¸­æ—¶ï¼Œexp ä¸º 0</span></span><br><span class="line">    <span class="comment">// å°†é‡è¯•æ¬¡æ•°è®¾ç½®ä¸º 1ï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡é€’å¢ 1</span></span><br><span class="line">    r.failures[item] = r.failures[item] + <span class="number">1</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨æŒ‡æ•°ç®—æ³•è®¡ç®—é™æµæ—¶é—´</span></span><br><span class="line">    backoff := <span class="keyword">float64</span>(r.baseDelay.Nanoseconds()) * math.Pow(<span class="number">2</span>, <span class="keyword">float64</span>(exp))</span><br><span class="line">    <span class="keyword">if</span> backoff &gt; math.MaxInt64 &#123;</span><br><span class="line">        <span class="keyword">return</span> r.maxDelay</span><br><span class="line">    &#125;</span><br><span class="line">    calculated := time.Duration(backoff)</span><br><span class="line">    <span class="keyword">if</span> calculated &gt; r.maxDelay &#123;</span><br><span class="line">        <span class="keyword">return</span> r.maxDelay</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> calculated</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="DelayingQueue"><a href="#DelayingQueue" class="headerlink" title="DelayingQueue"></a>DelayingQueue</h1><p>å¦‚æ­¤æˆ‘ä»¬é¦–å…ˆæŸ¥çœ‹ <code>DelayingInterface</code> æ¥å£çš„å®ç°ä¹‹ä¸€ <code>delaying_queue.go</code></p>
<p>æˆ‘ä»¬çœ‹ï¼Œè¿™ä¸ª queue æƒ³å®ç°å¦‚ä½•çš„åŠŸèƒ½ï¼Ÿ</p>
<p>AddAfter ? æ‰€è°“çš„åœ¨ n time ä¹‹åçš„å†å°† item åŠ å…¥ queue çš„åŠŸèƒ½</p>
<p>ä¸ºäº†å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œé¦–å…ˆè¦è€ƒè™‘ AddAfter æ˜¯åŒæ­¥çš„ï¼Œäº¦æˆ–æ˜¯å¼‚æ­¥çš„æ–¹æ³• ?</p>
<p>å½“å‰å®ç°æ˜¯å¼‚æ­¥çš„æ–¹æ³•</p>
<h2 id="AddAfter"><a href="#AddAfter" class="headerlink" title="AddAfter"></a>AddAfter</h2><p>è®¡ç®—å‡º readyAt æ—¶é—´ï¼Œå°†è¯¥æ—¶é—´ä¸ item ä¸€å¹¶å­˜å…¥ waitingForAddChï¼Œè¿™ä¸ª ch çš„å¤§å°ä¸º 1000ï¼Œä¹Ÿå°±æ˜¯è¯´æœªè¾¾åˆ° 1000 æ—¶ï¼ŒAddAfter æ˜¯ä¸ä¼šè¢«é˜»å¡çš„</p>
<p>ç»†å¿ƒçš„åŒå­¦å¯èƒ½ä¼šé—®ï¼Œå¦‚æœ AddAfter çš„æ—¶é—´ä¸º 0 ç”šè‡³ä¸ºè´Ÿæ€ä¹ˆåŠï¼Œå½“ç„¶è¿™ç§æƒ…å†µç›´æ¥åŠ å…¥ queue å³å¯ï¼Œå°±ä¸éœ€è¦å†åŠ å…¥ waitingForAddCh äº†</p>
<h2 id="waitingLoop"><a href="#waitingLoop" class="headerlink" title="waitingLoop"></a>waitingLoop</h2><p>å½“ç„¶ä¸ºäº†å®ç° AddAfter è¿™ä¸ªåŠŸèƒ½ï¼Œå…ä¸äº† queue éœ€è¦åšä¸€äº›é¢å¤–çš„ç»´æŠ¤äº‹æƒ…ï¼Œæœ€é‡è¦çš„å°±æ˜¯ queue åˆå§‹åŒ–æ—¶ï¼Œå¼€å§‹ç”¨åç¨‹æ‰§è¡Œ waitingLoop æ–¹æ³•</p>
<p>è¿™ä¸ªæ–¹æ³•æ˜¯å®ç° <code>delaying_queue</code> åŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘</p>
<p>æ³¨æ„åˆ°å¾…åŠ å…¥ queue çš„ item ä½äº <code>waitingForAddCh</code> ä¸­ï¼Œ<code>waitingLoop</code> å½“å¯ä»¥ä» <code>waitingForAddCh</code> è·å–åˆ° item æ—¶</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> waitEntry := &lt;-q.waitingForAddCh:</span><br><span class="line">    <span class="keyword">if</span> waitEntry.readyAt.After(q.clock.Now()) &#123;</span><br><span class="line">        insert(waitingForQueue, waitingEntryByData, waitEntry)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        q.Add(waitEntry.data)</span><br><span class="line">    &#125;</span><br><span class="line">    drained := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> !drained &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> waitEntry := &lt;-q.waitingForAddCh:</span><br><span class="line">            <span class="keyword">if</span> waitEntry.readyAt.After(q.clock.Now()) &#123;</span><br><span class="line">                insert(waitingForQueue, waitingEntryByData, waitEntry)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                q.Add(waitEntry.data)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            drained = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆä¼šåˆ¤æ–­è¿™ä¸ª item æ˜¯å¦å¯ä»¥åŠ å…¥ queue äº†ï¼Œå¦‚æœæ—¶å€™è¿˜æ²¡åˆ°ï¼Œé‚£ä¹ˆå°†è¯¥ item åŠ å…¥ä»¥ readyAt ä¸ºæ’åºå…³é”®çš„ä¼˜å…ˆé˜Ÿåˆ—ä¸­ã€‚è‹¥æ—¶å€™åˆ°äº†ï¼Œåˆ™åŠ å…¥ queueã€‚å¤„ç†å®Œç¬¬ä¸€ä¸ª item ä¹‹åï¼Œä¼šå°† <code>waitingForAddCh</code> ä¸­å‰©ä½™çš„ item å‡æŒ‰ç…§ç›¸åŒçš„é€»è¾‘å¤„ç†ä¹‹</p>
<p>è¿™ä¸ª item åŠ å…¥ä¼˜å…ˆé˜Ÿåˆ—æ—¶ï¼Œè¿˜æœ‰ä¸€ä¸ªè®²ç©¶çš„åœ°æ–¹ï¼Œæ³¨æ„åˆ°ä¸‹è¿°ä»£ç </p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// insert adds the entry to the priority queue, or updates the readyAt if it already exists in the queue</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">insert</span><span class="params">(q *waitForPriorityQueue, knownEntries <span class="keyword">map</span>[t]*waitFor, entry *waitFor)</span></span> &#123;</span><br><span class="line">    <span class="comment">// if the entry already exists, update the time only if it would cause the item to be queued sooner</span></span><br><span class="line">    existing, exists := knownEntries[entry.data]</span><br><span class="line">    <span class="keyword">if</span> exists &#123;</span><br><span class="line">        <span class="keyword">if</span> existing.readyAt.After(entry.readyAt) &#123;</span><br><span class="line">            existing.readyAt = entry.readyAt</span><br><span class="line">            heap.Fix(q, existing.index)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    heap.Push(q, entry)</span><br><span class="line">    knownEntries[entry.data] = entry</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¦‚æœåŠ å…¥çš„ item å·²ç»å­˜åœ¨ï¼Œå¹¶ä¸”æ–°åŠ å…¥ item çš„ readyAt æ—¶é—´æ¯”å·²ç»å­˜åœ¨çš„ item çš„æ—¶é—´æ™šï¼Œé‚£ä¹ˆä¸å¥½æ„æ€å“ˆï¼Œè¿™ä¸ª item ä¼šè¢«ç›´æ¥ä¸¢å¼ƒã€‚åªæœ‰æ–°åŠ å…¥çš„ item çš„ readyAt æ—¶é—´æ¯”å·²å­˜åœ¨çš„ item æ—¶é—´è¦æ—©ï¼Œæ‰ä¼šæ›´æ–°å·²å­˜åœ¨çš„ item çš„ readyAt æ—¶é—´ï¼Œå¹¶è°ƒæ•´ item åœ¨ä¼˜å…ˆé˜Ÿåˆ—ä¸­çš„ä½ç½®</p>
<p>æ‰€ä»¥çœ‹åˆ°è¿™é‡Œï¼Œdelaying_queue å®é™…ä¸Šè¿˜æœ‰<strong>å»é‡</strong>åŠŸèƒ½</p>
<p>å›åˆ° waitingLoop çš„ loop æ¥ï¼Œloop é¦–å…ˆè¦æ‰§è¡Œçš„æ“ä½œï¼Œå³ä¸ºä»ä¼˜å…ˆé˜Ÿåˆ—ä¸­ä¾æ¬¡ Peek itemï¼Œå³ä¸æ–­ä»ä¼˜å…ˆé˜Ÿåˆ—ä¸­å–å‡ºç¬¬ä¸€ä¸ª itemï¼Œè¿™ä¸ª item æœ€æœ‰å¯èƒ½åˆ°è§¦å‘æ—¶é—´äº†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Add ready entries</span></span><br><span class="line"><span class="keyword">for</span> waitingForQueue.Len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">    entry := waitingForQueue.Peek().(*waitFor)</span><br><span class="line">    <span class="keyword">if</span> entry.readyAt.After(now) &#123;</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    entry = heap.Pop(waitingForQueue).(*waitFor)</span><br><span class="line">    q.Add(entry.data)</span><br><span class="line">    <span class="built_in">delete</span>(waitingEntryByData, entry.data)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ˜¾ç„¶å¦‚æœåˆ°è¾¾äº† Add æ—¶é—´ï¼Œé‚£ä¹ˆå°±å°†å…¶åŠ å…¥ queue ä¸­ï¼Œå¹¶æ‰§è¡Œä¸€äº›æ¸…ç†å·¥ä½œã€‚è‹¥ç»ˆäºéå†åˆ°æœªåˆ°è§¦å‘æ—¶é—´çš„ item äº†ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥é€€å‡ºéå†ä¼˜å…ˆé˜Ÿåˆ—çš„å¾ªç¯äº†</p>
<p>å› ä¸ºè¿™ä¸ªæ—¶å€™ï¼Œæ‰€æœ‰å½“å‰å¯ä»¥ Add queue çš„ item éƒ½å·²ç»å¤„ç†å®Œäº†ï¼Œæ‰€ä»¥æ¥ä¸‹æ¥ï¼Œå¯ä»¥æ‰§è¡Œä¸€æ®µä¼˜åŒ–çš„é€»è¾‘ï¼ŒåŠ å¿« item çš„å¤„ç†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Set up a wait for the first item&#x27;s readyAt (if one exists)</span></span><br><span class="line">nextReadyAt := never</span><br><span class="line"><span class="keyword">if</span> waitingForQueue.Len() &gt; <span class="number">0</span> &#123;</span><br><span class="line">    entry := waitingForQueue.Peek().(*waitFor)</span><br><span class="line">    nextReadyAt = q.clock.After(entry.readyAt.Sub(now))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸ªæœ‰ç‚¹æ„æ€ï¼Œéƒ½å¤„ç†å®Œäº†æ˜¯å§ï¼Œé‚£æˆ‘é€‰ä¼˜å…ˆé˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ª itemï¼Œç”¨å®ƒçš„ readyAt æ—¶é—´è®¾ç½®ä¸€ä¸ªå®šæ—¶å™¨ï¼Œè¿™æ ·çš„è¯ï¼Œä¸€æ—¦åˆ°è¾¾éœ€è¦ Add çš„æ—¶é—´ï¼ŒwaitLoop å°±ä¼šå¤„ç†äº† (å½“ç„¶ç”¨æˆ·æ€çš„ç¨‹åºï¼Œå®šæ—¶ä¸Šéƒ½æœ‰äº›è®¸åå·®ï¼Œä¸ä¼šç‰¹åˆ«ç‰¹åˆ«ç²¾ç¡®)</p>
<p>éƒ½å‡†å¤‡å¥½ä¹‹åï¼ŒwaitLoop å°±è¿›å…¥ç­‰å¾…æ•°æ®/äº‹ä»¶çš„é€»è¾‘äº†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> &#123;</span><br><span class="line"><span class="keyword">case</span> &lt;-q.stopCh:</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line"><span class="keyword">case</span> &lt;-q.heartbeat.C():</span><br><span class="line">    <span class="comment">// continue the loop, which will add ready items</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯å¿ƒè·³ï¼Œæ‰€è°“çš„æœ€å¤§ç­‰å¾…æ—¶é—´ï¼Œç›®å‰æ˜¯ 10sï¼Œå³å¦‚æœ 10s å†…å•¥éƒ½æ²¡å‘ç”Ÿçš„è¯ï¼Œä¹Ÿä¼šæ‰§è¡Œä¸€èˆ¬ waitLoop ä¸­çš„å¾ªç¯é€»è¾‘</span></span><br><span class="line"><span class="keyword">case</span> &lt;-nextReadyAt:</span><br><span class="line">    <span class="comment">// continue the loop, which will add ready items</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ä¼˜å…ˆé˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ª item çš„å®šæ—¶å™¨è§¦å‘äº†</span></span><br><span class="line"><span class="keyword">case</span> waitEntry := &lt;-q.waitingForAddCh:</span><br><span class="line">    <span class="comment">// è¿™æ˜¯æˆ‘ä»¬è¯´çš„ï¼Œé¦–å…ˆåˆ¤æ–­ç¬¬ä¸€ä¸ª item æ˜¯å¦å¯ä»¥åŠ å…¥ queue</span></span><br><span class="line">    <span class="keyword">if</span> waitEntry.readyAt.After(q.clock.Now()) &#123;</span><br><span class="line">        insert(waitingForQueue, waitingEntryByData, waitEntry)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        q.Add(waitEntry.data)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥ä¼šå¤„ç†ä»ç„¶å¤„äº waitingForAddCh ä¸­çš„ itemï¼Œä¸ä¸Šè¿°é€»è¾‘ä¸€è‡´</span></span><br><span class="line">    drained := <span class="literal">false</span></span><br><span class="line">    <span class="keyword">for</span> !drained &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> waitEntry := &lt;-q.waitingForAddCh:</span><br><span class="line">            <span class="keyword">if</span> waitEntry.readyAt.After(q.clock.Now()) &#123;</span><br><span class="line">                insert(waitingForQueue, waitingEntryByData, waitEntry)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                q.Add(waitEntry.data)</span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            drained = <span class="literal">true</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>okï¼Œè‡³æ­¤ delaying_queue çš„è¦ç‚¹å°±è¯´å®Œäº†ï¼Œä¸‹é¢æå‡ ç‚¹ä½¿ç”¨çš„æ—¶å€™çš„æ³¨æ„ç‚¹ï¼Œé¿å…è¸©å‘</p>
<ul>
<li>AddAfter ä¸ºå¼‚æ­¥æ–¹æ³•ï¼Œæ‰€ä»¥ç°è±¡ä¸ºè°ƒç”¨ AddAfter ä¹‹åï¼Œitem å¹¶ä¸ä¼šç«‹å³è¢«åŠ å…¥åˆ° queue ä¸­</li>
<li>AddAfter ä¼šåšå»é‡å¤„ç†ï¼Œåœ¨ queue ä¸­ä¾ç„¶æœ‰ç›¸åŒçš„ item æ—¶ï¼Œå¦‚æœæ–°åŠ å…¥ item çš„ readyAt time é åçš„è¯ï¼Œæ–°åŠ å…¥çš„ item ä¼šè¢«ä¸¢å¼ƒ</li>
</ul>
<h1 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h1><p>ä»£ç å®ç°ä½äº queue.go ä¸­</p>
<p>å¥½äº†ï¼Œåœ¨ç»è¿‡ DelayQueue çš„å»¶æ—¶åŠ å…¥ç­–ç•¥ä¹‹åï¼Œæœ€ç»ˆ item è¿˜æ˜¯è¢«åŠ å…¥ queue ä¸­çš„ï¼Œè€Œ queue çš„å®ç°ä¹Ÿå¤šæœ‰è®²ç©¶ï¼Œæ¥ä¸€æ¢ç©¶ç«Ÿå§</p>
<p>queue å†…éƒ¨æœ‰ä¸¤ä¸ªé‡è¦çš„æ•°æ®ç»“æ„</p>
<ul>
<li>processing set</li>
<li>dirty set</li>
</ul>
<p>æœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æ–¹æ³•</p>
<ul>
<li>Done</li>
</ul>
<p>é¦–å…ˆæ¥çœ‹ä¸€ä¸‹ queue çš„ Add æ–¹æ³•</p>
<h2 id="Add"><a href="#Add" class="headerlink" title="Add"></a>Add</h2><p>ä»£ç ä¸å¤šï¼Œç›´æ¥ä¸Šäº†</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Type)</span> <span class="title">Add</span><span class="params">(item <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    <span class="comment">// cond åŠ é”</span></span><br><span class="line">    q.cond.L.Lock()</span><br><span class="line">    <span class="keyword">defer</span> q.cond.L.Unlock()</span><br><span class="line">    <span class="keyword">if</span> q.shuttingDown &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœåœ¨ dirty set ä¸­ï¼Œé‚£ä¹ˆè¯¥ item è¢«å¿½ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> q.dirty.has(item) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    q.metrics.add(item)</span><br><span class="line">    <span class="comment">// dirty set æ ‡è®°</span></span><br><span class="line">    q.dirty.insert(item)</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰ item ä»ç„¶åœ¨å¤„ç†ä¸­ï¼Œåˆ™è¢«å¿½ç•¥</span></span><br><span class="line">    <span class="keyword">if</span> q.processing.has(item) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åŠ å…¥ queue</span></span><br><span class="line">    q.queue = <span class="built_in">append</span>(q.queue, item)</span><br><span class="line">    <span class="comment">// é€šçŸ¥ cond lock çš„åç¨‹</span></span><br><span class="line">    q.cond.Signal()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Get"><a href="#Get" class="headerlink" title="Get"></a>Get</h2><blockquote>
<p>queue çš„å‡ºå£</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Type)</span> <span class="title">Get</span><span class="params">()</span> <span class="params">(item <span class="keyword">interface</span>&#123;&#125;, shutdown <span class="keyword">bool</span>)</span></span> &#123;</span><br><span class="line">    <span class="comment">// cond åŠ é”</span></span><br><span class="line">    q.cond.L.Lock()</span><br><span class="line">    <span class="keyword">defer</span> q.cond.L.Unlock()</span><br><span class="line">    <span class="comment">// å¦‚æœ queue ä¸ºç©ºï¼Œå¹¶ä¸” queue æœªå…³é—­ï¼Œåˆ™ç­‰å¾…</span></span><br><span class="line">    <span class="comment">// å³ Get æ–¹æ³•åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæ˜¯é˜»å¡çš„</span></span><br><span class="line">    <span class="keyword">for</span> <span class="built_in">len</span>(q.queue) == <span class="number">0</span> &amp;&amp; !q.shuttingDown &#123;</span><br><span class="line">        q.cond.Wait()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™ç§æƒ…å†µæ˜¯ queue å…³é—­çš„æ—¶å€™</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(q.queue) == <span class="number">0</span> &#123;</span><br><span class="line">        <span class="comment">// We must be shutting down.</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å– queue ä¸­ç¬¬ä¸€ä¸ª item è¿”å›</span></span><br><span class="line">    item, q.queue = q.queue[<span class="number">0</span>], q.queue[<span class="number">1</span>:]</span><br><span class="line">    q.metrics.get(item)</span><br><span class="line">    <span class="comment">// æ ‡è®° item ä¸ºå¤„ç†ä¸­</span></span><br><span class="line">    q.processing.insert(item)</span><br><span class="line">    <span class="comment">// å»é™¤ item dirty æ ‡è®°</span></span><br><span class="line">    q.dirty.<span class="built_in">delete</span>(item)</span><br><span class="line">    <span class="keyword">return</span> item, <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹äº† Add ä¸ Get å®ç°åï¼Œæˆ‘ä»¬å¾—åˆ°å‡ ä¸ªç»“è®º</p>
<ul>
<li>queue ä¹Ÿå®ç°äº†å»é‡: Add ç›¸åŒ itemï¼Œè‹¥è¯¥ item æœªè¢« Getï¼Œé‚£ä»…ä¼šè¢«åŠ å…¥ queue ä¸€æ¬¡</li>
<li>queue.Get æ–¹æ³•åœ¨ queue ä¸­æ²¡æ•°æ®æ—¶ï¼Œæ˜¯é˜»å¡çš„ï¼Œå³ä½ å¯ä»¥è¿™å†™</li>
</ul>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">    obj := queue.Get()</span><br><span class="line">    <span class="comment">// obj ä¸€å®šå­˜åœ¨</span></span><br><span class="line">    <span class="comment">// blabla</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Done"><a href="#Done" class="headerlink" title="Done"></a>Done</h2><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(q *Type)</span> <span class="title">Done</span><span class="params">(item <span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">    q.cond.L.Lock()</span><br><span class="line">    <span class="keyword">defer</span> q.cond.L.Unlock()</span><br><span class="line">    q.metrics.done(item)</span><br><span class="line">    q.processing.<span class="built_in">delete</span>(item)</span><br><span class="line">    <span class="keyword">if</span> q.dirty.has(item) &#123; <span class="comment">// å¦‚æœ item è¢«æ ‡è®°ä¸º dirtyï¼Œåˆ™é‡æ–°åŠ å…¥ queue ä¸­</span></span><br><span class="line">        q.queue = <span class="built_in">append</span>(q.queue, item)</span><br><span class="line">        q.cond.Signal()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Done æ–¹æ³•ä¼šå»æ‰ item çš„ processing æ ‡è®°ï¼Œå¹¶ä¸”å¦‚æœ item è¢«æ ‡è®°ä¸º dirtyï¼Œé‚£ä¼šå†å°† item åŠ å…¥ queueã€‚æœ‰è¿™ä¸ªé€»è¾‘é‚£æˆ‘ä»¬åº”è¯¥å¦‚ä½•ä½¿ç”¨ queue ?</p>
<p>æˆ‘ä»¬é¦–å…ˆæ¥è€ƒè™‘è¿™ç§åœºæ™¯</p>
<p>itemA è¢« Add queueï¼Œæ­¤æ—¶ X åç¨‹ Get æ—¶ï¼Œè·å–åˆ°äº† itemAï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒitemA è¢«æ ‡è®°ä¸º processingï¼Œè€Œæ²¡æœ‰ dirty çš„æ ‡è®°ï¼Œè‹¥æ­¤æ—¶å¦ä¸€ Y åç¨‹åˆå†æ¬¡è°ƒç”¨ Add æ–¹æ³•å°† itemA Add queueï¼Œè¿™æ—¶ itemA å°±è¢«æ ‡è®°ä¸º dirty äº†ï¼Œå¹¶ä¸”å› ä¸ºæœ‰ processing æ ‡è®°ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šè¢«åŠ å…¥ queue ä¸­</p>
<p>è¿‡äº†ä¸€äº›æ—¶é—´åï¼ŒX åç¨‹æ‰§è¡Œ ok äº†ï¼Œè°ƒç”¨ Done(itemA) æ–¹æ³•ï¼Œå»é™¤ itemA çš„ processing æ ‡è®°ï¼Œå› ä¸º itemA ä¸º dirtyï¼Œæ‰€ä»¥å°†å…¶é‡æ–°åŠ å…¥ queue ä¸­ï¼Œç­‰å¾…è¢« Get å¹¶å¤„ç†</p>
<p>æ‰€ä»¥åœ¨è¿™ç§åœºæ™¯ä¸‹å°±å¥½ç†è§£å¤šäº†ï¼Œå®é™…ä¸Š queue è¿˜æœ‰ä¸ªç‰¹æ€§ï¼Œå³ queue ä¸­ä¸ä¼šæœ‰é‡å¤çš„ itemï¼Œä½†æ˜¯ä»…å…è®¸ item è¢« Get ä¹‹åï¼ŒDone ä¹‹å‰ï¼Œè¢« Add ä¸€æ¬¡ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒDone çš„æ—¶å€™ï¼Œä¼šé‡æ–°å°† item åŠ å…¥ queue ä¸­</p>
<p>å¯ä»¥ç†è§£ä¸ºå¦‚æœè¿™ä¸ª item æ­£åœ¨è¢«å¤„ç†æ—¶ï¼Œqueue å…è®¸è‡³å¤šç¼“å­˜ä¸€æ¬¡ç›¸åŒçš„ item</p>
<p>æ‰€ä»¥å†æ€»ç»“ä¸€æ¬¡ queue çš„ç‰¹æ€§</p>
<ul>
<li>æ·»åŠ  item è°ƒç”¨ Add æ–¹æ³•</li>
<li>è·å– item è°ƒç”¨ Get æ–¹æ³•</li>
<li>å¤„ç† item ä¹‹åè°ƒç”¨ Done æ–¹æ³•ã€‚å¦åˆ™å†æ¬¡ Add ç›¸åŒ item æ—¶ï¼Œè‹¥è¯¥ item ä»æœªè¢« Get åˆ™ç›´æ¥è¢«å¿½ç•¥ã€‚è‹¥è¯¥ item å·²è¢« Getï¼Œåˆ™è¢«æ‰“ä¸Š dirty æ ‡è®°ï¼Œåœ¨å…¶è¢«è°ƒç”¨ Done æ—¶ï¼Œè¯¥ item æ‰ä¼šè¢«é‡æ–°åŠ å…¥ queue ä¸­</li>
<li>æœ¬è´¨ä¸Š queue ä¸­ä¸ä¼šæœ‰é‡å¤çš„ item</li>
</ul>
<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><p>åœ¨çœ‹äº†è¿™å‡ ç§ queue çš„å®ç°ä¹‹åï¼Œæ˜¯å¦æ›´äº†è§£ rate_limmiting_queue.go è¯¥å¦‚ä½•ä½¿ç”¨äº†ï¼Ÿ</p>
<p>ä¾‹å¦‚åœ¨ knative-build-controller ä¸­å®ƒè¢«å¦‚æ­¤åˆå§‹åŒ– (å¤©ä¸‹ä»£ç ä¸€å¤§æŠ„)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">workqueue.NewNamedRateLimitingQueue(workqueue.DefaultControllerRateLimiter(), <span class="string">&quot;Builds&quot;</span>),</span><br></pre></td></tr></table></figure>

<p>å…·ä½“ä½¿ç”¨æ—¶</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Controller)</span> <span class="title">processNextWorkItem</span><span class="params">()</span> <span class="title">bool</span></span> &#123;</span><br><span class="line">    <span class="comment">// ä» queue ä¸­å– item</span></span><br><span class="line">    obj, shutdown := c.workqueue.Get()</span><br><span class="line">    <span class="keyword">if</span> shutdown &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> err := <span class="function"><span class="keyword">func</span><span class="params">(obj <span class="keyword">interface</span>&#123;&#125;)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†ç»“æŸä¹‹åï¼Œéœ€è¦è°ƒç”¨ Done</span></span><br><span class="line">        <span class="keyword">defer</span> c.workqueue.Done(obj)</span><br><span class="line">        </span><br><span class="line">        key, ok := obj.(<span class="keyword">string</span>)</span><br><span class="line">        <span class="keyword">if</span> !ok &#123;</span><br><span class="line">            c.workqueue.Forget(obj) <span class="comment">// Fatal é”™è¯¯ï¼Œè°ƒç”¨ Forgetï¼Œæ²¡æœ‰é‡è¯•çš„å¿…è¦</span></span><br><span class="line">            runtime.HandleError(fmt.Errorf(<span class="string">&quot;expected string in workqueue but got %#v&quot;</span>, obj))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> err := c.syncHandler(key); err != <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="comment">// å¤„ç†å¤±è´¥æ—¶ï¼Œä¸è°ƒç”¨ Forgetï¼Œå¢åŠ  item çš„é‡è¯•æ¬¡æ•°</span></span><br><span class="line">            <span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;error syncing &#x27;%s&#x27;: %s&quot;</span>, key, err.Error())</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„ç†æˆåŠŸè°ƒç”¨ Forgetï¼Œæ¸…é™¤ item çš„é‡è¯•æ¬¡æ•°ï¼Œä½¿å¾—ä¸‹æ¬¡ç›¸åŒçš„ item ä¸å— rate limit å½±å“</span></span><br><span class="line">        c.workqueue.Forget(obj)</span><br><span class="line">        c.logger.Infof(<span class="string">&quot;Successfully synced &#x27;%s&#x27;&quot;</span>, key)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    &#125;(obj); err != <span class="literal">nil</span> &#123;</span><br><span class="line">        runtime.HandleError(err)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ‰€ä»¥å†è¯´ä¸€éæµ“ç¼©ç”¨æ³•</p>
<ul>
<li>æ·»åŠ  item è°ƒç”¨ Add æ–¹æ³•</li>
<li>è·å– item è°ƒç”¨ Get æ–¹æ³•</li>
<li>å¤„ç† item ä¹‹åè°ƒç”¨ Done æ–¹æ³•</li>
<li>ä¸å¢åŠ  item é‡è¯•æ¬¡æ•°è°ƒç”¨ Forget æ–¹æ³•</li>
</ul>
<p>å†è¯´ä¸€é rate limit queue é‡ç‚¹ï¼Œåˆ‡è«è¸©å‘</p>
<ul>
<li>Add æ˜¯å¼‚æ­¥æ–¹æ³•</li>
<li>Add æœ‰å»é‡åŠŸèƒ½<ul>
<li>å…ˆç»è¿‡ DelayQueue å»é‡å¤„ç†ï¼Œå¯¹äºæ–°åŠ å…¥çš„ itemï¼Œåœ¨å…¶ä¼˜å…ˆé˜Ÿåˆ—ä¸­ä¾ç„¶æœ‰ç›¸åŒçš„ item æ—¶ï¼Œå¦‚æœæ–°åŠ å…¥ item çš„ readyAt time è¾ƒåŸ item çš„ readyAt æ—¶é—´é åçš„è¯ï¼Œæ–°åŠ å…¥çš„ item ä¼šè¢«ä¸¢å¼ƒ</li>
<li>å†ç»è¿‡ Queue å»é‡å¤„ç†ï¼Œå¦‚æœ queue ä¸­æœ‰ç›¸åŒ item åˆ™ç›´æ¥è¢«ä¸¢å¼ƒã€‚è‹¥ queue ä¸­æ²¡æœ‰ç›¸åŒ itemï¼Œä½†æ˜¯ item å¤„äºè¢«å¤„ç†ä¸­ï¼Œå³æœªè¢«è°ƒç”¨ Done æ—¶ï¼Œä¼šå°† item æ ‡è®°ä¸º dirtyï¼Œå¾… item è¢«è°ƒç”¨ Done æ—¶ï¼Œé‡æ–°åŠ å…¥ queue</li>
</ul>
</li>
<li>å¤„ç† item ç»“æŸä¹‹åï¼Œæ— è®ºå¦‚ä½•è°ƒç”¨ Doneï¼Œæ ‡è¯†è¯¥ item å·²è¢«å¤„ç†ç»“æŸ</li>
<li>è‹¥ä¸éœ€è¦å¢åŠ  item çš„é‡è¯•æ¬¡æ•°ï¼Œåˆ™ç»“æŸä¹‹åè°ƒç”¨ Forget æ–¹æ³•ï¼Œæ¸…é™¤è¯¥ item çš„é‡è¯•æ¬¡æ•°ç»Ÿè®¡</li>
<li>å¦‚æœéœ€è¦è°ƒç”¨ Forgetï¼Œåˆ™å…ˆè°ƒç”¨ Forget å†è°ƒç”¨ Doneï¼Œç¡®ä¿å†æ¬¡ Add çš„æ—¶å€™ä¸å—é™æµå½±å“</li>
</ul>
<p>ä¹‹æ‰€ä»¥å…³æ³¨åˆ°è¿™ä¸ªé—®é¢˜ï¼Œæ˜¯å› ä¸ºåœ¨å†™ build-controller ä¸€ä¸ª bugfix çš„ ut æ—¶ï¼Œå„ç§å‘ï¼Œé‚ç ”ç©¶äº†ä¸‹ workqueue çš„ç»†èŠ‚ï¼Œå…³äºè¿™ä¸ª bugfix çš„è®¨è®ºçœ‹è¿™ä¸ªé“¾æ¥ <a target="_blank" rel="noopener" href="https://github.com/knative/build/issues/332">Timeout of build may have problem</a></p>
<p>Thanks for your time ğŸ˜</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/73c2c618.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="é¢†ç•¥äº†ç¹åæ²§æ¡‘<br>è°äººè¿‡å¾€ä¸ç›¸ä¼¼">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="éšé£é£˜æ•£çš„è®°å¿†">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/73c2c618.html" class="post-title-link" itemprop="url">client go informers</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">å‘è¡¨äº</span>

      <time title="åˆ›å»ºæ—¶é—´ï¼š2018-09-16 14:09:09" itemprop="dateCreated datePublished" datetime="2018-09-16T14:09:09Z">2018-09-16</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">æ›´æ–°äº</span>
        <time title="ä¿®æ”¹æ—¶é—´ï¼š2020-11-22 06:09:55" itemprop="dateModified" datetime="2020-11-22T06:09:55Z">2020-11-22</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="æœ¬æ–‡å­—æ•°">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">æœ¬æ–‡å­—æ•°ï¼š</span>
      <span>426</span>
    </span>
    <span class="post-meta-item" title="é˜…è¯»æ—¶é•¿">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">é˜…è¯»æ—¶é•¿ &asymp;</span>
      <span>1 åˆ†é’Ÿ</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>å ä¸ªå‘ï¼Œè¿˜æ˜¯åœ¨ ut çš„æ—¶å€™è¢«å‘åˆ°äº†ï¼Œåç»­æœ‰æ—¶é—´è¡¥ä¸Šï¼Œè¿™ä¸ªæˆ‘è®¤ä¸º k8s æœ€æˆåŠŸçš„åœ°æ–¹</p>
<p>ä¸æ˜¯å®¹å™¨è°ƒåº¦ï¼Œè€Œæ˜¯è¿™å¥—åŸºäº etcd æŠ½è±¡å‡ºæ¥çš„ api ğŸ˜ƒ</p>
<ul>
<li>informer</li>
<li>lister</li>
</ul>
<p>è¿™ informer å‘€ï¼Œå…¶å®å°±æ˜¯æä¾› add/update/create å›è°ƒçš„å°è£… (æ‰€è°“ informer)</p>
<p>è€Œè¿™ lister å‘¢ï¼Œæ˜¯å¯¹è±¡ cacheï¼Œä» lister ä¸­å¯ä»¥è·å–åˆ°å¯¹è±¡ã€‚lister ç”± informer æä¾›ã€‚</p>
<p>å…¶å®è¿˜æŒºè‡ªç„¶çš„ï¼Œæƒ³æƒ³ informer å›è°ƒ add/update/create çš„æ—¶å€™ï¼ŒåŸºæœ¬æ€è·¯</p>
<ul>
<li>list-watch kube-apiserver</li>
<li>watch åˆ°å¯¹è±¡å˜åŒ–ï¼Œæ ¹æ® cache è®¡ç®— diffï¼Œç„¶åç›¸åº”å›è°ƒ add/update/create</li>
</ul>
<p>æ‰€ä»¥å®ƒæ˜¯éœ€è¦ lister è¿™æ ·çš„ local cache çš„</p>
<p>æ‰€ä»¥å¦‚æœè‡ªå·±è¦å®ç°ä¸€ä¸ª k8s style çš„ controllerï¼Œéœ€è¦ä½¿ç”¨åˆ° informer æ—¶ï¼Œé¦–å…ˆåˆå§‹åŒ– informerï¼Œåˆå§‹åŒ– ok ä¹‹åï¼Œå¦‚æœéœ€è¦æŸ¥å¯¹è±¡ï¼Œé‚£å¯ä»¥é€šè¿‡ informer çš„ lister æ¥è·å–</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/5/"><i class="fa fa-angle-left" aria-label="ä¸Šä¸€é¡µ"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/5/">5</a><span class="page-number current">6</span><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/7/"><i class="fa fa-angle-right" aria-label="ä¸‹ä¸€é¡µ"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="ç«™ç‚¹æ€»å­—æ•°">282k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="ç«™ç‚¹é˜…è¯»æ—¶é•¿">4:16</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
