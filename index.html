<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="领略了繁华沧桑谁人过往不相似">
<meta property="og:type" content="website">
<meta property="og:title" content="随风飘散的记忆">
<meta property="og:url" content="https://zrss.github.io/index.html">
<meta property="og:site_name" content="随风飘散的记忆">
<meta property="og:description" content="领略了繁华沧桑谁人过往不相似">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="tech">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zrss.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>随风飘散的记忆</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">随风飘散的记忆</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">领略了繁华沧桑<br>谁人过往不相似</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">121</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/fee9442e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/fee9442e.html" class="post-title-link" itemprop="url">golang handle signals</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-12-25 15:00:00 / 修改时间：07:42:38" itemprop="dateCreated datePublished" datetime="2022-12-25T15:00:00Z">2022-12-25</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://pkg.go.dev/os/signal#hdr-Default_behavior_of_signals_in_Go_programs">https://pkg.go.dev/os/signal#hdr-Default_behavior_of_signals_in_Go_programs</a></p>
<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/os/signal#hdr-Changing_the_behavior_of_signals_in_Go_programs">https://pkg.go.dev/os/signal#hdr-Changing_the_behavior_of_signals_in_Go_programs</a></p>
<blockquote>
<p>By default, a synchronous signal is converted into a run-time panic. A SIGHUP, SIGINT, or SIGTERM signal causes the program to exit. </p>
<p>Notify disables the default behavior for a given set of asynchronous signals and instead delivers them over one or more registered channels. Specifically, it applies to the signals SIGHUP, SIGINT, SIGQUIT, SIGABRT, and SIGTERM. </p>
</blockquote>
<p>但是别忘了会有 race 的情况, 下边通过 bash shell 脚本来启动 golang 进程做一个示例</p>
<p>test-signal</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/signal&quot;</span></span><br><span class="line">	<span class="string">&quot;syscall&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	signalCh := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">2</span>)</span><br><span class="line">	signal.Notify(signalCh, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;notify signals\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		sig := &lt;- signalCh</span><br><span class="line">		fmt.Printf(<span class="string">&quot;receive signal %v\n&quot;</span>, sig)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;wait signal\n&quot;</span>)</span><br><span class="line">	time.Sleep(time.Minute)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>test1.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./test-signal &amp;</span><br><span class="line">pid=$!</span><br><span class="line"></span><br><span class="line">echo &quot;test-signal pid: $pid&quot;</span><br><span class="line"></span><br><span class="line">kill $pid</span><br><span class="line">wait $pid</span><br><span class="line"></span><br><span class="line">exit_code=$?</span><br><span class="line">echo &quot;test-signal exit_code: $exit_code&quot;</span><br></pre></td></tr></table></figure>

<p>test2.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">./test-signal &amp;</span><br><span class="line">pid=$!</span><br><span class="line"></span><br><span class="line">echo &quot;test-signal pid: $pid&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> important</span></span><br><span class="line">sleep 1</span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line">kill $pid</span><br><span class="line">wait $pid</span><br><span class="line"></span><br><span class="line">exit_code=$?</span><br><span class="line">echo &quot;test-signal exit_code: $exit_code&quot;</span><br></pre></td></tr></table></figure>

<p>test1.sh 的执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test-signal pid: 4878</span><br><span class="line">test1.sh: line 7:  4878 Terminated: 15          ./test-signal</span><br><span class="line">test-signal exit_code: 143</span><br></pre></td></tr></table></figure>

<p>test2.sh 的执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test-signal pid: 4880</span><br><span class="line">notify signals</span><br><span class="line">wait signal</span><br><span class="line">receive signal terminated</span><br></pre></td></tr></table></figure>

<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><ol>
<li>golang 程序处理 TERM 信号的默认行为是退出, 且退出码为 143 (128 + 15), 15 为 TERM</li>
<li>使用 signal.Notify 可以修改 golang 程序处理 TERM 信号的默认行为; 但是如果 golang 程序启动后过快接收到 TERM 信号 (在 signal.Notify 执行完成之前), 则会导致程序直接退出 (默认行为)</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/219bf6b1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/219bf6b1.html" class="post-title-link" itemprop="url">gorm v1 logger</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-12-17 10:32:00 / 修改时间：04:11:28" itemprop="dateCreated datePublished" datetime="2022-12-17T10:32:00Z">2022-12-17</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://v1.gorm.io/docs/">https://v1.gorm.io/docs/</a></p>
<p><a target="_blank" rel="noopener" href="https://v1.gorm.io/docs/logger.html">https://v1.gorm.io/docs/logger.html</a></p>
<blockquote>
<p>Refer GORM’s default logger for how to customize it</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/jinzhu/gorm/blob/v1.9.16/logger.go">https://github.com/jinzhu/gorm/blob/v1.9.16/logger.go</a></p>
<p>gorm v1 print log</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">print</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	s.logger.Print(v...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">log</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s != <span class="literal">nil</span> &amp;&amp; s.logMode == detailedLogMode &#123;</span><br><span class="line">		s.<span class="built_in">print</span>(<span class="built_in">append</span>([]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;log&quot;</span>, fileWithLineNum()&#125;, v...)...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">slog</span><span class="params">(sql <span class="keyword">string</span>, t time.Time, vars ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s.logMode == detailedLogMode &#123;</span><br><span class="line">		s.<span class="built_in">print</span>(<span class="string">&quot;sql&quot;</span>, fileWithLineNum(), NowFunc().Sub(t), sql, vars, s.RowsAffected)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gorm v1 print error</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AddError add error to the db</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">AddError</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err != ErrRecordNotFound &#123;</span><br><span class="line">			<span class="keyword">if</span> s.logMode == defaultLogMode &#123;</span><br><span class="line">				<span class="keyword">go</span> s.<span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>, fileWithLineNum(), err)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				s.log(err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			errors := Errors(s.GetErrors())</span><br><span class="line">			errors = errors.Add(err)</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(errors) &gt; <span class="number">1</span> &#123;</span><br><span class="line">				err = errors</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		s.Error = err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gorm v1 print sql</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// trace print sql log</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(scope *Scope)</span> <span class="title">trace</span><span class="params">(t time.Time)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(scope.SQL) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		scope.db.slog(scope.SQL, t, scope.SQLVars...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此在打开 gorm v1 LogMode 的时候</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LogMode set log mode, `true` for detailed logs, `false` for no log, default, will only print error logs</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">LogMode</span><span class="params">(enable <span class="keyword">bool</span>)</span> *<span class="title">DB</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> enable &#123;</span><br><span class="line">		s.logMode = detailedLogMode</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		s.logMode = noLogMode</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会进入到 <code>s.print log</code>, <code>s.print sql</code> 的打印逻辑</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.soberkoder.com/go-gorm-logging/">https://www.soberkoder.com/go-gorm-logging/</a></p>
</blockquote>
<p>如若需要自定义 gorm v1 logger 可以参考如下代码段</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GormLogger struct</span></span><br><span class="line"><span class="keyword">type</span> GormLogger <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print - Log Formatter</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*GormLogger)</span> <span class="title">Print</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> v[<span class="number">0</span>] == <span class="string">&quot;sql&quot;</span> &#123;</span><br><span class="line">    log.WithFields(</span><br><span class="line">      log.Fields&#123;</span><br><span class="line">        <span class="string">&quot;module&quot;</span>:        <span class="string">&quot;gorm&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:          <span class="string">&quot;sql&quot;</span>,</span><br><span class="line">        <span class="string">&quot;rows_returned&quot;</span>: v[<span class="number">5</span>],</span><br><span class="line">        <span class="string">&quot;src&quot;</span>:           v[<span class="number">1</span>],</span><br><span class="line">        <span class="comment">//&quot;values&quot;:        v[4],</span></span><br><span class="line">        <span class="string">&quot;duration&quot;</span>:      v[<span class="number">2</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ).Info(v[<span class="number">3</span>])</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log.WithFields(log.Fields&#123;<span class="string">&quot;module&quot;</span>: <span class="string">&quot;gorm&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;log&quot;</span>, <span class="string">&quot;src&quot;</span>: v[<span class="number">1</span>]&#125;).Print(v[<span class="number">2</span>:]...)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外也可以根据 <code>duration</code> 实现客户端的 slow sql 打印</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/52d00230.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/52d00230.html" class="post-title-link" itemprop="url">Docker container -i -t</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-08-14 02:56:55 / 修改时间：08:43:57" itemprop="dateCreated datePublished" datetime="2022-08-14T02:56:55Z">2022-08-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/run/#foreground">https://docs.docker.com/engine/reference/run/#foreground</a></p>
<p>-t : Allocate a pseudo-tty<br>-i : Keep STDIN open even if not attached</p>
</blockquote>
<p><code>docker run -t</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull ubuntu:bionic-20200713</span><br><span class="line"></span><br><span class="line">docker run -t --rm ubuntu:bionic-20200713 /bin/bash</span><br><span class="line">root@9a7a115ff8d2:/# ls</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动容器无 <code>-i</code> 参数时，执行 <code>ls</code> 等命令无回显，执行 <code>exit</code> 命令无法退出 container terminal</p>
<p><code>docker run -i</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -i --rm ubuntu:bionic-20200713 /bin/bash</span><br><span class="line">echo hello</span><br><span class="line">hello</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>启动容器无 <code>-t</code> 参数时，缺少常用的 terminal 功能，例如无当前登陆用户提示；但执行 <code>ls</code> 等命令正常有回显，且执行 <code>exit</code> 命令可退出</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48368411/what-is-docker-run-it-flag">https://stackoverflow.com/questions/48368411/what-is-docker-run-it-flag</a></p>
<p>Without <code>-t</code> tag one can still interact with the container, but with it, you’ll have a nicer, more features terminal.</p>
</blockquote>
<h1 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.24/#container-v1-core">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.24/#container-v1-core</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Variables for interactive containers, these have very specialized use-cases (e.g. debugging)</span></span><br><span class="line"><span class="comment">// and shouldn&#x27;t be used for general purpose containers.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Whether this container should allocate a buffer for stdin in the container runtime. If this</span></span><br><span class="line"><span class="comment">// is not set, reads from stdin in the container will always result in EOF.</span></span><br><span class="line"><span class="comment">// Default is false.</span></span><br><span class="line"><span class="comment">// +optional</span></span><br><span class="line">Stdin <span class="keyword">bool</span> <span class="string">`json:&quot;stdin,omitempty&quot; protobuf:&quot;varint,16,opt,name=stdin&quot;`</span></span><br><span class="line"><span class="comment">// Whether the container runtime should close the stdin channel after it has been opened by</span></span><br><span class="line"><span class="comment">// a single attach. When stdin is true the stdin stream will remain open across multiple attach</span></span><br><span class="line"><span class="comment">// sessions. If stdinOnce is set to true, stdin is opened on container start, is empty until the</span></span><br><span class="line"><span class="comment">// first client attaches to stdin, and then remains open and accepts data until the client disconnects,</span></span><br><span class="line"><span class="comment">// at which time stdin is closed and remains closed until the container is restarted. If this</span></span><br><span class="line"><span class="comment">// flag is false, a container processes that reads from stdin will never receive an EOF.</span></span><br><span class="line"><span class="comment">// Default is false</span></span><br><span class="line"><span class="comment">// +optional</span></span><br><span class="line">StdinOnce <span class="keyword">bool</span> <span class="string">`json:&quot;stdinOnce,omitempty&quot; protobuf:&quot;varint,17,opt,name=stdinOnce&quot;`</span></span><br><span class="line"><span class="comment">// Whether this container should allocate a TTY for itself, also requires &#x27;stdin&#x27; to be true.</span></span><br><span class="line"><span class="comment">// Default is false.</span></span><br><span class="line"><span class="comment">// +optional</span></span><br><span class="line">TTY <span class="keyword">bool</span> <span class="string">`json:&quot;tty,omitempty&quot; protobuf:&quot;varint,18,opt,name=tty&quot;`</span></span><br></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">config := &amp;runtimeapi.ContainerConfig&#123;</span><br><span class="line">	Metadata: &amp;runtimeapi.ContainerMetadata&#123;</span><br><span class="line">		Name:    container.Name,</span><br><span class="line">		Attempt: restartCountUint32,</span><br><span class="line">	&#125;,</span><br><span class="line">	Image:       &amp;runtimeapi.ImageSpec&#123;Image: imageRef&#125;,</span><br><span class="line">	Command:     command,</span><br><span class="line">	Args:        args,</span><br><span class="line">	WorkingDir:  container.WorkingDir,</span><br><span class="line">	Labels:      newContainerLabels(container, pod),</span><br><span class="line">	Annotations: newContainerAnnotations(container, pod, restartCount, opts),</span><br><span class="line">	Devices:     makeDevices(opts),</span><br><span class="line">	Mounts:      m.makeMounts(opts, container),</span><br><span class="line">	LogPath:     containerLogsPath,</span><br><span class="line">	Stdin:       container.Stdin,</span><br><span class="line">	StdinOnce:   container.StdinOnce,</span><br><span class="line">	Tty:         container.TTY,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="use-conda-env-in-docker"><a href="#use-conda-env-in-docker" class="headerlink" title="use conda env in docker"></a>use conda env in docker</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://pythonspeed.com/articles/activate-conda-dockerfile/">https://pythonspeed.com/articles/activate-conda-dockerfile/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.conda.io/projects/conda/en/latest/commands/run.html">https://docs.conda.io/projects/conda/en/latest/commands/run.html</a></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda run --no-capture-output -n my-python-env python --version</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/4c123add.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/4c123add.html" class="post-title-link" itemprop="url">mlnx ofed</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-19 14:11:00 / 修改时间：14:04:45" itemprop="dateCreated datePublished" datetime="2022-06-19T14:11:00Z">2022-06-19</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="mlnx-cx-adapter-card-firmware"><a href="#mlnx-cx-adapter-card-firmware" class="headerlink" title="mlnx cx adapter card firmware"></a>mlnx cx adapter card firmware</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://network.nvidia.com/support/firmware/connectx4ib/">https://network.nvidia.com/support/firmware/connectx4ib/</a></p>
</blockquote>
<ul>
<li>12.28.2006 – newer, current versions</li>
<li>12.28.1002 – old</li>
<li>12.27.4000 – older</li>
</ul>
<p>注意到 mlnx ofed Additional Firware Version Supported 一般是前几个 firmware 版本中的一个</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://network.nvidia.com/support/firmware/connectx5ib/">https://network.nvidia.com/support/firmware/connectx5ib/</a></p>
</blockquote>
<ul>
<li>16.28.2006 – newer</li>
<li>16.28.1002 – old</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://network.nvidia.com/support/firmware/connectx6dx/">https://network.nvidia.com/support/firmware/connectx6dx/</a></p>
</blockquote>
<ul>
<li>22.28.2006 – newer</li>
<li>22.28.1002 – old</li>
</ul>
<h1 id="mlnx-ofed"><a href="#mlnx-ofed" class="headerlink" title="mlnx ofed"></a>mlnx ofed</h1><p>容器镜像中安装的 mlnx ofed，与宿主机中安装的 mlnx ofed 有何联系？</p>
<p>其实并无联系，仅仅与宿主机 mlnx 网卡型号，及其 firmware 版本有关系</p>
<p>以 mlnx ofed LTS version 5.4-3.1.0.0 为例，在其 Release Notes 中明确提到了该 ofed 配套的 firmware 版本</p>
<blockquote>
<p>不同 OS 版本，均指向同一 Release Notes</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/networking/display/MLNXOFEDv543100/Release+Notes">https://docs.nvidia.com/networking/display/MLNXOFEDv543100/Release+Notes</a></p>
<p>支持的网卡及其速率</p>
<ul>
<li>ConnectX-4<ul>
<li>Infiniband: …</li>
<li>Ethernet: 100Gb, …</li>
</ul>
</li>
<li>ConnectX-5<ul>
<li>Infiniband: …</li>
<li>Ethernet: 100Gb, …</li>
</ul>
</li>
<li>ConnectX-6 Dx<ul>
<li>Ethernet: 100Gb, …</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/networking/display/MLNXOFEDv543100/General+Support#GeneralSupport-SupportedNICFirmwareVersions">https://docs.nvidia.com/networking/display/MLNXOFEDv543100/General+Support#GeneralSupport-SupportedNICFirmwareVersions</a></p>
<blockquote>
<p>Upgrading MLNX_OFED on a cluster requires upgrading all of its nodes to the newest version as well</p>
</blockquote>
<blockquote>
<p>This current version is tested with the following NVIDIA NIC firmware versions</p>
</blockquote>
<blockquote>
<p>Firmware versions listed are the minimum supported versions</p>
</blockquote>
<table>
<thead>
<tr>
<th>NIC</th>
<th>Recommended Firmware Version</th>
<th>Additional Firmware Version Supported</th>
</tr>
</thead>
<tbody><tr>
<td>cx4</td>
<td>12.28.2006</td>
<td>12.28.2006</td>
</tr>
<tr>
<td>cx5</td>
<td>16.31.2006</td>
<td>16.31.1014</td>
</tr>
<tr>
<td>cx6 dx</td>
<td>22.31.2006</td>
<td>22.31.1014</td>
</tr>
</tbody></table>
<p>该 mlnx ofed 5.4-3.1.0.0 驱动要求的 <strong>最小</strong> firmware 版本，但是注意到 mlnx ofed 从 5.4 版本才开始增加 <code>minimum supported versions</code> 的描述</p>
<p>与之相比，mlnx ofed LTS version 4.9-4.1.7.0 驱动要求的 firmware 版本如下</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/networking/display/MLNXOFEDv494170/General+Support+in+MLNX_OFED#GeneralSupportinMLNX_OFED-SupportedNICsFirmwareVersions">https://docs.nvidia.com/networking/display/MLNXOFEDv494170/General+Support+in+MLNX_OFED#GeneralSupportinMLNX_OFED-SupportedNICsFirmwareVersions</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>NIC</th>
<th>Recommended Firmware Version</th>
<th>Additional Firmware Version Supported</th>
</tr>
</thead>
<tbody><tr>
<td>cx4</td>
<td>12.28.2006</td>
<td>12.27.4000</td>
</tr>
<tr>
<td>cx5</td>
<td>16.28.2006</td>
<td>16.27.2008</td>
</tr>
<tr>
<td>cx6 dx</td>
<td>22.28.2006</td>
<td>NA</td>
</tr>
</tbody></table>
<h1 id="identifying-adapter-cards"><a href="#identifying-adapter-cards" class="headerlink" title="identifying adapter cards"></a>identifying adapter cards</h1><p><a target="_blank" rel="noopener" href="https://network.nvidia.com/support/firmware/identification/">https://network.nvidia.com/support/firmware/identification/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ibv_devinfo</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/e3ce3305.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/e3ce3305.html" class="post-title-link" itemprop="url">use docker container in modelarts training service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-12 15:06:00 / 修改时间：07:11:18" itemprop="dateCreated datePublished" datetime="2022-06-12T15:06:00Z">2022-06-12</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>目标：构建有如下软件的容器镜像，并使用华为云 ModelArts 训练服务运行</p>
<ul>
<li>ubuntu-18.04</li>
<li>cuda-10.2</li>
<li>python-3.7.13</li>
<li>pytorch-1.8.1</li>
</ul>
<h1 id="1-准备-context-文件夹"><a href="#1-准备-context-文件夹" class="headerlink" title="1. 准备 context 文件夹"></a>1. 准备 context 文件夹</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p context</span><br></pre></td></tr></table></figure>

<h2 id="1-1-准备文件"><a href="#1-1-准备文件" class="headerlink" title="1.1. 准备文件"></a>1.1. 准备文件</h2><h3 id="1-1-1-pip-conf"><a href="#1-1-1-pip-conf" class="headerlink" title="1.1.1. pip.conf"></a>1.1.1. pip.conf</h3><blockquote>
<p>使用华为开源镜像站 pypi 配置</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.huaweicloud.com/home">https://mirrors.huaweicloud.com/home</a></p>
</blockquote>
<p>文件内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://repo.huaweicloud.com/repository/pypi/simple</span><br><span class="line">trusted-host = repo.huaweicloud.com</span><br><span class="line">timeout = 120</span><br></pre></td></tr></table></figure>

<h3 id="1-1-2-torch-whl"><a href="#1-1-2-torch-whl" class="headerlink" title="1.1.2. torch*.whl"></a>1.1.2. torch*.whl</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://pytorch.org/get-started/previous-versions/#v181">https://pytorch.org/get-started/previous-versions/#v181</a></p>
</blockquote>
<p>在该地址上 <a target="_blank" rel="noopener" href="https://download.pytorch.org/whl/torch_stable.html">https://download.pytorch.org/whl/torch_stable.html</a> 搜索并下载如下 whl</p>
<ul>
<li>torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl</li>
<li>torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl</li>
<li>torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl</li>
</ul>
<h3 id="1-1-3-Miniconda3"><a href="#1-1-3-Miniconda3" class="headerlink" title="1.1.3. Miniconda3"></a>1.1.3. Miniconda3</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.conda.io/en/latest/miniconda.html">https://docs.conda.io/en/latest/miniconda.html</a></p>
<p>Miniconda3-py37_4.12.0-Linux-x86_64.sh</p>
</blockquote>
<p>使用该地址 <a target="_blank" rel="noopener" href="https://repo.anaconda.com/miniconda/Miniconda3-py37_4.12.0-Linux-x86_64.sh">https://repo.anaconda.com/miniconda/Miniconda3-py37_4.12.0-Linux-x86_64.sh</a>, 下载 miniconda3 安装文件</p>
<h2 id="1-2-context-文件夹内容"><a href="#1-2-context-文件夹内容" class="headerlink" title="1.2. context 文件夹内容"></a>1.2. context 文件夹内容</h2><p>将上述文件放置在 context 文件夹内</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">context</span><br><span class="line">├── Miniconda3-py37_4.12.0-Linux-x86_64.sh</span><br><span class="line">├── pip.conf</span><br><span class="line">├── torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl</span><br><span class="line">├── torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl</span><br><span class="line">└── torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl</span><br></pre></td></tr></table></figure>

<h1 id="2-编写容器镜像-Dockerfile-文件"><a href="#2-编写容器镜像-Dockerfile-文件" class="headerlink" title="2. 编写容器镜像 Dockerfile 文件"></a>2. 编写容器镜像 Dockerfile 文件</h1><p>在 context 文件夹内新建名为 <strong>Dockerfile</strong> 的空文件，并将下述文件内容写入其中</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容器镜像构建主机需要连通公网</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础容器镜像, https://github.com/NVIDIA/nvidia-docker/wiki/CUDA</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds</span></span><br><span class="line"><span class="comment"># require Docker Engine &gt;= 17.05</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># builder stage</span></span><br><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">10.2</span>-runtime-ubuntu18.<span class="number">04</span> AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础容器镜像的默认用户已经是 root</span></span><br><span class="line"><span class="comment"># USER root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用华为开源镜像站提供的 pypi 配置</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /root/.pip/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> pip.conf /root/.pip/pip.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝待安装文件到基础容器镜像中的 /tmp 目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> Miniconda3-py37_4.12.0-Linux-x86_64.sh \</span></span><br><span class="line"><span class="bash">     torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">     torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">     torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">     ./tmp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://conda.io/projects/conda/en/latest/user-guide/install/linux.html#installing-on-linux</span></span><br><span class="line"><span class="comment"># 安装 Miniconda3 到基础容器镜像的 /home/ma-user/miniconda3 目录中</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> bash /tmp/Miniconda3-py37_4.12.0-Linux-x86_64.sh -b -p /home/ma-user/miniconda3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Miniconda3 默认 python 环境 (即 /home/ma-user/miniconda3/bin/pip) 安装 torch*.whl</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /tmp &amp;&amp; \</span></span><br><span class="line"><span class="bash">    /home/ma-user/miniconda3/bin/pip install --no-cache-dir \</span></span><br><span class="line"><span class="bash">    /tmp/torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">    /tmp/torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">    /tmp/torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建最终容器镜像</span></span><br><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">10.2</span>-runtime-ubuntu18.<span class="number">04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 vim / curl 工具（依然使用华为开源镜像站）</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cp -a /etc/apt/sources.list /etc/apt/sources.list.bak &amp;&amp; \</span></span><br><span class="line"><span class="bash">    sed -i <span class="string">&quot;s@http://.*archive.ubuntu.com@http://repo.huaweicloud.com@g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="bash">    sed -i <span class="string">&quot;s@http://.*security.ubuntu.com@http://repo.huaweicloud.com@g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y vim curl &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get clean &amp;&amp; \</span></span><br><span class="line"><span class="bash">    mv /etc/apt/sources.list.bak /etc/apt/sources.list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 ma-user 用户 (uid = 1000, gid = 100)</span></span><br><span class="line"><span class="comment"># 注意到基础容器镜像已存在 gid = 100 的组，因此 ma-user 用户可直接使用</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> useradd -m -d /home/ma-user -s /bin/bash -g 100 -u 1000 ma-user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从上述 builder stage 中拷贝 /home/ma-user/miniconda3 目录到当前容器镜像的同名目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --chown=ma-user --from=builder /home/ma-user/miniconda3 /home/ma-user/miniconda3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置容器镜像预置环境变量</span></span><br><span class="line"><span class="comment"># 请务必设置 PYTHONUNBUFFERED=1, 以免日志丢失</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=$PATH:/home/ma-<span class="keyword">user</span>/miniconda3/bin \</span><br><span class="line">    PYTHONUNBUFFERED=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置容器镜像默认用户与工作目录</span></span><br><span class="line"><span class="keyword">USER</span> ma-<span class="keyword">user</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /home/ma-user</span></span><br></pre></td></tr></table></figure>

<h1 id="3-构建容器镜像"><a href="#3-构建容器镜像" class="headerlink" title="3. 构建容器镜像"></a>3. 构建容器镜像</h1><p>context 文件夹内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── Miniconda3-py37_4.12.0-Linux-x86_64.sh</span><br><span class="line">├── pip.conf</span><br><span class="line">├── torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl</span><br><span class="line">├── torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl</span><br><span class="line">└── torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl</span><br></pre></td></tr></table></figure>

<p>执行如下命令构建容器镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 执行构建容器镜像命令之前，请务必切换到 context 目录内</span></span><br><span class="line">cd context</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行构建容器镜像命令</span></span><br><span class="line">docker build . -t swr.cn-north-4.myhuaweicloud.com/deep-learning-demo/pytorch:1.8.1-cuda10.2</span><br></pre></td></tr></table></figure>

<p>容器镜像构建成功后，可通过如下命令查询到对应的容器镜像地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | grep pytorch | grep 1.8.1-cuda10.2</span><br></pre></td></tr></table></figure>

<h1 id="3-pytorch-verification-code"><a href="#3-pytorch-verification-code" class="headerlink" title="3. pytorch verification code"></a>3. pytorch verification code</h1><p><a target="_blank" rel="noopener" href="https://pytorch.org/get-started/locally/#linux-verification">https://pytorch.org/get-started/locally/#linux-verification</a></p>
<p>验证示例代码：pytorch-verification.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line">x = torch.randn(<span class="number">5</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(x)</span><br><span class="line"></span><br><span class="line">available_dev = torch.device(<span class="string">&quot;cuda&quot;</span>) <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> torch.device(<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">y = torch.randn(<span class="number">5</span>, <span class="number">3</span>).to(available_dev)</span><br><span class="line"><span class="built_in">print</span>(y)</span><br></pre></td></tr></table></figure>

<h1 id="4-boot-command-in-modelarts-training-service"><a href="#4-boot-command-in-modelarts-training-service" class="headerlink" title="4. boot command in modelarts training service"></a>4. boot command in modelarts training service</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/ma-user/miniconda3/bin/python $&#123;MA_JOB_DIR&#125;/code/pytorch-verification.py</span><br></pre></td></tr></table></figure>

<p>cpu 训练作业日志显示示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tensor([[ 0.8945, -0.6946,  0.3807],</span><br><span class="line">        [ 0.6665,  0.3133,  0.8285],</span><br><span class="line">        [-0.5353, -0.1730, -0.5419],</span><br><span class="line">        [ 0.4870,  0.5183,  0.2505],</span><br><span class="line">        [ 0.2679, -0.4996,  0.7919]])</span><br><span class="line">tensor([[ 0.9692,  0.4652,  0.5659],</span><br><span class="line">        [ 2.2032,  1.4157, -0.1755],</span><br><span class="line">        [-0.6296,  0.5466,  0.6994],</span><br><span class="line">        [ 0.2353, -0.0089, -1.9546],</span><br><span class="line">        [ 0.9319,  1.1781, -0.4587]])</span><br></pre></td></tr></table></figure>

<p>gpu 训练作业日志显示示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tensor([[-0.2874, -0.3475,  0.1848],</span><br><span class="line">        [-0.1660, -0.5038, -0.5470],</span><br><span class="line">        [ 0.1289, -0.2400,  2.0829],</span><br><span class="line">        [ 1.6870, -0.0492,  0.1189],</span><br><span class="line">        [ 0.4800, -0.3611, -0.9572]])</span><br><span class="line">tensor([[-0.6710,  0.4095, -0.7370],</span><br><span class="line">        [ 1.4353,  0.9093,  1.7551],</span><br><span class="line">        [ 1.3477, -0.0499,  0.2404],</span><br><span class="line">        [ 1.7489, -1.0203, -0.7875],</span><br><span class="line">        [-1.2104,  0.4593,  1.1365]], device=&#x27;cuda:0&#x27;)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/705102b6.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/705102b6.html" class="post-title-link" itemprop="url">docker container metrics</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-12 15:05:00 / 修改时间：07:06:50" itemprop="dateCreated datePublished" datetime="2022-06-12T15:05:00Z">2022-06-12</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>189</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/runmetrics/#tips-for-high-performance-metric-collection">https://docs.docker.com/config/containers/runmetrics/#tips-for-high-performance-metric-collection</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/runmetrics/#collect-metrics-when-a-container-exits">https://docs.docker.com/config/containers/runmetrics/#collect-metrics-when-a-container-exits</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/ff6309c.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/ff6309c.html" class="post-title-link" itemprop="url">mount s3 bucket with goofys</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-12 15:03:00 / 修改时间：07:07:09" itemprop="dateCreated datePublished" datetime="2022-06-12T15:03:00Z">2022-06-12</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>32</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/kahing/goofys">https://github.com/kahing/goofys</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/da36620.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/da36620.html" class="post-title-link" itemprop="url">k8s docker image cache</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-04 13:33:00 / 修改时间：08:43:57" itemprop="dateCreated datePublished" datetime="2022-05-04T13:33:00Z">2022-05-04</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>k8s 1.19</p>
</blockquote>
<h1 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0OLdyVwg4Nsw0Xvvg8if5w">https://mp.weixin.qq.com/s/0OLdyVwg4Nsw0Xvvg8if5w</a></p>
</blockquote>
<p>阿里巴巴云原生这篇 pod 创建效率优化不错，e2e 分析了 docker pull 的加速技术</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://qiankunli.github.io/2015/09/22/docker_image.html">https://qiankunli.github.io/2015/09/22/docker_image.html</a></p>
</blockquote>
<p><img src="https://qiankunli.github.io/public/upload/container/image_push_pull.png" alt="docker pull phase"></p>
<p>上图可见 docker pull 的几个阶段</p>
<ol>
<li>下载</li>
<li>解压</li>
<li>将文件 union 为 rootfs (图中没写)</li>
</ol>
<p>所以 docker pull 加速也从上述几个阶段入手</p>
<h1 id="下载加速"><a href="#下载加速" class="headerlink" title="下载加速"></a>下载加速</h1><h2 id="p2p-powered-docker-registry"><a href="#p2p-powered-docker-registry" class="headerlink" title="p2p powered docker registry"></a>p2p powered docker registry</h2><p><a target="_blank" rel="noopener" href="https://d7y.io/">https://d7y.io/</a></p>
<blockquote>
<p>Dragonfly is an intelligent P2P based image and file distribution system</p>
<p>Originally it was born to solve all kinds of distribution at very large scales, such as application distribution, cache distribution, log distribution, image distribution, and so on</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/uber/kraken">https://github.com/uber/kraken</a></p>
<blockquote>
<p>Kraken is a P2P-powered Docker registry that focuses on scalability and availability. It is designed for Docker image management, replication, and distribution in a hybrid cloud environment</p>
<p>all participants can reach a minimum of 80% max upload/download speed in theory (60% with current implementation), and performance doesn’t degrade much as the blob size and cluster size increase</p>
</blockquote>
<p>提升 docker image 分发到节点（大规模）的速度，适合容器化服务发布/更新的场景</p>
<h2 id="docker-registry-mirror"><a href="#docker-registry-mirror" class="headerlink" title="docker registry mirror"></a>docker registry mirror</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/recipes/mirror/">https://docs.docker.com/registry/recipes/mirror/</a></p>
<h1 id="解压加速"><a href="#解压加速" class="headerlink" title="解压加速"></a>解压加速</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd">https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd</a></p>
<blockquote>
<p>gzip/gunzip 是单线程的压缩/解压工具，可考虑采用 pigz/unpigz 进行多线程的压缩/解压，充分利用多核优势。</p>
<p>containerd 从 1.2 版本开始支持 pigz，节点上安装 unpigz 工具后，会优先用其进行解压。通过这种方法，可通过节点多核能力提升镜像解压效率。</p>
</blockquote>
<h1 id="k8s-加速"><a href="#k8s-加速" class="headerlink" title="k8s 加速"></a>k8s 加速</h1><h2 id="docker-images-pull-policy"><a href="#docker-images-pull-policy" class="headerlink" title="docker images pull policy"></a>docker images pull policy</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/images/#image-pull-policy">https://kubernetes.io/docs/concepts/containers/images/#image-pull-policy</a></p>
<ol>
<li>Never</li>
<li>IfNotPresent</li>
<li>Always</li>
</ol>
<p>Never，kubelet 会直接启动容器镜像；路径最短</p>
<p>IfNotPresent，local docker image list 查询是否命中，命中则启动容器镜像；未命中，走 docker pull；路径中等</p>
<p>Always，即使镜像没有变化，也会多一次 remote docker registry query 的查询时间；未命中，走 docker pull；路径最长</p>
<blockquote>
<p>every time the kubelet launches a container, the kubelet queries the container image registry to resolve the name to an image digest. If the kubelet has a container image with that exact digest cached locally, the kubelet uses its cached image; otherwise, the kubelet pulls the image with the resolved digest, and uses that image to launch the container.</p>
</blockquote>
<h2 id="docker-images-pre-pulled"><a href="#docker-images-pre-pulled" class="headerlink" title="docker images pre-pulled"></a>docker images pre-pulled</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/images/#pre-pulled-images">https://kubernetes.io/docs/concepts/containers/images/#pre-pulled-images</a></p>
<h2 id="schedule-imagelocality"><a href="#schedule-imagelocality" class="headerlink" title="schedule imagelocality"></a>schedule imagelocality</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/scheduling/config/#scheduling-plugins">https://kubernetes.io/docs/reference/scheduling/config/#scheduling-plugins</a></p>
<ul>
<li>imagelocality</li>
</ul>
<p>注意到仅对 containers 生效，对 init containers 不生效；在 k8s sche 的 score 阶段有效，使用镜像大小作为 base score，即镜像大小越大，imagelocality 调度权重越高；当然为了避免 <em>node heating problem</em>，即由于 imagelocality 的策略，很可能 pod 的多个副本被调度到同一个节点，而其他节点没有有效利用上；因此最终 imagelocality score 的计算，还乘以了 image spread 的比例</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scaledImageScore returns an adaptively scaled score for the given state of an image.</span></span><br><span class="line"><span class="comment">// The size of the image is used as the base score, scaled by a factor which considers how much nodes the image has &quot;spread&quot; to.</span></span><br><span class="line"><span class="comment">// This heuristic aims to mitigate the undesirable &quot;node heating problem&quot;, i.e., pods get assigned to the same or</span></span><br><span class="line"><span class="comment">// a few nodes due to image locality.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scaledImageScore</span><span class="params">(imageState *framework.ImageStateSummary, totalNumNodes <span class="keyword">int</span>)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line">	spread := <span class="keyword">float64</span>(imageState.NumNodes) / <span class="keyword">float64</span>(totalNumNodes)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int64</span>(<span class="keyword">float64</span>(imageState.Size) * spread)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 k8s cluster 中只有少量节点缓存了指定 image，则 spread 比例就会低，相应的 imagelocality score 得分也会低；反之，假若大多数 cluster nodes 都缓存了指定 image，则 spread 比例就会高，相应的 imagelocality score 得分也高</p>
<p>可见 k8s 设计之初还是侧重在服务管理，上述的调度策略也是对服务的高可用性友好的</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculatePriority returns the priority of a node. Given the sumScores of requested images on the node, the node&#x27;s</span></span><br><span class="line"><span class="comment">// priority is obtained by scaling the maximum priority value with a ratio proportional to the sumScores.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calculatePriority</span><span class="params">(sumScores <span class="keyword">int64</span>, numContainers <span class="keyword">int</span>)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line">	maxThreshold := maxContainerThreshold * <span class="keyword">int64</span>(numContainers)</span><br><span class="line">	<span class="keyword">if</span> sumScores &lt; minThreshold &#123;</span><br><span class="line">		sumScores = minThreshold</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> sumScores &gt; maxThreshold &#123;</span><br><span class="line">		sumScores = maxThreshold</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int64</span>(framework.MaxNodeScore) * (sumScores - minThreshold) / (maxThreshold - minThreshold)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后 imagelocality score 经过修正后，得到 image 在调度中的 priority；注意到 &lt; minThreshold 的 score 都是一样的，物理意义上，就是说没有一个节点有缓存，和有少量节点有镜像缓存，在调度上的 priority 都是一样的，这样就避免了 node heating problem</p>
<blockquote>
<p>node heating problem</p>
<p><a target="_blank" rel="noopener" href="https://oracle.github.io/weblogic-kubernetes-operator/faq/node-heating/">https://oracle.github.io/weblogic-kubernetes-operator/faq/node-heating/</a></p>
<p>this often results in Kubernetes running many of the Pods for WebLogic Server instances on the same Node while other Nodes are not fairly utilized. This is commonly known as the “Node heating problem.”</p>
</blockquote>
<h2 id="k8s-gc-unused-docker-images"><a href="#k8s-gc-unused-docker-images" class="headerlink" title="k8s gc unused docker images"></a>k8s gc unused docker images</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/architecture/garbage-collection/#containers-images">https://kubernetes.io/docs/concepts/architecture/garbage-collection/#containers-images</a></p>
<p>Kubernetes manages the lifecycle of <strong>all images</strong> through its image manager</p>
<p>The kubelet considers the following disk usage limits when making garbage collection decisions:</p>
<ul>
<li>HighThresholdPercent</li>
<li>LowThresholdPercent</li>
</ul>
<p>Disk usage above the configured <strong>HighThresholdPercent</strong> value triggers garbage collection, which deletes images in order based on <strong>the last time they were used, starting with the oldest first</strong>. The kubelet deletes images until disk usage reaches the <strong>LowThresholdPercent</strong> value.</p>
<h2 id="docker-image-cache-management"><a href="#docker-image-cache-management" class="headerlink" title="docker image cache management"></a>docker image cache management</h2><p><a target="_blank" rel="noopener" href="https://github.com/senthilrch/kube-fledged">https://github.com/senthilrch/kube-fledged</a></p>
<blockquote>
<p>kube-fledged is a kubernetes operator for creating and managing a cache of container images directly on the worker nodes of a kubernetes cluster</p>
<p>kube-fledged provides CRUD APIs to manage the lifecycle of the image cache</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/senthilrch/kube-fledged/blob/master/docs/design-proposal.md">https://github.com/senthilrch/kube-fledged/blob/master/docs/design-proposal.md</a></p>
<h1 id="按需加载文件"><a href="#按需加载文件" class="headerlink" title="按需加载文件"></a>按需加载文件</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0OLdyVwg4Nsw0Xvvg8if5w">https://mp.weixin.qq.com/s/0OLdyVwg4Nsw0Xvvg8if5w</a></p>
<blockquote>
<p>当前节点上创建容器时，是需要先把镜像全部数据拉取到本地，然后才能启动容器。再考虑下启动虚拟机的过程，即使是几百 GB 的虚拟机镜像，启动虚拟机也通常是在秒级别，几乎感受不到虚拟机镜像大小带来的影响。</p>
<p>《Slacker: Fast Distribution with Lazy Docker Containers》</p>
<p>该 paper 分析，在镜像启动耗时中，拉取镜像占比 76%，但是在启动时，仅有 6.4% 的数据被使用到，即镜像启动时需要的镜像数据量很少，需要考虑在镜像启动阶段按需加载镜像，改变对镜像的使用方式。</p>
<p>对于「Image 所有 layers 下载完后才能启动镜像」，需要改为启动容器时按需加载镜像，类似启动虚拟机的方式，仅对启动阶段需要的数据进行网络传输。</p>
</blockquote>
<p>这个对现有架构的改动是很大了 …</p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/742103">https://developer.aliyun.com/article/742103</a></p>
<p>2020/01/08</p>
<h1 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h1><h2 id="容器镜像启动加速技术"><a href="#容器镜像启动加速技术" class="headerlink" title="容器镜像启动加速技术"></a>容器镜像启动加速技术</h2><h3 id="容器镜像"><a href="#容器镜像" class="headerlink" title="容器镜像"></a>容器镜像</h3><ol>
<li>镜像文件下载加速<ol>
<li>docker registry mirror，本地 mirror，路程更近</li>
<li>p2p (Dragonfly, Kraken)，分发加速</li>
</ol>
</li>
<li>镜像文件解压加速<ol>
<li>container runtime: containerd, unpigz，多线程解压</li>
</ol>
</li>
<li>镜像文件按需加载<ol>
<li><em>Slacker: Fast Distribution with Lazy Docker Containers: Our analysis shows that pulling packages accounts for 76% of container start time, but only 6.4% of that data is read.</em></li>
</ol>
</li>
</ol>
<h3 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h3><ol>
<li>imagePullPolicy<ol>
<li>Never，路径最短，依赖镜像预下载</li>
<li>IfNotPresent</li>
<li>Always</li>
</ol>
</li>
<li>schedule imagelocality: 调度优化，当集群中大多数节点均有缓存时，优先将 pod 调度到已有缓存的节点</li>
<li>docker images pre-pulled + docker image cache management: 集群 docker image cache 管理</li>
</ol>
<p>k8s 属于业务逻辑层面的优化</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/dc51ca39.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/dc51ca39.html" class="post-title-link" itemprop="url">ps-worker-paper</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-05-03 10:00:00" itemprop="dateCreated datePublished" datetime="2022-05-03T10:00:00Z">2022-05-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-05-04 08:44:04" itemprop="dateModified" datetime="2022-05-04T08:44:04Z">2022-05-04</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1YA4y197G8?spm_id_from=333.337.search-card.all.click">https://www.bilibili.com/video/BV1YA4y197G8?spm_id_from=333.337.search-card.all.click</a></p>
<p><a target="_blank" rel="noopener" href="https://www.usenix.org/system/files/conference/osdi14/osdi14-paper-li_mu.pdf">https://www.usenix.org/system/files/conference/osdi14/osdi14-paper-li_mu.pdf</a></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/dmlc/ps-lite">https://github.com/dmlc/ps-lite</a></p>
<p>总结李沐大神 ps-worker 的论文实现要点如下</p>
<h1 id="server-高可用"><a href="#server-高可用" class="headerlink" title="server 高可用"></a>server 高可用</h1><ol>
<li>多副本复制: 例如每次对 server 的修改或写入，均会复制到两个其他副本后再回复 ok。当然这会增加延迟，以及要求客户端错误重试</li>
<li>一致性哈希: key-value datastore, improve load balancing and recovery</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://memcached.org/">https://memcached.org/</a> 也采用了类似的高可用策略</p>
</blockquote>
<h1 id="server-一致性"><a href="#server-一致性" class="headerlink" title="server 一致性"></a>server 一致性</h1><ol>
<li>vector clock，记录时间点 (t) 发出的权重 (w) 的数据，使用 vector clock 便于实现各种一致性模型，given the potentially complex task dependency graph and<br>the need for fast recovery</li>
</ol>
<h1 id="worker-高可用"><a href="#worker-高可用" class="headerlink" title="worker 高可用"></a>worker 高可用</h1><p>论文中提到</p>
<ul>
<li>一般而言 worker 仅负责部分数据的计算，而部分数据往往不至于对模型的最终效果有很大影响</li>
<li>假若每个 worker 数据量较大，恢复 worker 的代价较高，还不如恢复 server</li>
</ul>
<p>所以 worker 的高可用，还是交由算法设计者控制。可能算法设计者更愿意实现即使 worker 挂了，模型训练依然能够运行下去的算法</p>
<h1 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h1><p>parameter server 综合利用了现有技术（交叉），是领域型的 memcached/redis (这两都是 kv datastore)。当然 ps 是面向机器学习算法设计的，通过优化机器学习算法，使其适应 ps api，，解决了机器学习领域大规模训练的实际（工业界）问题</p>
<blockquote>
<p>The novelty of the proposed system lies in the synergy achieved by picking the right systems techniques, adapting them to the machine learning algorithms, and modifying the machine learning algorithms to be more systemsfriendly. In particular, we can relax a number of otherwise hard systems constraints since the associated machine learning algorithms are quite tolerant to perturbations. The consequence is the first general purpose ML system capable of scaling to industrial scale sizes</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/467ab0db.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/467ab0db.html" class="post-title-link" itemprop="url">conda activate</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2022-04-06 20:42:00" itemprop="dateCreated datePublished" datetime="2022-04-06T20:42:00Z">2022-04-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-04-10 13:49:22" itemprop="dateModified" datetime="2022-04-10T13:49:22Z">2022-04-10</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<ul>
<li>conda 4.12.0</li>
<li>macOS 10.15.7</li>
</ul>
</blockquote>
<p>示例为个人 PC 环境下的回显</p>
<blockquote>
<p>Conda makes environments first-class citizens, making it easy to create independent environments even for C libraries. Conda is written entirely in Python</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># conda environments:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">base                     /Users/huangzhesi/miniconda</span><br><span class="line">conda-dev             *  /Users/huangzhesi/miniconda/envs/conda-dev</span><br><span class="line">pandas                   /Users/huangzhesi/miniconda/envs/pandas</span><br><span class="line">pytorch-1.8              /Users/huangzhesi/miniconda/envs/pytorch-1.8</span><br><span class="line">pytorch-dev              /Users/huangzhesi/miniconda/envs/pytorch-dev</span><br><span class="line">tensorflow-1.x           /Users/huangzhesi/miniconda/envs/tensorflow-1.x</span><br></pre></td></tr></table></figure>

<p>今天来探索下我们输入 <code>conda activate conda-dev</code> 命令后，实际上 conda 为了我们做什么</p>
<p>先说结论</p>
<ol>
<li>设置了 conda env bin 到环境变量 PATH（替换 <em>old</em> conda env 值，比如 base conda env）</li>
<li>未修改环境变量 <code>LD_LIBRARY_PATH</code>，原因如下</li>
</ol>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.conda.io/projects/conda-build/en/latest/resources/use-shared-libraries.html#shared-libraries-in-macos-and-linux">https://docs.conda.io/projects/conda-build/en/latest/resources/use-shared-libraries.html#shared-libraries-in-macos-and-linux</a></p>
<p><a target="_blank" rel="noopener" href="https://conda.io/projects/conda-build/en/latest/concepts/recipe.html#prefix-replacement">https://conda.io/projects/conda-build/en/latest/concepts/recipe.html#prefix-replacement</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/conda/conda/issues/308#issuecomment-36058087">https://github.com/conda/conda/issues/308#issuecomment-36058087</a></p>
<p>the problem with activate setting LD_LIBRARY_PATH (even when conda packages themselves don’t need it) is that it might break other things on the users system.</p>
</blockquote>
<h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><p><a target="_blank" rel="noopener" href="https://github.com/conda/conda/tree/4.12.0">https://github.com/conda/conda/tree/4.12.0</a></p>
<p><code>conda activate</code> 命令在 conda/activate.py 文件里边实现</p>
<p>调用顺序如下</p>
<ol>
<li>activate</li>
<li>build_activate</li>
<li>_build_activate_stack</li>
</ol>
<p>最终返回一个 structure</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="string">&#x27;unset_vars&#x27;</span>: unset_vars,</span><br><span class="line">    <span class="string">&#x27;set_vars&#x27;</span>: set_vars,</span><br><span class="line">    <span class="string">&#x27;export_vars&#x27;</span>: export_vars,</span><br><span class="line">    <span class="string">&#x27;deactivate_scripts&#x27;</span>: deactivate_scripts,</span><br><span class="line">    <span class="string">&#x27;activate_scripts&#x27;</span>: activate_scripts,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见 <code>conda activate</code> 命令实际上会 <code>unset</code>，<code>set</code>，<code>export</code> vars，以达到激活环境的效果</p>
<h1 id="激活流程"><a href="#激活流程" class="headerlink" title="激活流程"></a>激活流程</h1><h2 id="查询-conda-env-path"><a href="#查询-conda-env-path" class="headerlink" title="查询 conda env path"></a>查询 conda env path</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">conda_prefix</span>(<span class="params">self</span>):</span></span><br><span class="line">    <span class="keyword">return</span> abspath(sys.prefix)</span><br></pre></td></tr></table></figure>

<p><code>root_prefix</code> case = <code>conda_prefix</code> = <code>/Users/huangzhesi/miniconda</code></p>
<p>prefix magic file = <code>&#123;conda_prefix&#125;/conda-meta/history</code></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># path is the prefix magic file</span></span><br><span class="line">        <span class="keyword">if</span> isfile(path):</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                fh = <span class="built_in">open</span>(path, <span class="string">&#x27;a+&#x27;</span>)</span><br></pre></td></tr></table></figure>

<p>测试 history file 是否有读写权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls -alh /Users/huangzhesi/miniconda/conda-meta | grep <span class="built_in">history</span></span><br><span class="line">-rw-r--r--    1 huangzhesi  staff   8.2K 12 19 21:44 <span class="built_in">history</span></span><br></pre></td></tr></table></figure>

<p>(1) 假若 history file 有读写权限，则 context envs dirs 按如下顺序</p>
<ol>
<li><code>/Users/huangzhesi/miniconda/envs</code></li>
<li><code>~/.conda/envs</code></li>
</ol>
<p>(2) 若 history file 没有读写权限，则 context envs dirs 按如下顺序</p>
<ol>
<li><code>~/.conda/envs</code></li>
<li><code>/Users/huangzhesi/miniconda/envs</code></li>
</ol>
<p>从 context envs dirs 中查询待激活的 env</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># name is the conda activate &#123;name&#125;</span></span><br><span class="line">    <span class="keyword">for</span> envs_dir <span class="keyword">in</span> envs_dirs:</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> isdir(envs_dir):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        prefix = join(envs_dir, name)</span><br><span class="line">        <span class="keyword">if</span> isdir(prefix):</span><br><span class="line">            <span class="keyword">return</span> abspath(prefix)</span><br></pre></td></tr></table></figure>

<p>到这里 prefix 就确定了 <code>prefix = locate_prefix_by_name(env_name_or_prefix)</code></p>
<p><code>prefix = /Users/huangzhesi/miniconda/envs/conda-dev</code></p>
<ul>
<li>CONDA_SHLVL=1</li>
<li>CONDA_PREFIX=/Users/huangzhesi/miniconda</li>
</ul>
<p>替换 <code>old_conda_prefix</code>，比如 base conda env</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">new_path = self.pathsep_join(</span><br><span class="line">    self._replace_prefix_in_path(old_conda_prefix, prefix))</span><br></pre></td></tr></table></figure>

<p>需要设置的环境变量</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">env_vars_to_export = OrderedDict((</span><br><span class="line">    (<span class="string">&#x27;path&#x27;</span>, new_path),</span><br><span class="line">    (<span class="string">&#x27;conda_prefix&#x27;</span>, prefix),</span><br><span class="line">    (<span class="string">&#x27;conda_shlvl&#x27;</span>, new_conda_shlvl),</span><br><span class="line">    (<span class="string">&#x27;conda_default_env&#x27;</span>, conda_default_env),</span><br><span class="line">    (<span class="string">&#x27;conda_prompt_modifier&#x27;</span>, conda_prompt_modifier)))</span><br></pre></td></tr></table></figure>

<h1 id="set-ld-library-path-inside-python"><a href="#set-ld-library-path-inside-python" class="headerlink" title="set ld_library_path inside python"></a>set ld_library_path inside python</h1><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/6543847/setting-ld-library-path-from-inside-python">https://stackoverflow.com/questions/6543847/setting-ld-library-path-from-inside-python</a></p>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/856116/changing-ld-library-path-at-runtime-for-ctypes">https://stackoverflow.com/questions/856116/changing-ld-library-path-at-runtime-for-ctypes</a></p>
<p>比较 hack，不优雅 …</p>
<p>如果 conda env 中安装的非 conda package，其依赖 shared libraries，没太好办法，手动设置 <code>LD_LIBRARY_PATH</code> 环境变量吧</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">274k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:09</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
