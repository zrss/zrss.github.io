<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="领略了繁华沧桑谁人过往不相似">
<meta property="og:type" content="website">
<meta property="og:title" content="随风飘散的记忆">
<meta property="og:url" content="https://zrss.github.io/index.html">
<meta property="og:site_name" content="随风飘散的记忆">
<meta property="og:description" content="领略了繁华沧桑谁人过往不相似">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="tech">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zrss.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>随风飘散的记忆</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">随风飘散的记忆</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">领略了繁华沧桑<br>谁人过往不相似</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/ab861e1f.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/ab861e1f.html" class="post-title-link" itemprop="url">kubelet mount gpu</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-03-27 12:48:00 / 修改时间：14:20:04" itemprop="dateCreated datePublished" datetime="2022-03-27T12:48:00Z">2022-03-27</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>8.9k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>相关问题: <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/72486">https://github.com/kubernetes/kubernetes/issues/72486</a>, init container 申请 devices 资源时，似乎会锁定资源，导致 container 无法申请到足够的 devices 资源</p>
<p>讨论目的: 探索 k8s init container 挂载 gpu 的实现逻辑</p>
<p>k8s release-1.19 分支代码</p>
</blockquote>
<h1 id="kubelet-sync-pod"><a href="#kubelet-sync-pod" class="headerlink" title="kubelet sync pod"></a>kubelet sync pod</h1><p>pkg/kubelet/kubelet_pods.go</p>
<p>大致的调用顺序</p>
<ol>
<li>syncPod</li>
<li>SyncPod</li>
<li>startContainer</li>
<li>generateContainerConfig</li>
<li>GenerateRunContainerOptions</li>
<li>GetResources</li>
<li>GetDeviceRunContainerOptions</li>
<li>Allocate</li>
</ol>
<blockquote>
<p>// syncPod is the transaction script for the sync of a single pod.</p>
</blockquote>
<p><strong>SyncPod</strong></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Step 6: start the init container.</span></span><br><span class="line"><span class="keyword">if</span> container := podContainerChanges.NextInitContainerToStart; container != <span class="literal">nil</span> &#123;</span><br><span class="line">	<span class="comment">// Start the next init container.</span></span><br><span class="line">	<span class="keyword">if</span> err := start(<span class="string">&quot;init container&quot;</span>, containerStartSpec(container)); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Successfully started the container; clear the entry in the failure</span></span><br><span class="line">	klog.V(<span class="number">4</span>).Infof(<span class="string">&quot;Completed init container %q for pod %q&quot;</span>, container.Name, format.Pod(pod))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Step 7: start containers in podContainerChanges.ContainersToStart.</span></span><br><span class="line"><span class="keyword">for</span> _, idx := <span class="keyword">range</span> podContainerChanges.ContainersToStart &#123;</span><br><span class="line">	start(<span class="string">&quot;container&quot;</span>, containerStartSpec(&amp;pod.Spec.Containers[idx]))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>pod 状态有变化时，大致的调用顺序</p>
<ol>
<li>dispatchWork</li>
<li>UpdatePod</li>
<li>managePodLoop (goroutine)</li>
</ol>
<blockquote>
<p>// Creating a new pod worker either means this is a new pod, or that the kubelet just restarted.</p>
</blockquote>
<p><code>managePodLoop</code> 循环从 <code>podUpdates</code> channel 中，调用 <code>syncPod</code></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *podWorkers)</span> <span class="title">managePodLoop</span><span class="params">(podUpdates &lt;-<span class="keyword">chan</span> UpdatePodOptions)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> lastSyncTime time.Time</span><br><span class="line">	<span class="keyword">for</span> update := <span class="keyword">range</span> podUpdates &#123;</span><br><span class="line">		err := <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">error</span></span> &#123;</span><br><span class="line">			podUID := update.Pod.UID</span><br><span class="line">			<span class="comment">// This is a blocking call that would return only if the cache</span></span><br><span class="line">			<span class="comment">// has an entry for the pod that is newer than minRuntimeCache</span></span><br><span class="line">			<span class="comment">// Time. This ensures the worker doesn&#x27;t start syncing until</span></span><br><span class="line">			<span class="comment">// after the cache is at least newer than the finished time of</span></span><br><span class="line">			<span class="comment">// the previous sync.</span></span><br><span class="line">			status, err := p.podCache.GetNewerThan(podUID, lastSyncTime)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="comment">// This is the legacy event thrown by manage pod loop</span></span><br><span class="line">				<span class="comment">// all other events are now dispatched from syncPodFn</span></span><br><span class="line">				p.recorder.Eventf(update.Pod, v1.EventTypeWarning, events.FailedSync, <span class="string">&quot;error determining status: %v&quot;</span>, err)</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			err = p.syncPodFn(syncPodOptions&#123;</span><br><span class="line">				mirrorPod:      update.MirrorPod,</span><br><span class="line">				pod:            update.Pod,</span><br><span class="line">				podStatus:      status,</span><br><span class="line">				killPodOptions: update.KillPodOptions,</span><br><span class="line">				updateType:     update.UpdateType,</span><br><span class="line">			&#125;)</span><br><span class="line">			lastSyncTime = time.Now()</span><br><span class="line">			<span class="keyword">return</span> err</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="comment">// notify the call-back function if the operation succeeded or not</span></span><br><span class="line">		<span class="keyword">if</span> update.OnCompleteFunc != <span class="literal">nil</span> &#123;</span><br><span class="line">			update.OnCompleteFunc(err)</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="comment">// IMPORTANT: we do not log errors here, the syncPodFn is responsible for logging errors</span></span><br><span class="line">			klog.Errorf(<span class="string">&quot;Error syncing pod %s (%q), skipping: %v&quot;</span>, update.Pod.UID, format.Pod(update.Pod), err)</span><br><span class="line">		&#125;</span><br><span class="line">		p.wrapUp(update.Pod.UID, err)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上可知，kubelet 可以并发处理多个 pod 变化事件（syncPod in goroutine），但是处理单个 pod 的不同事件时（syncPod），为串行处理</p>
<h1 id="kubelet-admit-pod"><a href="#kubelet-admit-pod" class="headerlink" title="kubelet admit pod"></a>kubelet admit pod</h1><p>那么设备资源分配，如何保证不同 pod 之间无冲突呢？</p>
<p>kubelet 在 pod Admit 时，会调用 deviceManger Allocate api 分配设备资源</p>
<p>kubelet 处理 pod 新增大致顺序如下</p>
<ol>
<li>syncLoopIteration</li>
<li>kubetypes.ADD</li>
<li>HandlePodAdditions</li>
<li>canAdmitPod</li>
</ol>
<p>for loop pod canAdminPod</p>
<p>即 kubelet 处理 pod add 时，是没有并发的，逐一处理</p>
<p>resourceAllocator admit handler，注意到分配顺序为 init container, containers</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *resourceAllocator)</span> <span class="title">Admit</span><span class="params">(attrs *lifecycle.PodAdmitAttributes)</span> <span class="title">lifecycle</span>.<span class="title">PodAdmitResult</span></span> &#123;</span><br><span class="line">	pod := attrs.Pod</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> _, container := <span class="keyword">range</span> <span class="built_in">append</span>(pod.Spec.InitContainers, pod.Spec.Containers...) &#123;</span><br><span class="line">		err := m.deviceManager.Allocate(pod, &amp;container)</span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> lifecycle.PodAdmitResult&#123;</span><br><span class="line">				Message: fmt.Sprintf(<span class="string">&quot;Allocate failed due to %v, which is unexpected&quot;</span>, err),</span><br><span class="line">				Reason:  <span class="string">&quot;UnexpectedAdmissionError&quot;</span>,</span><br><span class="line">				Admit:   <span class="literal">false</span>,</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> m.cpuManager != <span class="literal">nil</span> &#123;</span><br><span class="line">			err = m.cpuManager.Allocate(pod, &amp;container)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> lifecycle.PodAdmitResult&#123;</span><br><span class="line">					Message: fmt.Sprintf(<span class="string">&quot;Allocate failed due to %v, which is unexpected&quot;</span>, err),</span><br><span class="line">					Reason:  <span class="string">&quot;UnexpectedAdmissionError&quot;</span>,</span><br><span class="line">					Admit:   <span class="literal">false</span>,</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> lifecycle.PodAdmitResult&#123;Admit: <span class="literal">true</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续往下看 deviceManger Allocate</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocate is the call that you can use to allocate a set of devices</span></span><br><span class="line"><span class="comment">// from the registered device plugins.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ManagerImpl)</span> <span class="title">Allocate</span><span class="params">(pod *v1.Pod, container *v1.Container)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> _, ok := m.devicesToReuse[<span class="keyword">string</span>(pod.UID)]; !ok &#123;</span><br><span class="line">		m.devicesToReuse[<span class="keyword">string</span>(pod.UID)] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]sets.String)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If pod entries to m.devicesToReuse other than the current pod exist, delete them.</span></span><br><span class="line">	<span class="keyword">for</span> podUID := <span class="keyword">range</span> m.devicesToReuse &#123;</span><br><span class="line">		<span class="keyword">if</span> podUID != <span class="keyword">string</span>(pod.UID) &#123;</span><br><span class="line">			<span class="built_in">delete</span>(m.devicesToReuse, podUID)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// Allocate resources for init containers first as we know the caller always loops</span></span><br><span class="line">	<span class="comment">// through init containers before looping through app containers. Should the caller</span></span><br><span class="line">	<span class="comment">// ever change those semantics, this logic will need to be amended.</span></span><br><span class="line">	<span class="keyword">for</span> _, initContainer := <span class="keyword">range</span> pod.Spec.InitContainers &#123;</span><br><span class="line">		<span class="keyword">if</span> container.Name == initContainer.Name &#123;</span><br><span class="line">			<span class="keyword">if</span> err := m.allocateContainerResources(pod, container, m.devicesToReuse[<span class="keyword">string</span>(pod.UID)]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> err</span><br><span class="line">			&#125;</span><br><span class="line">			m.podDevices.addContainerAllocatedResources(<span class="keyword">string</span>(pod.UID), container.Name, m.devicesToReuse[<span class="keyword">string</span>(pod.UID)])</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err := m.allocateContainerResources(pod, container, m.devicesToReuse[<span class="keyword">string</span>(pod.UID)]); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> err</span><br><span class="line">	&#125;</span><br><span class="line">	m.podDevices.removeContainerAllocatedResources(<span class="keyword">string</span>(pod.UID), container.Name, m.devicesToReuse[<span class="keyword">string</span>(pod.UID)])</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意到先为 init container 分配 device 资源，且分配后的 device 资源被 <code>addContainerAllocatedResources</code> 加入到 devicesToReuse 中；假设在下一个循环，是为 container 分配资源，则会优先使用 <code>devicesToReuse</code> 去分配，分配完成后，再使用 <code>removeContainerAllocatedResources</code> 从 <code>devicesToReuse</code> 中减去已分配的 device 资源</p>
<p>devicesToAllocate</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocates from reusableDevices list first.</span></span><br><span class="line"><span class="keyword">if</span> allocateRemainingFrom(reusableDevices) &#123;</span><br><span class="line">	<span class="keyword">return</span> allocated, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h1><blockquote>
<p>相关问题: <a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/72486#issuecomment-482554372">https://github.com/kubernetes/kubernetes/issues/72486#issuecomment-482554372</a></p>
</blockquote>
<p>回到相关问题，从上述的分配逻辑可知，init container 申请 device，导致 container 无法继续申请 device 的 bug 已经被 fixed</p>
<p>从代码实现上也可知，假若如 issue 中的 pod yaml</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">args:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">sleep</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;10&quot;</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">alpha.kubernetes.io/nvidia-gpu:</span> <span class="number">4</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">4Gi</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">alpha.kubernetes.io/nvidia-gpu:</span> <span class="number">4</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="attr">initContainers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">init-myservice</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&#x27;sh&#x27;</span>, <span class="string">&#x27;-c&#x27;</span>, <span class="string">&#x27;sleep 200&#x27;</span>]</span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">requests:</span></span><br><span class="line">        <span class="attr">alpha.kubernetes.io/nvidia-gpu:</span> <span class="number">4</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">4Gi</span></span><br><span class="line">      <span class="attr">limits:</span></span><br><span class="line">        <span class="attr">alpha.kubernetes.io/nvidia-gpu:</span> <span class="number">4</span></span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">        <span class="attr">memory:</span> <span class="string">4Gi</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>从 k8s 的实现逻辑上看，init container 申请的 device，实际上会与 container 申请的 device 相同；原因如下</p>
<ol>
<li>device 分配（admit）逐一 pod 进行，因此没有 pod 并发分配约束</li>
<li>pod 内部按先 init container 后 container 的顺序依次分配 device</li>
<li>init container 已分配的 device 作为 devicesToReuse</li>
<li>在后续的 container 分配时，优先使用 devicesToReuse 分配 device</li>
</ol>
<p>不过在 syncPod 内部也有一个 workaround 的 case</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ManagerImpl)</span> <span class="title">GetDeviceRunContainerOptions</span><span class="params">(pod *v1.Pod, container *v1.Container)</span> <span class="params">(*DeviceRunContainerOptions, error)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> k := <span class="keyword">range</span> container.Resources.Limits &#123;</span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">		<span class="comment">// This is a device plugin resource yet we don&#x27;t have cached</span></span><br><span class="line">		<span class="comment">// resource state. This is likely due to a race during node</span></span><br><span class="line">		<span class="comment">// restart. We re-issue allocate request to cover this race.</span></span><br><span class="line">		<span class="keyword">if</span> m.podDevices.containerDevices(podUID, contName, resource) == <span class="literal">nil</span> &#123;</span><br><span class="line">			needsReAllocate = <span class="literal">true</span></span><br><span class="line">		&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> needsReAllocate &#123;</span><br><span class="line">		klog.V(<span class="number">2</span>).Infof(<span class="string">&quot;needs re-allocate device plugin resources for pod %s, container %s&quot;</span>, podUID, container.Name)</span><br><span class="line">		<span class="keyword">if</span> err := m.Allocate(pod, container); err != <span class="literal">nil</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, err</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>19/11/10 的 commit</p>
<blockquote>
<p>Checks whether we have cached runtime state before starting a container that requests any device plugin resource. If not, re-issue Allocate grpc calls. This allows us to handle the edge case that a pod got assigned to a node even before it populates its extended resource capacity.</p>
</blockquote>
<p>注释说明这种情况出现在 node 重启，pod 又被分配到了一个 node 上，但是这个 node 的 extended resource capacity 又并未 polulates 的情况</p>
<p>回到 deviceManger Allocate 方法</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Allocate is the call that you can use to allocate a set of devices</span></span><br><span class="line"><span class="comment">// from the registered device plugins.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(m *ManagerImpl)</span> <span class="title">Allocate</span><span class="params">(pod *v1.Pod, container *v1.Container)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> _, ok := m.devicesToReuse[<span class="keyword">string</span>(pod.UID)]; !ok &#123;</span><br><span class="line">		m.devicesToReuse[<span class="keyword">string</span>(pod.UID)] = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]sets.String)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// If pod entries to m.devicesToReuse other than the current pod exist, delete them.</span></span><br><span class="line">	<span class="keyword">for</span> podUID := <span class="keyword">range</span> m.devicesToReuse &#123;</span><br><span class="line">		<span class="keyword">if</span> podUID != <span class="keyword">string</span>(pod.UID) &#123;</span><br><span class="line">			<span class="built_in">delete</span>(m.devicesToReuse, podUID)</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可见其中使用了 map，并不是并发安全的；因此上述 workaround 代码，假若触发条件非单一 pod 的情况下，是有并发问题的；既然提交了如此久，未被修复，那么我也认为该处 workaround 代码无多 pod 并发冲突 … :) 当然啦，这不是乱说的，找到上边代码合入的 PR 讨论，也可以佐证是 serialized 的</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/87759">https://github.com/kubernetes/kubernetes/pull/87759</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/87759#pullrequestreview-364185345">https://github.com/kubernetes/kubernetes/pull/87759#pullrequestreview-364185345</a></p>
<p>其实大佬们也注意到了这个实现的诡异之处，只是 leave it behind，因为之前就有，此次重构并未修改原来的逻辑</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/87759#pullrequestreview-353195106">https://github.com/kubernetes/kubernetes/pull/87759#pullrequestreview-353195106</a></p>
<p>设计思路呢，其实就是 init container 的资源，继续分配给 container</p>
<blockquote>
<p>I’d need to look closer at this, but is the idea to:</p>
<ol>
<li><p>Unconditionally allocate CPUs to the container from the pool of available CPUs</p>
</li>
<li><p>Check if the container we just allocated to is an init container</p>
</li>
<li><p>if it IS an init container, reset the pool of available CPUs to re-include the CPUs just assigned to the init container (but <strong>keep them assigned to the init container in the process</strong>).</p>
</li>
<li><p>If it is NOT an init container, just return (leaving the CPUs removed from the pool of available CPUs).</p>
</li>
</ol>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/87759#discussion_r383888297">https://github.com/kubernetes/kubernetes/pull/87759#discussion_r383888297</a></p>
<blockquote>
<p>This would only work if Pod admission is serialized. @derekwaynecarr can you confirm that this is the case?</p>
</blockquote>
<p>总之呢，最后是确认了是 work 的</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/dfdab12d.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/dfdab12d.html" class="post-title-link" itemprop="url">golang memory model</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-12-26 21:39:00 / 修改时间：13:39:59" itemprop="dateCreated datePublished" datetime="2021-12-26T21:39:00Z">2021-12-26</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://go.dev/ref/mem">https://go.dev/ref/mem</a></p>
<blockquote>
<p>Note that a read <em>r</em> may observe the value written by a write <em>w</em> that happens concurrently with <em>r</em>. Even if this occurs, it does not imply that reads happening after <em>r</em> will observe writes that happened before <em>w</em>.</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a, b <span class="keyword">int</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">	a = <span class="number">1</span></span><br><span class="line">	b = <span class="number">2</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">g</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="built_in">print</span>(b)</span><br><span class="line">	<span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> f()</span><br><span class="line">	g()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>it can happen that g prints 2 and then 0.</p>
<blockquote>
<p>A send on a channel happens before the corresponding receive from that channel completes.</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">10</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">	a = <span class="string">&quot;hello, world&quot;</span></span><br><span class="line">	c &lt;- <span class="number">0</span> <span class="comment">// send on c</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> f()</span><br><span class="line">	&lt;-c</span><br><span class="line">	<span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>is guaranteed to print “hello, world”. The write to <em>a</em> happens before the send on <em>c</em>, which happens before the corresponding receive on <em>c</em> completes, which happens before the <em>print</em>.</p>
<p>The closing of a channel happens before a receive that returns a zero value because the channel is closed.</p>
<p>In the previous example, replacing <code>c &lt;- 0</code> with <code>close(c)</code> yields a program with the same guaranteed behavior.</p>
<blockquote>
<p>A receive from an unbuffered channel happens before the send on that channel completes.</p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> c = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>)</span><br><span class="line"><span class="keyword">var</span> a <span class="keyword">string</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">()</span></span> &#123;</span><br><span class="line">	a = <span class="string">&quot;hello, world&quot;</span></span><br><span class="line">	&lt;-c</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">go</span> f()</span><br><span class="line">	c &lt;- <span class="number">0</span></span><br><span class="line">	<span class="built_in">print</span>(a)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>is also guaranteed to print “hello, world”. The write to a happens before the receive on <em>c</em>, which happens before the corresponding send on <em>c</em> completes, which happens before the <em>print</em>.</p>
<p>If the channel were buffered (e.g., c = make(chan int, 1)) then the program would not be guaranteed to print “hello, world”. (It might print the empty string, crash, or do something else.)</p>
<blockquote>
<p>The kth receive on a channel with capacity C happens before the k+Cth send from that channel completes.</p>
</blockquote>
<p>This program starts a goroutine for every entry in the work list, but the goroutines coordinate using the limit channel to ensure that at most three are running work functions at a time.</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> limit = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">int</span>, <span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	<span class="keyword">for</span> _, w := <span class="keyword">range</span> work &#123;</span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(w <span class="keyword">func</span>()</span>)</span> &#123;</span><br><span class="line">			limit &lt;- <span class="number">1</span></span><br><span class="line">			w()</span><br><span class="line">			&lt;-limit</span><br><span class="line">		&#125;(w)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">select</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/50cf0505.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/50cf0505.html" class="post-title-link" itemprop="url">infiniband ethernet</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-26 14:44:37" itemprop="dateCreated datePublished" datetime="2021-12-26T14:44:37Z">2021-12-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-06 05:53:58" itemprop="dateModified" datetime="2022-03-06T05:53:58Z">2022-03-06</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Configure-RoCE"><a href="#Configure-RoCE" class="headerlink" title="Configure RoCE"></a>Configure RoCE</h1><p><a target="_blank" rel="noopener" href="https://community.mellanox.com/s/article/howto-configure-roce-on-connectx-4">https://community.mellanox.com/s/article/howto-configure-roce-on-connectx-4</a></p>
<p><a target="_blank" rel="noopener" href="https://community.mellanox.com/s/article/understanding-show-gids-script">https://community.mellanox.com/s/article/understanding-show-gids-script</a></p>
<blockquote>
<p>Use <code>ibv_query_gid</code> and <code>ibv_find_gid_index</code> functions defined in libibverbs to get the desired GID index.</p>
</blockquote>
<p>根据上述材料可知，RoCE 首先需要网卡设备支持比如 mlnx ConnectX-4</p>
<p>以 mlnx 网卡设备为例</p>
<ol>
<li>找到 mlnx 设备 GID 映射到的网络设备</li>
</ol>
<p><code>cat /sys/class/infiniband/mlx5_0/ports/1/gid_attrs/ndevs/1</code></p>
<ol start="2">
<li>查看 GIDs 1 对应的 RoCE type</li>
</ol>
<p><code>cat /sys/class/infiniband/mlx5_0/ports/1/gid_attrs/types/1</code></p>
<ol start="3">
<li>查看 GIDs 1 地址</li>
</ol>
<p><code>cat /sys/class/infiniband/mlx5_0/ports/1/gids/1</code></p>
<table>
<thead>
<tr>
<th>Interface</th>
<th>GID Index</th>
<th>RoCE version</th>
<th>GID Address</th>
</tr>
</thead>
<tbody><tr>
<td>ens785f0</td>
<td>1</td>
<td>RoCEv2</td>
<td>fe80:0000:0000:0000:e61d:2dff:fef2:a488</td>
</tr>
</tbody></table>
<p>确定好需要使用的 GID 后，可使用 <code>ib_send_bw</code> 指定 GID 进行 RoCE 通信</p>
<p>另外注意到</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://community.mellanox.com/s/article/howto-configure-roce-on-connectx-4">https://community.mellanox.com/s/article/howto-configure-roce-on-connectx-4</a></p>
</blockquote>
<p>在 mlnx 设备映射到的网络设备中增加的 vlan 网卡也支持 RoCE</p>
<h1 id="RoCE-in-container"><a href="#RoCE-in-container" class="headerlink" title="RoCE in container"></a>RoCE in container</h1><h2 id="NCCL-RoCE-failed-in-container"><a href="#NCCL-RoCE-failed-in-container" class="headerlink" title="NCCL RoCE failed in container"></a>NCCL RoCE failed in container</h2><blockquote>
<p>NCCL WARN Call to ibv_modify_qp failed with error No such device</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IB setup</span></span><br><span class="line">ibv_context* ctx = ncclIbDevs[lComm-&gt;dev].context;</span><br><span class="line"><span class="keyword">uint8_t</span> ib_port = ncclIbDevs[lComm-&gt;dev].port;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ibv_port_attr</span> <span class="title">portAttr</span>;</span></span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_query_port</span>(ctx, ib_port, &amp;portAttr));</span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">ibv_gid</span> <span class="title">gid</span>;</span></span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_query_gid</span>(ctx, ib_port, <span class="built_in">ncclParamIbGidIndex</span>(), &amp;gid));</span><br><span class="line"></span><br><span class="line"><span class="comment">// QP Creation</span></span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbInitVerbs</span>(ctx, &amp;rComm-&gt;verbs));</span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbCreateQp</span>(ib_port, &amp;rComm-&gt;verbs, IBV_ACCESS_REMOTE_WRITE, &amp;rComm-&gt;qp));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Adjust the MTU</span></span><br><span class="line">remQpInfo.mtu = (<span class="keyword">enum</span> ibv_mtu)std::<span class="built_in">min</span>(remQpInfo.mtu, portAttr.active_mtu);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup QP</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp</span>* <span class="title">qp</span> =</span> rComm-&gt;qp;</span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtrQp</span>(qp, &amp;remQpInfo));</span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtsQp</span>(qp));</span><br></pre></td></tr></table></figure>

<p><strong>ncclIbRtrQp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbRtrQp</span><span class="params">(ibv_qp* qp, struct ncclIbQpInfo* info)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp_attr</span> <span class="title">qpAttr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;qpAttr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ibv_qp_attr));</span><br><span class="line">  qpAttr.qp_state = IBV_QPS_RTR;</span><br><span class="line">  qpAttr.path_mtu = info-&gt;mtu;</span><br><span class="line">  qpAttr.dest_qp_num = info-&gt;qpn;</span><br><span class="line">  qpAttr.rq_psn = <span class="number">0</span>;</span><br><span class="line">  qpAttr.max_dest_rd_atomic = <span class="number">1</span>;</span><br><span class="line">  qpAttr.min_rnr_timer = <span class="number">12</span>;</span><br><span class="line">  <span class="keyword">if</span> (info-&gt;lid == <span class="number">0</span>) &#123;</span><br><span class="line">    qpAttr.ah_attr.is_global = <span class="number">1</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.dgid.global.subnet_prefix = info-&gt;spn;</span><br><span class="line">    qpAttr.ah_attr.grh.dgid.global.interface_id = info-&gt;iid;</span><br><span class="line">    qpAttr.ah_attr.grh.flow_label = <span class="number">0</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.sgid_index = <span class="built_in">ncclParamIbGidIndex</span>();</span><br><span class="line">    qpAttr.ah_attr.grh.hop_limit = <span class="number">255</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.traffic_class = <span class="built_in">ncclParamIbTc</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    qpAttr.ah_attr.is_global = <span class="number">0</span>;</span><br><span class="line">    qpAttr.ah_attr.dlid = info-&gt;lid;</span><br><span class="line">  &#125;</span><br><span class="line">  qpAttr.ah_attr.sl = <span class="built_in">ncclParamIbSl</span>();</span><br><span class="line">  qpAttr.ah_attr.src_path_bits = <span class="number">0</span>;</span><br><span class="line">  qpAttr.ah_attr.port_num = info-&gt;ib_port;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_modify_qp</span>(qp, &amp;qpAttr, IBV_QP_STATE | IBV_QP_AV | IBV_QP_PATH_MTU | IBV_QP_DEST_QPN | IBV_QP_RQ_PSN | IBV_QP_MAX_DEST_RD_ATOMIC | IBV_QP_MIN_RNR_TIMER));</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>推测是在容器中虽然发现了 mlnx 设备，但是并没有发现 mlnx 设备对应的网络设备（例如 demo 中的 ens785f0)，也就无法找到可使用的 GID 进行 RoCE 通信</p>
<h2 id="ib-write-bw-failed-in-container"><a href="#ib-write-bw-failed-in-container" class="headerlink" title="ib_write_bw failed in container"></a>ib_write_bw failed in container</h2><blockquote>
<p>Failed to modify QP 100 to RTR</p>
</blockquote>
<p>使用 <code>ib_write_bw</code> 也会报错，看报错信息，与 NCCL 出错的方法一致 <code>ncclIbRtrQp</code></p>
<h2 id="multus-cni"><a href="#multus-cni" class="headerlink" title="multus-cni"></a>multus-cni</h2><p><a target="_blank" rel="noopener" href="https://github.com/k8snetworkplumbingwg/multus-cni">https://github.com/k8snetworkplumbingwg/multus-cni</a></p>
<p>理论上需要使用 multus-cni 以 macvlan 的方式增加 RoCE 网络设备到容器中</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Mellanox/k8s-rdma-sriov-dev-plugin/issues/18">https://github.com/Mellanox/k8s-rdma-sriov-dev-plugin/issues/18</a></p>
<blockquote>
<p>instead of calico, you should use macvlan cni where those virtual devices are child of enp175s0. RoCE can make use of those netdevices.</p>
<p>Other users are using multus plugin, which allows you to have multiple netdev interfaces in a Pod. Such as first managed default veth interface via your existing plugin, and second macvlan or sriov interface via 2nd cni.<br>This way you get both of both world for performance and functionality.</p>
</blockquote>
<p>根据 multus-cni quick start 文档，假若 multus 实测可兼容目前 k8s 集群默认的 cni 插件的情况下，需要额外增加 macvlan RoCE 网络设备的 crd 资源配置（假若主机上有多个 RoCE 网络设备，则可分别创建多个 crd 资源配置，每个资源配置对应其中一个 RoCE 网络设备）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl create -f -</span><br><span class="line">apiVersion: &quot;k8s.cni.cncf.io/v1&quot;</span><br><span class="line">kind: NetworkAttachmentDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: macvlan-conf</span><br><span class="line">spec:</span><br><span class="line">  config: &#x27;&#123;</span><br><span class="line">      &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;macvlan&quot;,</span><br><span class="line">      &quot;master&quot;: &quot;eth0&quot;,</span><br><span class="line">      &quot;mode&quot;: &quot;bridge&quot;,</span><br><span class="line">      &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">        &quot;subnet&quot;: &quot;192.168.1.0/24&quot;,</span><br><span class="line">        &quot;rangeStart&quot;: &quot;192.168.1.200&quot;,</span><br><span class="line">        &quot;rangeEnd&quot;: &quot;192.168.1.216&quot;,</span><br><span class="line">        &quot;routes&quot;: [</span><br><span class="line">          &#123; &quot;dst&quot;: &quot;0.0.0.0/0&quot; &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;gateway&quot;: &quot;192.168.1.1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;&#x27;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>当然前提是 k8s 集群中已安装了 macvlan cni</strong></p>
<blockquote>
<p>type: This tells CNI which binary to call on disk. Each CNI plugin is a binary that’s called. Typically, these binaries are stored in /opt/cni/bin on each node, and CNI executes this binary. In this case we’ve specified the loopback binary (which create a loopback-type network interface). <strong>If this is your first time installing Multus, you might want to verify that the plugins that are in the “type” field are actually on disk in the /opt/cni/bin directory.</strong></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/">https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cni.dev/plugins/current/main/macvlan/">https://www.cni.dev/plugins/current/main/macvlan/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/network/macvlan/">https://docs.docker.com/network/macvlan/</a></p>
<blockquote>
<p>Some applications, especially legacy applications or applications which monitor network traffic, expect to be directly connected to the physical network. In this type of situation, you can use the macvlan network driver to assign a MAC address to each container’s virtual network interface, making it appear to be a physical network interface directly connected to the physical network.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/network/network-tutorial-macvlan/">https://docs.docker.com/network/network-tutorial-macvlan/</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/71008a70.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/71008a70.html" class="post-title-link" itemprop="url">k8s-crd-clientsets</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-12-26 14:43:37 / 修改时间：06:45:47" itemprop="dateCreated datePublished" datetime="2021-12-26T14:43:37Z">2021-12-26</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>126</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/code-generator">https://github.com/kubernetes/code-generator</a></p>
<p><a target="_blank" rel="noopener" href="https://cloud.redhat.com/blog/kubernetes-deep-dive-code-generation-customresources">https://cloud.redhat.com/blog/kubernetes-deep-dive-code-generation-customresources</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/14155322.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/14155322.html" class="post-title-link" itemprop="url">go db connection pool</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-09-25 04:52:20 / 修改时间：06:52:29" itemprop="dateCreated datePublished" datetime="2021-09-25T04:52:20Z">2021-09-25</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.8k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="https-pkg-go-dev-database-sql-driver"><a href="#https-pkg-go-dev-database-sql-driver" class="headerlink" title="https://pkg.go.dev/database/sql/driver"></a><a target="_blank" rel="noopener" href="https://pkg.go.dev/database/sql/driver">https://pkg.go.dev/database/sql/driver</a></h1><p>sql/driver 中定义了 db driver 应实现的接口，其中明确了 <strong>ErrBadConn</strong> 的处理方式</p>
<blockquote>
<ol>
<li>The Connector.Connect and Driver.Open methods should never return ErrBadConn. </li>
<li>ErrBadConn should only be returned from Validator, SessionResetter, or a query method if the connection is already in an invalid (e.g. closed) state.</li>
</ol>
<p><code>var ErrBadConn = errors.New(&quot;driver: bad connection&quot;)</code></p>
<p>ErrBadConn should be returned by a driver to signal to the sql package that a driver.Conn is in a bad state (such as the server having earlier closed the connection) and <strong>the sql package</strong> should retry on a new connection.</p>
<p>To prevent duplicate operations, ErrBadConn should NOT be returned if there’s a possibility that the database server might have performed the operation. Even if the server sends back an error, you shouldn’t return ErrBadConn.</p>
</blockquote>
<p>简而言之，当 sql driver 返回 ErrBadConn 错误时，sql package 应使用 new connection 重试</p>
<h1 id="https-pkg-go-dev-database-sql"><a href="#https-pkg-go-dev-database-sql" class="headerlink" title="https://pkg.go.dev/database/sql"></a><a target="_blank" rel="noopener" href="https://pkg.go.dev/database/sql">https://pkg.go.dev/database/sql</a></h1><p>golang native db connection pool</p>
<p>connection retry 机制结合 golang native sql Query/Exec 实现理解</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/11978">https://github.com/golang/go/issues/11978</a></p>
</blockquote>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// maxBadConnRetries is the number of maximum retries if the driver returns</span></span><br><span class="line"><span class="comment">// driver.ErrBadConn to signal a broken connection before forcing a new</span></span><br><span class="line"><span class="comment">// connection to be opened.</span></span><br><span class="line"><span class="keyword">const</span> maxBadConnRetries = <span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// QueryContext executes a query that returns rows, typically a SELECT.</span></span><br><span class="line"><span class="comment">// The args are for any placeholder parameters in the query.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span> <span class="title">QueryContext</span><span class="params">(ctx context.Context, query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(*Rows, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> rows *Rows</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; maxBadConnRetries; i++ &#123;</span><br><span class="line">		rows, err = db.query(ctx, query, args, cachedOrNewConn)</span><br><span class="line">		<span class="keyword">if</span> err != driver.ErrBadConn &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err == driver.ErrBadConn &#123;</span><br><span class="line">		<span class="keyword">return</span> db.query(ctx, query, args, alwaysNewConn)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> rows, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Query executes a query that returns rows, typically a SELECT.</span></span><br><span class="line"><span class="comment">// The args are for any placeholder parameters in the query.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span> <span class="title">Query</span><span class="params">(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(*Rows, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> db.QueryContext(context.Background(), query, args...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Exec 实现</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ExecContext executes a query without returning any rows.</span></span><br><span class="line"><span class="comment">// The args are for any placeholder parameters in the query.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span> <span class="title">ExecContext</span><span class="params">(ctx context.Context, query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(Result, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">var</span> res Result</span><br><span class="line">	<span class="keyword">var</span> err error</span><br><span class="line">	<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; maxBadConnRetries; i++ &#123;</span><br><span class="line">		res, err = db.exec(ctx, query, args, cachedOrNewConn)</span><br><span class="line">		<span class="keyword">if</span> err != driver.ErrBadConn &#123;</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> err == driver.ErrBadConn &#123;</span><br><span class="line">		<span class="keyword">return</span> db.exec(ctx, query, args, alwaysNewConn)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> res, err</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Exec executes a query without returning any rows.</span></span><br><span class="line"><span class="comment">// The args are for any placeholder parameters in the query.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(db *DB)</span> <span class="title">Exec</span><span class="params">(query <span class="keyword">string</span>, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(Result, error)</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> db.ExecContext(context.Background(), query, args...)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>综上 ErrBadConn 时，最多重试 2 次，使用 cached conn 或 new conn；超过重试次数，再尝试使用 new conn 1 次</p>
<h1 id="psql-BadConn"><a href="#psql-BadConn" class="headerlink" title="psql BadConn"></a>psql BadConn</h1><p><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/10/app-psql.html#id-1.9.4.18.7">https://www.postgresql.org/docs/10/app-psql.html#id-1.9.4.18.7</a></p>
<blockquote>
<p>2 if the connection to the server went bad and the session was not interactive</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/6555f3f9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/6555f3f9.html" class="post-title-link" itemprop="url">resource limit in k8s</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-05 02:30:20" itemprop="dateCreated datePublished" datetime="2021-09-05T02:30:20Z">2021-09-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-13 16:33:11" itemprop="dateModified" datetime="2021-09-13T16:33:11Z">2021-09-13</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Docker-Resource-Limit"><a href="#Docker-Resource-Limit" class="headerlink" title="Docker Resource Limit"></a>Docker Resource Limit</h1><h2 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/resource_constraints/#cpu">https://docs.docker.com/config/containers/resource_constraints/#cpu</a></p>
<ul>
<li><code>--cpu-period</code>: CFS 调度算法中的 cpu 时间分片，默认为 100ms</li>
<li><code>--cpu-quota</code>: CFS quota，在每个 cpu period 分片中，在 cpu 限流前，docker container 能使用的 cpu 时间</li>
<li><code>--cpuset-cpus</code>: docker container binding to cpu core</li>
<li><code>--cpu-shares</code>: Set this flag to a value greater or less than the default of 1024 to increase or reduce the container’s weight, and give it access to a greater or lesser proportion of the host machine’s CPU cycles. This is only enforced when CPU cycles are constrained. When plenty of CPU cycles are available, all containers use as much CPU as they need. In that way, this is a <strong>soft limit</strong>.</li>
</ul>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/resource_constraints/#limit-a-containers-access-to-memory">https://docs.docker.com/config/containers/resource_constraints/#limit-a-containers-access-to-memory</a></p>
<ul>
<li><code>--memory</code>: The maximum amount of memory the container can use (cgroup limit)</li>
<li><code>--memory-swap</code>:</li>
<li><code>--oom-kill-disable</code>:</li>
</ul>
<p>针对 OOM 补充说明如下</p>
<ol>
<li>容器内进程使用 memory 超过限制，kernel 会触发 oom killer (cgroup)，kill oom_score 高分进程</li>
<li>容器只要 1 pid 进程未退出，则容器不会退出</li>
</ol>
<p>OOM 始终针对的是进程，而非容器</p>
<h2 id="Docker-Container-OOMKilled-status"><a href="#Docker-Container-OOMKilled-status" class="headerlink" title="Docker Container OOMKilled status"></a>Docker Container OOMKilled status</h2><ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48618431/what-does-oom-kill-disable-do-for-a-docker-container">https://stackoverflow.com/questions/48618431/what-does-oom-kill-disable-do-for-a-docker-container</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/14440#issuecomment-119243820">https://github.com/moby/moby/issues/14440#issuecomment-119243820</a></li>
<li><a target="_blank" rel="noopener" href="https://plumbr.io/blog/java/oomkillers-in-docker-are-more-complex-than-you-thought">https://plumbr.io/blog/java/oomkillers-in-docker-are-more-complex-than-you-thought</a></li>
<li><a target="_blank" rel="noopener" href="https://zhimin-wen.medium.com/memory-limit-of-pod-and-oom-killer-891ee1f1cad8">https://zhimin-wen.medium.com/memory-limit-of-pod-and-oom-killer-891ee1f1cad8</a></li>
<li><a target="_blank" rel="noopener" href="https://faun.pub/understanding-docker-container-memory-limit-behavior-41add155236c">https://faun.pub/understanding-docker-container-memory-limit-behavior-41add155236c</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/15621#issuecomment-181418985">https://github.com/moby/moby/issues/15621#issuecomment-181418985</a></li>
<li><a target="_blank" rel="noopener" href="https://draveness.me/docker/">https://draveness.me/docker/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/38352#issuecomment-446329512">https://github.com/moby/moby/issues/38352#issuecomment-446329512</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/containerd/cgroups/issues/74">https://github.com/containerd/cgroups/issues/74</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/78973">https://github.com/kubernetes/kubernetes/issues/78973</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/50632">https://github.com/kubernetes/kubernetes/issues/50632</a></li>
</ol>
<p>容器内的子进程发生了 oom killed，在 docker container 退出时也会被设置 OOMKilled 标志；参考该 issue</p>
<p><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/15621#issuecomment-181418985">https://github.com/moby/moby/issues/15621#issuecomment-181418985</a></p>
<p>在 docker container 未退出时会设置 container event</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/events/">https://docs.docker.com/engine/reference/commandline/events/</a></p>
<p>docker container 设置 OOMKilled 原理，参考该 issue</p>
<p><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/38352#issuecomment-446329512">https://github.com/moby/moby/issues/38352#issuecomment-446329512</a></p>
<p>在实现上</p>
<ol>
<li>containerd 监听了一系列事件，假若获取到 cgroup oom event 则记录 OOMKilled = true</li>
<li>containerd 将处理后的事件发送至 dockerd 进一步处理</li>
<li>dockerd 在处理 OOM 事件时，记录 container oom 事件</li>
<li>dockerd 在处理 Exit 事件时，将 OOMKilled = true 写入容器的 status</li>
</ol>
<h1 id="K8S-Resource-Limit"><a href="#K8S-Resource-Limit" class="headerlink" title="K8S Resource Limit"></a>K8S Resource Limit</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#how-pods-with-resource-limits-are-run">https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#how-pods-with-resource-limits-are-run</a></p>
<h2 id="CPU-Docker-Container-config"><a href="#CPU-Docker-Container-config" class="headerlink" title="CPU (Docker Container config)"></a>CPU (Docker Container config)</h2><blockquote>
<p>CPU is always requested as an absolute quantity, never as a relative quantity; 0.1 is the same amount of CPU on a single-core, dual-core, or 48-core machine.</p>
</blockquote>
<ul>
<li><code>--cpu-shares</code>: max({requests.cpu} * 1024, 2)</li>
</ul>
<p>例如 requests 为 180，则 <code>--cpu-shares=184320</code></p>
<ul>
<li><p><code>--cpu-period</code>: 100</p>
</li>
<li><p><code>--cpu-quota</code>: limits.cpu * 100</p>
</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/63352630">https://stackoverflow.com/a/63352630</a></p>
<p> The resulting value is the total amount of CPU time in microseconds that a container can use every <strong>100ms</strong>. A container cannot use more than its share of CPU time during this interval.</p>
<p>The default quota period is 100ms. The minimum resolution of CPU quota is 1ms.</p>
</blockquote>
<p>cpu 时间分片为 period，quota 为实际每个 period 周期中，可使用的 cpu time；假若受到 qutoa 限制的 cpu 任务，在当前 period 的 quota 仍未完成，则当前任务挂起，等待下个 period 继续执行</p>
<p>multi cpu 机器注意 quota 可以是 period 的倍数，例如限制 container 使用 0.5 cpu，则 <code>--cpu-quota=50</code>，假若主机有 20 cpu，限制 container 使用 10 cpu，则 <code>--cpu-quota=10*100=1000</code></p>
<h2 id="Memory-Docker-Container-config"><a href="#Memory-Docker-Container-config" class="headerlink" title="Memory (Docker Container config)"></a>Memory (Docker Container config)</h2><ul>
<li><code>--memory</code>: int({limits.memory})</li>
<li><code>--memory-swap</code>: int({limits.memory})</li>
</ul>
<p>the container does not have access to swap</p>
<h2 id="K8s-OOM-Watcher"><a href="#K8s-OOM-Watcher" class="headerlink" title="K8s OOM Watcher"></a>K8s OOM Watcher</h2><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/v1.22.1/pkg/kubelet/oom/oom_watcher_linux.go">https://github.com/kubernetes/kubernetes/blob/v1.22.1/pkg/kubelet/oom/oom_watcher_linux.go</a></p>
<ul>
<li>/dev/kmsg</li>
</ul>
<blockquote>
<p>Start watches for system oom’s and records an event for every system oom encountered.</p>
</blockquote>
<p>当 kubelet 观测到节点发生 system oom 时（非 cgroup oom），生成 event；可通过 kubectl 工具查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get event --field-selector type=Warning,reason=SystemOOM</span><br></pre></td></tr></table></figure>

<p>如下 PR 尝试将 pod 内进程 oom 关联至 pod，未合入</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/100483">https://github.com/kubernetes/kubernetes/issues/100483</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/100487">https://github.com/kubernetes/kubernetes/pull/100487</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/cbf18cae.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/cbf18cae.html" class="post-title-link" itemprop="url">learning lenet5</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-08-15 03:21:13" itemprop="dateCreated datePublished" datetime="2021-08-15T03:21:13Z">2021-08-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-05 03:22:51" itemprop="dateModified" datetime="2021-09-05T03:22:51Z">2021-09-05</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>389</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li><a target="_blank" rel="noopener" href="https://medium.com/analytics-vidhya/lenet-with-tensorflow-a35da0d503df">https://medium.com/analytics-vidhya/lenet-with-tensorflow-a35da0d503df</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@mgazar/lenet-5-in-9-lines-of-code-using-keras-ac99294c8086">https://medium.com/@mgazar/lenet-5-in-9-lines-of-code-using-keras-ac99294c8086</a></li>
</ol>
<p><a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/pad">https://www.tensorflow.org/api_docs/python/tf/pad</a></p>
<blockquote>
<p>paddings is an integer tensor with shape [n, 2], where n is the rank of tensor. </p>
</blockquote>
<p>each dimension D</p>
<ul>
<li>paddings[D, 0]: add before tensor </li>
<li>paddings[D, 1]: add after tensor</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://www.tensorflow.org/api_docs/python/tf/expand_dims">https://www.tensorflow.org/api_docs/python/tf/expand_dims</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/d2d36a67.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/d2d36a67.html" class="post-title-link" itemprop="url">pod spec of volcano job and sysctl</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-08-14 03:09:06 / 修改时间：05:09:51" itemprop="dateCreated datePublished" datetime="2021-08-14T03:09:06Z">2021-08-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="pod-spec-of-volcano-job"><a href="#pod-spec-of-volcano-job" class="headerlink" title="pod spec of volcano job"></a>pod spec of volcano job</h1><p><a target="_blank" rel="noopener" href="https://github.com/volcano-sh/volcano/blob/v1.3.0/pkg/controllers/job/job_controller_util.go">https://github.com/volcano-sh/volcano/blob/v1.3.0/pkg/controllers/job/job_controller_util.go</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">    v1 <span class="string">&quot;k8s.io/api/core/v1&quot;</span></span><br><span class="line">    ...</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// MakePodName append podname,jobname,taskName and index and returns the string.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakePodName</span><span class="params">(jobName <span class="keyword">string</span>, taskName <span class="keyword">string</span>, index <span class="keyword">int</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> fmt.Sprintf(jobhelpers.PodNameFmt, jobName, taskName, index)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">createJobPod</span><span class="params">(job *batch.Job, template *v1.PodTemplateSpec, ix <span class="keyword">int</span>)</span> *<span class="title">v1</span>.<span class="title">Pod</span></span> &#123;</span><br><span class="line">	templateCopy := template.DeepCopy()</span><br><span class="line"></span><br><span class="line">	pod := &amp;v1.Pod&#123;</span><br><span class="line">		ObjectMeta: metav1.ObjectMeta&#123;</span><br><span class="line">			Name:      jobhelpers.MakePodName(job.Name, template.Name, ix),</span><br><span class="line">			Namespace: job.Namespace,</span><br><span class="line">			OwnerReferences: []metav1.OwnerReference&#123;</span><br><span class="line">				*metav1.NewControllerRef(job, helpers.JobKind),</span><br><span class="line">			&#125;,</span><br><span class="line">			Labels:      templateCopy.Labels,</span><br><span class="line">			Annotations: templateCopy.Annotations,</span><br><span class="line">		&#125;,</span><br><span class="line">		Spec: templateCopy.Spec,</span><br><span class="line">	&#125;</span><br><span class="line">    </span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="sysctl-of-pod-spec"><a href="#sysctl-of-pod-spec" class="headerlink" title="sysctl of pod spec"></a>sysctl of pod spec</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/">https://kubernetes.io/docs/tasks/administer-cluster/sysctl-cluster/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: sysctl-example</span><br><span class="line">spec:</span><br><span class="line">  securityContext:</span><br><span class="line">    sysctls:</span><br><span class="line">    - name: net.ipv4.ip_local_port_range</span><br><span class="line">      value: &quot;30000 50000&quot;</span><br></pre></td></tr></table></figure>

<p>find out current ip local port range</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /proc/sys/net/ipv4/ip_local_port_range</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.thegeekdiary.com/how-to-reserve-a-port-range-for-a-third-party-application-in-centos-rhel/">https://www.thegeekdiary.com/how-to-reserve-a-port-range-for-a-third-party-application-in-centos-rhel/</a></p>
<blockquote>
<p>Note: ip_local_port_range and ip_local_reserved_ports settings are independent and both are considered by the kernel when determining which ports are available for <strong>automatic port assignments</strong>.</p>
</blockquote>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/fb311e36.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/fb311e36.html" class="post-title-link" itemprop="url">k8s init and sidecar container</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2021-07-18 07:38:28 / 修改时间：08:58:40" itemprop="dateCreated datePublished" datetime="2021-07-18T07:38:28Z">2021-07-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>661</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <pre class="mermaid">
graph LR
InitContainer --&gt; TrainingContainer
InitContainer --&gt; SidecarContainer
</pre>

<p>InitContainer and SidecarContainer act like system container and they are transparent to the TrainingContainer</p>
<p>TrainingJob(process) of user is running at TrainingContainer</p>
<p>we can do the init env action at InitContainer, such as download data, and the upload action can be done at SidecarContainer</p>
<p>however, there will be an engineering problem, that is, the file read permission problem. The best way is to make the InitC / SidecarC / TrainingC users (uid) the same</p>
<p>powered by <em>mermaid</em></p>
<p><a target="_blank" rel="noopener" href="https://mermaid-js.github.io/mermaid/#/flowchart">https://mermaid-js.github.io/mermaid/#/flowchart</a></p>
<p><a target="_blank" rel="noopener" href="https://theme-next.js.org/docs/tag-plugins/mermaid.html?highlight=mermaid">https://theme-next.js.org/docs/tag-plugins/mermaid.html?highlight=mermaid</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/theme-next/hexo-theme-next/pull/649">https://github.com/theme-next/hexo-theme-next/pull/649</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/e9a26fdf.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/e9a26fdf.html" class="post-title-link" itemprop="url">golang cli context</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-07-12 16:44:12" itemprop="dateCreated datePublished" datetime="2021-07-12T16:44:12Z">2021-07-12</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-07-18 03:26:20" itemprop="dateModified" datetime="2021-07-18T03:26:20Z">2021-07-18</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li><a target="_blank" rel="noopener" href="https://www.sohamkamani.com/golang/context-cancellation-and-values/">https://www.sohamkamani.com/golang/context-cancellation-and-values/</a></li>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/52346262/how-to-call-cancel-when-using-exec-commandcontext-in-a-goroutine">https://stackoverflow.com/questions/52346262/how-to-call-cancel-when-using-exec-commandcontext-in-a-goroutine</a></li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://blog.golang.org/context#:~:text=A%20Context%20is%20safe%20for,to%20signal%20all%20of%20them">https://blog.golang.org/context#:~:text=A%20Context%20is%20safe%20for,to%20signal%20all%20of%20them</a>.</p>
<p>A Context is safe for simultaneous use by multiple goroutines. Code can pass a single Context to any number of goroutines and cancel that Context to signal all of them.</p>
</blockquote>
<h1 id="project-structure"><a href="#project-structure" class="headerlink" title="project structure"></a>project structure</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">├── cmd</span><br><span class="line">│   └── command.go</span><br><span class="line">├── go.mod</span><br><span class="line">├── go.sum</span><br><span class="line">├── main.go</span><br><span class="line">└── pkg</span><br><span class="line">    └── run</span><br><span class="line">        └── long_run_cli.go</span><br><span class="line"></span><br><span class="line">3 directories, 5 files</span><br></pre></td></tr></table></figure>

<h1 id="main-go"><a href="#main-go" class="headerlink" title="main.go"></a>main.go</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/signal&quot;</span></span><br><span class="line">	<span class="string">&quot;syscall&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;zs/toolkit-cli/cmd&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	c := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">2</span>)</span><br><span class="line">	signal.Notify(c, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line"></span><br><span class="line">	ctx := context.Background()</span><br><span class="line">	ctx, cancel := context.WithCancel(ctx)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-c:</span><br><span class="line">			cancel()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	cmd.Execute(ctx)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="command-go"><a href="#command-go" class="headerlink" title="command.go"></a>command.go</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> cmd</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/exec&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;github.com/spf13/cobra&quot;</span></span><br><span class="line"></span><br><span class="line">	<span class="string">&quot;zs/toolkit-cli/pkg/run&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> rootCmd = &amp;cobra.Command&#123;</span><br><span class="line">	Use:   <span class="string">&quot;long run cli&quot;</span>,</span><br><span class="line">	Run: <span class="function"><span class="keyword">func</span><span class="params">(cmd *cobra.Command, args []<span class="keyword">string</span>)</span></span> &#123;</span><br><span class="line">		cli := run.New()</span><br><span class="line">		err := cli.LongRun(cmd.Context())</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">			fmt.Printf(<span class="string">&quot;cli run err: %v\n&quot;</span>, err)</span><br><span class="line">			<span class="keyword">if</span> exitError, ok := err.(*exec.ExitError); ok &#123;</span><br><span class="line">				fmt.Printf(<span class="string">&quot;exit code: %d\n&quot;</span>, exitError.ExitCode())</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Execute</span><span class="params">(ctx context.Context)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err := rootCmd.ExecuteContext(ctx); err != <span class="literal">nil</span> &#123;</span><br><span class="line">		fmt.Printf(<span class="string">&quot;err: %v\n&quot;</span>, err)</span><br><span class="line">		os.Exit(<span class="number">1</span>)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="long-run-cli-go"><a href="#long-run-cli-go" class="headerlink" title="long_run_cli.go"></a>long_run_cli.go</h1><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> run</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;context&quot;</span></span><br><span class="line">	<span class="string">&quot;os/exec&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CLI <span class="keyword">struct</span> &#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(cli CLI)</span> <span class="title">LongRun</span><span class="params">(ctx context.Context)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	cmd := exec.CommandContext(ctx, <span class="string">&quot;sleep&quot;</span>, <span class="string">&quot;30&quot;</span>)</span><br><span class="line">	<span class="keyword">return</span> cmd.Run()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">New</span><span class="params">()</span> *<span class="title">CLI</span></span> &#123;</span><br><span class="line">	<span class="keyword">return</span> &amp;CLI&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/os/exec#CommandContext">https://pkg.go.dev/os/exec#CommandContext</a></p>
<blockquote>
<p>The provided context is used to kill the process (by calling os.Process.Kill) if the context becomes done before the command completes on its own.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/golang/go/issues/21135">https://github.com/golang/go/issues/21135</a></p>
<blockquote>
<p>proposal: os/exec: allow user of CommandContext to specify the kill signal when context is done</p>
</blockquote>
<p>commandContext will trigger SIGKILL when the ctx is done …</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">248k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:45</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
