<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="领略了繁华沧桑谁人过往不相似">
<meta property="og:type" content="website">
<meta property="og:title" content="随风飘散的记忆">
<meta property="og:url" content="https://zrss.github.io/index.html">
<meta property="og:site_name" content="随风飘散的记忆">
<meta property="og:description" content="领略了繁华沧桑谁人过往不相似">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="tech">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zrss.github.io/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>随风飘散的记忆</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">随风飘散的记忆</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">领略了繁华沧桑<br>谁人过往不相似</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">126</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">69</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/ab66f1ba.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/ab66f1ba.html" class="post-title-link" itemprop="url">modelarts python sdk job demo</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-09 01:15:32" itemprop="dateCreated datePublished" datetime="2023-05-09T01:15:32Z">2023-05-09</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-05-08 17:18:01" itemprop="dateModified" datetime="2023-05-08T17:18:01Z">2023-05-08</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> modelarts.session <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">from</span> modelarts.estimatorV2 <span class="keyword">import</span> Estimator</span><br><span class="line"><span class="keyword">from</span> modelarts.train_params <span class="keyword">import</span> OutputData</span><br><span class="line"><span class="keyword">from</span> modelarts.train_params <span class="keyword">import</span> InputData</span><br><span class="line"></span><br><span class="line">session = Session(access_key=<span class="string">&#x27;XXX&#x27;</span>,secret_key=<span class="string">&#x27;YYY&#x27;</span>, project_id=<span class="string">&#x27;ZZZ&#x27;</span>, region_name=<span class="string">&#x27;cn-north-4&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># list job</span></span><br><span class="line"><span class="comment"># job_list = Estimator.get_job_list(session=session, offset=0, limit=10, sort_by=&quot;create_time&quot;, order=&quot;desc&quot;)</span></span><br><span class="line"><span class="comment"># print(job_list)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># create a basic training job</span></span><br><span class="line">estimator = Estimator(session=session,</span><br><span class="line">                      job_description=<span class="string">&#x27;This is a basic training job&#x27;</span>,</span><br><span class="line">                      user_image_url=<span class="string">&quot;deep-learning-demo/mpi:3.0.0-cuda10.2&quot;</span>, <span class="comment"># main container 的容器镜像地址</span></span><br><span class="line">                      user_command=<span class="string">&quot;echo hello-world&quot;</span>,  <span class="comment"># main container 的启动命令</span></span><br><span class="line">                      outputs=[OutputData(obs_path=<span class="string">&quot;obs://zs-modelarts/pytorch/model/&quot;</span>, name=<span class="string">&quot;model&quot;</span>, local_path=<span class="string">&quot;/model&quot;</span>, access_method=<span class="string">&quot;env&quot;</span>)],</span><br><span class="line">                      log_url=<span class="string">&quot;obs://zs-modelarts/pytorch/log/&quot;</span>, <span class="comment"># 训练作业日志转存 obs 路径</span></span><br><span class="line">                      train_instance_type=<span class="string">&quot;modelarts.p3.large.public.free&quot;</span>, <span class="comment"># 公共资源池</span></span><br><span class="line">                      train_instance_count=<span class="number">1</span> <span class="comment"># 训练作业节点个数</span></span><br><span class="line">                      )</span><br><span class="line"></span><br><span class="line">job_instance = estimator.fit(job_name=<span class="string">&quot;job-0&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># get job id in job_instance</span></span><br><span class="line"><span class="built_in">print</span>(job_instance.job_id)</span><br><span class="line"></span><br><span class="line"><span class="comment"># view the training job log</span></span><br><span class="line"><span class="comment"># estimator = Estimator(session=session, job_id=&quot;2bfc13b6-782e-45ad-ae90-476dfa97591a&quot;)</span></span><br><span class="line"><span class="comment"># info = estimator.get_job_log()</span></span><br><span class="line"><span class="comment"># print(info)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># view the training job metrics</span></span><br><span class="line"><span class="comment"># estimator = Estimator(session=session, job_id=&quot;2bfc13b6-782e-45ad-ae90-476dfa97591a&quot;)</span></span><br><span class="line"><span class="comment"># info = estimator.get_job_metrics()</span></span><br><span class="line"><span class="comment"># print(info)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># delete the training job metrics</span></span><br><span class="line"><span class="comment"># Estimator.delete_job_by_id(session=session, job_id=&quot;2bfc13b6-782e-45ad-ae90-476dfa97591a&quot;)</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/86c16d0a.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/86c16d0a.html" class="post-title-link" itemprop="url">roce flow control</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-07 10:15:47" itemprop="dateCreated datePublished" datetime="2023-05-07T10:15:47Z">2023-05-07</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>个人理解记录</p>
</blockquote>
<p>所谓无损, 也就是不丢包; 通过 global pause, pfc, dcqcn 等不断演进的流控/拥塞控制协议, 来保障在丢包之前控制源头降速, 避免丢包</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://enterprise-support.nvidia.com/s/article/howto-configure-dcqcn--roce-cc--values-for-connectx-4--linux-x">https://enterprise-support.nvidia.com/s/article/howto-configure-dcqcn--roce-cc--values-for-connectx-4--linux-x</a></li>
<li><a target="_blank" rel="noopener" href="https://enterprise-support.nvidia.com/s/article/dcqcn-parameters">https://enterprise-support.nvidia.com/s/article/dcqcn-parameters</a></li>
<li><a target="_blank" rel="noopener" href="https://enterprise-support.nvidia.com/s/article/DCQCN-CC-algorithm">https://enterprise-support.nvidia.com/s/article/DCQCN-CC-algorithm</a></li>
</ul>
<h1 id="ifconfig-vs-ethtool"><a href="#ifconfig-vs-ethtool" class="headerlink" title="ifconfig vs ethtool"></a>ifconfig vs ethtool</h1><p><a target="_blank" rel="noopener" href="https://enterprise-support.nvidia.com/s/article/ibdev2netdev">https://enterprise-support.nvidia.com/s/article/ibdev2netdev</a></p>
<p><code>ibdev2netdev</code></p>
<p>执行上述命令可查询得到 <em>it maps the adapter port to the net device</em></p>
<p>对于 infiniband 类型的 link layer, 一般来说上述命令得到的是 ib0 设备, 即 IPoIB 虚拟网卡; 对于 ethernet 类型的 link layer，一般来说上述命令得到的是 ens[xxx] 网卡设备</p>
<p>另外注意到 <code>ifconfig ens[xxx]</code> 中显示的 Tx 与 Rx, 实际上与 <code>ethtool -S ens[xxx]</code> 中的如下值一致</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://enterprise-support.nvidia.com/s/article/understanding-mlx5-ethtool-counters">https://enterprise-support.nvidia.com/s/article/understanding-mlx5-ethtool-counters</a></p>
</blockquote>
<ul>
<li>rx_bytes: Representor only: bytes received, that were handled by the hypervisor. supported from kernel 4.18</li>
<li>tx_bytes: Representor only: bytes transmitted, that were handled by the hypervisor. supported from kernel 4.18</li>
</ul>
<p>经过实际测试，在使用 rdma 网卡通信时，上述两值并没有明显的计数增加，而观察到 ethtool counters rx_bytes_phy / tx_bytes_phy 才有与实际流量相当的计数增加。所以可能早期（或者内核？） ifconfig 中获取到的数值，仅是网卡的其中某个计数器，而那个计数器又并不能代表真正的实际情况，所以可能 ifconfig 中的数值会是个误导。我们应使用 <code>ethtool -S ens[xxx]</code> 查看 rdma 网卡的统计信息。</p>
<blockquote>
<p>rx_bytes_phy, ConnectX-3 naming : rx_bytes<br>例如在 cx3 网卡时，当前主机安装的 ifconfig，取的的确就是“正确”的；而在 cx4/5/6 网卡，rx_bytes 的物理意义发生了变化，变为了记录 <em>Representor only: bytes received, that were handled by the hypervisor. supported from kernel 4.18</em></p>
</blockquote>
<h1 id="交换机端口常用查询命令"><a href="#交换机端口常用查询命令" class="headerlink" title="交换机端口常用查询命令"></a>交换机端口常用查询命令</h1><p><a target="_blank" rel="noopener" href="https://support.huawei.com/enterprise/zh/doc/EDOC1100153180/e4418444">https://support.huawei.com/enterprise/zh/doc/EDOC1100153180/e4418444</a></p>
<p><a target="_blank" rel="noopener" href="https://www.infoq.cn/article/o3rnxl2trb1gxemmxdoj">https://www.infoq.cn/article/o3rnxl2trb1gxemmxdoj</a></p>
<p>egress/ingress port</p>
<h2 id="查看是否出现丢包"><a href="#查看是否出现丢包" class="headerlink" title="查看是否出现丢包"></a>查看是否出现丢包</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">display interface 100GE1/0/1</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Input:                                                                      </span><br><span class="line">  Unicast:            11657620879,   Multicast:                     695     </span><br><span class="line">  Broadcast:                    0,   Jumbo:                           0     </span><br><span class="line">  Discard:                      0,   Frames:                          0     </span><br><span class="line">  Pause:                        0                                           </span><br><span class="line"></span><br><span class="line">  Total Error:                  0                                           </span><br><span class="line">  CRC:                          0,   Giants:                          0     </span><br><span class="line">  Jabbers:                      0,   Fragments:                       0     </span><br><span class="line">  Runts:                        0,   DropEvents:                      0     </span><br><span class="line">  Alignments:                   0,   Symbols:                         0     </span><br><span class="line">  Ignoreds:                     0                                           </span><br><span class="line"></span><br><span class="line">Output:                                                                     </span><br><span class="line">  Unicast:              536390526,   Multicast:                     695     </span><br><span class="line">  Broadcast:                    0,   Jumbo:                           0     </span><br><span class="line">  Discard:                      0,   Buffers Purged:                  0     </span><br><span class="line">  Pause:                 18913700</span><br></pre></td></tr></table></figure>

<h2 id="上行方向丢包-Input"><a href="#上行方向丢包-Input" class="headerlink" title="上行方向丢包 Input"></a>上行方向丢包 Input</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">display qos buffer ingress-statistics interface 100GE1/0/1</span><br></pre></td></tr></table></figure>

<p>查看入方向统计值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Interface                   Dropped        Drop Rate   Drop Time                </span><br><span class="line">                     (Packets/Bytes)        (pps/bps)                           </span><br><span class="line">----------------------------------------------------------------                </span><br><span class="line">100GE1/0/1                         0                0          -                </span><br><span class="line">                                   0                0                           </span><br><span class="line">----------------------------------------------------------------</span><br></pre></td></tr></table></figure>

<h2 id="下行出现丢包-Output"><a href="#下行出现丢包-Output" class="headerlink" title="下行出现丢包 Output"></a>下行出现丢包 Output</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">display qos queue statistics interface 100GE1/0/1</span><br></pre></td></tr></table></figure>

<p>查看队列统计情况</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">----------------------------------------------------------------------------------------------                                           </span><br><span class="line">    4         0                   6             0                   0             0          -                                                                 </span><br><span class="line">      100000000                1092             0                   0             0                                                                            </span><br><span class="line">----------------------------------------------------------------------------------------------                                                                 </span><br></pre></td></tr></table></figure>

<h2 id="查看接口出方向队列的缓存使用情况"><a href="#查看接口出方向队列的缓存使用情况" class="headerlink" title="查看接口出方向队列的缓存使用情况"></a>查看接口出方向队列的缓存使用情况</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">display qos buffer egress-usage interface 100GE1/0/1</span><br></pre></td></tr></table></figure>

<p>可以查看无损队列</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Egress Buffer Usage (KBytes) on single queue: (Current/Total)                   </span><br><span class="line">*: Dynamic threshold                                                            </span><br><span class="line">------------------------------------------------------------                    </span><br><span class="line">Interface       Queue   Type        Guaranteed        Shared                    </span><br><span class="line"></span><br><span class="line">------------------------------------------------------------                    </span><br><span class="line">100GE1/0/1          0   Lossy              0/1          0/5*                    </span><br><span class="line">                    1   Lossy              0/1          0/5*                    </span><br><span class="line">                    2   Lossy              0/1          0/5*                    </span><br><span class="line">                    3   Lossless           0/1       0/10156                    </span><br><span class="line">                    4   Lossy              0/1          0/5*                    </span><br><span class="line">                    5   Lossy              0/1          0/5*                    </span><br><span class="line">                    6   Lossy              0/1          0/5*                    </span><br><span class="line">                    7   Lossy              0/1          0/5*                    </span><br><span class="line">------------------------------------------------------------                    </span><br><span class="line">Lossless Service Pool (cells):  0/0                                             </span><br><span class="line">Lossy    Service Pool (cells):  0/151136                                        </span><br><span class="line">------------------------------------------------------------  </span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/f62c2008.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/f62c2008.html" class="post-title-link" itemprop="url">reading nccl</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-03 20:05:15" itemprop="dateCreated datePublished" datetime="2023-05-03T20:05:15Z">2023-05-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-06-11 15:16:35" itemprop="dateModified" datetime="2023-06-11T15:16:35Z">2023-06-11</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>56k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>51 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>以如下 nccl 版本为例分析</p>
<ul>
<li>pytorch/pytorch:1.13.1-cuda11.6-cudnn8-runtime</li>
<li>pytorch 1.13, cuda 11.6.2, nccl 2.14.3</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;import torch;print(torch.cuda.nccl.version())&quot;</span></span><br></pre></td></tr></table></figure>

<h1 id="rdma-和网络相关知识"><a href="#rdma-和网络相关知识" class="headerlink" title="rdma 和网络相关知识"></a>rdma 和网络相关知识</h1><ol>
<li><a target="_blank" rel="noopener" href="https://www.doc.ic.ac.uk/~jgiceva/teaching/ssc18-rdma.pdf">https://www.doc.ic.ac.uk/~jgiceva/teaching/ssc18-rdma.pdf</a>, rdma tutorial</li>
<li><a target="_blank" rel="noopener" href="https://www.openfabrics.org/images/eventpresos/workshops2013/IBUG/2013_UserDay_Thur_1400_Bob-Russell-programming-concepts.pdf">https://www.openfabrics.org/images/eventpresos/workshops2013/IBUG/2013_UserDay_Thur_1400_Bob-Russell-programming-concepts.pdf</a>, ofa rdma program, 非常好, 五星推荐</li>
<li><a target="_blank" rel="noopener" href="https://blog.zhaw.ch/icclab/infiniband-an-introduction-simple-ib-verbs-program-with-rdma-write/">https://blog.zhaw.ch/icclab/infiniband-an-introduction-simple-ib-verbs-program-with-rdma-write/</a>, 非常好</li>
<li><a target="_blank" rel="noopener" href="https://insujang.github.io/2020-02-09/introduction-to-programming-infiniband/">https://insujang.github.io/2020-02-09/introduction-to-programming-infiniband/</a>, qp 状态转换流程</li>
<li><a target="_blank" rel="noopener" href="https://www.rdmamojo.com/2012/05/05/qp-state-machine/">https://www.rdmamojo.com/2012/05/05/qp-state-machine/</a>, qp 状态详述</li>
<li><a target="_blank" rel="noopener" href="https://arthurchiao.art/blog/linux-net-stack-implementation-rx-zh">https://arthurchiao.art/blog/linux-net-stack-implementation-rx-zh</a>, linux rx 原理及内核实现</li>
<li><a target="_blank" rel="noopener" href="https://support.huawei.com/enterprise/zh/doc/EDOC1100197616/3dfff4ec">https://support.huawei.com/enterprise/zh/doc/EDOC1100197616/3dfff4ec</a>, HPC 集群 mlnx 网卡巡检</li>
<li><a target="_blank" rel="noopener" href="https://support.huawei.com/enterprise/zh/doc/EDOC1100197616/37b637af">https://support.huawei.com/enterprise/zh/doc/EDOC1100197616/37b637af</a>, HPC 集群交换机 roce 流量信息巡检</li>
</ol>
<p>缩写解释</p>
<ul>
<li>CA: channel adapter, 即 rdma (infiniband) 网卡; HCA, host channel adapter</li>
<li>RoCE: rdma over Converged Ethernet; rdma 的一种高性价比实现 (对于云厂商来说, 一般而言只要替换支持 RoCE 的网卡即可, 传输/交换网络设备不需要更换, 即可支持业务层 rdma)</li>
<li>mlnx ofed: ib 驱动</li>
<li>rdma: remote direct memory access, 远程直接访问内存</li>
<li>rdma program<ul>
<li>qp: queue pair, 包括 send queue, recv queue; Rtr, ready to receive; Rts, ready to send; qp 状态机; qp 可以理解为 rdma 中的 client</li>
<li>cq: completion queue, 用于获取 send/recv 结果</li>
<li>mr: memory region, rdma 可操作的 memory region; rkey, 用于远程访问 mr 的 key; lkey, 用于本地读取 mr 的 key</li>
<li>pd: protect domain, 用于关联 mr</li>
<li>wr: work request</li>
</ul>
</li>
</ul>
<h1 id="nccl-net"><a href="#nccl-net" class="headerlink" title="nccl net"></a>nccl net</h1><p>net.h, ncclNet 里边相当于网络接口定义, 例如定义了 ncclNetIsend 等接口</p>
<p>而这些接口的具体又会有 netSocketIsend 与 netIBIsend 的实现，在如下两个对象中</p>
<ul>
<li>ncclNetSocket</li>
<li>ncclNetIb</li>
</ul>
<h2 id="net-整体流程概述"><a href="#net-整体流程概述" class="headerlink" title="net 整体流程概述"></a>net 整体流程概述</h2><p><strong>socket server</strong></p>
<ol>
<li>listen</li>
</ol>
<p><strong>send</strong></p>
<ol>
<li>connect</li>
<li>send check</li>
<li>send</li>
<li>test</li>
</ol>
<p><strong>recv</strong></p>
<ol>
<li>accept</li>
<li>recv check</li>
<li>recv</li>
<li>test</li>
</ol>
<h2 id="nccl-net-ib"><a href="#nccl-net-ib" class="headerlink" title="nccl net ib"></a>nccl net ib</h2><blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/Mellanox/nv_peer_memory">https://github.com/Mellanox/nv_peer_memory</a><br><a target="_blank" rel="noopener" href="https://download.nvidia.com/XFree86/Linux-x86_64/470.42.01/README/nvidia-peermem.html">https://download.nvidia.com/XFree86/Linux-x86_64/470.42.01/README/nvidia-peermem.html</a>, <em>This module, originally maintained by Mellanox on GitHub, is now included with the NVIDIA Linux GPU driver</em></p>
</blockquote>
<ol>
<li>net ib 相比与 net socket 的优势在于 net ib 通过 ibverbs api, 实现了 rdma (当然前提是主机上有能支持 rdma 的网卡); rdma 通过网卡直接读写远端的内存 (HOST MEM); 也就是达到了所谓的 OS bypass/CPU offload 效果, 能极大的提升通过网络传输数据的效率</li>
<li>如果安装了 <code>nv_peer_mem</code> mod, net ib 可以通过网卡直接读写远端的 GPU MEM (DEV MEM); 另外高版本 (例如 470) 的 gpu driver 自带了 <code>nvidia-peermem</code> mod, 可以替代 <code>nv_peer_mem</code> 提供 GPU Direct RDMA 功能</li>
</ol>
<h3 id="net-ib-整体流程概述"><a href="#net-ib-整体流程概述" class="headerlink" title="net ib 整体流程概述"></a>net ib 整体流程概述</h3><ul>
<li>ib connect, send check / ib accept, recv check</li>
</ul>
<p>在这个阶段, 主要是发送方与接收方通过 socket 完成 rdma 通信初始化工作, 具体如 qp 初始化</p>
<p><img src="/images/nccl-ib-connect-accept.drawio.svg" alt="ib connect/ib accept"></p>
<ul>
<li>recv/send</li>
</ul>
<p>在这个阶段, 主要是接收方将待接收数据的 mem addr 通过 fifo 数据结构 rdma 写入到发送方; 随后发送方根据 fifo 数据结构, 将数据 rdma 写入到接收方指示的 mem addr</p>
<p><img src="/images/nccl-ib-send-recv.drawio.svg" alt="ib recv/ib send"></p>
<p><strong>socket server</strong></p>
<ol>
<li>listen: 监听 bootstrap 网卡端口, 启动 socket server</li>
</ol>
<p><strong>send</strong></p>
<ol>
<li>connect: 创建 pd/cq (comm-&gt;verbs), mr (comm-&gt;fifo), qp (comm-&gt;qps); 最终将 qpInfo (包括 fifo addr, fifo rkey, qp 等信息) 通过 socket 发送到 receiver</li>
<li>send check: 通过 socket 接收 receiver 返回的 qpInfo; 使用 receiver qpInfo 完成 sender qp (本端 qp) 的状态转移; 可以理解为建立 sender qp 与 receiver qp 的连接 (Rtr, Rts); 通过 socket 发送 1 (ready) 到 receiver; send comm ready</li>
<li>send: <code>ibv_post_send</code>, 往 qp 的 send queue 发 wr (cp 会通知是否完成); 发送 fifo 中的 <code>ncclIbSendFifo</code> slot; 如果 slot ready, sender 根据 <code>ncclIbSendFifo</code> 中 receiver 写入的 MEM 地址, 直接将待发送的 data 写入到 receiver 指示的 MEM 地址</li>
<li>test: <code>ibv_poll_cq</code>, 从 cq 中获取已完成的 wr, 判断发送请求是否完成</li>
</ol>
<p><strong>recv</strong></p>
<ol>
<li>accept: 接收 sender 的 qpInfo (包括 sender 的 fifo addr, fifo rkey, qp 等信息); 创建 pd/cq (rComm-&gt;verbs), mr (rComm-&gt;remFifo.elems), qp (rComm-&gt;qps); 使用 sender qpInfo 完成 receiver qp (本端 qp) 的状态转移; 最终将 qpInfo (包括 fifo addr, fifo rkey, qp 等信息) 通过 socket 发送到 sender</li>
<li>recv check: 接收 1 (ready); recv comm ready</li>
<li>recv: <code>ibv_post_recv</code> 往 qp 的 recv queue 发 wr (cq 会通知是否完成); <code>ncclIbPostFifo</code>, 将 fifo 信息 (receiver 准备接收数据的 MEM 地址, rkey 等信息) rdma 到 sender fifo</li>
<li>test: <code>ibv_poll_cq</code>, 从 cq 中获取已完成的 wr, 判断接收请求是否完成</li>
</ol>
<h1 id="nccl-recv-流程说明"><a href="#nccl-recv-流程说明" class="headerlink" title="nccl recv 流程说明"></a>nccl recv 流程说明</h1><p>交由 rdma 操作的 MEM 需要先 reg 为 memory region (mr), reg 动作在 <code>recvProxyConnect</code> 方法中执行</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclNetRegMr</span>(comm, resources-&gt;netRecvComm, resources-&gt;buffers[p], resources-&gt;buffSizes[p], <span class="built_in">NCCL_NET_MAP_DEV_MEM</span>(map, buffs[p]) ? NCCL_PTR_CUDA : NCCL_PTR_HOST, &amp;resources-&gt;mhandles[p]));</span><br></pre></td></tr></table></figure>

<p>随后执行 <code>recvProxyProgress</code> 方法, 涉及到网络通信的, 最终通过 <code>ncclNetIrecv</code> 方法执行接收数据的实现; <code>ncclNetIrecv</code> 在 net ib 中的实现为 <code>ncclIbIrecv</code></p>
<h1 id="nccl-流程说明"><a href="#nccl-流程说明" class="headerlink" title="nccl 流程说明"></a>nccl 流程说明</h1><p>nccl 完整通信实现看下来的机制大致是</p>
<ol>
<li>nccl group 启动</li>
<li>nccl proxy service 启动</li>
<li>通信算子 entry 加入 ncclTask 队列</li>
<li>group 提交通信算子 entry 到 proxy</li>
<li>proxy 使用通信算子对应的具体实现来完成参数传递</li>
</ol>
<p>c++ 代码较为难读 … 先大致理解如上</p>
<h1 id="nccl-ib-相关环境变量说明"><a href="#nccl-ib-相关环境变量说明" class="headerlink" title="nccl ib 相关环境变量说明"></a>nccl ib 相关环境变量说明</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/deeplearning/nccl/archives/nccl_2143/user-guide/docs/env.html">https://docs.nvidia.com/deeplearning/nccl/archives/nccl_2143/user-guide/docs/env.html</a><br><a target="_blank" rel="noopener" href="https://www.rdmamojo.com/2013/01/12/ibv_modify_qp/">https://www.rdmamojo.com/2013/01/12/ibv_modify_qp/</a></p>
</blockquote>
<p>RoCE</p>
<ol>
<li><strong>NCCL_SOCKET_IFNAME</strong>: 指定 ib bootstrap 网卡 (socket)</li>
<li><strong>NCCL_IB_HCA</strong>: 指定 ib 网卡</li>
<li><strong>NCCL_IB_RETRY_CNT</strong>: qp.retry_cnt, A 3 bits value of the total number of times that the QP will try to resend the packets before reporting an error because the remote side doesn’t answer in the primary path</li>
<li><strong>NCCL_IB_TIMEOUT</strong>: qp.timeout, The minimum timeout that a QP waits for ACK/NACK from remote QP before retransmitting the packet.</li>
<li><strong>NCCL_IB_TC</strong>: qp.ah_attr.grh.traffic_class, traffic_class, Using this value, the originator of the packets specifies the required delivery priority for handling them by the routers</li>
<li><strong>NCCL_IB_GID_INDEX</strong>: qp.ah_attr.grh.sgid_index, An index in the port’s GID table that will be used to identify the originator of the packet</li>
</ol>
<h1 id="net-ib-cc-代码注释"><a href="#net-ib-cc-代码注释" class="headerlink" title="net_ib.cc 代码注释"></a>net_ib.cc 代码注释</h1><p>net_ib.cc 代码注释, 尽量理解, 难免有误, 持续学习</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/nccl/blob/v2.14.3-1/src/transport/net_ib.cc">https://github.com/NVIDIA/nccl/blob/v2.14.3-1/src/transport/net_ib.cc</a></p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br><span class="line">656</span><br><span class="line">657</span><br><span class="line">658</span><br><span class="line">659</span><br><span class="line">660</span><br><span class="line">661</span><br><span class="line">662</span><br><span class="line">663</span><br><span class="line">664</span><br><span class="line">665</span><br><span class="line">666</span><br><span class="line">667</span><br><span class="line">668</span><br><span class="line">669</span><br><span class="line">670</span><br><span class="line">671</span><br><span class="line">672</span><br><span class="line">673</span><br><span class="line">674</span><br><span class="line">675</span><br><span class="line">676</span><br><span class="line">677</span><br><span class="line">678</span><br><span class="line">679</span><br><span class="line">680</span><br><span class="line">681</span><br><span class="line">682</span><br><span class="line">683</span><br><span class="line">684</span><br><span class="line">685</span><br><span class="line">686</span><br><span class="line">687</span><br><span class="line">688</span><br><span class="line">689</span><br><span class="line">690</span><br><span class="line">691</span><br><span class="line">692</span><br><span class="line">693</span><br><span class="line">694</span><br><span class="line">695</span><br><span class="line">696</span><br><span class="line">697</span><br><span class="line">698</span><br><span class="line">699</span><br><span class="line">700</span><br><span class="line">701</span><br><span class="line">702</span><br><span class="line">703</span><br><span class="line">704</span><br><span class="line">705</span><br><span class="line">706</span><br><span class="line">707</span><br><span class="line">708</span><br><span class="line">709</span><br><span class="line">710</span><br><span class="line">711</span><br><span class="line">712</span><br><span class="line">713</span><br><span class="line">714</span><br><span class="line">715</span><br><span class="line">716</span><br><span class="line">717</span><br><span class="line">718</span><br><span class="line">719</span><br><span class="line">720</span><br><span class="line">721</span><br><span class="line">722</span><br><span class="line">723</span><br><span class="line">724</span><br><span class="line">725</span><br><span class="line">726</span><br><span class="line">727</span><br><span class="line">728</span><br><span class="line">729</span><br><span class="line">730</span><br><span class="line">731</span><br><span class="line">732</span><br><span class="line">733</span><br><span class="line">734</span><br><span class="line">735</span><br><span class="line">736</span><br><span class="line">737</span><br><span class="line">738</span><br><span class="line">739</span><br><span class="line">740</span><br><span class="line">741</span><br><span class="line">742</span><br><span class="line">743</span><br><span class="line">744</span><br><span class="line">745</span><br><span class="line">746</span><br><span class="line">747</span><br><span class="line">748</span><br><span class="line">749</span><br><span class="line">750</span><br><span class="line">751</span><br><span class="line">752</span><br><span class="line">753</span><br><span class="line">754</span><br><span class="line">755</span><br><span class="line">756</span><br><span class="line">757</span><br><span class="line">758</span><br><span class="line">759</span><br><span class="line">760</span><br><span class="line">761</span><br><span class="line">762</span><br><span class="line">763</span><br><span class="line">764</span><br><span class="line">765</span><br><span class="line">766</span><br><span class="line">767</span><br><span class="line">768</span><br><span class="line">769</span><br><span class="line">770</span><br><span class="line">771</span><br><span class="line">772</span><br><span class="line">773</span><br><span class="line">774</span><br><span class="line">775</span><br><span class="line">776</span><br><span class="line">777</span><br><span class="line">778</span><br><span class="line">779</span><br><span class="line">780</span><br><span class="line">781</span><br><span class="line">782</span><br><span class="line">783</span><br><span class="line">784</span><br><span class="line">785</span><br><span class="line">786</span><br><span class="line">787</span><br><span class="line">788</span><br><span class="line">789</span><br><span class="line">790</span><br><span class="line">791</span><br><span class="line">792</span><br><span class="line">793</span><br><span class="line">794</span><br><span class="line">795</span><br><span class="line">796</span><br><span class="line">797</span><br><span class="line">798</span><br><span class="line">799</span><br><span class="line">800</span><br><span class="line">801</span><br><span class="line">802</span><br><span class="line">803</span><br><span class="line">804</span><br><span class="line">805</span><br><span class="line">806</span><br><span class="line">807</span><br><span class="line">808</span><br><span class="line">809</span><br><span class="line">810</span><br><span class="line">811</span><br><span class="line">812</span><br><span class="line">813</span><br><span class="line">814</span><br><span class="line">815</span><br><span class="line">816</span><br><span class="line">817</span><br><span class="line">818</span><br><span class="line">819</span><br><span class="line">820</span><br><span class="line">821</span><br><span class="line">822</span><br><span class="line">823</span><br><span class="line">824</span><br><span class="line">825</span><br><span class="line">826</span><br><span class="line">827</span><br><span class="line">828</span><br><span class="line">829</span><br><span class="line">830</span><br><span class="line">831</span><br><span class="line">832</span><br><span class="line">833</span><br><span class="line">834</span><br><span class="line">835</span><br><span class="line">836</span><br><span class="line">837</span><br><span class="line">838</span><br><span class="line">839</span><br><span class="line">840</span><br><span class="line">841</span><br><span class="line">842</span><br><span class="line">843</span><br><span class="line">844</span><br><span class="line">845</span><br><span class="line">846</span><br><span class="line">847</span><br><span class="line">848</span><br><span class="line">849</span><br><span class="line">850</span><br><span class="line">851</span><br><span class="line">852</span><br><span class="line">853</span><br><span class="line">854</span><br><span class="line">855</span><br><span class="line">856</span><br><span class="line">857</span><br><span class="line">858</span><br><span class="line">859</span><br><span class="line">860</span><br><span class="line">861</span><br><span class="line">862</span><br><span class="line">863</span><br><span class="line">864</span><br><span class="line">865</span><br><span class="line">866</span><br><span class="line">867</span><br><span class="line">868</span><br><span class="line">869</span><br><span class="line">870</span><br><span class="line">871</span><br><span class="line">872</span><br><span class="line">873</span><br><span class="line">874</span><br><span class="line">875</span><br><span class="line">876</span><br><span class="line">877</span><br><span class="line">878</span><br><span class="line">879</span><br><span class="line">880</span><br><span class="line">881</span><br><span class="line">882</span><br><span class="line">883</span><br><span class="line">884</span><br><span class="line">885</span><br><span class="line">886</span><br><span class="line">887</span><br><span class="line">888</span><br><span class="line">889</span><br><span class="line">890</span><br><span class="line">891</span><br><span class="line">892</span><br><span class="line">893</span><br><span class="line">894</span><br><span class="line">895</span><br><span class="line">896</span><br><span class="line">897</span><br><span class="line">898</span><br><span class="line">899</span><br><span class="line">900</span><br><span class="line">901</span><br><span class="line">902</span><br><span class="line">903</span><br><span class="line">904</span><br><span class="line">905</span><br><span class="line">906</span><br><span class="line">907</span><br><span class="line">908</span><br><span class="line">909</span><br><span class="line">910</span><br><span class="line">911</span><br><span class="line">912</span><br><span class="line">913</span><br><span class="line">914</span><br><span class="line">915</span><br><span class="line">916</span><br><span class="line">917</span><br><span class="line">918</span><br><span class="line">919</span><br><span class="line">920</span><br><span class="line">921</span><br><span class="line">922</span><br><span class="line">923</span><br><span class="line">924</span><br><span class="line">925</span><br><span class="line">926</span><br><span class="line">927</span><br><span class="line">928</span><br><span class="line">929</span><br><span class="line">930</span><br><span class="line">931</span><br><span class="line">932</span><br><span class="line">933</span><br><span class="line">934</span><br><span class="line">935</span><br><span class="line">936</span><br><span class="line">937</span><br><span class="line">938</span><br><span class="line">939</span><br><span class="line">940</span><br><span class="line">941</span><br><span class="line">942</span><br><span class="line">943</span><br><span class="line">944</span><br><span class="line">945</span><br><span class="line">946</span><br><span class="line">947</span><br><span class="line">948</span><br><span class="line">949</span><br><span class="line">950</span><br><span class="line">951</span><br><span class="line">952</span><br><span class="line">953</span><br><span class="line">954</span><br><span class="line">955</span><br><span class="line">956</span><br><span class="line">957</span><br><span class="line">958</span><br><span class="line">959</span><br><span class="line">960</span><br><span class="line">961</span><br><span class="line">962</span><br><span class="line">963</span><br><span class="line">964</span><br><span class="line">965</span><br><span class="line">966</span><br><span class="line">967</span><br><span class="line">968</span><br><span class="line">969</span><br><span class="line">970</span><br><span class="line">971</span><br><span class="line">972</span><br><span class="line">973</span><br><span class="line">974</span><br><span class="line">975</span><br><span class="line">976</span><br><span class="line">977</span><br><span class="line">978</span><br><span class="line">979</span><br><span class="line">980</span><br><span class="line">981</span><br><span class="line">982</span><br><span class="line">983</span><br><span class="line">984</span><br><span class="line">985</span><br><span class="line">986</span><br><span class="line">987</span><br><span class="line">988</span><br><span class="line">989</span><br><span class="line">990</span><br><span class="line">991</span><br><span class="line">992</span><br><span class="line">993</span><br><span class="line">994</span><br><span class="line">995</span><br><span class="line">996</span><br><span class="line">997</span><br><span class="line">998</span><br><span class="line">999</span><br><span class="line">1000</span><br><span class="line">1001</span><br><span class="line">1002</span><br><span class="line">1003</span><br><span class="line">1004</span><br><span class="line">1005</span><br><span class="line">1006</span><br><span class="line">1007</span><br><span class="line">1008</span><br><span class="line">1009</span><br><span class="line">1010</span><br><span class="line">1011</span><br><span class="line">1012</span><br><span class="line">1013</span><br><span class="line">1014</span><br><span class="line">1015</span><br><span class="line">1016</span><br><span class="line">1017</span><br><span class="line">1018</span><br><span class="line">1019</span><br><span class="line">1020</span><br><span class="line">1021</span><br><span class="line">1022</span><br><span class="line">1023</span><br><span class="line">1024</span><br><span class="line">1025</span><br><span class="line">1026</span><br><span class="line">1027</span><br><span class="line">1028</span><br><span class="line">1029</span><br><span class="line">1030</span><br><span class="line">1031</span><br><span class="line">1032</span><br><span class="line">1033</span><br><span class="line">1034</span><br><span class="line">1035</span><br><span class="line">1036</span><br><span class="line">1037</span><br><span class="line">1038</span><br><span class="line">1039</span><br><span class="line">1040</span><br><span class="line">1041</span><br><span class="line">1042</span><br><span class="line">1043</span><br><span class="line">1044</span><br><span class="line">1045</span><br><span class="line">1046</span><br><span class="line">1047</span><br><span class="line">1048</span><br><span class="line">1049</span><br><span class="line">1050</span><br><span class="line">1051</span><br><span class="line">1052</span><br><span class="line">1053</span><br><span class="line">1054</span><br><span class="line">1055</span><br><span class="line">1056</span><br><span class="line">1057</span><br><span class="line">1058</span><br><span class="line">1059</span><br><span class="line">1060</span><br><span class="line">1061</span><br><span class="line">1062</span><br><span class="line">1063</span><br><span class="line">1064</span><br><span class="line">1065</span><br><span class="line">1066</span><br><span class="line">1067</span><br><span class="line">1068</span><br><span class="line">1069</span><br><span class="line">1070</span><br><span class="line">1071</span><br><span class="line">1072</span><br><span class="line">1073</span><br><span class="line">1074</span><br><span class="line">1075</span><br><span class="line">1076</span><br><span class="line">1077</span><br><span class="line">1078</span><br><span class="line">1079</span><br><span class="line">1080</span><br><span class="line">1081</span><br><span class="line">1082</span><br><span class="line">1083</span><br><span class="line">1084</span><br><span class="line">1085</span><br><span class="line">1086</span><br><span class="line">1087</span><br><span class="line">1088</span><br><span class="line">1089</span><br><span class="line">1090</span><br><span class="line">1091</span><br><span class="line">1092</span><br><span class="line">1093</span><br><span class="line">1094</span><br><span class="line">1095</span><br><span class="line">1096</span><br><span class="line">1097</span><br><span class="line">1098</span><br><span class="line">1099</span><br><span class="line">1100</span><br><span class="line">1101</span><br><span class="line">1102</span><br><span class="line">1103</span><br><span class="line">1104</span><br><span class="line">1105</span><br><span class="line">1106</span><br><span class="line">1107</span><br><span class="line">1108</span><br><span class="line">1109</span><br><span class="line">1110</span><br><span class="line">1111</span><br><span class="line">1112</span><br><span class="line">1113</span><br><span class="line">1114</span><br><span class="line">1115</span><br><span class="line">1116</span><br><span class="line">1117</span><br><span class="line">1118</span><br><span class="line">1119</span><br><span class="line">1120</span><br><span class="line">1121</span><br><span class="line">1122</span><br><span class="line">1123</span><br><span class="line">1124</span><br><span class="line">1125</span><br><span class="line">1126</span><br><span class="line">1127</span><br><span class="line">1128</span><br><span class="line">1129</span><br><span class="line">1130</span><br><span class="line">1131</span><br><span class="line">1132</span><br><span class="line">1133</span><br><span class="line">1134</span><br><span class="line">1135</span><br><span class="line">1136</span><br><span class="line">1137</span><br><span class="line">1138</span><br><span class="line">1139</span><br><span class="line">1140</span><br><span class="line">1141</span><br><span class="line">1142</span><br><span class="line">1143</span><br><span class="line">1144</span><br><span class="line">1145</span><br><span class="line">1146</span><br><span class="line">1147</span><br><span class="line">1148</span><br><span class="line">1149</span><br><span class="line">1150</span><br><span class="line">1151</span><br><span class="line">1152</span><br><span class="line">1153</span><br><span class="line">1154</span><br><span class="line">1155</span><br><span class="line">1156</span><br><span class="line">1157</span><br><span class="line">1158</span><br><span class="line">1159</span><br><span class="line">1160</span><br><span class="line">1161</span><br><span class="line">1162</span><br><span class="line">1163</span><br><span class="line">1164</span><br><span class="line">1165</span><br><span class="line">1166</span><br><span class="line">1167</span><br><span class="line">1168</span><br><span class="line">1169</span><br><span class="line">1170</span><br><span class="line">1171</span><br><span class="line">1172</span><br><span class="line">1173</span><br><span class="line">1174</span><br><span class="line">1175</span><br><span class="line">1176</span><br><span class="line">1177</span><br><span class="line">1178</span><br><span class="line">1179</span><br><span class="line">1180</span><br><span class="line">1181</span><br><span class="line">1182</span><br><span class="line">1183</span><br><span class="line">1184</span><br><span class="line">1185</span><br><span class="line">1186</span><br><span class="line">1187</span><br><span class="line">1188</span><br><span class="line">1189</span><br><span class="line">1190</span><br><span class="line">1191</span><br><span class="line">1192</span><br><span class="line">1193</span><br><span class="line">1194</span><br><span class="line">1195</span><br><span class="line">1196</span><br><span class="line">1197</span><br><span class="line">1198</span><br><span class="line">1199</span><br><span class="line">1200</span><br><span class="line">1201</span><br><span class="line">1202</span><br><span class="line">1203</span><br><span class="line">1204</span><br><span class="line">1205</span><br><span class="line">1206</span><br><span class="line">1207</span><br><span class="line">1208</span><br><span class="line">1209</span><br><span class="line">1210</span><br><span class="line">1211</span><br><span class="line">1212</span><br><span class="line">1213</span><br><span class="line">1214</span><br><span class="line">1215</span><br><span class="line">1216</span><br><span class="line">1217</span><br><span class="line">1218</span><br><span class="line">1219</span><br><span class="line">1220</span><br><span class="line">1221</span><br><span class="line">1222</span><br><span class="line">1223</span><br><span class="line">1224</span><br><span class="line">1225</span><br><span class="line">1226</span><br><span class="line">1227</span><br><span class="line">1228</span><br><span class="line">1229</span><br><span class="line">1230</span><br><span class="line">1231</span><br><span class="line">1232</span><br><span class="line">1233</span><br><span class="line">1234</span><br><span class="line">1235</span><br><span class="line">1236</span><br><span class="line">1237</span><br><span class="line">1238</span><br><span class="line">1239</span><br><span class="line">1240</span><br><span class="line">1241</span><br><span class="line">1242</span><br><span class="line">1243</span><br><span class="line">1244</span><br><span class="line">1245</span><br><span class="line">1246</span><br><span class="line">1247</span><br><span class="line">1248</span><br><span class="line">1249</span><br><span class="line">1250</span><br><span class="line">1251</span><br><span class="line">1252</span><br><span class="line">1253</span><br><span class="line">1254</span><br><span class="line">1255</span><br><span class="line">1256</span><br><span class="line">1257</span><br><span class="line">1258</span><br><span class="line">1259</span><br><span class="line">1260</span><br><span class="line">1261</span><br><span class="line">1262</span><br><span class="line">1263</span><br><span class="line">1264</span><br><span class="line">1265</span><br><span class="line">1266</span><br><span class="line">1267</span><br><span class="line">1268</span><br><span class="line">1269</span><br><span class="line">1270</span><br><span class="line">1271</span><br><span class="line">1272</span><br><span class="line">1273</span><br><span class="line">1274</span><br><span class="line">1275</span><br><span class="line">1276</span><br><span class="line">1277</span><br><span class="line">1278</span><br><span class="line">1279</span><br><span class="line">1280</span><br><span class="line">1281</span><br><span class="line">1282</span><br><span class="line">1283</span><br><span class="line">1284</span><br><span class="line">1285</span><br><span class="line">1286</span><br><span class="line">1287</span><br><span class="line">1288</span><br><span class="line">1289</span><br><span class="line">1290</span><br><span class="line">1291</span><br><span class="line">1292</span><br><span class="line">1293</span><br><span class="line">1294</span><br><span class="line">1295</span><br><span class="line">1296</span><br><span class="line">1297</span><br><span class="line">1298</span><br><span class="line">1299</span><br><span class="line">1300</span><br><span class="line">1301</span><br><span class="line">1302</span><br><span class="line">1303</span><br><span class="line">1304</span><br><span class="line">1305</span><br><span class="line">1306</span><br><span class="line">1307</span><br><span class="line">1308</span><br><span class="line">1309</span><br><span class="line">1310</span><br><span class="line">1311</span><br><span class="line">1312</span><br><span class="line">1313</span><br><span class="line">1314</span><br><span class="line">1315</span><br><span class="line">1316</span><br><span class="line">1317</span><br><span class="line">1318</span><br><span class="line">1319</span><br><span class="line">1320</span><br><span class="line">1321</span><br><span class="line">1322</span><br><span class="line">1323</span><br><span class="line">1324</span><br><span class="line">1325</span><br><span class="line">1326</span><br><span class="line">1327</span><br><span class="line">1328</span><br><span class="line">1329</span><br><span class="line">1330</span><br><span class="line">1331</span><br><span class="line">1332</span><br><span class="line">1333</span><br><span class="line">1334</span><br><span class="line">1335</span><br><span class="line">1336</span><br><span class="line">1337</span><br><span class="line">1338</span><br><span class="line">1339</span><br><span class="line">1340</span><br><span class="line">1341</span><br><span class="line">1342</span><br><span class="line">1343</span><br><span class="line">1344</span><br><span class="line">1345</span><br><span class="line">1346</span><br><span class="line">1347</span><br><span class="line">1348</span><br><span class="line">1349</span><br><span class="line">1350</span><br><span class="line">1351</span><br><span class="line">1352</span><br><span class="line">1353</span><br><span class="line">1354</span><br><span class="line">1355</span><br><span class="line">1356</span><br><span class="line">1357</span><br><span class="line">1358</span><br><span class="line">1359</span><br><span class="line">1360</span><br><span class="line">1361</span><br><span class="line">1362</span><br><span class="line">1363</span><br><span class="line">1364</span><br><span class="line">1365</span><br><span class="line">1366</span><br><span class="line">1367</span><br><span class="line">1368</span><br><span class="line">1369</span><br><span class="line">1370</span><br><span class="line">1371</span><br><span class="line">1372</span><br><span class="line">1373</span><br><span class="line">1374</span><br><span class="line">1375</span><br><span class="line">1376</span><br><span class="line">1377</span><br><span class="line">1378</span><br><span class="line">1379</span><br><span class="line">1380</span><br><span class="line">1381</span><br><span class="line">1382</span><br><span class="line">1383</span><br><span class="line">1384</span><br><span class="line">1385</span><br><span class="line">1386</span><br><span class="line">1387</span><br><span class="line">1388</span><br><span class="line">1389</span><br><span class="line">1390</span><br><span class="line">1391</span><br><span class="line">1392</span><br><span class="line">1393</span><br><span class="line">1394</span><br><span class="line">1395</span><br><span class="line">1396</span><br><span class="line">1397</span><br><span class="line">1398</span><br><span class="line">1399</span><br><span class="line">1400</span><br><span class="line">1401</span><br><span class="line">1402</span><br><span class="line">1403</span><br><span class="line">1404</span><br><span class="line">1405</span><br><span class="line">1406</span><br><span class="line">1407</span><br><span class="line">1408</span><br><span class="line">1409</span><br><span class="line">1410</span><br><span class="line">1411</span><br><span class="line">1412</span><br><span class="line">1413</span><br><span class="line">1414</span><br><span class="line">1415</span><br><span class="line">1416</span><br><span class="line">1417</span><br><span class="line">1418</span><br><span class="line">1419</span><br><span class="line">1420</span><br><span class="line">1421</span><br><span class="line">1422</span><br><span class="line">1423</span><br><span class="line">1424</span><br><span class="line">1425</span><br><span class="line">1426</span><br><span class="line">1427</span><br><span class="line">1428</span><br><span class="line">1429</span><br><span class="line">1430</span><br><span class="line">1431</span><br><span class="line">1432</span><br><span class="line">1433</span><br><span class="line">1434</span><br><span class="line">1435</span><br><span class="line">1436</span><br><span class="line">1437</span><br><span class="line">1438</span><br><span class="line">1439</span><br><span class="line">1440</span><br><span class="line">1441</span><br><span class="line">1442</span><br><span class="line">1443</span><br><span class="line">1444</span><br><span class="line">1445</span><br><span class="line">1446</span><br><span class="line">1447</span><br><span class="line">1448</span><br><span class="line">1449</span><br><span class="line">1450</span><br><span class="line">1451</span><br><span class="line">1452</span><br><span class="line">1453</span><br><span class="line">1454</span><br><span class="line">1455</span><br><span class="line">1456</span><br><span class="line">1457</span><br><span class="line">1458</span><br><span class="line">1459</span><br><span class="line">1460</span><br><span class="line">1461</span><br><span class="line">1462</span><br><span class="line">1463</span><br><span class="line">1464</span><br><span class="line">1465</span><br><span class="line">1466</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*************************************************************************</span></span><br><span class="line"><span class="comment"> * Copyright (c) 2016-2022, NVIDIA CORPORATION. All rights reserved.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * See LICENSE.txt for license information</span></span><br><span class="line"><span class="comment"> ************************************************************************/</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;nccl.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;core.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;socket.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;net.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;graph.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;utils.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;param.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;assert.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> ENABLE_TIMER 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;timer.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;ibvwrap.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAXNAMESIZE 64</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">char</span> ncclIbIfName[MAX_IF_NAME_SIZE+<span class="number">1</span>];</span><br><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">union</span> <span class="title">ncclSocketAddress</span> <span class="title">ncclIbIfAddr</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// rdma (infiniband) 中的 memory region, 即提供给 rdma 网卡直接操作 (读/写) 的 pin memory</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbMr</span> &#123;</span></span><br><span class="line">  <span class="keyword">uintptr_t</span> addr;</span><br><span class="line">  <span class="keyword">int</span> pages;</span><br><span class="line">  <span class="keyword">int</span> refs;</span><br><span class="line">  ibv_mr *mr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ncclIbMrCache</span></span><br><span class="line"><span class="comment">// 维护 ib mr</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbMrCache</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbMr</span> *<span class="title">slots</span>;</span></span><br><span class="line">  <span class="keyword">int</span> capacity, population;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ncclNIbDevs = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ib 设备信息, 聚合数据结构</span></span><br><span class="line"><span class="function">struct <span class="title">alignas</span><span class="params">(<span class="number">64</span>)</span> ncclIbDev </span>&#123;</span><br><span class="line">  <span class="keyword">pthread_mutex_t</span> lock;</span><br><span class="line">  <span class="keyword">int</span> device;</span><br><span class="line">  <span class="keyword">uint64_t</span> guid;</span><br><span class="line">  <span class="keyword">uint8_t</span> port;</span><br><span class="line">  <span class="keyword">uint8_t</span> link;</span><br><span class="line">  <span class="keyword">int</span> speed;</span><br><span class="line">  ibv_context* context;</span><br><span class="line">  <span class="keyword">int</span> pdRefs;</span><br><span class="line">  ibv_pd* pd;</span><br><span class="line">  <span class="keyword">char</span> devName[MAXNAMESIZE];</span><br><span class="line">  <span class="keyword">char</span>* pciPath;</span><br><span class="line">  <span class="keyword">int</span> realPort;</span><br><span class="line">  <span class="keyword">int</span> maxQp;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbMrCache</span> <span class="title">mrCache</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_IB_PORT 15</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userIbDev</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> devName[MAXNAMESIZE];</span><br><span class="line">  <span class="keyword">uint16_t</span> port_en;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_IB_DEVS 16</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbDev</span> <span class="title">ncclIbDevs</span>[<span class="title">MAX_IB_DEVS</span>];</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">userIbDev</span> <span class="title">userIbDevs</span>[<span class="title">MAX_IB_DEVS</span>];</span></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> ncclIbLock = PTHREAD_MUTEX_INITIALIZER;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ncclIbRelaxedOrderingEnabled = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbGidIndex, <span class="string">&quot;IB_GID_INDEX&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbTimeout, <span class="string">&quot;IB_TIMEOUT&quot;</span>, <span class="number">18</span>);</span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbRetryCnt, <span class="string">&quot;IB_RETRY_CNT&quot;</span>, <span class="number">7</span>);</span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbPkey, <span class="string">&quot;IB_PKEY&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbUseInline, <span class="string">&quot;IB_USE_INLINE&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbSl, <span class="string">&quot;IB_SL&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbTc, <span class="string">&quot;IB_TC&quot;</span>, <span class="number">0</span>);</span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbArThreshold, <span class="string">&quot;IB_AR_THRESHOLD&quot;</span>, <span class="number">8192</span>);</span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbPciRelaxedOrdering, <span class="string">&quot;IB_PCI_RELAXED_ORDERING&quot;</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">pthread_t</span> ncclIbAsyncThread;</span><br><span class="line"><span class="comment">// https://www.rdmamojo.com/2012/08/11/ibv_get_async_event/</span></span><br><span class="line"><span class="comment">// 这里常见错误 NET/IB : Got async event : port xxx</span></span><br><span class="line"><span class="comment">// 一般是 rdma 网卡 down</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span>* <span class="title">ncclIbAsyncThreadMain</span><span class="params">(<span class="keyword">void</span>* args)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_context</span>* <span class="title">context</span> =</span> (struct ibv_context*)args;</span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_async_event</span> <span class="title">event</span>;</span></span><br><span class="line">    <span class="keyword">if</span> (ncclSuccess != <span class="built_in">wrap_ibv_get_async_event</span>(context, &amp;event)) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">    <span class="keyword">char</span> *str;</span><br><span class="line">    <span class="keyword">if</span> (ncclSuccess != <span class="built_in">wrap_ibv_event_type_str</span>(&amp;str, event.event_type)) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">    <span class="keyword">if</span> (event.event_type != IBV_EVENT_COMM_EST)</span><br><span class="line">      <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : Got async event : %s&quot;</span>, str);</span><br><span class="line">    <span class="keyword">if</span> (ncclSuccess != <span class="built_in">wrap_ibv_ack_async_event</span>(&amp;event)) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbDisable, <span class="string">&quot;IB_DISABLE&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ncclResult_t <span class="title">ncclIbGetPciPath</span><span class="params">(<span class="keyword">char</span>* devName, <span class="keyword">char</span>** path, <span class="keyword">int</span>* realPort)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">char</span> devicePath[PATH_MAX];</span><br><span class="line">  <span class="built_in">snprintf</span>(devicePath, PATH_MAX, <span class="string">&quot;/sys/class/infiniband/%s/device&quot;</span>, devName);</span><br><span class="line">  <span class="keyword">char</span>* p = <span class="built_in">realpath</span>(devicePath, <span class="literal">NULL</span>);</span><br><span class="line">  <span class="keyword">if</span> (p == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">WARN</span>(<span class="string">&quot;Could not find real path of %s (%s)&quot;</span>, devName, devicePath);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Merge multi-port NICs into the same PCI device</span></span><br><span class="line">    p[<span class="built_in">strlen</span>(p)<span class="number">-1</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    <span class="comment">// Also merge virtual functions (VF) into the same device</span></span><br><span class="line">    p[<span class="built_in">strlen</span>(p)<span class="number">-3</span>] = <span class="string">&#x27;0&#x27;</span>;</span><br><span class="line">    <span class="comment">// And keep the real port aside (the ibv port is always 1 on recent cards)</span></span><br><span class="line">    *realPort = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> d=<span class="number">0</span>; d&lt;ncclNIbDevs; d++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">strcmp</span>(p, ncclIbDevs[d].pciPath) == <span class="number">0</span>) (*realPort)++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  *path = p;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ibvWidths[] = &#123; <span class="number">1</span>, <span class="number">4</span>, <span class="number">8</span>, <span class="number">12</span>, <span class="number">2</span> &#125;;</span><br><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> ibvSpeeds[] = &#123; <span class="number">2500</span>, <span class="number">5000</span>, <span class="number">10000</span>, <span class="number">10000</span>, <span class="number">14000</span>, <span class="number">25000</span>, <span class="number">50000</span> &#125;;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">firstBitSet</span><span class="params">(<span class="keyword">int</span> val, <span class="keyword">int</span> max)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (i&lt;max &amp;&amp; ((val &amp; (<span class="number">1</span>&lt;&lt;i)) == <span class="number">0</span>)) i++;</span><br><span class="line">  <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ncclIbWidth</span><span class="params">(<span class="keyword">int</span> width)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ibvWidths[<span class="built_in">firstBitSet</span>(width, <span class="built_in"><span class="keyword">sizeof</span></span>(ibvWidths)/<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>)<span class="number">-1</span>)];</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ncclIbSpeed</span><span class="params">(<span class="keyword">int</span> speed)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ibvSpeeds[<span class="built_in">firstBitSet</span>(speed, <span class="built_in"><span class="keyword">sizeof</span></span>(ibvSpeeds)/<span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>)<span class="number">-1</span>)];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Determine whether RELAXED_ORDERING is enabled and possible</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">ncclIbRelaxedOrderingCapable</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> roMode = <span class="built_in">ncclParamIbPciRelaxedOrdering</span>();</span><br><span class="line">  ncclResult_t r = ncclInternalError;</span><br><span class="line">  <span class="keyword">if</span> (roMode == <span class="number">1</span> || roMode == <span class="number">2</span>) &#123;</span><br><span class="line">    <span class="comment">// Query IBVERBS_1.8 API - needed for IBV_ACCESS_RELAXED_ORDERING support</span></span><br><span class="line">    r = <span class="built_in">wrap_ibv_reg_mr_iova2</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> r == ncclInternalError ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbInit</span><span class="params">(ncclDebugLogger_t logFunction)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ncclParamIbDisable</span>()) <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> shownIbHcaEnv = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span>(<span class="built_in">wrap_ibv_symbols</span>() != ncclSuccess) &#123; <span class="keyword">return</span> ncclInternalError; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (ncclNIbDevs == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="built_in">pthread_mutex_lock</span>(&amp;ncclIbLock);</span><br><span class="line">    <span class="built_in">wrap_ibv_fork_init</span>();</span><br><span class="line">    <span class="keyword">if</span> (ncclNIbDevs == <span class="number">-1</span>) &#123;</span><br><span class="line">      ncclNIbDevs = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">ncclFindInterfaces</span>(ncclIbIfName, &amp;ncclIbIfAddr, MAX_IF_NAME_SIZE, <span class="number">1</span>) != <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : No IP interface found.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Detect IB cards</span></span><br><span class="line">      <span class="keyword">int</span> nIbDevs;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">ibv_device</span>** <span class="title">devices</span>;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// Check if user defined which IB device:port to use</span></span><br><span class="line">      <span class="keyword">char</span>* userIbEnv = <span class="built_in">getenv</span>(<span class="string">&quot;NCCL_IB_HCA&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (userIbEnv != <span class="literal">NULL</span> &amp;&amp; shownIbHcaEnv++ == <span class="number">0</span>) <span class="built_in">INFO</span>(NCCL_NET|NCCL_ENV, <span class="string">&quot;NCCL_IB_HCA set to %s&quot;</span>, userIbEnv);</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">netIf</span> <span class="title">userIfs</span>[<span class="title">MAX_IB_DEVS</span>];</span></span><br><span class="line">      <span class="keyword">bool</span> searchNot = userIbEnv &amp;&amp; userIbEnv[<span class="number">0</span>] == <span class="string">&#x27;^&#x27;</span>;</span><br><span class="line">      <span class="keyword">if</span> (searchNot) userIbEnv++;</span><br><span class="line">      <span class="keyword">bool</span> searchExact = userIbEnv &amp;&amp; userIbEnv[<span class="number">0</span>] == <span class="string">&#x27;=&#x27;</span>;</span><br><span class="line">      <span class="keyword">if</span> (searchExact) userIbEnv++;</span><br><span class="line">      <span class="keyword">int</span> nUserIfs = <span class="built_in">parseStringList</span>(userIbEnv, userIfs, MAX_IB_DEVS);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (ncclSuccess != <span class="built_in">wrap_ibv_get_device_list</span>(&amp;devices, &amp;nIbDevs)) <span class="keyword">return</span> ncclInternalError;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> d=<span class="number">0</span>; d&lt;nIbDevs &amp;&amp; ncclNIbDevs&lt;MAX_IB_DEVS; d++) &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ibv_context</span> * <span class="title">context</span>;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打开 ib 设备</span></span><br><span class="line">        <span class="keyword">if</span> (ncclSuccess != <span class="built_in">wrap_ibv_open_device</span>(&amp;context, devices[d]) || context == <span class="literal">NULL</span>) &#123;</span><br><span class="line">          <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : Unable to open device %s&quot;</span>, devices[d]-&gt;name);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> nPorts = <span class="number">0</span>;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">ibv_device_attr</span> <span class="title">devAttr</span>;</span></span><br><span class="line">        <span class="built_in">memset</span>(&amp;devAttr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(devAttr));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 查询 ib 设备详情</span></span><br><span class="line">        <span class="keyword">if</span> (ncclSuccess != <span class="built_in">wrap_ibv_query_device</span>(context, &amp;devAttr)) &#123;</span><br><span class="line">          <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : Unable to query device %s&quot;</span>, devices[d]-&gt;name);</span><br><span class="line">          <span class="keyword">if</span> (ncclSuccess != <span class="built_in">wrap_ibv_close_device</span>(context)) &#123; <span class="keyword">return</span> ncclInternalError; &#125;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取 ib 设备 port 详情</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> port = <span class="number">1</span>; port &lt;= devAttr.phys_port_cnt; port++) &#123;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span> <span class="title">ibv_port_attr</span> <span class="title">portAttr</span>;</span></span><br><span class="line">          <span class="keyword">if</span> (ncclSuccess != <span class="built_in">wrap_ibv_query_port</span>(context, port, &amp;portAttr)) &#123;</span><br><span class="line">            <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : Unable to query port %d&quot;</span>, port);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (portAttr.state != IBV_PORT_ACTIVE) <span class="keyword">continue</span>; <span class="comment">// port 不是 active 的时候会被忽略</span></span><br><span class="line">          <span class="keyword">if</span> (portAttr.link_layer != IBV_LINK_LAYER_INFINIBAND</span><br><span class="line">              &amp;&amp; portAttr.link_layer != IBV_LINK_LAYER_ETHERNET) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// check against user specified HCAs/ports</span></span><br><span class="line">          <span class="keyword">if</span> (! (<span class="built_in">matchIfList</span>(devices[d]-&gt;name, port, userIfs, nUserIfs, searchExact) ^ searchNot)) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// NET/IB: [0] mlx5_2:0/RoCE</span></span><br><span class="line">          <span class="built_in">TRACE</span>(NCCL_INIT|NCCL_NET,<span class="string">&quot;NET/IB: [%d] %s:%d/%s &quot;</span>, d, devices[d]-&gt;name, port,</span><br><span class="line">              portAttr.link_layer == IBV_LINK_LAYER_INFINIBAND ? <span class="string">&quot;IB&quot;</span> : <span class="string">&quot;RoCE&quot;</span>);</span><br><span class="line"></span><br><span class="line">          <span class="built_in">pthread_mutex_init</span>(&amp;ncclIbDevs[ncclNIbDevs].lock, <span class="literal">NULL</span>);</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].device = d;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].guid = devAttr.sys_image_guid;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].port = port;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].link = portAttr.link_layer;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].speed = <span class="built_in">ncclIbSpeed</span>(portAttr.active_speed) * <span class="built_in">ncclIbWidth</span>(portAttr.active_width);</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].context = context;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].pdRefs = <span class="number">0</span>;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].pd = <span class="literal">NULL</span>;</span><br><span class="line">          <span class="built_in">strncpy</span>(ncclIbDevs[ncclNIbDevs].devName, devices[d]-&gt;name, MAXNAMESIZE);</span><br><span class="line">          <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbGetPciPath</span>(ncclIbDevs[ncclNIbDevs].devName, &amp;ncclIbDevs[ncclNIbDevs].pciPath, &amp;ncclIbDevs[ncclNIbDevs].realPort));</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].maxQp = devAttr.max_qp;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].mrCache.capacity = <span class="number">0</span>;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].mrCache.population = <span class="number">0</span>;</span><br><span class="line">          ncclIbDevs[ncclNIbDevs].mrCache.slots = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 初始化好 ib 设备信息后</span></span><br><span class="line">          <span class="comment">// 启动 ncclIbAsyncThreadMain thread, 监听 ib 设备事件</span></span><br><span class="line">          <span class="built_in">pthread_create</span>(&amp;ncclIbAsyncThread, <span class="literal">NULL</span>, ncclIbAsyncThreadMain, context);</span><br><span class="line">          <span class="built_in">ncclSetThreadName</span>(ncclIbAsyncThread, <span class="string">&quot;NCCL IbAsync %2d&quot;</span>, ncclNIbDevs);</span><br><span class="line">          <span class="built_in">pthread_detach</span>(ncclIbAsyncThread); <span class="comment">// will not be pthread_join()&#x27;d</span></span><br><span class="line">          ncclNIbDevs++;</span><br><span class="line">          nPorts++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (nPorts == <span class="number">0</span> &amp;&amp; ncclSuccess != <span class="built_in">wrap_ibv_close_device</span>(context)) &#123; <span class="keyword">return</span> ncclInternalError; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (nIbDevs &amp;&amp; (ncclSuccess != <span class="built_in">wrap_ibv_free_device_list</span>(devices))) &#123; <span class="keyword">return</span> ncclInternalError; &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (ncclNIbDevs == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">INFO</span>(NCCL_INIT|NCCL_NET, <span class="string">&quot;NET/IB : No device found.&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">char</span> line[<span class="number">1024</span>];</span><br><span class="line">      line[<span class="number">0</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      <span class="comment">// Determine whether RELAXED_ORDERING is enabled and possible</span></span><br><span class="line">      ncclIbRelaxedOrderingEnabled = <span class="built_in">ncclIbRelaxedOrderingCapable</span>();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> d=<span class="number">0</span>; d&lt;ncclNIbDevs; d++) &#123;</span><br><span class="line">        <span class="built_in">snprintf</span>(line+<span class="built_in">strlen</span>(line), <span class="number">1023</span>-<span class="built_in">strlen</span>(line), <span class="string">&quot; [%d]%s:%d/%s&quot;</span>, d, ncclIbDevs[d].devName,</span><br><span class="line">            ncclIbDevs[d].port, ncclIbDevs[d].link == IBV_LINK_LAYER_INFINIBAND ? <span class="string">&quot;IB&quot;</span> : <span class="string">&quot;RoCE&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      line[<span class="number">1023</span>] = <span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">      <span class="keyword">char</span> addrline[SOCKET_NAME_MAXLEN+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// OOB 个人理解是用于辅助完成 ib 通信初始化的网卡</span></span><br><span class="line">      <span class="built_in">INFO</span>(NCCL_INIT|NCCL_NET, <span class="string">&quot;NET/IB : Using%s %s; OOB %s:%s&quot;</span>, line, ncclIbRelaxedOrderingEnabled ? <span class="string">&quot;[RO]&quot;</span> : <span class="string">&quot;&quot;</span>,</span><br><span class="line">           ncclIbIfName, <span class="built_in">ncclSocketToString</span>(&amp;ncclIbIfAddr, addrline));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">pthread_mutex_unlock</span>(&amp;ncclIbLock);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbDevices</span><span class="params">(<span class="keyword">int</span>* ndev)</span> </span>&#123;</span><br><span class="line">  *ndev = ncclNIbDevs;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detect whether GDR can work on a given NIC with the current CUDA device</span></span><br><span class="line"><span class="comment">// Returns :</span></span><br><span class="line"><span class="comment">// ncclSuccess : GDR works</span></span><br><span class="line"><span class="comment">// ncclSystemError : no module or module loaded but not supported by GPU</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbGdrSupport</span><span class="params">(<span class="keyword">int</span> ibDev)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> moduleLoaded = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (moduleLoaded == <span class="number">-1</span>) &#123;</span><br><span class="line">    <span class="comment">// nv_mem or nvidia-peermem 都能开启 GDR</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check for the nv_peer_mem module being loaded</span></span><br><span class="line">    moduleLoaded = ((<span class="built_in">access</span>(<span class="string">&quot;/sys/kernel/mm/memory_peers/nv_mem/version&quot;</span>, F_OK) == <span class="number">-1</span>) &amp;&amp;</span><br><span class="line">                    <span class="comment">// Also support the new nvidia-peermem module</span></span><br><span class="line">                    (<span class="built_in">access</span>(<span class="string">&quot;/sys/kernel/mm/memory_peers/nvidia-peermem/version&quot;</span>, F_OK) == <span class="number">-1</span>)) ? <span class="number">0</span> : <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (moduleLoaded == <span class="number">0</span>) <span class="keyword">return</span> ncclSystemError;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Detect whether DMA-BUF support is present in the kernel</span></span><br><span class="line"><span class="comment">// Returns :</span></span><br><span class="line"><span class="comment">// ncclSuccess : DMA-BUF support is available</span></span><br><span class="line"><span class="comment">// ncclSystemError : DMA-BUF is not supported by the kernel</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbDmaBufSupport</span><span class="params">(<span class="keyword">int</span> dev)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">int</span> dmaBufSupported = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (dmaBufSupported == <span class="number">-1</span>) &#123;</span><br><span class="line">    ncclResult_t res;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_pd</span>* <span class="title">pd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_context</span>* <span class="title">ctx</span>;</span></span><br><span class="line">    ctx = ncclIbDevs[dev].context;</span><br><span class="line">    <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">wrap_ibv_alloc_pd</span>(&amp;pd, ctx), res, failure);</span><br><span class="line">    <span class="comment">// Test kernel DMA-BUF support with a dummy call (fd=-1)</span></span><br><span class="line">    (<span class="keyword">void</span>) <span class="built_in">wrap_direct_ibv_reg_dmabuf_mr</span>(pd, <span class="number">0ULL</span><span class="comment">/*offset*/</span>, <span class="number">0ULL</span><span class="comment">/*len*/</span>, <span class="number">0ULL</span><span class="comment">/*iova*/</span>, <span class="number">-1</span><span class="comment">/*fd*/</span>, <span class="number">0</span><span class="comment">/*flags*/</span>);</span><br><span class="line">    <span class="comment">// ibv_reg_dmabuf_mr() will fail with EOPNOTSUPP/EPROTONOSUPPORT if not supported (EBADF otherwise)</span></span><br><span class="line">    dmaBufSupported = (errno != EOPNOTSUPP &amp;&amp; errno != EPROTONOSUPPORT) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">wrap_ibv_dealloc_pd</span>(pd), res, failure);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (dmaBufSupported == <span class="number">0</span>) <span class="keyword">return</span> ncclSystemError;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">failure:</span><br><span class="line">  dmaBufSupported = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> ncclSystemError;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> ncclResult_t <span class="title">GetSocketAddr</span><span class="params">(<span class="keyword">union</span> ncclSocketAddress* addr)</span> </span>&#123;</span><br><span class="line">  <span class="built_in">memcpy</span>(addr, &amp;ncclIbIfAddr, <span class="built_in"><span class="keyword">sizeof</span></span>(*addr));</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NCCL_NET_IB_MAX_RECVS 8</span></span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbGetProperties</span><span class="params">(<span class="keyword">int</span> dev, ncclNetProperties_t* props)</span> </span>&#123;</span><br><span class="line">  props-&gt;name = ncclIbDevs[dev].devName;</span><br><span class="line">  props-&gt;pciPath = ncclIbDevs[dev].pciPath;</span><br><span class="line">  props-&gt;guid = ncclIbDevs[dev].guid;</span><br><span class="line">  props-&gt;ptrSupport = NCCL_PTR_HOST;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ncclIbGdrSupport</span>(dev) == ncclSuccess) &#123;</span><br><span class="line">    props-&gt;ptrSupport |= NCCL_PTR_CUDA; <span class="comment">// GDR support via nv_peermem</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ncclIbDmaBufSupport</span>(dev) == ncclSuccess) &#123;</span><br><span class="line">    props-&gt;ptrSupport |= NCCL_PTR_DMABUF; <span class="comment">// GDR support via DMA-BUF</span></span><br><span class="line">  &#125;</span><br><span class="line">  props-&gt;speed = ncclIbDevs[dev].speed;</span><br><span class="line">  props-&gt;latency = <span class="number">0</span>; <span class="comment">// Not set</span></span><br><span class="line">  props-&gt;port = ncclIbDevs[dev].port + ncclIbDevs[dev].realPort;</span><br><span class="line">  props-&gt;maxComms = ncclIbDevs[dev].maxQp;</span><br><span class="line">  props-&gt;maxRecvs = NCCL_NET_IB_MAX_RECVS;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// We need to support NCCL_NET_MAX_REQUESTS for each concurrent receive</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MAX_REQUESTS (NCCL_NET_MAX_REQUESTS*NCCL_NET_IB_MAX_RECVS)</span></span><br><span class="line"><span class="built_in"><span class="keyword">static_assert</span></span>(MAX_REQUESTS &lt;= <span class="number">256</span>, <span class="string">&quot;request id are encoded in wr_id and we need up to 8 requests ids per completion&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NCCL_IB_MAX_QPS 128</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 完成 rdma (infiniband) 需要的信息; 例如 queue pair num</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbQpInfo</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint32_t</span> lid;</span><br><span class="line">  <span class="keyword">uint8_t</span> ib_port;</span><br><span class="line">  <span class="keyword">uint8_t</span> link_layer;</span><br><span class="line">  <span class="keyword">uint32_t</span> qpn[NCCL_IB_MAX_QPS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// For RoCE</span></span><br><span class="line">  <span class="keyword">uint64_t</span> spn;</span><br><span class="line">  <span class="keyword">uint64_t</span> iid;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">ibv_mtu</span> <span class="title">mtu</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// FIFO RDMA info</span></span><br><span class="line">  <span class="keyword">uint32_t</span> fifoRkey;</span><br><span class="line">  <span class="keyword">uint64_t</span> fifoAddr;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">ncclIbCommState</span> &#123;</span></span><br><span class="line">  ncclIbCommStateStart = <span class="number">0</span>,</span><br><span class="line">  ncclIbCommStateConnect = <span class="number">1</span>,</span><br><span class="line">  ncclIbCommStateAccept = <span class="number">3</span>,</span><br><span class="line">  ncclIbCommStateSend = <span class="number">4</span>,</span><br><span class="line">  ncclIbCommStateRecv = <span class="number">5</span>,</span><br><span class="line">  ncclIbCommStateConnected = <span class="number">6</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbCommStage</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">ncclIbCommState</span> <span class="title">state</span>;</span></span><br><span class="line">  <span class="keyword">int</span> offset;</span><br><span class="line">  <span class="keyword">void</span>* buffer;</span><br><span class="line">  <span class="keyword">void</span>* comm;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbHandle</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">ncclSocketAddress</span> <span class="title">connectAddr</span>;</span> <span class="comment">// Filled by the target</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbCommStage</span> <span class="title">stage</span>;</span> <span class="comment">// Used by the other side when connecting</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NCCL_NET_IB_REQ_UNUSED 0</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NCCL_NET_IB_REQ_SEND 1</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NCCL_NET_IB_REQ_RECV 2</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> NCCL_NET_IB_REQ_FLUSH 3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// request</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbVerbs</span>* <span class="title">verbs</span>;</span></span><br><span class="line">  <span class="keyword">int</span> type;</span><br><span class="line">  <span class="keyword">int</span> events;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">ncclSocketAddress</span> *<span class="title">addr</span>;</span></span><br><span class="line">  <span class="keyword">int</span> nreqs;</span><br><span class="line">  <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">      <span class="keyword">int</span> size;</span><br><span class="line">      <span class="keyword">void</span>* data;</span><br><span class="line">      <span class="keyword">uint32_t</span> lkey;</span><br><span class="line">      <span class="keyword">int</span> offset;</span><br><span class="line">    &#125; send;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">      <span class="keyword">int</span> sizes[NCCL_NET_IB_MAX_RECVS];</span><br><span class="line">    &#125; recv;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbVerbs</span> &#123;</span></span><br><span class="line">  <span class="comment">// 设备 index</span></span><br><span class="line">  <span class="keyword">int</span> dev;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// rdma (infiniband) 中的 protect domain</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_pd</span>* <span class="title">pd</span>;</span> <span class="comment">// duplicate of ncclIbDevs[dev].pd</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// rdma (infiniband) 中的 completion queue</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_cq</span>* <span class="title">cq</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> pad[<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ib request</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span> <span class="title">reqs</span>[<span class="title">MAX_REQUESTS</span>];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbListenComm</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> dev;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclSocket</span> <span class="title">sock</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbCommStage</span> <span class="title">stage</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ncclIbSendFifo</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendFifo</span> &#123;</span></span><br><span class="line">  <span class="keyword">uint64_t</span> addr; <span class="comment">// 远端 mem addr</span></span><br><span class="line">  <span class="keyword">int</span>      size; <span class="comment">// 数据大小</span></span><br><span class="line">  <span class="keyword">uint32_t</span> rkey; <span class="comment">// remote key, 用于 rdma</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint32_t</span> nreqs;</span><br><span class="line">  <span class="keyword">uint32_t</span> tag;</span><br><span class="line">  <span class="keyword">uint64_t</span> idx;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendComm</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbVerbs</span> <span class="title">verbs</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendFifo</span> <span class="title">fifo</span>[<span class="title">MAX_REQUESTS</span>][<span class="title">NCCL_NET_IB_MAX_RECVS</span>];</span></span><br><span class="line">  <span class="keyword">uint64_t</span> fifoHead;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>* <span class="title">fifoReqs</span>[<span class="title">MAX_REQUESTS</span>][<span class="title">NCCL_NET_IB_MAX_RECVS</span>];</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_send_wr</span> <span class="title">wrs</span>[<span class="title">NCCL_NET_IB_MAX_RECVS</span>+1];</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_sge</span> <span class="title">sges</span>[<span class="title">NCCL_NET_IB_MAX_RECVS</span>];</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclSocket</span> <span class="title">sock</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> ready;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp</span>* <span class="title">qps</span>[<span class="title">NCCL_IB_MAX_QPS</span>];</span></span><br><span class="line">  <span class="keyword">int</span> nqps;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_mr</span>* <span class="title">fifoMr</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// The SendFifo needs to be 32-byte aligned and each element needs</span></span><br><span class="line"><span class="comment">// to be a 32-byte multiple, so that an entry does not get split and</span></span><br><span class="line"><span class="comment">// written out of order when IB Relaxed Ordering is enabled</span></span><br><span class="line"><span class="built_in"><span class="keyword">static_assert</span></span>((<span class="built_in">offsetof</span>(struct ncclIbSendComm, fifo) % <span class="number">32</span>) == <span class="number">0</span>, <span class="string">&quot;ncclIbSendComm fifo must be 32-byte aligned&quot;</span>);</span><br><span class="line"><span class="built_in"><span class="keyword">static_assert</span></span>((<span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbSendFifo) % <span class="number">32</span>) == <span class="number">0</span>, <span class="string">&quot;ncclIbSendFifo element size must be 32-byte multiples&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbGpuFlush</span> &#123;</span></span><br><span class="line">  <span class="keyword">int</span> enabled;</span><br><span class="line">  <span class="keyword">int</span> hostMem;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_mr</span>* <span class="title">hostMr</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_sge</span> <span class="title">sge</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp</span>* <span class="title">qp</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// remote fifo 队列, 队列中的 item 为 ncclIbSendFifo</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRemFifo</span> &#123;</span></span><br><span class="line">  </span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendFifo</span> <span class="title">elems</span>[<span class="title">MAX_REQUESTS</span>][<span class="title">NCCL_NET_IB_MAX_RECVS</span>];</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 队尾</span></span><br><span class="line">  <span class="keyword">uint64_t</span> fifoTail;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> addr;</span><br><span class="line">  <span class="keyword">uint32_t</span> rkey;</span><br><span class="line">  <span class="keyword">uint32_t</span> flags;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_mr</span>* <span class="title">mr</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_sge</span> <span class="title">sge</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRecvComm</span> &#123;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbVerbs</span> <span class="title">verbs</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRemFifo</span> <span class="title">remFifo</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclSocket</span> <span class="title">sock</span>;</span></span><br><span class="line">  <span class="keyword">int</span> ready;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp</span>* <span class="title">qps</span>[<span class="title">NCCL_IB_MAX_QPS</span>];</span></span><br><span class="line">  <span class="keyword">int</span> nqps;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbGpuFlush</span> <span class="title">gpuFlush</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="built_in"><span class="keyword">static_assert</span></span>((<span class="built_in">offsetof</span>(struct ncclIbRecvComm, remFifo) % <span class="number">32</span>) == <span class="number">0</span>, <span class="string">&quot;ncclIbSendComm fifo must be 32-byte aligned&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbQpsPerConn, <span class="string">&quot;IB_QPS_PER_CONNECTION&quot;</span>, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbInitVerbs</span><span class="params">(<span class="keyword">int</span> dev, struct ibv_context* ctx, struct ncclIbVerbs* verbs)</span> </span>&#123;</span><br><span class="line">  verbs-&gt;dev = dev;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pthread_mutex_lock</span>(&amp;ncclIbDevs[dev].lock);</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == ncclIbDevs[dev].pdRefs++) &#123;</span><br><span class="line">    ncclResult_t res;</span><br><span class="line">    <span class="comment">// 分配 protect domain, pd</span></span><br><span class="line">    <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">wrap_ibv_alloc_pd</span>(&amp;ncclIbDevs[dev].pd, ctx), res, failure);</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span>) &#123;</span><br><span class="line">    failure:</span><br><span class="line">      <span class="built_in">pthread_mutex_unlock</span>(&amp;ncclIbDevs[dev].lock);</span><br><span class="line">      <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  verbs-&gt;pd = ncclIbDevs[dev].pd;</span><br><span class="line">  <span class="built_in">pthread_mutex_unlock</span>(&amp;ncclIbDevs[dev].lock);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建 completion queue</span></span><br><span class="line">  <span class="comment">// Recv requests can generate 2 completions (one for the post FIFO, one for the Recv).</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_create_cq</span>(&amp;verbs-&gt;cq, ctx, <span class="number">2</span>*MAX_REQUESTS*<span class="built_in">ncclParamIbQpsPerConn</span>(), <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">0</span>));</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbDestroyVerbs</span><span class="params">(struct ncclIbVerbs* verbs)</span> </span>&#123;</span><br><span class="line">  ncclResult_t res;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_destroy_cq</span>(verbs-&gt;cq));</span><br><span class="line"></span><br><span class="line">  <span class="built_in">pthread_mutex_lock</span>(&amp;ncclIbDevs[verbs-&gt;dev].lock);</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> == --ncclIbDevs[verbs-&gt;dev].pdRefs) &#123;</span><br><span class="line">    <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">wrap_ibv_dealloc_pd</span>(ncclIbDevs[verbs-&gt;dev].pd), res, returning);</span><br><span class="line">  &#125;</span><br><span class="line">  res = ncclSuccess;</span><br><span class="line">returning:</span><br><span class="line">  <span class="built_in">pthread_mutex_unlock</span>(&amp;ncclIbDevs[verbs-&gt;dev].lock);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建 qp, 用于数据发送, 接收</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// cq 关联到 qp</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbCreateQp</span><span class="params">(<span class="keyword">uint8_t</span> ib_port, struct ncclIbVerbs* verbs, <span class="keyword">int</span> access_flags, struct ibv_qp** qp)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp_init_attr</span> <span class="title">qpInitAttr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;qpInitAttr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ibv_qp_init_attr));</span><br><span class="line">  qpInitAttr.send_cq = verbs-&gt;cq;</span><br><span class="line">  qpInitAttr.recv_cq = verbs-&gt;cq;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注意此处, NCCL 使用的是 RC 传输</span></span><br><span class="line">  qpInitAttr.qp_type = IBV_QPT_RC;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We might send 2 messages per send (RDMA and RDMA_WITH_IMM)</span></span><br><span class="line">  qpInitAttr.cap.max_send_wr = <span class="number">2</span>*MAX_REQUESTS;</span><br><span class="line">  qpInitAttr.cap.max_recv_wr = MAX_REQUESTS;</span><br><span class="line">  qpInitAttr.cap.max_send_sge = <span class="number">1</span>;</span><br><span class="line">  qpInitAttr.cap.max_recv_sge = <span class="number">1</span>;</span><br><span class="line">  qpInitAttr.cap.max_inline_data = <span class="built_in">ncclParamIbUseInline</span>() ? <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbSendFifo) : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 关联 qp 到 pd, protect domain</span></span><br><span class="line">  <span class="comment">// 也就是说 pd 包括 qp, cq</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_create_qp</span>(qp, verbs-&gt;pd, &amp;qpInitAttr));</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp_attr</span> <span class="title">qpAttr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;qpAttr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ibv_qp_attr));</span><br><span class="line">  <span class="comment">// 注意此处 INIT</span></span><br><span class="line">  qpAttr.qp_state = IBV_QPS_INIT;</span><br><span class="line">  qpAttr.pkey_index = <span class="built_in">ncclParamIbPkey</span>();</span><br><span class="line">  qpAttr.port_num = ib_port;</span><br><span class="line">  qpAttr.qp_access_flags = access_flags;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 可以回顾 QP 状态转换图</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_modify_qp</span>(*qp, &amp;qpAttr, IBV_QP_STATE | IBV_QP_PKEY_INDEX | IBV_QP_PORT | IBV_QP_ACCESS_FLAGS));</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// qp 状态转换</span></span><br><span class="line"><span class="comment">// read to read (receive)</span></span><br><span class="line"><span class="comment">// qp 接收数据时, 如下为相关的环境变量</span></span><br><span class="line"><span class="comment">// NCCL_IB_GID_INDEX, roce only</span></span><br><span class="line"><span class="comment">// NCCL_IB_TC, roce only</span></span><br><span class="line"><span class="comment">// NCCL_IB_SL</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbRtrQp</span><span class="params">(struct ibv_qp* qp, <span class="keyword">uint32_t</span> qpn, struct ncclIbQpInfo* info)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp_attr</span> <span class="title">qpAttr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;qpAttr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ibv_qp_attr));</span><br><span class="line">  qpAttr.qp_state = IBV_QPS_RTR;</span><br><span class="line">  qpAttr.path_mtu = info-&gt;mtu;</span><br><span class="line">  qpAttr.dest_qp_num = qpn;</span><br><span class="line">  qpAttr.rq_psn = <span class="number">0</span>;</span><br><span class="line">  qpAttr.max_dest_rd_atomic = <span class="number">1</span>;</span><br><span class="line">  qpAttr.min_rnr_timer = <span class="number">12</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// roce 时, 如下两个环境变量有效</span></span><br><span class="line">  <span class="comment">// NCCL_IB_GID_INDEX</span></span><br><span class="line">  <span class="comment">// NCCL_IB_TC</span></span><br><span class="line">  <span class="keyword">if</span> (info-&gt;link_layer == IBV_LINK_LAYER_ETHERNET) &#123;</span><br><span class="line">    qpAttr.ah_attr.is_global = <span class="number">1</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.dgid.global.subnet_prefix = info-&gt;spn;</span><br><span class="line">    qpAttr.ah_attr.grh.dgid.global.interface_id = info-&gt;iid;</span><br><span class="line">    qpAttr.ah_attr.grh.flow_label = <span class="number">0</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.sgid_index = <span class="built_in">ncclParamIbGidIndex</span>();</span><br><span class="line">    qpAttr.ah_attr.grh.hop_limit = <span class="number">255</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.traffic_class = <span class="built_in">ncclParamIbTc</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    qpAttr.ah_attr.is_global = <span class="number">0</span>;</span><br><span class="line">    qpAttr.ah_attr.dlid = info-&gt;lid;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// NCCL_IB_SL 对于 infiniband or ethernet 都有效</span></span><br><span class="line">  qpAttr.ah_attr.sl = <span class="built_in">ncclParamIbSl</span>();</span><br><span class="line">  qpAttr.ah_attr.src_path_bits = <span class="number">0</span>;</span><br><span class="line">  qpAttr.ah_attr.port_num = info-&gt;ib_port;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_modify_qp</span>(qp, &amp;qpAttr, IBV_QP_STATE | IBV_QP_AV | IBV_QP_PATH_MTU | IBV_QP_DEST_QPN | IBV_QP_RQ_PSN | IBV_QP_MAX_DEST_RD_ATOMIC | IBV_QP_MIN_RNR_TIMER));</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// qp 状态转换</span></span><br><span class="line"><span class="comment">// read to send</span></span><br><span class="line"><span class="comment">// qp 发送数据时, 如下为相关的环境变量</span></span><br><span class="line"><span class="comment">// NCCL_IB_TIMEOUT, 注意该 env 默认值为 18, 即 timeout 时间为 1073742 usec (1.07 sec). 调整该 env 在 roce 网络丢包情况下, 对通信性能影响较大, 例如假若调整为 25, 则 timeout 时间为 137000000 usec (137 sec), 2min+</span></span><br><span class="line"><span class="comment">// NCCL_IB_RETRY_CNT, 注意此 env 默认值为 7, A 3 bits value of the total number of times that the QP will try to resend the packets before reporting an error because the remote side doesn&#x27;t answer in the primary path</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbRtsQp</span><span class="params">(struct ibv_qp* qp)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp_attr</span> <span class="title">qpAttr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;qpAttr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ibv_qp_attr));</span><br><span class="line">  qpAttr.qp_state = IBV_QPS_RTS;</span><br><span class="line">  qpAttr.timeout = <span class="built_in">ncclParamIbTimeout</span>();</span><br><span class="line">  qpAttr.retry_cnt = <span class="built_in">ncclParamIbRetryCnt</span>();</span><br><span class="line">  qpAttr.rnr_retry = <span class="number">7</span>; <span class="comment">// rnr retry infinite</span></span><br><span class="line">  qpAttr.sq_psn = <span class="number">0</span>;</span><br><span class="line">  qpAttr.max_rd_atomic = <span class="number">1</span>;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_modify_qp</span>(qp, &amp;qpAttr, IBV_QP_STATE | IBV_QP_TIMEOUT | IBV_QP_RETRY_CNT | IBV_QP_RNR_RETRY | IBV_QP_SQ_PSN | IBV_QP_MAX_QP_RD_ATOMIC));</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 socket 通信辅助 ib 完成初始化</span></span><br><span class="line"><span class="comment">// 所以要启动 socket server</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbListen</span><span class="params">(<span class="keyword">int</span> dev, <span class="keyword">void</span>* opaqueHandle, <span class="keyword">void</span>** listenComm)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbListenComm</span>* <span class="title">comm</span>;</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclCalloc</span>(&amp;comm, <span class="number">1</span>));</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbHandle</span>* <span class="title">handle</span> =</span> (struct ncclIbHandle*) opaqueHandle;</span><br><span class="line">  <span class="built_in"><span class="keyword">static_assert</span></span>(<span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbHandle) &lt; NCCL_NET_HANDLE_MAXSIZE, <span class="string">&quot;ncclIbHandle size too large&quot;</span>);</span><br><span class="line">  <span class="built_in">memset</span>(handle, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbHandle));</span><br><span class="line">  comm-&gt;dev = dev;</span><br><span class="line">  comm-&gt;sock.asyncFlag = <span class="number">1</span>; <span class="comment">/* nonblocking socket is required by network communication. */</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">GetSocketAddr</span>(&amp;comm-&gt;sock.addr));</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketListen</span>(&amp;comm-&gt;sock));</span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;handle-&gt;connectAddr, &amp;comm-&gt;sock.addr, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">union</span> ncclSocketAddress));</span><br><span class="line">  *listenComm = comm;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// IB 连接</span></span><br><span class="line"><span class="comment">// 使用 socket 发送本端 ib 相关信息</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbConnect</span><span class="params">(<span class="keyword">int</span> dev, <span class="keyword">void</span>* opaqueHandle, <span class="keyword">void</span>** sendComm)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbHandle</span>* <span class="title">handle</span> =</span> (struct ncclIbHandle*) opaqueHandle;</span><br><span class="line">  <span class="class"><span class="keyword">enum</span> <span class="title">ncclSocketState</span> <span class="title">conState</span>;</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbCommStage</span>* <span class="title">stage</span> =</span> &amp;handle-&gt;stage;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendComm</span>* <span class="title">comm</span> =</span> (struct ncclIbSendComm*)stage-&gt;comm;</span><br><span class="line">  *sendComm = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;state == ncclIbCommStateConnect) <span class="keyword">goto</span> ib_connect_check;</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;state == ncclIbCommStateSend) <span class="keyword">goto</span> ib_send;</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;state != ncclIbCommStateStart) &#123;</span><br><span class="line">    <span class="built_in">WARN</span>(<span class="string">&quot;Error: trying to connect already connected sendComm&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbMalloc</span>((<span class="keyword">void</span>**)&amp;comm, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbSendComm)));</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketInit</span>(&amp;comm-&gt;sock, &amp;handle-&gt;connectAddr, <span class="literal">NULL</span>, <span class="number">1</span>));</span><br><span class="line">  stage-&gt;comm = comm;</span><br><span class="line">  stage-&gt;state = ncclIbCommStateConnect;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketConnect</span>(&amp;comm-&gt;sock));</span><br><span class="line"></span><br><span class="line">ib_connect_check:</span><br><span class="line">  <span class="comment">/* since ncclSocketConnect is async, we must check if connection is complete */</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclGetSocketState</span>(&amp;comm-&gt;sock, &amp;conState));</span><br><span class="line">  <span class="keyword">if</span> (conState == ncclSocketConnecting) &#123;</span><br><span class="line">    <span class="comment">/* expect user to call again */</span></span><br><span class="line">    <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (conState == ncclSocketError) &#123;</span><br><span class="line">    <span class="keyword">return</span> ncclRemoteError;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IB Setup</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_context</span>* <span class="title">ctx</span>;</span></span><br><span class="line">  ctx = ncclIbDevs[dev].context;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbInitVerbs</span>(dev, ctx, &amp;comm-&gt;verbs));</span><br><span class="line">  <span class="keyword">uint8_t</span> ib_port;</span><br><span class="line">  ib_port = ncclIbDevs[dev].port;</span><br><span class="line">  comm-&gt;nqps = <span class="built_in">ncclParamIbQpsPerConn</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认创建 1 qp</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++) &#123;</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbCreateQp</span>(ib_port, &amp;comm-&gt;verbs, IBV_ACCESS_REMOTE_WRITE, comm-&gt;qps+q));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Send my QP Info to receiver through the socket. Hope this won&#x27;t block.</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_port_attr</span> <span class="title">portAttr</span>;</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_query_port</span>(ctx, ib_port, &amp;portAttr));</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbQpInfo</span> <span class="title">qpInfo</span>;</span></span><br><span class="line">  qpInfo.ib_port = ib_port;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++) qpInfo.qpn[q] = comm-&gt;qps[q]-&gt;qp_num;</span><br><span class="line">  qpInfo.mtu = portAttr.active_mtu;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Prepare my fifo</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_reg_mr</span>(&amp;comm-&gt;fifoMr, comm-&gt;verbs.pd, comm-&gt;fifo, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbSendFifo)*MAX_REQUESTS*NCCL_NET_IB_MAX_RECVS, IBV_ACCESS_LOCAL_WRITE|IBV_ACCESS_REMOTE_WRITE|IBV_ACCESS_REMOTE_READ));</span><br><span class="line">  qpInfo.fifoRkey = comm-&gt;fifoMr-&gt;rkey;</span><br><span class="line">  qpInfo.fifoAddr = (<span class="keyword">uint64_t</span>)comm-&gt;fifo;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// RoCE support</span></span><br><span class="line">  qpInfo.lid = portAttr.lid;</span><br><span class="line">  qpInfo.link_layer = portAttr.link_layer;</span><br><span class="line">  <span class="keyword">if</span> (qpInfo.link_layer == IBV_LINK_LAYER_INFINIBAND) &#123; <span class="comment">// IB</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++)</span><br><span class="line">      <span class="built_in">INFO</span>(NCCL_NET,<span class="string">&quot;NET/IB: Dev %d Port %d qpn %d mtu %d LID %d&quot;</span>, dev, ib_port, qpInfo.qpn[q], qpInfo.mtu, qpInfo.lid);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// RoCE</span></span><br><span class="line">    <span class="keyword">union</span> ibv_gid gid;</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_query_gid</span>(ctx, ib_port, <span class="built_in">ncclParamIbGidIndex</span>(), &amp;gid));</span><br><span class="line">    qpInfo.spn = gid.global.subnet_prefix;</span><br><span class="line">    qpInfo.iid = gid.global.interface_id;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++)</span><br><span class="line">      <span class="built_in">INFO</span>(NCCL_NET,<span class="string">&quot;NET/IB: Dev %d Port %d qpn %d mtu %d GID %ld (%lX/%lX)&quot;</span>, dev, ib_port, qpInfo.qpn[q], qpInfo.mtu, <span class="built_in">ncclParamIbGidIndex</span>(), qpInfo.spn, qpInfo.iid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  stage-&gt;state = ncclIbCommStateSend;</span><br><span class="line">  stage-&gt;offset = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbMalloc</span>((<span class="keyword">void</span>**)&amp;stage-&gt;buffer, <span class="built_in"><span class="keyword">sizeof</span></span>(qpInfo)));</span><br><span class="line">  <span class="built_in">memcpy</span>(stage-&gt;buffer, &amp;qpInfo, <span class="built_in"><span class="keyword">sizeof</span></span>(qpInfo));</span><br><span class="line"></span><br><span class="line">ib_send:</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketProgress</span>(NCCL_SOCKET_SEND, &amp;comm-&gt;sock, stage-&gt;buffer, <span class="built_in"><span class="keyword">sizeof</span></span>(qpInfo), &amp;stage-&gt;offset));</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;offset != <span class="built_in"><span class="keyword">sizeof</span></span>(qpInfo))</span><br><span class="line">    <span class="keyword">return</span> ncclSuccess;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(stage-&gt;buffer);</span><br><span class="line">  stage-&gt;state = ncclIbCommStateConnected;</span><br><span class="line">  *sendComm = comm;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">NCCL_PARAM</span>(IbGdrFlushDisable, <span class="string">&quot;GDR_FLUSH_DISABLE&quot;</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收对端 ib 信息</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbAccept</span><span class="params">(<span class="keyword">void</span>* listenComm, <span class="keyword">void</span>** recvComm)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbListenComm</span>* <span class="title">lComm</span> =</span> (struct ncclIbListenComm*)listenComm;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbCommStage</span>* <span class="title">stage</span> =</span> &amp;lComm-&gt;stage;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRecvComm</span>* <span class="title">rComm</span> =</span> (struct ncclIbRecvComm*)stage-&gt;comm;</span><br><span class="line">  *recvComm = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;state == ncclIbCommStateAccept) <span class="keyword">goto</span> ib_accept;</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;state == ncclIbCommStateRecv) <span class="keyword">goto</span> ib_recv;</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;state == ncclIbCommStateSend) <span class="keyword">goto</span> ib_send;</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;state != ncclIbCommStateStart) &#123;</span><br><span class="line">    <span class="built_in">WARN</span>(<span class="string">&quot;Listencomm in unknown state %d\n&quot;</span>, stage-&gt;state);</span><br><span class="line">    <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbMalloc</span>((<span class="keyword">void</span>**)&amp;rComm, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbRecvComm)));</span><br><span class="line">  stage-&gt;comm = rComm;</span><br><span class="line">  stage-&gt;state = ncclIbCommStateAccept;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketInit</span>(&amp;rComm-&gt;sock, <span class="literal">NULL</span>, lComm-&gt;sock.abortFlag, <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">ib_accept:</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketAccept</span>(&amp;rComm-&gt;sock, &amp;lComm-&gt;sock));</span><br><span class="line">  <span class="keyword">if</span> (rComm-&gt;sock.fd == <span class="number">-1</span>)</span><br><span class="line">    <span class="keyword">return</span> ncclSuccess;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbQpInfo</span> <span class="title">remQpInfo</span>;</span></span><br><span class="line">  stage-&gt;state = ncclIbCommStateRecv;</span><br><span class="line">  stage-&gt;offset = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbMalloc</span>((<span class="keyword">void</span>**)&amp;stage-&gt;buffer, <span class="built_in"><span class="keyword">sizeof</span></span>(remQpInfo)));</span><br><span class="line">ib_recv:</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketProgress</span>(NCCL_SOCKET_RECV, &amp;rComm-&gt;sock, stage-&gt;buffer, <span class="built_in"><span class="keyword">sizeof</span></span>(remQpInfo), &amp;stage-&gt;offset));</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;offset != <span class="built_in"><span class="keyword">sizeof</span></span>(remQpInfo))</span><br><span class="line">    <span class="keyword">return</span> ncclSuccess;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* copy back the received info */</span></span><br><span class="line">  <span class="built_in">memcpy</span>(&amp;remQpInfo, stage-&gt;buffer, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbQpInfo));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IB setup</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_context</span>* <span class="title">ctx</span>;</span></span><br><span class="line">  <span class="keyword">uint8_t</span> ib_port;</span><br><span class="line">  ctx = ncclIbDevs[lComm-&gt;dev].context;</span><br><span class="line">  ib_port = ncclIbDevs[lComm-&gt;dev].port;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_port_attr</span> <span class="title">portAttr</span>;</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_query_port</span>(ctx, ib_port, &amp;portAttr));</span><br><span class="line">  <span class="class"><span class="keyword">union</span> <span class="title">ibv_gid</span> <span class="title">gid</span>;</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_query_gid</span>(ctx, ib_port, <span class="built_in">ncclParamIbGidIndex</span>(), &amp;gid));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// QP Creation</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbInitVerbs</span>(lComm-&gt;dev, ctx, &amp;rComm-&gt;verbs));</span><br><span class="line">  rComm-&gt;nqps = <span class="built_in">ncclParamIbQpsPerConn</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;rComm-&gt;nqps; q++) &#123;</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbCreateQp</span>(ib_port, &amp;rComm-&gt;verbs, IBV_ACCESS_REMOTE_WRITE, rComm-&gt;qps+q));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Adjust the MTU</span></span><br><span class="line">  remQpInfo.mtu = (<span class="keyword">enum</span> ibv_mtu)std::<span class="built_in">min</span>(remQpInfo.mtu, portAttr.active_mtu);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Setup QP</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;rComm-&gt;nqps; q++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp</span>* <span class="title">qp</span> =</span> rComm-&gt;qps[q];</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtrQp</span>(qp, remQpInfo.qpn[q], &amp;remQpInfo));</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtsQp</span>(qp));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Retain remote fifo info and prepare my RDMA ops</span></span><br><span class="line">  rComm-&gt;remFifo.rkey = remQpInfo.fifoRkey;</span><br><span class="line">  rComm-&gt;remFifo.addr = remQpInfo.fifoAddr;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_reg_mr</span>(&amp;rComm-&gt;remFifo.mr, rComm-&gt;verbs.pd, &amp;rComm-&gt;remFifo.elems, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbSendFifo)*MAX_REQUESTS*NCCL_NET_IB_MAX_RECVS, IBV_ACCESS_REMOTE_WRITE|IBV_ACCESS_LOCAL_WRITE|IBV_ACCESS_REMOTE_READ));</span><br><span class="line">  rComm-&gt;remFifo.sge.lkey = rComm-&gt;remFifo.mr-&gt;lkey;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">ncclParamIbUseInline</span>()) rComm-&gt;remFifo.flags = IBV_SEND_INLINE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果开启了 gdr flush, 则创建独立的 qp, 用于 gdr flush 通信</span></span><br><span class="line">  <span class="comment">// Allocate Flush dummy buffer for GPU Direct RDMA</span></span><br><span class="line">  rComm-&gt;gpuFlush.enabled = (<span class="built_in">ncclIbGdrSupport</span>(lComm-&gt;dev) == <span class="number">0</span>) &amp;&amp; (<span class="built_in">ncclParamIbGdrFlushDisable</span>() == <span class="number">0</span>) ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (rComm-&gt;gpuFlush.enabled) &#123;</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_reg_mr</span>(&amp;rComm-&gt;gpuFlush.hostMr, rComm-&gt;verbs.pd, &amp;rComm-&gt;gpuFlush.hostMem, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), IBV_ACCESS_LOCAL_WRITE));</span><br><span class="line">    rComm-&gt;gpuFlush.sge.addr = (<span class="keyword">uint64_t</span>)&amp;rComm-&gt;gpuFlush.hostMem;</span><br><span class="line">    rComm-&gt;gpuFlush.sge.length = <span class="number">1</span>;</span><br><span class="line">    rComm-&gt;gpuFlush.sge.lkey = rComm-&gt;gpuFlush.hostMr-&gt;lkey;</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbCreateQp</span>(ib_port, &amp;rComm-&gt;verbs, IBV_ACCESS_LOCAL_WRITE | IBV_ACCESS_REMOTE_READ, &amp;rComm-&gt;gpuFlush.qp));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbQpInfo</span> <span class="title">localQpInfo</span>;</span></span><br><span class="line">    localQpInfo.lid=portAttr.lid;</span><br><span class="line">    localQpInfo.link_layer=portAttr.link_layer;</span><br><span class="line">    localQpInfo.ib_port=ib_port;</span><br><span class="line">    localQpInfo.spn=gid.global.subnet_prefix;</span><br><span class="line">    localQpInfo.iid=gid.global.interface_id;</span><br><span class="line">    localQpInfo.mtu=portAttr.active_mtu;</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtrQp</span>(rComm-&gt;gpuFlush.qp, rComm-&gt;gpuFlush.qp-&gt;qp_num, &amp;localQpInfo));</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtsQp</span>(rComm-&gt;gpuFlush.qp));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fill Handle</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbQpInfo</span> <span class="title">qpInfo</span>;</span></span><br><span class="line">  qpInfo.lid=portAttr.lid;</span><br><span class="line">  qpInfo.link_layer=portAttr.link_layer;</span><br><span class="line">  qpInfo.ib_port=ib_port;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;rComm-&gt;nqps; q++) qpInfo.qpn[q]=rComm-&gt;qps[q]-&gt;qp_num;</span><br><span class="line">  qpInfo.spn=gid.global.subnet_prefix;</span><br><span class="line">  qpInfo.iid=gid.global.interface_id;</span><br><span class="line">  qpInfo.mtu=remQpInfo.mtu;</span><br><span class="line"></span><br><span class="line">  stage-&gt;state = ncclIbCommStateSend;</span><br><span class="line">  stage-&gt;offset = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;buffer) <span class="built_in">free</span>(stage-&gt;buffer);</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbMalloc</span>((<span class="keyword">void</span>**)&amp;stage-&gt;buffer, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbQpInfo)));</span><br><span class="line">  <span class="built_in">memcpy</span>(stage-&gt;buffer, &amp;qpInfo, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbQpInfo));</span><br><span class="line">ib_send:</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketProgress</span>(NCCL_SOCKET_SEND, &amp;rComm-&gt;sock, stage-&gt;buffer, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbQpInfo), &amp;stage-&gt;offset));</span><br><span class="line">  <span class="keyword">if</span> (stage-&gt;offset &lt; <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbQpInfo)) <span class="keyword">return</span> ncclSuccess;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">free</span>(stage-&gt;buffer);</span><br><span class="line">  *recvComm = rComm;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* reset lComm stage */</span></span><br><span class="line">  stage-&gt;state = ncclIbCommStateStart;</span><br><span class="line">  stage-&gt;offset = <span class="number">0</span>;</span><br><span class="line">  stage-&gt;comm = <span class="literal">NULL</span>;</span><br><span class="line">  stage-&gt;buffer = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取 request 用于通信</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbGetRequest</span><span class="params">(struct ncclIbVerbs* verbs, struct ncclIbRequest** req)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;MAX_REQUESTS; i++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>* <span class="title">r</span> =</span> verbs-&gt;reqs+i;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;type == NCCL_NET_IB_REQ_UNUSED) &#123;</span><br><span class="line">      r-&gt;verbs = verbs;</span><br><span class="line">      r-&gt;events = <span class="number">1</span>;</span><br><span class="line">      r-&gt;addr = <span class="literal">NULL</span>;</span><br><span class="line">      *req = r;</span><br><span class="line">      <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : unable to allocate requests&quot;</span>);</span><br><span class="line">  *req = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 还回 request</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbFreeRequest</span><span class="params">(struct ncclIbRequest* r)</span> </span>&#123;</span><br><span class="line">  r-&gt;type = NCCL_NET_IB_REQ_UNUSED;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ib 通信前初始化好 qp</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclSendCheck</span><span class="params">(struct ncclIbSendComm* comm)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbQpInfo</span> <span class="title">remQpInfo</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 接收远端 qp info: remQpInfo -&gt; remoteQpInfo</span></span><br><span class="line">  <span class="comment">// Do not block on this receive, return if not ready.</span></span><br><span class="line">  <span class="keyword">int</span> bytes = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketProgress</span>(NCCL_SOCKET_RECV, &amp;comm-&gt;sock, &amp;remQpInfo, <span class="built_in"><span class="keyword">sizeof</span></span>(remQpInfo), &amp;bytes));</span><br><span class="line">  <span class="keyword">if</span> (bytes == <span class="number">0</span>) <span class="keyword">return</span> ncclSuccess; <span class="comment">// Try again later</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketWait</span>(NCCL_SOCKET_RECV, &amp;comm-&gt;sock, &amp;remQpInfo, <span class="built_in"><span class="keyword">sizeof</span></span>(remQpInfo), &amp;bytes));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 修改本端 qp 信息, 进行 qp 状态转换</span></span><br><span class="line">  <span class="comment">// 类似于本端 qp 要与对端通信 qp 的地址填入</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp</span>* <span class="title">qp</span> =</span> comm-&gt;qps[q];</span><br><span class="line">    <span class="comment">// 所以如果此时 roce 网卡网络不通 (无法 ping 通 roce 网卡的 ip 地址), 那么就会出现常见错误之一 ibv_modify_qp failed with error Connection timed out</span></span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtrQp</span>(qp, remQpInfo.qpn[q], &amp;remQpInfo));</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtsQp</span>(qp));</span><br><span class="line">  &#125;</span><br><span class="line">  comm-&gt;ready = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 socket 通信，通知对端 qp 已经准备好</span></span><br><span class="line">  <span class="comment">// Block until this is done. It *should* not block indefinitely.</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketSend</span>(&amp;comm-&gt;sock, &amp;comm-&gt;ready, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>)));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收对端 ready 情况</span></span><br><span class="line"><span class="comment">// 等待对端 comm-&gt;ready</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclRecvCheck</span><span class="params">(struct ncclIbRecvComm* comm)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Do not block on this receive, return if not ready.</span></span><br><span class="line">  <span class="keyword">int</span> bytes = <span class="number">0</span>;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketProgress</span>(NCCL_SOCKET_RECV, &amp;comm-&gt;sock, &amp;comm-&gt;ready, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), &amp;bytes));</span><br><span class="line">  <span class="keyword">if</span> (bytes == <span class="number">0</span>) <span class="keyword">return</span> ncclSuccess; <span class="comment">// Try again later</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSocketWait</span>(NCCL_SOCKET_RECV, &amp;comm-&gt;sock, &amp;comm-&gt;ready, <span class="built_in"><span class="keyword">sizeof</span></span>(<span class="keyword">int</span>), &amp;bytes));</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这放的位置有点儿突然 ...</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbTest</span><span class="params">(<span class="keyword">void</span>* request, <span class="keyword">int</span>* done, <span class="keyword">int</span>* size)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* DMA-BUF support */</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbRegMrDmaBuf</span><span class="params">(<span class="keyword">void</span>* comm, <span class="keyword">void</span>* data, <span class="keyword">size_t</span> size, <span class="keyword">int</span> type, <span class="keyword">uint64_t</span> offset, <span class="keyword">int</span> fd, <span class="keyword">void</span>** mhandle)</span> </span>&#123;</span><br><span class="line">  <span class="built_in"><span class="keyword">static_assert</span></span>(<span class="built_in">offsetof</span>(struct ncclIbSendComm, verbs) == <span class="built_in">offsetof</span>(struct ncclIbRecvComm, verbs), <span class="string">&quot;Send and recv comms must have verbs at the same offset&quot;</span>);</span><br><span class="line">  <span class="built_in">assert</span>(size &gt; <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> __thread <span class="keyword">uintptr_t</span> pageSize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (pageSize == <span class="number">0</span>) pageSize = <span class="built_in">sysconf</span>(_SC_PAGESIZE);</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbVerbs</span>* <span class="title">verbs</span> =</span> (struct ncclIbVerbs*)comm;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbMrCache</span>* <span class="title">cache</span> =</span> &amp;ncclIbDevs[verbs-&gt;dev].mrCache;</span><br><span class="line">  <span class="keyword">uintptr_t</span> addr = (<span class="keyword">uintptr_t</span>)data &amp; -pageSize;</span><br><span class="line">  <span class="keyword">size_t</span> pages = ((<span class="keyword">uintptr_t</span>)data + size - addr + pageSize<span class="number">-1</span>)/pageSize;</span><br><span class="line">  ncclResult_t res;</span><br><span class="line">  <span class="built_in">pthread_mutex_lock</span>(&amp;ncclIbDevs[verbs-&gt;dev].lock);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> slot=<span class="number">0</span>; <span class="comment">/*true*/</span>; slot++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (slot == cache-&gt;population) &#123; <span class="comment">// didn&#x27;t find in cache</span></span><br><span class="line">      <span class="keyword">if</span> (cache-&gt;population == cache-&gt;capacity) &#123; <span class="comment">// must grow cache</span></span><br><span class="line">        cache-&gt;capacity = cache-&gt;capacity &lt; <span class="number">32</span> ? <span class="number">32</span> : <span class="number">2</span>*cache-&gt;capacity;</span><br><span class="line">        <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">ncclRealloc</span>(&amp;cache-&gt;slots, cache-&gt;population, cache-&gt;capacity), res, returning);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Deregister / register</span></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">ibv_mr</span>* <span class="title">mr</span>;</span></span><br><span class="line">      <span class="keyword">unsigned</span> <span class="keyword">int</span> flags = IBV_ACCESS_LOCAL_WRITE|IBV_ACCESS_REMOTE_WRITE|IBV_ACCESS_REMOTE_READ;</span><br><span class="line">      <span class="keyword">if</span> (ncclIbRelaxedOrderingEnabled) flags |= IBV_ACCESS_RELAXED_ORDERING;</span><br><span class="line">      <span class="keyword">if</span> (fd != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">/* DMA-BUF support */</span></span><br><span class="line">        <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">wrap_ibv_reg_dmabuf_mr</span>(&amp;mr, verbs-&gt;pd, offset, pages*pageSize, addr, fd, flags), res, returning);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (ncclIbRelaxedOrderingEnabled) &#123;</span><br><span class="line">          <span class="comment">// Use IBVERBS_1.8 API - needed for IBV_ACCESS_RELAXED_ORDERING support</span></span><br><span class="line">          <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">wrap_ibv_reg_mr_iova2</span>(&amp;mr, verbs-&gt;pd, (<span class="keyword">void</span>*)addr, pages*pageSize, addr, flags), res, returning);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">wrap_ibv_reg_mr</span>(&amp;mr, verbs-&gt;pd, (<span class="keyword">void</span>*)addr, pages*pageSize, flags), res, returning);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">TRACE</span>(NCCL_INIT,<span class="string">&quot;regAddr %llx size %lld rkey %x fd %d&quot;</span>, (<span class="keyword">unsigned</span> <span class="keyword">long</span> <span class="keyword">long</span>)addr, (<span class="keyword">long</span> <span class="keyword">long</span>)pages*pageSize, mr-&gt;rkey, fd);</span><br><span class="line">      cache-&gt;population += <span class="number">1</span>;</span><br><span class="line">      cache-&gt;slots[slot].addr = addr;</span><br><span class="line">      cache-&gt;slots[slot].pages = pages;</span><br><span class="line">      cache-&gt;slots[slot].refs = <span class="number">1</span>;</span><br><span class="line">      cache-&gt;slots[slot].mr = mr;</span><br><span class="line">      *mhandle = (<span class="keyword">void</span>*)mr;</span><br><span class="line">      res = ncclSuccess;</span><br><span class="line">      <span class="keyword">goto</span> returning;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (cache-&gt;slots[slot].addr == addr &amp;&amp; cache-&gt;slots[slot].pages == pages) &#123;</span><br><span class="line">      cache-&gt;slots[slot].refs += <span class="number">1</span>;</span><br><span class="line">      *mhandle = (<span class="keyword">void</span>*)cache-&gt;slots[slot].mr;</span><br><span class="line">      res = ncclSuccess;</span><br><span class="line">      <span class="keyword">goto</span> returning;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">returning:</span><br><span class="line">  <span class="built_in">pthread_mutex_unlock</span>(&amp;ncclIbDevs[verbs-&gt;dev].lock);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// pin (lock) memory</span></span><br><span class="line"><span class="comment">// 这里的常见错误是 docker container 中 memlock 默认较小, 导致 ibv_reg_mr failed</span></span><br><span class="line"><span class="comment">// https://docs.nvidia.com/deeplearning/nccl/user-guide/docs/troubleshooting.html#infiniband</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbRegMr</span><span class="params">(<span class="keyword">void</span>* comm, <span class="keyword">void</span>* data, <span class="keyword">int</span> size, <span class="keyword">int</span> type, <span class="keyword">void</span>** mhandle)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">ncclIbRegMrDmaBuf</span>(comm, data, (<span class="keyword">size_t</span>)size, type, <span class="number">0ULL</span>, <span class="number">-1</span>, mhandle);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbDeregMr</span><span class="params">(<span class="keyword">void</span>* comm, <span class="keyword">void</span>* mhandle)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbVerbs</span>* <span class="title">verbs</span> =</span> (struct ncclIbVerbs*)comm;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbMrCache</span>* <span class="title">cache</span> =</span> &amp;ncclIbDevs[verbs-&gt;dev].mrCache;</span><br><span class="line">  ncclResult_t res;</span><br><span class="line">  <span class="built_in">pthread_mutex_lock</span>(&amp;ncclIbDevs[verbs-&gt;dev].lock);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; cache-&gt;population; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (mhandle == cache-&gt;slots[i].mr) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="number">0</span> == --cache-&gt;slots[i].refs) &#123;</span><br><span class="line">        <span class="built_in">memmove</span>(&amp;cache-&gt;slots[i], &amp;cache-&gt;slots[--cache-&gt;population], <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbMr));</span><br><span class="line">        <span class="keyword">if</span> (cache-&gt;population == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="built_in">free</span>(cache-&gt;slots);</span><br><span class="line">          cache-&gt;slots = <span class="literal">NULL</span>;</span><br><span class="line">          cache-&gt;capacity = <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">NCCLCHECKGOTO</span>(<span class="built_in">wrap_ibv_dereg_mr</span>((struct ibv_mr*)mhandle), res, returning);</span><br><span class="line">      &#125;</span><br><span class="line">      res = ncclSuccess;</span><br><span class="line">      <span class="keyword">goto</span> returning;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB: could not find mr %p inside cache of %d entries&quot;</span>, mhandle, cache-&gt;population);</span><br><span class="line">  res = ncclInternalError;</span><br><span class="line">returning:</span><br><span class="line">  <span class="built_in">pthread_mutex_unlock</span>(&amp;ncclIbDevs[verbs-&gt;dev].lock);</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbMultiSend</span><span class="params">(struct ncclIbSendComm* comm, <span class="keyword">int</span> slot)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>** <span class="title">reqs</span> =</span> comm-&gt;fifoReqs[slot];</span><br><span class="line">  <span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendFifo</span>* <span class="title">slots</span> =</span> comm-&gt;fifo[slot];</span><br><span class="line">  <span class="keyword">int</span> nreqs = slots[<span class="number">0</span>].nreqs;</span><br><span class="line">  <span class="keyword">if</span> (nreqs &gt; NCCL_NET_IB_MAX_RECVS) <span class="keyword">return</span> ncclInternalError;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">uint64_t</span> wr_id = <span class="number">0ULL</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;nreqs; r++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_send_wr</span>* <span class="title">wr</span> =</span> comm-&gt;wrs+r;</span><br><span class="line">    <span class="built_in">memset</span>(wr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ibv_send_wr));</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_sge</span>* <span class="title">sge</span> =</span> comm-&gt;sges+r;</span><br><span class="line">    sge-&gt;addr=(<span class="keyword">uintptr_t</span>)reqs[r]-&gt;send.data;</span><br><span class="line">    sge-&gt;lkey=reqs[r]-&gt;send.lkey;</span><br><span class="line"></span><br><span class="line">    wr-&gt;opcode = IBV_WR_RDMA_WRITE;</span><br><span class="line">    wr-&gt;send_flags = <span class="number">0</span>;</span><br><span class="line">    wr-&gt;wr.rdma.remote_addr = slots[r].addr;</span><br><span class="line">    wr-&gt;wr.rdma.rkey = slots[r].rkey;</span><br><span class="line">    wr-&gt;next = wr+<span class="number">1</span>;</span><br><span class="line">    wr_id += (reqs[r] - comm-&gt;verbs.reqs) &lt;&lt; (r*<span class="number">8</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Write size as immediate data. In the case of multi-send, only write</span></span><br><span class="line">  <span class="comment">// 0 or 1 as size to indicate whether there was data sent or received.</span></span><br><span class="line">  <span class="keyword">uint32_t</span> immData = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (nreqs == <span class="number">1</span>) &#123;</span><br><span class="line">    immData = reqs[<span class="number">0</span>]-&gt;send.size;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (nreqs &gt; <span class="number">32</span>) &#123;</span><br><span class="line">      <span class="built_in">WARN</span>(<span class="string">&quot;Cannot store sizes of %d requests in a 32-bits field&quot;</span>, nreqs);</span><br><span class="line">      <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;nreqs; r++) &#123;</span><br><span class="line">      immData |= (reqs[r]-&gt;send.size ? <span class="number">1</span> : <span class="number">0</span>) &lt;&lt; r;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_send_wr</span>* <span class="title">lastWr</span> =</span> comm-&gt;wrs+nreqs<span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">if</span> (nreqs &gt; <span class="number">1</span> || reqs[<span class="number">0</span>]-&gt;send.size &gt; <span class="built_in">ncclParamIbArThreshold</span>()) &#123;</span><br><span class="line">    <span class="comment">// When using adaptive routing, send the bulk of the data first as an</span></span><br><span class="line">    <span class="comment">// RDMA_WRITE, then a 0-byte RDMA_WRITE_WITH_IMM to trigger a remote</span></span><br><span class="line">    <span class="comment">// completion.</span></span><br><span class="line">    lastWr++;</span><br><span class="line">    <span class="built_in">memset</span>(lastWr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ibv_send_wr));</span><br><span class="line">  &#125;</span><br><span class="line">  lastWr-&gt;wr_id = wr_id;</span><br><span class="line">  lastWr-&gt;opcode = IBV_WR_RDMA_WRITE_WITH_IMM;</span><br><span class="line">  lastWr-&gt;imm_data = immData;</span><br><span class="line">  lastWr-&gt;next = <span class="literal">NULL</span>;</span><br><span class="line">  lastWr-&gt;send_flags = IBV_SEND_SIGNALED;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Multi-QP: make sure IB writes are multiples of 128B so that LL and LL128 protocols still work</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">int</span> align = <span class="number">128</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;nreqs; r++) &#123;</span><br><span class="line">      <span class="keyword">int</span> chunkSize = <span class="built_in">DIVUP</span>(<span class="built_in">DIVUP</span>(reqs[r]-&gt;send.size, comm-&gt;nqps), align) * align;</span><br><span class="line">      <span class="keyword">int</span> length = std::<span class="built_in">min</span>(reqs[r]-&gt;send.size-reqs[r]-&gt;send.offset, chunkSize);</span><br><span class="line">      <span class="keyword">if</span> (length &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        comm-&gt;wrs[r].sg_list = <span class="literal">NULL</span>;</span><br><span class="line">        comm-&gt;wrs[r].num_sge = <span class="number">0</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        comm-&gt;sges[r].length = length;</span><br><span class="line">        comm-&gt;wrs[r].sg_list = comm-&gt;sges+r;</span><br><span class="line">        comm-&gt;wrs[r].num_sge = <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_send_wr</span>* <span class="title">bad_wr</span>;</span></span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_post_send</span>(comm-&gt;qps[q], comm-&gt;wrs, &amp;bad_wr));</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;nreqs; r++) &#123;</span><br><span class="line">      <span class="keyword">int</span> chunkSize = <span class="built_in">DIVUP</span>(<span class="built_in">DIVUP</span>(reqs[r]-&gt;send.size, comm-&gt;nqps), align) * align;</span><br><span class="line">      reqs[r]-&gt;send.offset += chunkSize;</span><br><span class="line">      comm-&gt;sges[r].addr += chunkSize;</span><br><span class="line">      comm-&gt;wrs[r].wr.rdma.remote_addr += chunkSize;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbIsend</span><span class="params">(<span class="keyword">void</span>* sendComm, <span class="keyword">void</span>* data, <span class="keyword">int</span> size, <span class="keyword">int</span> tag, <span class="keyword">void</span>* mhandle, <span class="keyword">void</span>** request)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendComm</span>* <span class="title">comm</span> =</span> (struct ncclIbSendComm*)sendComm;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 如果未 ready, 则 set up qp</span></span><br><span class="line">  <span class="keyword">if</span> (comm-&gt;ready == <span class="number">0</span>) <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclSendCheck</span>(comm));</span><br><span class="line">  <span class="keyword">if</span> (comm-&gt;ready == <span class="number">0</span>) &#123; *request = <span class="literal">NULL</span>; <span class="keyword">return</span> ncclSuccess; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_mr</span>* <span class="title">mr</span> =</span> (struct ibv_mr*)mhandle;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wait for the receiver to have posted the corresponding receive</span></span><br><span class="line">  <span class="keyword">int</span> nreqs = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">volatile</span> <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendFifo</span>* <span class="title">slots</span>;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> slot = (comm-&gt;fifoHead)%MAX_REQUESTS;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>** <span class="title">reqs</span> =</span> comm-&gt;fifoReqs[slot];</span><br><span class="line">  slots = comm-&gt;fifo[slot];</span><br><span class="line">  <span class="keyword">int</span> idx = comm-&gt;fifoHead+<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> (slots[<span class="number">0</span>].idx != idx) &#123; *request = <span class="literal">NULL</span>; <span class="keyword">return</span> ncclSuccess; &#125;</span><br><span class="line">  nreqs = slots[<span class="number">0</span>].nreqs;</span><br><span class="line">  <span class="comment">// Wait until all data has arrived</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">1</span>; r&lt;nreqs; r++) <span class="keyword">while</span>(slots[r].idx != idx);</span><br><span class="line"></span><br><span class="line">  __sync_synchronize(); <span class="comment">// order the nreqsPtr load against tag/rkey/addr loads below</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;nreqs; r++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (reqs[r] != <span class="literal">NULL</span> || slots[r].tag != tag) <span class="keyword">continue</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Sanity checks to catch user collective call count/size mismatches</span></span><br><span class="line">    <span class="keyword">if</span> (size &gt; slots[r].size) &#123;</span><br><span class="line">      <span class="keyword">char</span> line[SOCKET_NAME_MAXLEN+<span class="number">1</span>];</span><br><span class="line">      <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : req %d/%d tag %x peer %s collective mismatch error, local size %d remote size %d&quot;</span>,</span><br><span class="line">           r, nreqs, tag, <span class="built_in">ncclSocketToString</span>(&amp;comm-&gt;sock.addr, line), size, slots[r].size);</span><br><span class="line">      <span class="keyword">return</span> ncclInvalidUsage;</span><br><span class="line">    &#125; <span class="comment">// plus any potential programming errors</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (slots[r].size &lt; <span class="number">0</span> || slots[r].addr == <span class="number">0</span> || slots[r].rkey == <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="keyword">char</span> line[SOCKET_NAME_MAXLEN+<span class="number">1</span>];</span><br><span class="line">     <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : req %d/%d tag %x peer %s posted incorrect receive info: size %d addr %lx rkey %x&quot;</span>,</span><br><span class="line">          r, nreqs, tag, <span class="built_in">ncclSocketToString</span>(&amp;comm-&gt;sock.addr, line), slots[r].size, slots[r].addr, slots[r].rkey);</span><br><span class="line">      <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发送数据</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>* <span class="title">req</span>;</span></span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbGetRequest</span>(&amp;comm-&gt;verbs, &amp;req));</span><br><span class="line">    req-&gt;type = NCCL_NET_IB_REQ_SEND;</span><br><span class="line">    req-&gt;addr = &amp;comm-&gt;sock.addr;</span><br><span class="line">    req-&gt;verbs = &amp;comm-&gt;verbs;</span><br><span class="line">    req-&gt;nreqs = nreqs;</span><br><span class="line">    req-&gt;send.size = size;</span><br><span class="line">    req-&gt;send.data = data;</span><br><span class="line">    req-&gt;send.lkey = mr-&gt;lkey;</span><br><span class="line">    req-&gt;send.offset = <span class="number">0</span>;</span><br><span class="line">    req-&gt;addr = &amp;comm-&gt;sock.addr;</span><br><span class="line">    req-&gt;events = comm-&gt;nqps;</span><br><span class="line">    *request = reqs[r] = req;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this is a multi-recv, send only when all requests have matched.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">0</span>; r&lt;nreqs; r++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (reqs[r] == <span class="literal">NULL</span>) <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">TIME_START</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbMultiSend</span>(comm, slot));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Clear slots[0]-&gt;nreqs, as well as other fields to help debugging and sanity checks</span></span><br><span class="line">    <span class="built_in">memset</span>((<span class="keyword">void</span>*)slots, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbSendFifo));</span><br><span class="line">    <span class="built_in">memset</span>(reqs, <span class="number">0</span>, NCCL_NET_IB_MAX_RECVS*<span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbRequest*));</span><br><span class="line">    comm-&gt;fifoHead++;</span><br><span class="line">    <span class="built_in">TIME_STOP</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  *request = <span class="literal">NULL</span>;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 发送 fifo; fifo 中提供的是 ncclIbSendFifo, 其中有 rkey, 以及等待数据写入的 mem addr</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbPostFifo</span><span class="params">(struct ncclIbRecvComm* comm, <span class="keyword">int</span> n, <span class="keyword">void</span>** data, <span class="keyword">int</span>* sizes, <span class="keyword">int</span>* tags, <span class="keyword">void</span>** mhandles, struct ncclIbRequest* req)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_send_wr</span> <span class="title">wr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;wr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(wr));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> slot = comm-&gt;remFifo.fifoTail%MAX_REQUESTS;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendFifo</span>* <span class="title">localElem</span> =</span> comm-&gt;remFifo.elems[slot];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) &#123;</span><br><span class="line">    localElem[i].addr = (<span class="keyword">uint64_t</span>)data[i];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_mr</span>* <span class="title">mr</span> =</span> (struct ibv_mr*)mhandles[i];</span><br><span class="line">    localElem[i].rkey = mr-&gt;rkey;</span><br><span class="line">    localElem[i].nreqs = n;</span><br><span class="line">    localElem[i].size = sizes[i]; <span class="comment">// Sanity/Debugging</span></span><br><span class="line">    localElem[i].tag = tags[i];</span><br><span class="line">    localElem[i].idx = comm-&gt;remFifo.fifoTail+<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  wr.wr.rdma.remote_addr = comm-&gt;remFifo.addr + slot*NCCL_NET_IB_MAX_RECVS*<span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbSendFifo);</span><br><span class="line">  wr.wr.rdma.rkey = comm-&gt;remFifo.rkey;</span><br><span class="line">  comm-&gt;remFifo.sge.addr = (<span class="keyword">uint64_t</span>)localElem;</span><br><span class="line">  comm-&gt;remFifo.sge.length = n*<span class="built_in"><span class="keyword">sizeof</span></span>(struct ncclIbSendFifo);</span><br><span class="line">  wr.sg_list = &amp;comm-&gt;remFifo.sge;</span><br><span class="line">  wr.num_sge = <span class="number">1</span>;</span><br><span class="line">  wr.opcode = IBV_WR_RDMA_WRITE;</span><br><span class="line">  wr.send_flags = comm-&gt;remFifo.flags; <span class="comment">// IBV_SEND_INLINE</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// We need to occasionally post a request with the IBV_SEND_SIGNALED flag, otherwise</span></span><br><span class="line">  <span class="comment">// the send queue will never empty.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// From https://www.rdmamojo.com/2014/06/30/working-unsignaled-completions/</span></span><br><span class="line">  <span class="comment">// &quot;How to use Unsignaled Completion?&quot; / &quot;Gotchas and Pitfalls&quot;</span></span><br><span class="line">  <span class="comment">// All posted Send Requested, Signaled and Unsignaled, are considered outstanding until</span></span><br><span class="line">  <span class="comment">// a Work Completion that they, or Send Requests that were posted after them, was polled</span></span><br><span class="line">  <span class="comment">// from the Completion Queue associated with the Send Queue. This means if one works with</span></span><br><span class="line">  <span class="comment">// a Queue Pair that was configured to work with Unsignaled Completions, he must make</span></span><br><span class="line">  <span class="comment">// sure that occasionally (before the Send Queue is full with outstanding Send Requests)</span></span><br><span class="line">  <span class="comment">// a Send Request that generate Work Completion will be posted.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Not following this rule may lead to a case that the Send Queue is full with Send</span></span><br><span class="line">  <span class="comment">// Requests that won&#x27;t generate Work Completion:</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">//  - The Send Queue is full, so no new Send Requests can be posted to it 发送队列满了, 那么就没法发一个能生成 work completion 的 send request 了</span></span><br><span class="line">  <span class="comment">//  - The Send Queue can&#x27;t be emptied, since no Work Completion can be generated anymore</span></span><br><span class="line">  <span class="comment">//    (the reason is that no Work Completion, that can generate Work Completion that</span></span><br><span class="line">  <span class="comment">//    polling it will empty the Send Queue, can be posted)</span></span><br><span class="line">  <span class="comment">//  - The status of all posted Send Request is considered unknown</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 所有已发送的 signaled/unsignaled send request, 都被认为是未完成的. 他们什么时候算是完成的 ？在他们之后发送的 send requests 从 </span></span><br><span class="line">  <span class="comment">// 关联着 send queue 的 completion queue 被轮询到后</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 说的有点儿绕, 其实核心表达的是这篇材料里边有个 case https://www.openfabrics.org/images/eventpresos/workshops2013/IBUG/2013_UserDay_Thur_1400_Bob-Russell-programming-concepts.pdf</span></span><br><span class="line">  <span class="comment">// rdma ping pong 的例子，核心表达的意思是 write 可以不用 signal 是否完成, 因为 client 侧 write 之后, 随后直接 read, 可以直接等 read 的 cq, 如果 read cq 报错, 如果是之前的 write 报错, </span></span><br><span class="line">  <span class="comment">// 那么等 read 的 cq, 也会返回相应的报错信息</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// 也就是说如果 send with unsignaled completions, 怎么确认 send 完成了, 一定需要不时的, 注意要在 send queue 未被未完成的 send requests 占满之前,</span></span><br><span class="line">  <span class="comment">// 发送一个能生成 work completion 的 send request</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// 不按上边来的话, 可能会出现 send queue 里边的 send requests 都不会产生 work compeltion, 具体来说可能会出现如下现象</span></span><br><span class="line">  <span class="comment">// 1. send queue 满, 新的请求无法发送</span></span><br><span class="line">  <span class="comment">// 2. send queue 无法为空, 因为没有请求会生成 work competion, 所以也就无法从 send queue 里边清数据. 其实这点和 3 相关, 说的是一个意思</span></span><br><span class="line">  <span class="comment">// 3. 所有已发送的请求, 状态未知.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 所以在 NCCL 这里的实现上 slot 0 的数据使用 signaled, 而其他 slot 的数据使用 unsignaled 发送</span></span><br><span class="line">  <span class="keyword">if</span> (slot == <span class="number">0</span>) &#123;</span><br><span class="line">    wr.send_flags |= IBV_SEND_SIGNALED;</span><br><span class="line">    wr.wr_id = req - comm-&gt;verbs.reqs;</span><br><span class="line">    req-&gt;events++;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_send_wr</span>* <span class="title">bad_wr</span>;</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_post_send</span>(comm-&gt;qps[<span class="number">0</span>], &amp;wr, &amp;bad_wr));</span><br><span class="line">  comm-&gt;remFifo.fifoTail++;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbIrecv</span><span class="params">(<span class="keyword">void</span>* recvComm, <span class="keyword">int</span> n, <span class="keyword">void</span>** data, <span class="keyword">int</span>* sizes, <span class="keyword">int</span>* tags, <span class="keyword">void</span>** mhandles, <span class="keyword">void</span>** request)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRecvComm</span>* <span class="title">comm</span> =</span> (struct ncclIbRecvComm*)recvComm;</span><br><span class="line">  <span class="keyword">if</span> (comm-&gt;ready == <span class="number">0</span>) <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclRecvCheck</span>(comm));</span><br><span class="line">  <span class="keyword">if</span> (comm-&gt;ready == <span class="number">0</span>) &#123; *request = <span class="literal">NULL</span>; <span class="keyword">return</span> ncclSuccess; &#125;</span><br><span class="line">  <span class="keyword">if</span> (n &gt; NCCL_NET_IB_MAX_RECVS) <span class="keyword">return</span> ncclInternalError;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>* <span class="title">req</span>;</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbGetRequest</span>(&amp;comm-&gt;verbs, &amp;req));</span><br><span class="line">  req-&gt;type = NCCL_NET_IB_REQ_RECV;</span><br><span class="line">  req-&gt;addr = &amp;comm-&gt;sock.addr;</span><br><span class="line">  req-&gt;nreqs = n;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) req-&gt;recv.sizes[i] = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_recv_wr</span> <span class="title">wr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;wr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(wr));</span><br><span class="line">  wr.wr_id = req - comm-&gt;verbs.reqs;</span><br><span class="line"></span><br><span class="line">  wr.sg_list = <span class="literal">NULL</span>;</span><br><span class="line">  wr.num_sge = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TIME_START</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++) &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp</span>* <span class="title">qp</span> =</span> comm-&gt;qps[q];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_recv_wr</span>* <span class="title">bad_wr</span>;</span></span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_post_recv</span>(qp, &amp;wr, &amp;bad_wr));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">TIME_STOP</span>(<span class="number">1</span>);</span><br><span class="line">  req-&gt;events = comm-&gt;nqps;</span><br><span class="line"></span><br><span class="line">  *request = req;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Post to FIFO to notify sender</span></span><br><span class="line">  <span class="built_in">TIME_START</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbPostFifo</span>(comm, n, data, sizes, tags, mhandles, req));</span><br><span class="line">  <span class="built_in">TIME_STOP</span>(<span class="number">2</span>);</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 由前边的代码可知, ib flush 逻辑用于 gdr flush, 默认开启</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbIflush</span><span class="params">(<span class="keyword">void</span>* recvComm, <span class="keyword">int</span> n, <span class="keyword">void</span>** data, <span class="keyword">int</span>* sizes, <span class="keyword">void</span>** mhandles, <span class="keyword">void</span>** request)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRecvComm</span>* <span class="title">comm</span> =</span> (struct ncclIbRecvComm*)recvComm;</span><br><span class="line">  <span class="keyword">int</span> last = <span class="number">-1</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;n; i++) <span class="keyword">if</span> (sizes[i]) last = i;</span><br><span class="line">  <span class="keyword">if</span> (comm-&gt;gpuFlush.enabled == <span class="number">0</span> || last == <span class="number">-1</span>) <span class="keyword">return</span> ncclSuccess;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Only flush once using the last non-zero receive</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>* <span class="title">req</span>;</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbGetRequest</span>(&amp;comm-&gt;verbs, &amp;req));</span><br><span class="line">  req-&gt;type = NCCL_NET_IB_REQ_FLUSH;</span><br><span class="line">  req-&gt;addr = &amp;comm-&gt;sock.addr;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_mr</span>* <span class="title">mr</span> =</span> (struct ibv_mr*)mhandles[last];</span><br><span class="line"></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_send_wr</span> <span class="title">wr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;wr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(wr));</span><br><span class="line">  wr.wr_id = req - comm-&gt;verbs.reqs;</span><br><span class="line"></span><br><span class="line">  wr.wr.rdma.remote_addr = (<span class="keyword">uint64_t</span>)data[last];</span><br><span class="line">  wr.wr.rdma.rkey = mr-&gt;rkey;</span><br><span class="line">  wr.sg_list = &amp;comm-&gt;gpuFlush.sge;</span><br><span class="line">  wr.num_sge = <span class="number">1</span>;</span><br><span class="line">  wr.opcode = IBV_WR_RDMA_READ;</span><br><span class="line">  wr.send_flags = IBV_SEND_SIGNALED;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">TIME_START</span>(<span class="number">4</span>);</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_send_wr</span>* <span class="title">bad_wr</span>;</span></span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_post_send</span>(comm-&gt;gpuFlush.qp, &amp;wr, &amp;bad_wr));</span><br><span class="line">  <span class="built_in">TIME_STOP</span>(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  *request = req;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 确认数据收发是否完成</span></span><br><span class="line"><span class="comment">// 这里的常见错误是网络故障</span></span><br><span class="line"><span class="comment">// NCCL WARN NET/IB : Got completion with error 12, opcode 0, len 0, vendor err 129</span></span><br><span class="line"><span class="comment">// IBV_WC_RETRY_EXC_ERR (12) - Transport Retry Counter Exceeded: The local transport timeout retry counter was exceeded while trying to send this message. This means that the remote side didn&#x27;t send any Ack or Nack. If this happens when sending the first message, usually this mean that the connection attributes are wrong or the remote side isn&#x27;t in a state that it can respond to messages. If this happens after sending the first message, usually it means that the remote QP isn&#x27;t available anymore. Relevant for RC QPs.</span></span><br><span class="line"><span class="comment">// https://github.com/NVIDIA/nccl/issues/426</span></span><br><span class="line"><span class="comment">// 如果是训练启动时就报 error 12, 那多半是 qp 参数配置问题; 如果是训练过程中报错, 有可能是代码问题, 若相信 NCCL 的代码质量, 那当然更大概率是网络问题, 比如 roce v2 网络下, 对端网卡, 或者是交换机出现丢包, 导致一直未回复 ack, 最终导致超时发生</span></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbTest</span><span class="params">(<span class="keyword">void</span>* request, <span class="keyword">int</span>* done, <span class="keyword">int</span>* sizes)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span> *<span class="title">r</span> =</span> (struct ncclIbRequest*)request;</span><br><span class="line">  *done = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (r-&gt;events == <span class="number">0</span>) &#123;</span><br><span class="line">      *done = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> (sizes &amp;&amp; r-&gt;type == NCCL_NET_IB_REQ_RECV) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;r-&gt;nreqs; i++) sizes[i] = r-&gt;recv.sizes[i];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbFreeRequest</span>(r));</span><br><span class="line">      <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> wrDone = <span class="number">0</span>;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">ibv_wc</span> <span class="title">wcs</span>[4];</span></span><br><span class="line">    <span class="built_in">TIME_START</span>(<span class="number">3</span>);</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_poll_cq</span>(r-&gt;verbs-&gt;cq, <span class="number">4</span>, wcs, &amp;wrDone));</span><br><span class="line">    <span class="keyword">if</span> (wrDone == <span class="number">0</span>) &#123; <span class="built_in">TIME_CANCEL</span>(<span class="number">3</span>); &#125; <span class="keyword">else</span> &#123; <span class="built_in">TIME_STOP</span>(<span class="number">3</span>); &#125;</span><br><span class="line">    <span class="keyword">if</span> (wrDone == <span class="number">0</span>) <span class="keyword">return</span> ncclSuccess;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> w=<span class="number">0</span>; w&lt;wrDone; w++) &#123;</span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">ibv_wc</span> *<span class="title">wc</span> =</span> wcs+w;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// https://www.rdmamojo.com/2013/02/15/ibv_poll_cq/</span></span><br><span class="line">      <span class="comment">// Not all wc attributes are always valid. If the completion status is other than IBV_WC_SUCCESS, only the following attributes are valid:</span></span><br><span class="line">      <span class="comment">// wr_id</span></span><br><span class="line">      <span class="comment">// status</span></span><br><span class="line">      <span class="comment">// qp_num</span></span><br><span class="line">      <span class="comment">// vendor_err</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (wc-&gt;status != IBV_WC_SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">char</span> line[SOCKET_NAME_MAXLEN+<span class="number">1</span>];</span><br><span class="line">        <span class="built_in">WARN</span>(<span class="string">&quot;NET/IB : Got completion from peer %s with error %d, opcode %d, len %d, vendor err %d&quot;</span>,</span><br><span class="line">             <span class="built_in">ncclSocketToString</span>(r-&gt;addr, line), wc-&gt;status, wc-&gt;opcode, wc-&gt;byte_len, wc-&gt;vendor_err); <span class="comment">// 这里增加打印 qp num 会更方便 trace</span></span><br><span class="line">        <span class="keyword">return</span> ncclRemoteError;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>* <span class="title">req</span> =</span> r-&gt;verbs-&gt;reqs+(wc-&gt;wr_id &amp; <span class="number">0xff</span>);      </span><br><span class="line">      <span class="keyword">if</span> (req-&gt;type == NCCL_NET_IB_REQ_SEND) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;req-&gt;nreqs; i++) &#123;</span><br><span class="line">          <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRequest</span>* <span class="title">sendReq</span> =</span> r-&gt;verbs-&gt;reqs+((wc-&gt;wr_id &gt;&gt; (i*<span class="number">8</span>)) &amp; <span class="number">0xff</span>);</span><br><span class="line">          <span class="keyword">if</span> ((sendReq-&gt;events &lt;= <span class="number">0</span>)) <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">          sendReq-&gt;events--;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (req &amp;&amp; wc-&gt;opcode == IBV_WC_RECV_RDMA_WITH_IMM) &#123;</span><br><span class="line">          <span class="keyword">if</span> (req-&gt;type != NCCL_NET_IB_REQ_RECV) <span class="keyword">return</span> ncclInternalError;</span><br><span class="line">          <span class="keyword">if</span> (req-&gt;nreqs &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="comment">// In the case of a multi recv, we only set sizes to 0 or 1.</span></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;req-&gt;nreqs; i++) &#123;</span><br><span class="line">              req-&gt;recv.sizes[i] = (wc-&gt;imm_data &gt;&gt; i) &amp; <span class="number">0x1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            req-&gt;recv.sizes[<span class="number">0</span>] += wc-&gt;imm_data;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        req-&gt;events--;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbCloseSend</span><span class="params">(<span class="keyword">void</span>* sendComm)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbSendComm</span>* <span class="title">comm</span> =</span> (struct ncclIbSendComm*)sendComm;</span><br><span class="line">  <span class="keyword">if</span> (comm) &#123;</span><br><span class="line">    <span class="built_in">close</span>(comm-&gt;sock.fd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++)</span><br><span class="line">      <span class="keyword">if</span> (comm-&gt;qps[q] != <span class="literal">NULL</span>) <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_destroy_qp</span>(comm-&gt;qps[q]));</span><br><span class="line">    <span class="keyword">if</span> (comm-&gt;fifoMr != <span class="literal">NULL</span>) <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_dereg_mr</span>(comm-&gt;fifoMr));</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbDestroyVerbs</span>(&amp;comm-&gt;verbs));</span><br><span class="line">    <span class="built_in">free</span>(comm);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">TIME_PRINT</span>(<span class="string">&quot;IB&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbCloseRecv</span><span class="params">(<span class="keyword">void</span>* recvComm)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbRecvComm</span>* <span class="title">comm</span> =</span> (struct ncclIbRecvComm*)recvComm;</span><br><span class="line">  <span class="keyword">if</span> (comm) &#123;</span><br><span class="line">    <span class="built_in">close</span>(comm-&gt;sock.fd);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> q=<span class="number">0</span>; q&lt;comm-&gt;nqps; q++)</span><br><span class="line">      <span class="keyword">if</span> (comm-&gt;qps[q] != <span class="literal">NULL</span>) <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_destroy_qp</span>(comm-&gt;qps[q]));</span><br><span class="line">    <span class="keyword">if</span> (comm-&gt;gpuFlush.enabled) &#123;</span><br><span class="line">      <span class="keyword">if</span> (comm-&gt;gpuFlush.qp != <span class="literal">NULL</span>) <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_destroy_qp</span>(comm-&gt;gpuFlush.qp));</span><br><span class="line">      <span class="keyword">if</span> (comm-&gt;gpuFlush.hostMr != <span class="literal">NULL</span>) <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_dereg_mr</span>(comm-&gt;gpuFlush.hostMr));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (comm-&gt;remFifo.mr != <span class="literal">NULL</span>) <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_dereg_mr</span>(comm-&gt;remFifo.mr));</span><br><span class="line">    <span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbDestroyVerbs</span>(&amp;comm-&gt;verbs));</span><br><span class="line">    <span class="built_in">free</span>(comm);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbCloseListen</span><span class="params">(<span class="keyword">void</span>* listenComm)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ncclIbListenComm</span>* <span class="title">comm</span> =</span> (struct ncclIbListenComm*)listenComm;</span><br><span class="line">  <span class="keyword">if</span> (comm) &#123;</span><br><span class="line">    <span class="built_in">close</span>(comm-&gt;sock.fd);</span><br><span class="line">    <span class="built_in">free</span>(comm);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ncclNet_t ncclNetIb = &#123;</span><br><span class="line">  <span class="string">&quot;IB&quot;</span>,</span><br><span class="line">  ncclIbInit,</span><br><span class="line">  ncclIbDevices,</span><br><span class="line">  ncclIbGetProperties,</span><br><span class="line">  ncclIbListen,</span><br><span class="line">  ncclIbConnect,</span><br><span class="line">  ncclIbAccept,</span><br><span class="line">  ncclIbRegMr,</span><br><span class="line">  ncclIbRegMrDmaBuf,</span><br><span class="line">  ncclIbDeregMr,</span><br><span class="line">  ncclIbIsend,</span><br><span class="line">  ncclIbIrecv,</span><br><span class="line">  ncclIbIflush,</span><br><span class="line">  ncclIbTest,</span><br><span class="line">  ncclIbCloseSend,</span><br><span class="line">  ncclIbCloseRecv,</span><br><span class="line">  ncclIbCloseListen</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/f3995990.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/f3995990.html" class="post-title-link" itemprop="url">pytorch 1.13 and nccl</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-03 12:27:15" itemprop="dateCreated datePublished" datetime="2023-05-03T12:27:15Z">2023-05-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-05-07 10:15:47" itemprop="dateModified" datetime="2023-05-07T10:15:47Z">2023-05-07</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.4k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ul>
<li>windows 11</li>
<li>wsl2<ul>
<li>ubuntu 18.04</li>
<li>nvidia driver 531.68</li>
<li>cuda 11.6.2</li>
</ul>
</li>
</ul>
<h1 id="pytorch-1-13-1-docker-image"><a href="#pytorch-1-13-1-docker-image" class="headerlink" title="pytorch 1.13.1 docker image"></a>pytorch 1.13.1 docker image</h1><p>docker image</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker pull pytorch/pytorch:1.13.1-cuda11.6-cudnn8-runtime</span><br></pre></td></tr></table></figure>

<p>view nccl version of pytorch</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">docker run -ti --rm pytorch/pytorch:1.13.1-cuda11.6-cudnn8-runtime bash</span><br><span class="line"></span><br><span class="line">python -c &quot;import torch;print(torch.cuda.nccl.version())&quot;</span><br></pre></td></tr></table></figure>

<h1 id="pytorch-1-13-1"><a href="#pytorch-1-13-1" class="headerlink" title="pytorch 1.13.1"></a>pytorch 1.13.1</h1><p><a target="_blank" rel="noopener" href="https://github.com/pytorch/pytorch/tree/v1.13.1">https://github.com/pytorch/pytorch/tree/v1.13.1</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/pytorch/pytorch/tree/v1.13.1#from-source">https://github.com/pytorch/pytorch/tree/v1.13.1#from-source</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/pytorch/pytorch/blob/v1.13.1/CONTRIBUTING.md#tips-and-debugging">https://github.com/pytorch/pytorch/blob/v1.13.1/CONTRIBUTING.md#tips-and-debugging</a></p>
<p><a href="https://zrss.github.io/archives/5a3d0ab7.html">https://zrss.github.io/archives/5a3d0ab7.html</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">conda create -n pytorch-dev python=3.8</span><br><span class="line"></span><br><span class="line">conda activate pytorch-dev</span><br><span class="line"></span><br><span class="line">conda install astunparse numpy ninja pyyaml setuptools cmake cffi typing_extensions future six requests dataclasses</span><br><span class="line">conda install -c pytorch magma-cuda116</span><br><span class="line">conda install mkl mkl-include</span><br><span class="line"></span><br><span class="line">export CMAKE_PREFIX_PATH=$&#123;CONDA_PREFIX:-&quot;$(dirname $(which conda))/../&quot;&#125;</span><br><span class="line"></span><br><span class="line">CUDACXX=/usr/local/cuda/bin/nvcc MAX_JOBS=8 python setup.py develop</span><br></pre></td></tr></table></figure>

<p>如果 setup 过程中出现如下日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Building wheel torch-1.13.0a0+git49444c3</span><br><span class="line">-- Building version 1.13.0a0+git49444c3</span><br><span class="line">Could not find any of CMakeLists.txt, Makefile, setup.py, LICENSE, LICENSE.md, LICENSE.txt in /root/projects/pytorch/third_party/ios-cmake</span><br><span class="line">Did you run &#x27;git submodule update --init --recursive --jobs 0&#x27;?</span><br></pre></td></tr></table></figure>

<p>可以重新 update submodule，再做尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git submodule deinit -f .</span><br><span class="line">git clean -xdf</span><br><span class="line">python setup.py clean</span><br><span class="line">git submodule update --init --recursive --jobs 0</span><br></pre></td></tr></table></figure>

<p>如果 setup 过程中出现如下日志，可以减小 jobs 数（例如上述的 case 为 8），再做尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FAILED: third_party/fbgemm/CMakeFiles/fbgemm_avx2.dir/src/FbgemmI8DepthwiseAvx2.cc.o</span><br><span class="line">/usr/bin/c++ -DFBGEMM_STATIC -I/root/projects/pytorch/third_party/cpuinfo/include -I/root/projects/pytorch/third_party/fbgemm/third_party/asmjit/src -I/root/projects/pytorch/third_party/fbgemm/include -I/root/projects/pytorch/third_party/fbgemm -I/root/projects/pytorch/cmake/../third_party/benchmark/include -isystem /root/projects/pytorch/cmake/../third_party/googletest/googlemock/include -isystem /root/projects/pytorch/cmake/../third_party/googletest/googletest/include -isystem /root/projects/pytorch/third_party/protobuf/src -isystem /root/tools/miniconda3/envs/pytorch-dev/include -isystem /root/projects/pytorch/third_party/gemmlowp -isystem /root/projects/pytorch/third_party/neon2sse -isystem /root/projects/pytorch/third_party/XNNPACK/include -Wno-deprecated -fvisibility-inlines-hidden -DUSE_PTHREADPOOL -fopenmp -Wall -Wextra -Werror -Wno-deprecated-declarations -O3 -DNDEBUG -fPIC -fvisibility=hidden -m64 -mavx2 -mf16c -mfma -std=c++14 -Wno-uninitialized -MD -MT third_party/fbgemm/CMakeFiles/fbgemm_avx2.dir/src/FbgemmI8DepthwiseAvx2.cc.o -MF third_party/fbgemm/CMakeFiles/fbgemm_avx2.dir/src/FbgemmI8DepthwiseAvx2.cc.o.d -o third_party/fbgemm/CMakeFiles/fbgemm_avx2.dir/src/FbgemmI8DepthwiseAvx2.cc.o -c /root/projects/pytorch/third_party/fbgemm/src/FbgemmI8DepthwiseAvx2.cc</span><br><span class="line">c++: internal compiler error: Killed (program cc1plus)</span><br></pre></td></tr></table></figure>

<h1 id="nccl-v2-14-3-1"><a href="#nccl-v2-14-3-1" class="headerlink" title="nccl v2.14.3-1"></a>nccl v2.14.3-1</h1><p><a target="_blank" rel="noopener" href="https://github.com/NVIDIA/nccl/tree/v2.14.3-1">https://github.com/NVIDIA/nccl/tree/v2.14.3-1</a></p>
<p>make (generate header)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd nccl</span><br><span class="line">make -j 8 src.build</span><br></pre></td></tr></table></figure>

<p>如果 make 过程中出现如下日志，可以减小 make 所使用的核数（例如上述的 case 为 8 核），再做尝试</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++: internal compiler error: Killed (program cc1plus)</span><br></pre></td></tr></table></figure>

<p>将 <code>build/include/nccl.h</code> 文件拷贝至 <code>src</code> 目录下</p>
<h2 id="vscode-nccl-in-wsl"><a href="#vscode-nccl-in-wsl" class="headerlink" title="vscode nccl in wsl"></a>vscode nccl in wsl</h2><ol>
<li>config wsl for vscode</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://code.visualstudio.com/docs/cpp/config-wsl">https://code.visualstudio.com/docs/cpp/config-wsl</a></p>
<ol start="2">
<li>install cuda toolkit in wsl</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/cuda/wsl-user-guide/index.html#cuda-support-for-wsl-2">https://docs.nvidia.com/cuda/wsl-user-guide/index.html#cuda-support-for-wsl-2</a></p>
<p><a target="_blank" rel="noopener" href="https://developer.nvidia.com/cuda-11-6-2-download-archive?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=WSL-Ubuntu&amp;target_version=2.0&amp;target_type=deb_local">https://developer.nvidia.com/cuda-11-6-2-download-archive?target_os=Linux&amp;target_arch=x86_64&amp;Distribution=WSL-Ubuntu&amp;target_version=2.0&amp;target_type=deb_local</a></p>
<ol start="3">
<li>add includePath for vscode</li>
</ol>
<p><code>/usr/local/cuda/targets/x86_64-linux/include/</code></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/50758925.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/50758925.html" class="post-title-link" itemprop="url">wsl2 docker</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-05-03 11:32:15" itemprop="dateCreated datePublished" datetime="2023-05-03T11:32:15Z">2023-05-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2023-05-07 10:18:08" itemprop="dateModified" datetime="2023-05-07T10:18:08Z">2023-05-07</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>964</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <ol>
<li>参考 <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/binaries/#install-static-binaries">https://docs.docker.com/engine/install/binaries/#install-static-binaries</a> 使用二进制方式安装 docker engine 18.09.9</li>
<li>参考 <a target="_blank" rel="noopener" href="https://learn.microsoft.com/en-us/windows/wsl/wsl-config#systemd-support">https://learn.microsoft.com/en-us/windows/wsl/wsl-config#systemd-support</a> 开启 wsl2 支持 systemd</li>
<li>参考 <a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/linux-postinstall/#configure-docker-to-start-on-boot-with-systemd">https://docs.docker.com/engine/install/linux-postinstall/#configure-docker-to-start-on-boot-with-systemd</a> 配置 docker engine systemd, systemd 配置文件 <a target="_blank" rel="noopener" href="https://github.com/moby/moby/tree/master/contrib/init/systemd">https://github.com/moby/moby/tree/master/contrib/init/systemd</a></li>
<li>参考 <a target="_blank" rel="noopener" href="https://docs.docker.com/config/daemon/systemd/#httphttps-proxy">https://docs.docker.com/config/daemon/systemd/#httphttps-proxy</a> 配置 docker daemon proxy</li>
</ol>
<p>完成上述配置后发现 <code>docker info</code> 非常慢，并且尝试 <code>docker run</code> 容器镜像会有如下报错</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker: Error response from daemon: all SubConns are in TransientFailure, latest connection error: connection error: desc = &quot;transport: Error while dialing dial unix:///run/containerd/containerd.sock: timeout&quot;: unavailable.</span><br></pre></td></tr></table></figure>

<p>参考 <a target="_blank" rel="noopener" href="https://github.com/sous-chefs/docker/issues/1062">https://github.com/sous-chefs/docker/issues/1062</a> 发现疑似 master 分支的 systemd 配置引入了不兼容修改，导致使用 master 分支的 systemd 配置，无法完全启动 docker engine 18.09.9。修改 systemd 配置为 <a target="_blank" rel="noopener" href="https://github.com/moby/moby/tree/v18.09.9/contrib/init/systemd">https://github.com/moby/moby/tree/v18.09.9/contrib/init/systemd</a> 后，<code>docker info</code> 以及 <code>docker run</code> 功能恢复正常</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/fee9442e.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/fee9442e.html" class="post-title-link" itemprop="url">golang handle signals</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-12-25 15:00:00 / 修改时间：07:42:38" itemprop="dateCreated datePublished" datetime="2022-12-25T15:00:00Z">2022-12-25</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://pkg.go.dev/os/signal#hdr-Default_behavior_of_signals_in_Go_programs">https://pkg.go.dev/os/signal#hdr-Default_behavior_of_signals_in_Go_programs</a></p>
<p><a target="_blank" rel="noopener" href="https://pkg.go.dev/os/signal#hdr-Changing_the_behavior_of_signals_in_Go_programs">https://pkg.go.dev/os/signal#hdr-Changing_the_behavior_of_signals_in_Go_programs</a></p>
<blockquote>
<p>By default, a synchronous signal is converted into a run-time panic. A SIGHUP, SIGINT, or SIGTERM signal causes the program to exit. </p>
<p>Notify disables the default behavior for a given set of asynchronous signals and instead delivers them over one or more registered channels. Specifically, it applies to the signals SIGHUP, SIGINT, SIGQUIT, SIGABRT, and SIGTERM. </p>
</blockquote>
<p>但是别忘了会有 race 的情况, 下边通过 bash shell 脚本来启动 golang 进程做一个示例</p>
<p>test-signal</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;os/signal&quot;</span></span><br><span class="line">	<span class="string">&quot;syscall&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">	signalCh := <span class="built_in">make</span>(<span class="keyword">chan</span> os.Signal, <span class="number">2</span>)</span><br><span class="line">	signal.Notify(signalCh, syscall.SIGINT, syscall.SIGTERM)</span><br><span class="line">	fmt.Printf(<span class="string">&quot;notify signals\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">		sig := &lt;- signalCh</span><br><span class="line">		fmt.Printf(<span class="string">&quot;receive signal %v\n&quot;</span>, sig)</span><br><span class="line">	&#125;()</span><br><span class="line"></span><br><span class="line">	fmt.Printf(<span class="string">&quot;wait signal\n&quot;</span>)</span><br><span class="line">	time.Sleep(time.Minute)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>test1.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">./test-signal &amp;</span><br><span class="line">pid=$!</span><br><span class="line"></span><br><span class="line">echo &quot;test-signal pid: $pid&quot;</span><br><span class="line"></span><br><span class="line">kill $pid</span><br><span class="line">wait $pid</span><br><span class="line"></span><br><span class="line">exit_code=$?</span><br><span class="line">echo &quot;test-signal exit_code: $exit_code&quot;</span><br></pre></td></tr></table></figure>

<p>test2.sh</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">./test-signal &amp;</span><br><span class="line">pid=$!</span><br><span class="line"></span><br><span class="line">echo &quot;test-signal pid: $pid&quot;</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> important</span></span><br><span class="line">sleep 1</span><br><span class="line"><span class="meta">#</span><span class="bash"></span></span><br><span class="line"><span class="bash"></span></span><br><span class="line">kill $pid</span><br><span class="line">wait $pid</span><br><span class="line"></span><br><span class="line">exit_code=$?</span><br><span class="line">echo &quot;test-signal exit_code: $exit_code&quot;</span><br></pre></td></tr></table></figure>

<p>test1.sh 的执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">test-signal pid: 4878</span><br><span class="line">test1.sh: line 7:  4878 Terminated: 15          ./test-signal</span><br><span class="line">test-signal exit_code: 143</span><br></pre></td></tr></table></figure>

<p>test2.sh 的执行结果</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">test-signal pid: 4880</span><br><span class="line">notify signals</span><br><span class="line">wait signal</span><br><span class="line">receive signal terminated</span><br></pre></td></tr></table></figure>

<h1 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h1><ol>
<li>golang 程序处理 TERM 信号的默认行为是退出, 且退出码为 143 (128 + 15), 15 为 TERM</li>
<li>使用 signal.Notify 可以修改 golang 程序处理 TERM 信号的默认行为; 但是如果 golang 程序启动后过快接收到 TERM 信号 (在 signal.Notify 执行完成之前), 则会导致程序直接退出 (默认行为)</li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/219bf6b1.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/219bf6b1.html" class="post-title-link" itemprop="url">gorm v1 logger</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-12-17 10:32:00 / 修改时间：04:11:28" itemprop="dateCreated datePublished" datetime="2022-12-17T10:32:00Z">2022-12-17</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.2k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p><a target="_blank" rel="noopener" href="https://v1.gorm.io/docs/">https://v1.gorm.io/docs/</a></p>
<p><a target="_blank" rel="noopener" href="https://v1.gorm.io/docs/logger.html">https://v1.gorm.io/docs/logger.html</a></p>
<blockquote>
<p>Refer GORM’s default logger for how to customize it</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/jinzhu/gorm/blob/v1.9.16/logger.go">https://github.com/jinzhu/gorm/blob/v1.9.16/logger.go</a></p>
<p>gorm v1 print log</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">print</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	s.logger.Print(v...)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">log</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s != <span class="literal">nil</span> &amp;&amp; s.logMode == detailedLogMode &#123;</span><br><span class="line">		s.<span class="built_in">print</span>(<span class="built_in">append</span>([]<span class="keyword">interface</span>&#123;&#125;&#123;<span class="string">&quot;log&quot;</span>, fileWithLineNum()&#125;, v...)...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">slog</span><span class="params">(sql <span class="keyword">string</span>, t time.Time, vars ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> s.logMode == detailedLogMode &#123;</span><br><span class="line">		s.<span class="built_in">print</span>(<span class="string">&quot;sql&quot;</span>, fileWithLineNum(), NowFunc().Sub(t), sql, vars, s.RowsAffected)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gorm v1 print error</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// AddError add error to the db</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">AddError</span><span class="params">(err error)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> err != ErrRecordNotFound &#123;</span><br><span class="line">			<span class="keyword">if</span> s.logMode == defaultLogMode &#123;</span><br><span class="line">				<span class="keyword">go</span> s.<span class="built_in">print</span>(<span class="string">&quot;error&quot;</span>, fileWithLineNum(), err)</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				s.log(err)</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			errors := Errors(s.GetErrors())</span><br><span class="line">			errors = errors.Add(err)</span><br><span class="line">			<span class="keyword">if</span> <span class="built_in">len</span>(errors) &gt; <span class="number">1</span> &#123;</span><br><span class="line">				err = errors</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		s.Error = err</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> err</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>gorm v1 print sql</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// trace print sql log</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(scope *Scope)</span> <span class="title">trace</span><span class="params">(t time.Time)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(scope.SQL) &gt; <span class="number">0</span> &#123;</span><br><span class="line">		scope.db.slog(scope.SQL, t, scope.SQLVars...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>因此在打开 gorm v1 LogMode 的时候</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LogMode set log mode, `true` for detailed logs, `false` for no log, default, will only print error logs</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(s *DB)</span> <span class="title">LogMode</span><span class="params">(enable <span class="keyword">bool</span>)</span> *<span class="title">DB</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> enable &#123;</span><br><span class="line">		s.logMode = detailedLogMode</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		s.logMode = noLogMode</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> s</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会进入到 <code>s.print log</code>, <code>s.print sql</code> 的打印逻辑</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://www.soberkoder.com/go-gorm-logging/">https://www.soberkoder.com/go-gorm-logging/</a></p>
</blockquote>
<p>如若需要自定义 gorm v1 logger 可以参考如下代码段</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GormLogger struct</span></span><br><span class="line"><span class="keyword">type</span> GormLogger <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Print - Log Formatter</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(*GormLogger)</span> <span class="title">Print</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> v[<span class="number">0</span>] == <span class="string">&quot;sql&quot;</span> &#123;</span><br><span class="line">    log.WithFields(</span><br><span class="line">      log.Fields&#123;</span><br><span class="line">        <span class="string">&quot;module&quot;</span>:        <span class="string">&quot;gorm&quot;</span>,</span><br><span class="line">        <span class="string">&quot;type&quot;</span>:          <span class="string">&quot;sql&quot;</span>,</span><br><span class="line">        <span class="string">&quot;rows_returned&quot;</span>: v[<span class="number">5</span>],</span><br><span class="line">        <span class="string">&quot;src&quot;</span>:           v[<span class="number">1</span>],</span><br><span class="line">        <span class="comment">//&quot;values&quot;:        v[4],</span></span><br><span class="line">        <span class="string">&quot;duration&quot;</span>:      v[<span class="number">2</span>],</span><br><span class="line">      &#125;,</span><br><span class="line">    ).Info(v[<span class="number">3</span>])</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    log.WithFields(log.Fields&#123;<span class="string">&quot;module&quot;</span>: <span class="string">&quot;gorm&quot;</span>, <span class="string">&quot;type&quot;</span>: <span class="string">&quot;log&quot;</span>, <span class="string">&quot;src&quot;</span>: v[<span class="number">1</span>]&#125;).Print(v[<span class="number">2</span>:]...)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外也可以根据 <code>duration</code> 实现客户端的 slow sql 打印</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/52d00230.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/52d00230.html" class="post-title-link" itemprop="url">Docker container -i -t</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-08-14 02:56:55 / 修改时间：08:43:57" itemprop="dateCreated datePublished" datetime="2022-08-14T02:56:55Z">2022-08-14</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">笔记</span></a>
        </span>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="docker"><a href="#docker" class="headerlink" title="docker"></a>docker</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/run/#foreground">https://docs.docker.com/engine/reference/run/#foreground</a></p>
<p>-t : Allocate a pseudo-tty<br>-i : Keep STDIN open even if not attached</p>
</blockquote>
<p><code>docker run -t</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker pull ubuntu:bionic-20200713</span><br><span class="line"></span><br><span class="line">docker run -t --rm ubuntu:bionic-20200713 /bin/bash</span><br><span class="line">root@9a7a115ff8d2:/# ls</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>启动容器无 <code>-i</code> 参数时，执行 <code>ls</code> 等命令无回显，执行 <code>exit</code> 命令无法退出 container terminal</p>
<p><code>docker run -i</code></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -i --rm ubuntu:bionic-20200713 /bin/bash</span><br><span class="line">echo hello</span><br><span class="line">hello</span><br><span class="line">exit</span><br></pre></td></tr></table></figure>

<p>启动容器无 <code>-t</code> 参数时，缺少常用的 terminal 功能，例如无当前登陆用户提示；但执行 <code>ls</code> 等命令正常有回显，且执行 <code>exit</code> 命令可退出</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48368411/what-is-docker-run-it-flag">https://stackoverflow.com/questions/48368411/what-is-docker-run-it-flag</a></p>
<p>Without <code>-t</code> tag one can still interact with the container, but with it, you’ll have a nicer, more features terminal.</p>
</blockquote>
<h1 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.24/#container-v1-core">https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.24/#container-v1-core</a></p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Variables for interactive containers, these have very specialized use-cases (e.g. debugging)</span></span><br><span class="line"><span class="comment">// and shouldn&#x27;t be used for general purpose containers.</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Whether this container should allocate a buffer for stdin in the container runtime. If this</span></span><br><span class="line"><span class="comment">// is not set, reads from stdin in the container will always result in EOF.</span></span><br><span class="line"><span class="comment">// Default is false.</span></span><br><span class="line"><span class="comment">// +optional</span></span><br><span class="line">Stdin <span class="keyword">bool</span> <span class="string">`json:&quot;stdin,omitempty&quot; protobuf:&quot;varint,16,opt,name=stdin&quot;`</span></span><br><span class="line"><span class="comment">// Whether the container runtime should close the stdin channel after it has been opened by</span></span><br><span class="line"><span class="comment">// a single attach. When stdin is true the stdin stream will remain open across multiple attach</span></span><br><span class="line"><span class="comment">// sessions. If stdinOnce is set to true, stdin is opened on container start, is empty until the</span></span><br><span class="line"><span class="comment">// first client attaches to stdin, and then remains open and accepts data until the client disconnects,</span></span><br><span class="line"><span class="comment">// at which time stdin is closed and remains closed until the container is restarted. If this</span></span><br><span class="line"><span class="comment">// flag is false, a container processes that reads from stdin will never receive an EOF.</span></span><br><span class="line"><span class="comment">// Default is false</span></span><br><span class="line"><span class="comment">// +optional</span></span><br><span class="line">StdinOnce <span class="keyword">bool</span> <span class="string">`json:&quot;stdinOnce,omitempty&quot; protobuf:&quot;varint,17,opt,name=stdinOnce&quot;`</span></span><br><span class="line"><span class="comment">// Whether this container should allocate a TTY for itself, also requires &#x27;stdin&#x27; to be true.</span></span><br><span class="line"><span class="comment">// Default is false.</span></span><br><span class="line"><span class="comment">// +optional</span></span><br><span class="line">TTY <span class="keyword">bool</span> <span class="string">`json:&quot;tty,omitempty&quot; protobuf:&quot;varint,18,opt,name=tty&quot;`</span></span><br></pre></td></tr></table></figure>

<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">config := &amp;runtimeapi.ContainerConfig&#123;</span><br><span class="line">	Metadata: &amp;runtimeapi.ContainerMetadata&#123;</span><br><span class="line">		Name:    container.Name,</span><br><span class="line">		Attempt: restartCountUint32,</span><br><span class="line">	&#125;,</span><br><span class="line">	Image:       &amp;runtimeapi.ImageSpec&#123;Image: imageRef&#125;,</span><br><span class="line">	Command:     command,</span><br><span class="line">	Args:        args,</span><br><span class="line">	WorkingDir:  container.WorkingDir,</span><br><span class="line">	Labels:      newContainerLabels(container, pod),</span><br><span class="line">	Annotations: newContainerAnnotations(container, pod, restartCount, opts),</span><br><span class="line">	Devices:     makeDevices(opts),</span><br><span class="line">	Mounts:      m.makeMounts(opts, container),</span><br><span class="line">	LogPath:     containerLogsPath,</span><br><span class="line">	Stdin:       container.Stdin,</span><br><span class="line">	StdinOnce:   container.StdinOnce,</span><br><span class="line">	Tty:         container.TTY,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="use-conda-env-in-docker"><a href="#use-conda-env-in-docker" class="headerlink" title="use conda env in docker"></a>use conda env in docker</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://pythonspeed.com/articles/activate-conda-dockerfile/">https://pythonspeed.com/articles/activate-conda-dockerfile/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.conda.io/projects/conda/en/latest/commands/run.html">https://docs.conda.io/projects/conda/en/latest/commands/run.html</a></p>
</blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conda run --no-capture-output -n my-python-env python --version</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/4c123add.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/4c123add.html" class="post-title-link" itemprop="url">mlnx ofed</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-19 14:11:00 / 修改时间：14:04:45" itemprop="dateCreated datePublished" datetime="2022-06-19T14:11:00Z">2022-06-19</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>2 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="mlnx-cx-adapter-card-firmware"><a href="#mlnx-cx-adapter-card-firmware" class="headerlink" title="mlnx cx adapter card firmware"></a>mlnx cx adapter card firmware</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://network.nvidia.com/support/firmware/connectx4ib/">https://network.nvidia.com/support/firmware/connectx4ib/</a></p>
</blockquote>
<ul>
<li>12.28.2006 – newer, current versions</li>
<li>12.28.1002 – old</li>
<li>12.27.4000 – older</li>
</ul>
<p>注意到 mlnx ofed Additional Firware Version Supported 一般是前几个 firmware 版本中的一个</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://network.nvidia.com/support/firmware/connectx5ib/">https://network.nvidia.com/support/firmware/connectx5ib/</a></p>
</blockquote>
<ul>
<li>16.28.2006 – newer</li>
<li>16.28.1002 – old</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://network.nvidia.com/support/firmware/connectx6dx/">https://network.nvidia.com/support/firmware/connectx6dx/</a></p>
</blockquote>
<ul>
<li>22.28.2006 – newer</li>
<li>22.28.1002 – old</li>
</ul>
<h1 id="mlnx-ofed"><a href="#mlnx-ofed" class="headerlink" title="mlnx ofed"></a>mlnx ofed</h1><p>容器镜像中安装的 mlnx ofed，与宿主机中安装的 mlnx ofed 有何联系？</p>
<p>其实并无联系，仅仅与宿主机 mlnx 网卡型号，及其 firmware 版本有关系</p>
<p>以 mlnx ofed LTS version 5.4-3.1.0.0 为例，在其 Release Notes 中明确提到了该 ofed 配套的 firmware 版本</p>
<blockquote>
<p>不同 OS 版本，均指向同一 Release Notes</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/networking/display/MLNXOFEDv543100/Release+Notes">https://docs.nvidia.com/networking/display/MLNXOFEDv543100/Release+Notes</a></p>
<p>支持的网卡及其速率</p>
<ul>
<li>ConnectX-4<ul>
<li>Infiniband: …</li>
<li>Ethernet: 100Gb, …</li>
</ul>
</li>
<li>ConnectX-5<ul>
<li>Infiniband: …</li>
<li>Ethernet: 100Gb, …</li>
</ul>
</li>
<li>ConnectX-6 Dx<ul>
<li>Ethernet: 100Gb, …</li>
</ul>
</li>
</ul>
<p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/networking/display/MLNXOFEDv543100/General+Support#GeneralSupport-SupportedNICFirmwareVersions">https://docs.nvidia.com/networking/display/MLNXOFEDv543100/General+Support#GeneralSupport-SupportedNICFirmwareVersions</a></p>
<blockquote>
<p>Upgrading MLNX_OFED on a cluster requires upgrading all of its nodes to the newest version as well</p>
</blockquote>
<blockquote>
<p>This current version is tested with the following NVIDIA NIC firmware versions</p>
</blockquote>
<blockquote>
<p>Firmware versions listed are the minimum supported versions</p>
</blockquote>
<table>
<thead>
<tr>
<th>NIC</th>
<th>Recommended Firmware Version</th>
<th>Additional Firmware Version Supported</th>
</tr>
</thead>
<tbody><tr>
<td>cx4</td>
<td>12.28.2006</td>
<td>12.28.2006</td>
</tr>
<tr>
<td>cx5</td>
<td>16.31.2006</td>
<td>16.31.1014</td>
</tr>
<tr>
<td>cx6 dx</td>
<td>22.31.2006</td>
<td>22.31.1014</td>
</tr>
</tbody></table>
<p>该 mlnx ofed 5.4-3.1.0.0 驱动要求的 <strong>最小</strong> firmware 版本，但是注意到 mlnx ofed 从 5.4 版本才开始增加 <code>minimum supported versions</code> 的描述</p>
<p>与之相比，mlnx ofed LTS version 4.9-4.1.7.0 驱动要求的 firmware 版本如下</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.nvidia.com/networking/display/MLNXOFEDv494170/General+Support+in+MLNX_OFED#GeneralSupportinMLNX_OFED-SupportedNICsFirmwareVersions">https://docs.nvidia.com/networking/display/MLNXOFEDv494170/General+Support+in+MLNX_OFED#GeneralSupportinMLNX_OFED-SupportedNICsFirmwareVersions</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>NIC</th>
<th>Recommended Firmware Version</th>
<th>Additional Firmware Version Supported</th>
</tr>
</thead>
<tbody><tr>
<td>cx4</td>
<td>12.28.2006</td>
<td>12.27.4000</td>
</tr>
<tr>
<td>cx5</td>
<td>16.28.2006</td>
<td>16.27.2008</td>
</tr>
<tr>
<td>cx6 dx</td>
<td>22.28.2006</td>
<td>NA</td>
</tr>
</tbody></table>
<h1 id="identifying-adapter-cards"><a href="#identifying-adapter-cards" class="headerlink" title="identifying adapter cards"></a>identifying adapter cards</h1><p><a target="_blank" rel="noopener" href="https://network.nvidia.com/support/firmware/identification/">https://network.nvidia.com/support/firmware/identification/</a></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ibv_devinfo</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/e3ce3305.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/archives/e3ce3305.html" class="post-title-link" itemprop="url">use docker container in modelarts training service</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-06-12 15:06:00 / 修改时间：07:11:18" itemprop="dateCreated datePublished" datetime="2022-06-12T15:06:00Z">2022-06-12</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>4.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>4 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>目标：构建有如下软件的容器镜像，并使用华为云 ModelArts 训练服务运行</p>
<ul>
<li>ubuntu-18.04</li>
<li>cuda-10.2</li>
<li>python-3.7.13</li>
<li>pytorch-1.8.1</li>
</ul>
<h1 id="1-准备-context-文件夹"><a href="#1-准备-context-文件夹" class="headerlink" title="1. 准备 context 文件夹"></a>1. 准备 context 文件夹</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p context</span><br></pre></td></tr></table></figure>

<h2 id="1-1-准备文件"><a href="#1-1-准备文件" class="headerlink" title="1.1. 准备文件"></a>1.1. 准备文件</h2><h3 id="1-1-1-pip-conf"><a href="#1-1-1-pip-conf" class="headerlink" title="1.1.1. pip.conf"></a>1.1.1. pip.conf</h3><blockquote>
<p>使用华为开源镜像站 pypi 配置</p>
<p><a target="_blank" rel="noopener" href="https://mirrors.huaweicloud.com/home">https://mirrors.huaweicloud.com/home</a></p>
</blockquote>
<p>文件内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[global]</span><br><span class="line">index-url = https://repo.huaweicloud.com/repository/pypi/simple</span><br><span class="line">trusted-host = repo.huaweicloud.com</span><br><span class="line">timeout = 120</span><br></pre></td></tr></table></figure>

<h3 id="1-1-2-torch-whl"><a href="#1-1-2-torch-whl" class="headerlink" title="1.1.2. torch*.whl"></a>1.1.2. torch*.whl</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://pytorch.org/get-started/previous-versions/#v181">https://pytorch.org/get-started/previous-versions/#v181</a></p>
</blockquote>
<p>在该地址上 <a target="_blank" rel="noopener" href="https://download.pytorch.org/whl/torch_stable.html">https://download.pytorch.org/whl/torch_stable.html</a> 搜索并下载如下 whl</p>
<ul>
<li>torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl</li>
<li>torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl</li>
<li>torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl</li>
</ul>
<h3 id="1-1-3-Miniconda3"><a href="#1-1-3-Miniconda3" class="headerlink" title="1.1.3. Miniconda3"></a>1.1.3. Miniconda3</h3><blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.conda.io/en/latest/miniconda.html">https://docs.conda.io/en/latest/miniconda.html</a></p>
<p>Miniconda3-py37_4.12.0-Linux-x86_64.sh</p>
</blockquote>
<p>使用该地址 <a target="_blank" rel="noopener" href="https://repo.anaconda.com/miniconda/Miniconda3-py37_4.12.0-Linux-x86_64.sh">https://repo.anaconda.com/miniconda/Miniconda3-py37_4.12.0-Linux-x86_64.sh</a>, 下载 miniconda3 安装文件</p>
<h2 id="1-2-context-文件夹内容"><a href="#1-2-context-文件夹内容" class="headerlink" title="1.2. context 文件夹内容"></a>1.2. context 文件夹内容</h2><p>将上述文件放置在 context 文件夹内</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">context</span><br><span class="line">├── Miniconda3-py37_4.12.0-Linux-x86_64.sh</span><br><span class="line">├── pip.conf</span><br><span class="line">├── torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl</span><br><span class="line">├── torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl</span><br><span class="line">└── torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl</span><br></pre></td></tr></table></figure>

<h1 id="2-编写容器镜像-Dockerfile-文件"><a href="#2-编写容器镜像-Dockerfile-文件" class="headerlink" title="2. 编写容器镜像 Dockerfile 文件"></a>2. 编写容器镜像 Dockerfile 文件</h1><p>在 context 文件夹内新建名为 <strong>Dockerfile</strong> 的空文件，并将下述文件内容写入其中</p>
<figure class="highlight dockerfile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 容器镜像构建主机需要连通公网</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础容器镜像, https://github.com/NVIDIA/nvidia-docker/wiki/CUDA</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># https://docs.docker.com/develop/develop-images/multistage-build/#use-multi-stage-builds</span></span><br><span class="line"><span class="comment"># require Docker Engine &gt;= 17.05</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># builder stage</span></span><br><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">10.2</span>-runtime-ubuntu18.<span class="number">04</span> AS builder</span><br><span class="line"></span><br><span class="line"><span class="comment"># 基础容器镜像的默认用户已经是 root</span></span><br><span class="line"><span class="comment"># USER root</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用华为开源镜像站提供的 pypi 配置</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> mkdir -p /root/.pip/</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> pip.conf /root/.pip/pip.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝待安装文件到基础容器镜像中的 /tmp 目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> Miniconda3-py37_4.12.0-Linux-x86_64.sh \</span></span><br><span class="line"><span class="bash">     torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">     torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">     torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">     ./tmp</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># https://conda.io/projects/conda/en/latest/user-guide/install/linux.html#installing-on-linux</span></span><br><span class="line"><span class="comment"># 安装 Miniconda3 到基础容器镜像的 /home/ma-user/miniconda3 目录中</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> bash /tmp/Miniconda3-py37_4.12.0-Linux-x86_64.sh -b -p /home/ma-user/miniconda3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 Miniconda3 默认 python 环境 (即 /home/ma-user/miniconda3/bin/pip) 安装 torch*.whl</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> <span class="built_in">cd</span> /tmp &amp;&amp; \</span></span><br><span class="line"><span class="bash">    /home/ma-user/miniconda3/bin/pip install --no-cache-dir \</span></span><br><span class="line"><span class="bash">    /tmp/torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">    /tmp/torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl \</span></span><br><span class="line"><span class="bash">    /tmp/torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 构建最终容器镜像</span></span><br><span class="line"><span class="keyword">FROM</span> nvidia/cuda:<span class="number">10.2</span>-runtime-ubuntu18.<span class="number">04</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 vim / curl 工具（依然使用华为开源镜像站）</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> cp -a /etc/apt/sources.list /etc/apt/sources.list.bak &amp;&amp; \</span></span><br><span class="line"><span class="bash">    sed -i <span class="string">&quot;s@http://.*archive.ubuntu.com@http://repo.huaweicloud.com@g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="bash">    sed -i <span class="string">&quot;s@http://.*security.ubuntu.com@http://repo.huaweicloud.com@g&quot;</span> /etc/apt/sources.list &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get update &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get install -y vim curl &amp;&amp; \</span></span><br><span class="line"><span class="bash">    apt-get clean &amp;&amp; \</span></span><br><span class="line"><span class="bash">    mv /etc/apt/sources.list.bak /etc/apt/sources.list</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 增加 ma-user 用户 (uid = 1000, gid = 100)</span></span><br><span class="line"><span class="comment"># 注意到基础容器镜像已存在 gid = 100 的组，因此 ma-user 用户可直接使用</span></span><br><span class="line"><span class="keyword">RUN</span><span class="bash"> useradd -m -d /home/ma-user -s /bin/bash -g 100 -u 1000 ma-user</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从上述 builder stage 中拷贝 /home/ma-user/miniconda3 目录到当前容器镜像的同名目录</span></span><br><span class="line"><span class="keyword">COPY</span><span class="bash"> --chown=ma-user --from=builder /home/ma-user/miniconda3 /home/ma-user/miniconda3</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置容器镜像预置环境变量</span></span><br><span class="line"><span class="comment"># 请务必设置 PYTHONUNBUFFERED=1, 以免日志丢失</span></span><br><span class="line"><span class="keyword">ENV</span> PATH=$PATH:/home/ma-<span class="keyword">user</span>/miniconda3/bin \</span><br><span class="line">    PYTHONUNBUFFERED=<span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置容器镜像默认用户与工作目录</span></span><br><span class="line"><span class="keyword">USER</span> ma-<span class="keyword">user</span></span><br><span class="line"><span class="keyword">WORKDIR</span><span class="bash"> /home/ma-user</span></span><br></pre></td></tr></table></figure>

<h1 id="3-构建容器镜像"><a href="#3-构建容器镜像" class="headerlink" title="3. 构建容器镜像"></a>3. 构建容器镜像</h1><p>context 文件夹内容如下</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">context</span><br><span class="line">├── Dockerfile</span><br><span class="line">├── Miniconda3-py37_4.12.0-Linux-x86_64.sh</span><br><span class="line">├── pip.conf</span><br><span class="line">├── torch-1.8.1+cu102-cp37-cp37m-linux_x86_64.whl</span><br><span class="line">├── torchaudio-0.8.1-cp37-cp37m-linux_x86_64.whl</span><br><span class="line">└── torchvision-0.9.1+cu102-cp37-cp37m-linux_x86_64.whl</span><br></pre></td></tr></table></figure>

<p>执行如下命令构建容器镜像</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 执行构建容器镜像命令之前，请务必切换到 context 目录内</span></span><br><span class="line">cd context</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 执行构建容器镜像命令</span></span><br><span class="line">docker build . -t swr.cn-north-4.myhuaweicloud.com/deep-learning-demo/pytorch:1.8.1-cuda10.2</span><br></pre></td></tr></table></figure>

<p>容器镜像构建成功后，可通过如下命令查询到对应的容器镜像地址</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker images | grep pytorch | grep 1.8.1-cuda10.2</span><br></pre></td></tr></table></figure>

<h1 id="3-pytorch-verification-code"><a href="#3-pytorch-verification-code" class="headerlink" title="3. pytorch verification code"></a>3. pytorch verification code</h1><p><a target="_blank" rel="noopener" href="https://pytorch.org/get-started/locally/#linux-verification">https://pytorch.org/get-started/locally/#linux-verification</a></p>
<p>验证示例代码：pytorch-verification.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">import</span> torch.nn <span class="keyword">as</span> nn</span><br><span class="line"></span><br><span class="line">x = torch.randn(<span class="number">5</span>, <span class="number">3</span>)</span><br><span class="line"><span class="built_in">print</span>(x)</span><br><span class="line"></span><br><span class="line">available_dev = torch.device(<span class="string">&quot;cuda&quot;</span>) <span class="keyword">if</span> torch.cuda.is_available() <span class="keyword">else</span> torch.device(<span class="string">&quot;cpu&quot;</span>)</span><br><span class="line">y = torch.randn(<span class="number">5</span>, <span class="number">3</span>).to(available_dev)</span><br><span class="line"><span class="built_in">print</span>(y)</span><br></pre></td></tr></table></figure>

<h1 id="4-boot-command-in-modelarts-training-service"><a href="#4-boot-command-in-modelarts-training-service" class="headerlink" title="4. boot command in modelarts training service"></a>4. boot command in modelarts training service</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/home/ma-user/miniconda3/bin/python $&#123;MA_JOB_DIR&#125;/code/pytorch-verification.py</span><br></pre></td></tr></table></figure>

<p>cpu 训练作业日志显示示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tensor([[ 0.8945, -0.6946,  0.3807],</span><br><span class="line">        [ 0.6665,  0.3133,  0.8285],</span><br><span class="line">        [-0.5353, -0.1730, -0.5419],</span><br><span class="line">        [ 0.4870,  0.5183,  0.2505],</span><br><span class="line">        [ 0.2679, -0.4996,  0.7919]])</span><br><span class="line">tensor([[ 0.9692,  0.4652,  0.5659],</span><br><span class="line">        [ 2.2032,  1.4157, -0.1755],</span><br><span class="line">        [-0.6296,  0.5466,  0.6994],</span><br><span class="line">        [ 0.2353, -0.0089, -1.9546],</span><br><span class="line">        [ 0.9319,  1.1781, -0.4587]])</span><br></pre></td></tr></table></figure>

<p>gpu 训练作业日志显示示例</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">tensor([[-0.2874, -0.3475,  0.1848],</span><br><span class="line">        [-0.1660, -0.5038, -0.5470],</span><br><span class="line">        [ 0.1289, -0.2400,  2.0829],</span><br><span class="line">        [ 1.6870, -0.0492,  0.1189],</span><br><span class="line">        [ 0.4800, -0.3611, -0.9572]])</span><br><span class="line">tensor([[-0.6710,  0.4095, -0.7370],</span><br><span class="line">        [ 1.4353,  0.9093,  1.7551],</span><br><span class="line">        [ 1.3477, -0.0499,  0.2404],</span><br><span class="line">        [ 1.7489, -1.0203, -0.7875],</span><br><span class="line">        [-1.2104,  0.4593,  1.1365]], device=&#x27;cuda:0&#x27;)</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">340k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">5:09</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
