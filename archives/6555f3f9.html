<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="Docker Resource LimitCPUhttps:&#x2F;&#x2F;docs.docker.com&#x2F;config&#x2F;containers&#x2F;resource_constraints&#x2F;#cpu  --cpu-period: CFS 调度算法中的 cpu 时间分片，默认为 100ms --cpu-quota: CFS quota，在每个 cpu period 分片中，在 cpu 限流前，docker cont">
<meta property="og:type" content="article">
<meta property="og:title" content="resource limit in k8s">
<meta property="og:url" content="https://zrss.github.io/archives/6555f3f9.html">
<meta property="og:site_name" content="随风飘散的记忆">
<meta property="og:description" content="Docker Resource LimitCPUhttps:&#x2F;&#x2F;docs.docker.com&#x2F;config&#x2F;containers&#x2F;resource_constraints&#x2F;#cpu  --cpu-period: CFS 调度算法中的 cpu 时间分片，默认为 100ms --cpu-quota: CFS quota，在每个 cpu period 分片中，在 cpu 限流前，docker cont">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-09-05T02:30:20.748Z">
<meta property="article:modified_time" content="2021-09-13T16:33:11.880Z">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zrss.github.io/archives/6555f3f9.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zrss.github.io/archives/6555f3f9.html","path":"archives/6555f3f9.html","title":"resource limit in k8s"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>resource limit in k8s | 随风飘散的记忆</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">随风飘散的记忆</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Docker-Resource-Limit"><span class="nav-number">1.</span> <span class="nav-text">Docker Resource Limit</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU"><span class="nav-number">1.1.</span> <span class="nav-text">CPU</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory"><span class="nav-number">1.2.</span> <span class="nav-text">Memory</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Docker-Container-OOMKilled-status"><span class="nav-number">1.3.</span> <span class="nav-text">Docker Container OOMKilled status</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#K8S-Resource-Limit"><span class="nav-number">2.</span> <span class="nav-text">K8S Resource Limit</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#CPU-Docker-Container-config"><span class="nav-number">2.1.</span> <span class="nav-text">CPU (Docker Container config)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Memory-Docker-Container-config"><span class="nav-number">2.2.</span> <span class="nav-text">Memory (Docker Container config)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#K8s-OOM-Watcher"><span class="nav-number">2.3.</span> <span class="nav-text">K8s OOM Watcher</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">领略了繁华沧桑<br>谁人过往不相似</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">110</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">55</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/6555f3f9.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          resource limit in k8s
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-09-05 02:30:20" itemprop="dateCreated datePublished" datetime="2021-09-05T02:30:20Z">2021-09-05</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-09-13 16:33:11" itemprop="dateModified" datetime="2021-09-13T16:33:11Z">2021-09-13</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3.6k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>3 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Docker-Resource-Limit"><a href="#Docker-Resource-Limit" class="headerlink" title="Docker Resource Limit"></a>Docker Resource Limit</h1><h2 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/resource_constraints/#cpu">https://docs.docker.com/config/containers/resource_constraints/#cpu</a></p>
<ul>
<li><code>--cpu-period</code>: CFS 调度算法中的 cpu 时间分片，默认为 100ms</li>
<li><code>--cpu-quota</code>: CFS quota，在每个 cpu period 分片中，在 cpu 限流前，docker container 能使用的 cpu 时间</li>
<li><code>--cpuset-cpus</code>: docker container binding to cpu core</li>
<li><code>--cpu-shares</code>: Set this flag to a value greater or less than the default of 1024 to increase or reduce the container’s weight, and give it access to a greater or lesser proportion of the host machine’s CPU cycles. This is only enforced when CPU cycles are constrained. When plenty of CPU cycles are available, all containers use as much CPU as they need. In that way, this is a <strong>soft limit</strong>.</li>
</ul>
<h2 id="Memory"><a href="#Memory" class="headerlink" title="Memory"></a>Memory</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/config/containers/resource_constraints/#limit-a-containers-access-to-memory">https://docs.docker.com/config/containers/resource_constraints/#limit-a-containers-access-to-memory</a></p>
<ul>
<li><code>--memory</code>: The maximum amount of memory the container can use (cgroup limit)</li>
<li><code>--memory-swap</code>:</li>
<li><code>--oom-kill-disable</code>:</li>
</ul>
<p>针对 OOM 补充说明如下</p>
<ol>
<li>容器内进程使用 memory 超过限制，kernel 会触发 oom killer (cgroup)，kill oom_score 高分进程</li>
<li>容器只要 1 pid 进程未退出，则容器不会退出</li>
</ol>
<p>OOM 始终针对的是进程，而非容器</p>
<h2 id="Docker-Container-OOMKilled-status"><a href="#Docker-Container-OOMKilled-status" class="headerlink" title="Docker Container OOMKilled status"></a>Docker Container OOMKilled status</h2><ol>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/48618431/what-does-oom-kill-disable-do-for-a-docker-container">https://stackoverflow.com/questions/48618431/what-does-oom-kill-disable-do-for-a-docker-container</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/14440#issuecomment-119243820">https://github.com/moby/moby/issues/14440#issuecomment-119243820</a></li>
<li><a target="_blank" rel="noopener" href="https://plumbr.io/blog/java/oomkillers-in-docker-are-more-complex-than-you-thought">https://plumbr.io/blog/java/oomkillers-in-docker-are-more-complex-than-you-thought</a></li>
<li><a target="_blank" rel="noopener" href="https://zhimin-wen.medium.com/memory-limit-of-pod-and-oom-killer-891ee1f1cad8">https://zhimin-wen.medium.com/memory-limit-of-pod-and-oom-killer-891ee1f1cad8</a></li>
<li><a target="_blank" rel="noopener" href="https://faun.pub/understanding-docker-container-memory-limit-behavior-41add155236c">https://faun.pub/understanding-docker-container-memory-limit-behavior-41add155236c</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/15621#issuecomment-181418985">https://github.com/moby/moby/issues/15621#issuecomment-181418985</a></li>
<li><a target="_blank" rel="noopener" href="https://draveness.me/docker/">https://draveness.me/docker/</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/38352#issuecomment-446329512">https://github.com/moby/moby/issues/38352#issuecomment-446329512</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/containerd/cgroups/issues/74">https://github.com/containerd/cgroups/issues/74</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/78973">https://github.com/kubernetes/kubernetes/issues/78973</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/50632">https://github.com/kubernetes/kubernetes/issues/50632</a></li>
</ol>
<p>容器内的子进程发生了 oom killed，在 docker container 退出时也会被设置 OOMKilled 标志；参考该 issue</p>
<p><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/15621#issuecomment-181418985">https://github.com/moby/moby/issues/15621#issuecomment-181418985</a></p>
<p>在 docker container 未退出时会设置 container event</p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/events/">https://docs.docker.com/engine/reference/commandline/events/</a></p>
<p>docker container 设置 OOMKilled 原理，参考该 issue</p>
<p><a target="_blank" rel="noopener" href="https://github.com/moby/moby/issues/38352#issuecomment-446329512">https://github.com/moby/moby/issues/38352#issuecomment-446329512</a></p>
<p>在实现上</p>
<ol>
<li>containerd 监听了一系列事件，假若获取到 cgroup oom event 则记录 OOMKilled = true</li>
<li>containerd 将处理后的事件发送至 dockerd 进一步处理</li>
<li>dockerd 在处理 OOM 事件时，记录 container oom 事件</li>
<li>dockerd 在处理 Exit 事件时，将 OOMKilled = true 写入容器的 status</li>
</ol>
<h1 id="K8S-Resource-Limit"><a href="#K8S-Resource-Limit" class="headerlink" title="K8S Resource Limit"></a>K8S Resource Limit</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#how-pods-with-resource-limits-are-run">https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/#how-pods-with-resource-limits-are-run</a></p>
<h2 id="CPU-Docker-Container-config"><a href="#CPU-Docker-Container-config" class="headerlink" title="CPU (Docker Container config)"></a>CPU (Docker Container config)</h2><blockquote>
<p>CPU is always requested as an absolute quantity, never as a relative quantity; 0.1 is the same amount of CPU on a single-core, dual-core, or 48-core machine.</p>
</blockquote>
<ul>
<li><code>--cpu-shares</code>: max({requests.cpu} * 1024, 2)</li>
</ul>
<p>例如 requests 为 180，则 <code>--cpu-shares=184320</code></p>
<ul>
<li><p><code>--cpu-period</code>: 100</p>
</li>
<li><p><code>--cpu-quota</code>: limits.cpu * 100</p>
</li>
</ul>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://stackoverflow.com/a/63352630">https://stackoverflow.com/a/63352630</a></p>
<p> The resulting value is the total amount of CPU time in microseconds that a container can use every <strong>100ms</strong>. A container cannot use more than its share of CPU time during this interval.</p>
<p>The default quota period is 100ms. The minimum resolution of CPU quota is 1ms.</p>
</blockquote>
<p>cpu 时间分片为 period，quota 为实际每个 period 周期中，可使用的 cpu time；假若受到 qutoa 限制的 cpu 任务，在当前 period 的 quota 仍未完成，则当前任务挂起，等待下个 period 继续执行</p>
<p>multi cpu 机器注意 quota 可以是 period 的倍数，例如限制 container 使用 0.5 cpu，则 <code>--cpu-quota=50</code>，假若主机有 20 cpu，限制 container 使用 10 cpu，则 <code>--cpu-quota=10*100=1000</code></p>
<h2 id="Memory-Docker-Container-config"><a href="#Memory-Docker-Container-config" class="headerlink" title="Memory (Docker Container config)"></a>Memory (Docker Container config)</h2><ul>
<li><code>--memory</code>: int({limits.memory})</li>
<li><code>--memory-swap</code>: int({limits.memory})</li>
</ul>
<p>the container does not have access to swap</p>
<h2 id="K8s-OOM-Watcher"><a href="#K8s-OOM-Watcher" class="headerlink" title="K8s OOM Watcher"></a>K8s OOM Watcher</h2><p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/v1.22.1/pkg/kubelet/oom/oom_watcher_linux.go">https://github.com/kubernetes/kubernetes/blob/v1.22.1/pkg/kubelet/oom/oom_watcher_linux.go</a></p>
<ul>
<li>/dev/kmsg</li>
</ul>
<blockquote>
<p>Start watches for system oom’s and records an event for every system oom encountered.</p>
</blockquote>
<p>当 kubelet 观测到节点发生 system oom 时（非 cgroup oom），生成 event；可通过 kubectl 工具查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get event --field-selector type=Warning,reason=SystemOOM</span><br></pre></td></tr></table></figure>

<p>如下 PR 尝试将 pod 内进程 oom 关联至 pod，未合入</p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/issues/100483">https://github.com/kubernetes/kubernetes/issues/100483</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/pull/100487">https://github.com/kubernetes/kubernetes/pull/100487</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/archives/14155322.html" rel="prev" title="go db connection pool">
                  <i class="fa fa-chevron-left"></i> go db connection pool
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/archives/cbf18cae.html" rel="next" title="learning lenet5">
                  learning lenet5 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">248k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:45</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
