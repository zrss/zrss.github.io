<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="k8s 1.19  overview https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;0OLdyVwg4Nsw0Xvvg8if5w  阿里巴巴云原生这篇 pod 创建效率优化不错，e2e 分析了 docker pull 的加速技术  https:&#x2F;&#x2F;qiankunli.github.io&#x2F;2015&#x2F;09&#x2F;22&#x2F;docker_image.html   上图可见 docker pull 的几个">
<meta property="og:type" content="article">
<meta property="og:title" content="k8s docker image cache">
<meta property="og:url" content="https://zrss.github.io/archives/da36620.html">
<meta property="og:site_name" content="随风飘散的记忆">
<meta property="og:description" content="k8s 1.19  overview https:&#x2F;&#x2F;mp.weixin.qq.com&#x2F;s&#x2F;0OLdyVwg4Nsw0Xvvg8if5w  阿里巴巴云原生这篇 pod 创建效率优化不错，e2e 分析了 docker pull 的加速技术  https:&#x2F;&#x2F;qiankunli.github.io&#x2F;2015&#x2F;09&#x2F;22&#x2F;docker_image.html   上图可见 docker pull 的几个">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://qiankunli.github.io/public/upload/container/image_push_pull.png">
<meta property="article:published_time" content="2022-05-04T13:33:00.000Z">
<meta property="article:modified_time" content="2022-05-04T08:43:57.834Z">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="k8s">
<meta property="article:tag" content="docker image">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://qiankunli.github.io/public/upload/container/image_push_pull.png">


<link rel="canonical" href="https://zrss.github.io/archives/da36620.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zrss.github.io/archives/da36620.html","path":"archives/da36620.html","title":"k8s docker image cache"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>k8s docker image cache | 随风飘散的记忆</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">随风飘散的记忆</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#overview"><span class="nav-number">1.</span> <span class="nav-text">overview</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E4%B8%8B%E8%BD%BD%E5%8A%A0%E9%80%9F"><span class="nav-number">2.</span> <span class="nav-text">下载加速</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#p2p-powered-docker-registry"><span class="nav-number">2.1.</span> <span class="nav-text">p2p powered docker registry</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-registry-mirror"><span class="nav-number">2.2.</span> <span class="nav-text">docker registry mirror</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%A7%A3%E5%8E%8B%E5%8A%A0%E9%80%9F"><span class="nav-number">3.</span> <span class="nav-text">解压加速</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#k8s-%E5%8A%A0%E9%80%9F"><span class="nav-number">4.</span> <span class="nav-text">k8s 加速</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-images-pull-policy"><span class="nav-number">4.1.</span> <span class="nav-text">docker images pull policy</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-images-pre-pulled"><span class="nav-number">4.2.</span> <span class="nav-text">docker images pre-pulled</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#schedule-imagelocality"><span class="nav-number">4.3.</span> <span class="nav-text">schedule imagelocality</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#k8s-gc-unused-docker-images"><span class="nav-number">4.4.</span> <span class="nav-text">k8s gc unused docker images</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#docker-image-cache-management"><span class="nav-number">4.5.</span> <span class="nav-text">docker image cache management</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%8C%89%E9%9C%80%E5%8A%A0%E8%BD%BD%E6%96%87%E4%BB%B6"><span class="nav-number">5.</span> <span class="nav-text">按需加载文件</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#summary"><span class="nav-number">6.</span> <span class="nav-text">summary</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F%E5%90%AF%E5%8A%A8%E5%8A%A0%E9%80%9F%E6%8A%80%E6%9C%AF"><span class="nav-number">6.1.</span> <span class="nav-text">容器镜像启动加速技术</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%B9%E5%99%A8%E9%95%9C%E5%83%8F"><span class="nav-number">6.1.1.</span> <span class="nav-text">容器镜像</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#k8s"><span class="nav-number">6.1.2.</span> <span class="nav-text">k8s</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">领略了繁华沧桑<br>谁人过往不相似</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">124</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">66</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/da36620.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          k8s docker image cache
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2022-05-04 13:33:00 / 修改时间：08:43:57" itemprop="dateCreated datePublished" datetime="2022-05-04T13:33:00Z">2022-05-04</time>
    </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.7k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>k8s 1.19</p>
</blockquote>
<h1 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h1><blockquote>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0OLdyVwg4Nsw0Xvvg8if5w">https://mp.weixin.qq.com/s/0OLdyVwg4Nsw0Xvvg8if5w</a></p>
</blockquote>
<p>阿里巴巴云原生这篇 pod 创建效率优化不错，e2e 分析了 docker pull 的加速技术</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://qiankunli.github.io/2015/09/22/docker_image.html">https://qiankunli.github.io/2015/09/22/docker_image.html</a></p>
</blockquote>
<p><img src="https://qiankunli.github.io/public/upload/container/image_push_pull.png" alt="docker pull phase"></p>
<p>上图可见 docker pull 的几个阶段</p>
<ol>
<li>下载</li>
<li>解压</li>
<li>将文件 union 为 rootfs (图中没写)</li>
</ol>
<p>所以 docker pull 加速也从上述几个阶段入手</p>
<h1 id="下载加速"><a href="#下载加速" class="headerlink" title="下载加速"></a>下载加速</h1><h2 id="p2p-powered-docker-registry"><a href="#p2p-powered-docker-registry" class="headerlink" title="p2p powered docker registry"></a>p2p powered docker registry</h2><p><a target="_blank" rel="noopener" href="https://d7y.io/">https://d7y.io/</a></p>
<blockquote>
<p>Dragonfly is an intelligent P2P based image and file distribution system</p>
<p>Originally it was born to solve all kinds of distribution at very large scales, such as application distribution, cache distribution, log distribution, image distribution, and so on</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/uber/kraken">https://github.com/uber/kraken</a></p>
<blockquote>
<p>Kraken is a P2P-powered Docker registry that focuses on scalability and availability. It is designed for Docker image management, replication, and distribution in a hybrid cloud environment</p>
<p>all participants can reach a minimum of 80% max upload/download speed in theory (60% with current implementation), and performance doesn’t degrade much as the blob size and cluster size increase</p>
</blockquote>
<p>提升 docker image 分发到节点（大规模）的速度，适合容器化服务发布/更新的场景</p>
<h2 id="docker-registry-mirror"><a href="#docker-registry-mirror" class="headerlink" title="docker registry mirror"></a>docker registry mirror</h2><p><a target="_blank" rel="noopener" href="https://docs.docker.com/registry/recipes/mirror/">https://docs.docker.com/registry/recipes/mirror/</a></p>
<h1 id="解压加速"><a href="#解压加速" class="headerlink" title="解压加速"></a>解压加速</h1><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/">https://kubernetes.io/docs/setup/production-environment/container-runtimes/</a></p>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd">https://kubernetes.io/docs/setup/production-environment/container-runtimes/#containerd</a></p>
<blockquote>
<p>gzip/gunzip 是单线程的压缩/解压工具，可考虑采用 pigz/unpigz 进行多线程的压缩/解压，充分利用多核优势。</p>
<p>containerd 从 1.2 版本开始支持 pigz，节点上安装 unpigz 工具后，会优先用其进行解压。通过这种方法，可通过节点多核能力提升镜像解压效率。</p>
</blockquote>
<h1 id="k8s-加速"><a href="#k8s-加速" class="headerlink" title="k8s 加速"></a>k8s 加速</h1><h2 id="docker-images-pull-policy"><a href="#docker-images-pull-policy" class="headerlink" title="docker images pull policy"></a>docker images pull policy</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/images/#image-pull-policy">https://kubernetes.io/docs/concepts/containers/images/#image-pull-policy</a></p>
<ol>
<li>Never</li>
<li>IfNotPresent</li>
<li>Always</li>
</ol>
<p>Never，kubelet 会直接启动容器镜像；路径最短</p>
<p>IfNotPresent，local docker image list 查询是否命中，命中则启动容器镜像；未命中，走 docker pull；路径中等</p>
<p>Always，即使镜像没有变化，也会多一次 remote docker registry query 的查询时间；未命中，走 docker pull；路径最长</p>
<blockquote>
<p>every time the kubelet launches a container, the kubelet queries the container image registry to resolve the name to an image digest. If the kubelet has a container image with that exact digest cached locally, the kubelet uses its cached image; otherwise, the kubelet pulls the image with the resolved digest, and uses that image to launch the container.</p>
</blockquote>
<h2 id="docker-images-pre-pulled"><a href="#docker-images-pre-pulled" class="headerlink" title="docker images pre-pulled"></a>docker images pre-pulled</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/containers/images/#pre-pulled-images">https://kubernetes.io/docs/concepts/containers/images/#pre-pulled-images</a></p>
<h2 id="schedule-imagelocality"><a href="#schedule-imagelocality" class="headerlink" title="schedule imagelocality"></a>schedule imagelocality</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/reference/scheduling/config/#scheduling-plugins">https://kubernetes.io/docs/reference/scheduling/config/#scheduling-plugins</a></p>
<ul>
<li>imagelocality</li>
</ul>
<p>注意到仅对 containers 生效，对 init containers 不生效；在 k8s sche 的 score 阶段有效，使用镜像大小作为 base score，即镜像大小越大，imagelocality 调度权重越高；当然为了避免 <em>node heating problem</em>，即由于 imagelocality 的策略，很可能 pod 的多个副本被调度到同一个节点，而其他节点没有有效利用上；因此最终 imagelocality score 的计算，还乘以了 image spread 的比例</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// scaledImageScore returns an adaptively scaled score for the given state of an image.</span></span><br><span class="line"><span class="comment">// The size of the image is used as the base score, scaled by a factor which considers how much nodes the image has &quot;spread&quot; to.</span></span><br><span class="line"><span class="comment">// This heuristic aims to mitigate the undesirable &quot;node heating problem&quot;, i.e., pods get assigned to the same or</span></span><br><span class="line"><span class="comment">// a few nodes due to image locality.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">scaledImageScore</span><span class="params">(imageState *framework.ImageStateSummary, totalNumNodes <span class="keyword">int</span>)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line">	spread := <span class="keyword">float64</span>(imageState.NumNodes) / <span class="keyword">float64</span>(totalNumNodes)</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int64</span>(<span class="keyword">float64</span>(imageState.Size) * spread)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果 k8s cluster 中只有少量节点缓存了指定 image，则 spread 比例就会低，相应的 imagelocality score 得分也会低；反之，假若大多数 cluster nodes 都缓存了指定 image，则 spread 比例就会高，相应的 imagelocality score 得分也高</p>
<p>可见 k8s 设计之初还是侧重在服务管理，上述的调度策略也是对服务的高可用性友好的</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// calculatePriority returns the priority of a node. Given the sumScores of requested images on the node, the node&#x27;s</span></span><br><span class="line"><span class="comment">// priority is obtained by scaling the maximum priority value with a ratio proportional to the sumScores.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">calculatePriority</span><span class="params">(sumScores <span class="keyword">int64</span>, numContainers <span class="keyword">int</span>)</span> <span class="title">int64</span></span> &#123;</span><br><span class="line">	maxThreshold := maxContainerThreshold * <span class="keyword">int64</span>(numContainers)</span><br><span class="line">	<span class="keyword">if</span> sumScores &lt; minThreshold &#123;</span><br><span class="line">		sumScores = minThreshold</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> sumScores &gt; maxThreshold &#123;</span><br><span class="line">		sumScores = maxThreshold</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">int64</span>(framework.MaxNodeScore) * (sumScores - minThreshold) / (maxThreshold - minThreshold)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>最后 imagelocality score 经过修正后，得到 image 在调度中的 priority；注意到 &lt; minThreshold 的 score 都是一样的，物理意义上，就是说没有一个节点有缓存，和有少量节点有镜像缓存，在调度上的 priority 都是一样的，这样就避免了 node heating problem</p>
<blockquote>
<p>node heating problem</p>
<p><a target="_blank" rel="noopener" href="https://oracle.github.io/weblogic-kubernetes-operator/faq/node-heating/">https://oracle.github.io/weblogic-kubernetes-operator/faq/node-heating/</a></p>
<p>this often results in Kubernetes running many of the Pods for WebLogic Server instances on the same Node while other Nodes are not fairly utilized. This is commonly known as the “Node heating problem.”</p>
</blockquote>
<h2 id="k8s-gc-unused-docker-images"><a href="#k8s-gc-unused-docker-images" class="headerlink" title="k8s gc unused docker images"></a>k8s gc unused docker images</h2><p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/architecture/garbage-collection/#containers-images">https://kubernetes.io/docs/concepts/architecture/garbage-collection/#containers-images</a></p>
<p>Kubernetes manages the lifecycle of <strong>all images</strong> through its image manager</p>
<p>The kubelet considers the following disk usage limits when making garbage collection decisions:</p>
<ul>
<li>HighThresholdPercent</li>
<li>LowThresholdPercent</li>
</ul>
<p>Disk usage above the configured <strong>HighThresholdPercent</strong> value triggers garbage collection, which deletes images in order based on <strong>the last time they were used, starting with the oldest first</strong>. The kubelet deletes images until disk usage reaches the <strong>LowThresholdPercent</strong> value.</p>
<h2 id="docker-image-cache-management"><a href="#docker-image-cache-management" class="headerlink" title="docker image cache management"></a>docker image cache management</h2><p><a target="_blank" rel="noopener" href="https://github.com/senthilrch/kube-fledged">https://github.com/senthilrch/kube-fledged</a></p>
<blockquote>
<p>kube-fledged is a kubernetes operator for creating and managing a cache of container images directly on the worker nodes of a kubernetes cluster</p>
<p>kube-fledged provides CRUD APIs to manage the lifecycle of the image cache</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://github.com/senthilrch/kube-fledged/blob/master/docs/design-proposal.md">https://github.com/senthilrch/kube-fledged/blob/master/docs/design-proposal.md</a></p>
<h1 id="按需加载文件"><a href="#按需加载文件" class="headerlink" title="按需加载文件"></a>按需加载文件</h1><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/0OLdyVwg4Nsw0Xvvg8if5w">https://mp.weixin.qq.com/s/0OLdyVwg4Nsw0Xvvg8if5w</a></p>
<blockquote>
<p>当前节点上创建容器时，是需要先把镜像全部数据拉取到本地，然后才能启动容器。再考虑下启动虚拟机的过程，即使是几百 GB 的虚拟机镜像，启动虚拟机也通常是在秒级别，几乎感受不到虚拟机镜像大小带来的影响。</p>
<p>《Slacker: Fast Distribution with Lazy Docker Containers》</p>
<p>该 paper 分析，在镜像启动耗时中，拉取镜像占比 76%，但是在启动时，仅有 6.4% 的数据被使用到，即镜像启动时需要的镜像数据量很少，需要考虑在镜像启动阶段按需加载镜像，改变对镜像的使用方式。</p>
<p>对于「Image 所有 layers 下载完后才能启动镜像」，需要改为启动容器时按需加载镜像，类似启动虚拟机的方式，仅对启动阶段需要的数据进行网络传输。</p>
</blockquote>
<p>这个对现有架构的改动是很大了 …</p>
<p><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/742103">https://developer.aliyun.com/article/742103</a></p>
<p>2020/01/08</p>
<h1 id="summary"><a href="#summary" class="headerlink" title="summary"></a>summary</h1><h2 id="容器镜像启动加速技术"><a href="#容器镜像启动加速技术" class="headerlink" title="容器镜像启动加速技术"></a>容器镜像启动加速技术</h2><h3 id="容器镜像"><a href="#容器镜像" class="headerlink" title="容器镜像"></a>容器镜像</h3><ol>
<li>镜像文件下载加速<ol>
<li>docker registry mirror，本地 mirror，路程更近</li>
<li>p2p (Dragonfly, Kraken)，分发加速</li>
</ol>
</li>
<li>镜像文件解压加速<ol>
<li>container runtime: containerd, unpigz，多线程解压</li>
</ol>
</li>
<li>镜像文件按需加载<ol>
<li><em>Slacker: Fast Distribution with Lazy Docker Containers: Our analysis shows that pulling packages accounts for 76% of container start time, but only 6.4% of that data is read.</em></li>
</ol>
</li>
</ol>
<h3 id="k8s"><a href="#k8s" class="headerlink" title="k8s"></a>k8s</h3><ol>
<li>imagePullPolicy<ol>
<li>Never，路径最短，依赖镜像预下载</li>
<li>IfNotPresent</li>
<li>Always</li>
</ol>
</li>
<li>schedule imagelocality: 调度优化，当集群中大多数节点均有缓存时，优先将 pod 调度到已有缓存的节点</li>
<li>docker images pre-pulled + docker image cache management: 集群 docker image cache 管理</li>
</ol>
<p>k8s 属于业务逻辑层面的优化</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/k8s/" rel="tag"># k8s</a>
              <a href="/tags/docker-image/" rel="tag"># docker image</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/archives/ff6309c.html" rel="prev" title="mount s3 bucket with goofys">
                  <i class="fa fa-chevron-left"></i> mount s3 bucket with goofys
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/archives/dc51ca39.html" rel="next" title="ps-worker-paper">
                  ps-worker-paper <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">282k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:16</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
