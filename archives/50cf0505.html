<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/Z.png">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zrss.github.io","root":"/","images":"/images","scheme":"Muse","version":"8.6.1","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12},"copycode":true,"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="Configure RoCEhttps:&#x2F;&#x2F;community.mellanox.com&#x2F;s&#x2F;article&#x2F;howto-configure-roce-on-connectx-4 https:&#x2F;&#x2F;community.mellanox.com&#x2F;s&#x2F;article&#x2F;understanding-show-gids-script  Use ibv_query_gid and ibv_find_gid_in">
<meta property="og:type" content="article">
<meta property="og:title" content="infiniband ethernet">
<meta property="og:url" content="https://zrss.github.io/archives/50cf0505.html">
<meta property="og:site_name" content="随风飘散的记忆">
<meta property="og:description" content="Configure RoCEhttps:&#x2F;&#x2F;community.mellanox.com&#x2F;s&#x2F;article&#x2F;howto-configure-roce-on-connectx-4 https:&#x2F;&#x2F;community.mellanox.com&#x2F;s&#x2F;article&#x2F;understanding-show-gids-script  Use ibv_query_gid and ibv_find_gid_in">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2021-12-26T14:44:37.000Z">
<meta property="article:modified_time" content="2022-03-06T05:53:58.180Z">
<meta property="article:author" content="Zrss">
<meta property="article:tag" content="infiniband">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zrss.github.io/archives/50cf0505.html">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://zrss.github.io/archives/50cf0505.html","path":"archives/50cf0505.html","title":"infiniband ethernet"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>infiniband ethernet | 随风飘散的记忆</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">随风飘散的记忆</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Configure-RoCE"><span class="nav-number">1.</span> <span class="nav-text">Configure RoCE</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#RoCE-in-container"><span class="nav-number">2.</span> <span class="nav-text">RoCE in container</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NCCL-RoCE-failed-in-container"><span class="nav-number">2.1.</span> <span class="nav-text">NCCL RoCE failed in container</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ib-write-bw-failed-in-container"><span class="nav-number">2.2.</span> <span class="nav-text">ib_write_bw failed in container</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#multus-cni"><span class="nav-number">2.3.</span> <span class="nav-text">multus-cni</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-overview">
            <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Zrss</p>
  <div class="site-description" itemprop="description">领略了繁华沧桑<br>谁人过往不相似</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives">
          <span class="site-state-item-count">120</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
        <span class="site-state-item-count">65</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



          </div>
        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

  <a href="https://github.com/zrss" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://zrss.github.io/archives/50cf0505.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Zrss">
      <meta itemprop="description" content="领略了繁华沧桑<br>谁人过往不相似">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="随风飘散的记忆">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          infiniband ethernet
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-26 14:44:37" itemprop="dateCreated datePublished" datetime="2021-12-26T14:44:37Z">2021-12-26</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2022-03-06 05:53:58" itemprop="dateModified" datetime="2022-03-06T05:53:58Z">2022-03-06</time>
      </span>

  
      </div>
      <div class="post-meta">
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>5.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>5 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="Configure-RoCE"><a href="#Configure-RoCE" class="headerlink" title="Configure RoCE"></a>Configure RoCE</h1><p><a target="_blank" rel="noopener" href="https://community.mellanox.com/s/article/howto-configure-roce-on-connectx-4">https://community.mellanox.com/s/article/howto-configure-roce-on-connectx-4</a></p>
<p><a target="_blank" rel="noopener" href="https://community.mellanox.com/s/article/understanding-show-gids-script">https://community.mellanox.com/s/article/understanding-show-gids-script</a></p>
<blockquote>
<p>Use <code>ibv_query_gid</code> and <code>ibv_find_gid_index</code> functions defined in libibverbs to get the desired GID index.</p>
</blockquote>
<p>根据上述材料可知，RoCE 首先需要网卡设备支持比如 mlnx ConnectX-4</p>
<p>以 mlnx 网卡设备为例</p>
<ol>
<li>找到 mlnx 设备 GID 映射到的网络设备</li>
</ol>
<p><code>cat /sys/class/infiniband/mlx5_0/ports/1/gid_attrs/ndevs/1</code></p>
<ol start="2">
<li>查看 GIDs 1 对应的 RoCE type</li>
</ol>
<p><code>cat /sys/class/infiniband/mlx5_0/ports/1/gid_attrs/types/1</code></p>
<ol start="3">
<li>查看 GIDs 1 地址</li>
</ol>
<p><code>cat /sys/class/infiniband/mlx5_0/ports/1/gids/1</code></p>
<table>
<thead>
<tr>
<th>Interface</th>
<th>GID Index</th>
<th>RoCE version</th>
<th>GID Address</th>
</tr>
</thead>
<tbody><tr>
<td>ens785f0</td>
<td>1</td>
<td>RoCEv2</td>
<td>fe80:0000:0000:0000:e61d:2dff:fef2:a488</td>
</tr>
</tbody></table>
<p>确定好需要使用的 GID 后，可使用 <code>ib_send_bw</code> 指定 GID 进行 RoCE 通信</p>
<p>另外注意到</p>
<blockquote>
<p><a target="_blank" rel="noopener" href="https://community.mellanox.com/s/article/howto-configure-roce-on-connectx-4">https://community.mellanox.com/s/article/howto-configure-roce-on-connectx-4</a></p>
</blockquote>
<p>在 mlnx 设备映射到的网络设备中增加的 vlan 网卡也支持 RoCE</p>
<h1 id="RoCE-in-container"><a href="#RoCE-in-container" class="headerlink" title="RoCE in container"></a>RoCE in container</h1><h2 id="NCCL-RoCE-failed-in-container"><a href="#NCCL-RoCE-failed-in-container" class="headerlink" title="NCCL RoCE failed in container"></a>NCCL RoCE failed in container</h2><blockquote>
<p>NCCL WARN Call to ibv_modify_qp failed with error No such device</p>
</blockquote>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IB setup</span></span><br><span class="line">ibv_context* ctx = ncclIbDevs[lComm-&gt;dev].context;</span><br><span class="line"><span class="keyword">uint8_t</span> ib_port = ncclIbDevs[lComm-&gt;dev].port;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ibv_port_attr</span> <span class="title">portAttr</span>;</span></span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_query_port</span>(ctx, ib_port, &amp;portAttr));</span><br><span class="line"><span class="class"><span class="keyword">union</span> <span class="title">ibv_gid</span> <span class="title">gid</span>;</span></span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_query_gid</span>(ctx, ib_port, <span class="built_in">ncclParamIbGidIndex</span>(), &amp;gid));</span><br><span class="line"></span><br><span class="line"><span class="comment">// QP Creation</span></span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbInitVerbs</span>(ctx, &amp;rComm-&gt;verbs));</span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbCreateQp</span>(ib_port, &amp;rComm-&gt;verbs, IBV_ACCESS_REMOTE_WRITE, &amp;rComm-&gt;qp));</span><br><span class="line"></span><br><span class="line"><span class="comment">// Adjust the MTU</span></span><br><span class="line">remQpInfo.mtu = (<span class="keyword">enum</span> ibv_mtu)std::<span class="built_in">min</span>(remQpInfo.mtu, portAttr.active_mtu);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup QP</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp</span>* <span class="title">qp</span> =</span> rComm-&gt;qp;</span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtrQp</span>(qp, &amp;remQpInfo));</span><br><span class="line"><span class="built_in">NCCLCHECK</span>(<span class="built_in">ncclIbRtsQp</span>(qp));</span><br></pre></td></tr></table></figure>

<p><strong>ncclIbRtrQp</strong></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">ncclResult_t <span class="title">ncclIbRtrQp</span><span class="params">(ibv_qp* qp, struct ncclIbQpInfo* info)</span> </span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">ibv_qp_attr</span> <span class="title">qpAttr</span>;</span></span><br><span class="line">  <span class="built_in">memset</span>(&amp;qpAttr, <span class="number">0</span>, <span class="built_in"><span class="keyword">sizeof</span></span>(struct ibv_qp_attr));</span><br><span class="line">  qpAttr.qp_state = IBV_QPS_RTR;</span><br><span class="line">  qpAttr.path_mtu = info-&gt;mtu;</span><br><span class="line">  qpAttr.dest_qp_num = info-&gt;qpn;</span><br><span class="line">  qpAttr.rq_psn = <span class="number">0</span>;</span><br><span class="line">  qpAttr.max_dest_rd_atomic = <span class="number">1</span>;</span><br><span class="line">  qpAttr.min_rnr_timer = <span class="number">12</span>;</span><br><span class="line">  <span class="keyword">if</span> (info-&gt;lid == <span class="number">0</span>) &#123;</span><br><span class="line">    qpAttr.ah_attr.is_global = <span class="number">1</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.dgid.global.subnet_prefix = info-&gt;spn;</span><br><span class="line">    qpAttr.ah_attr.grh.dgid.global.interface_id = info-&gt;iid;</span><br><span class="line">    qpAttr.ah_attr.grh.flow_label = <span class="number">0</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.sgid_index = <span class="built_in">ncclParamIbGidIndex</span>();</span><br><span class="line">    qpAttr.ah_attr.grh.hop_limit = <span class="number">255</span>;</span><br><span class="line">    qpAttr.ah_attr.grh.traffic_class = <span class="built_in">ncclParamIbTc</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    qpAttr.ah_attr.is_global = <span class="number">0</span>;</span><br><span class="line">    qpAttr.ah_attr.dlid = info-&gt;lid;</span><br><span class="line">  &#125;</span><br><span class="line">  qpAttr.ah_attr.sl = <span class="built_in">ncclParamIbSl</span>();</span><br><span class="line">  qpAttr.ah_attr.src_path_bits = <span class="number">0</span>;</span><br><span class="line">  qpAttr.ah_attr.port_num = info-&gt;ib_port;</span><br><span class="line">  <span class="built_in">NCCLCHECK</span>(<span class="built_in">wrap_ibv_modify_qp</span>(qp, &amp;qpAttr, IBV_QP_STATE | IBV_QP_AV | IBV_QP_PATH_MTU | IBV_QP_DEST_QPN | IBV_QP_RQ_PSN | IBV_QP_MAX_DEST_RD_ATOMIC | IBV_QP_MIN_RNR_TIMER));</span><br><span class="line">  <span class="keyword">return</span> ncclSuccess;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>推测是在容器中虽然发现了 mlnx 设备，但是并没有发现 mlnx 设备对应的网络设备（例如 demo 中的 ens785f0)，也就无法找到可使用的 GID 进行 RoCE 通信</p>
<h2 id="ib-write-bw-failed-in-container"><a href="#ib-write-bw-failed-in-container" class="headerlink" title="ib_write_bw failed in container"></a>ib_write_bw failed in container</h2><blockquote>
<p>Failed to modify QP 100 to RTR</p>
</blockquote>
<p>使用 <code>ib_write_bw</code> 也会报错，看报错信息，与 NCCL 出错的方法一致 <code>ncclIbRtrQp</code></p>
<h2 id="multus-cni"><a href="#multus-cni" class="headerlink" title="multus-cni"></a>multus-cni</h2><p><a target="_blank" rel="noopener" href="https://github.com/k8snetworkplumbingwg/multus-cni">https://github.com/k8snetworkplumbingwg/multus-cni</a></p>
<p>理论上需要使用 multus-cni 以 macvlan 的方式增加 RoCE 网络设备到容器中</p>
<p><a target="_blank" rel="noopener" href="https://github.com/Mellanox/k8s-rdma-sriov-dev-plugin/issues/18">https://github.com/Mellanox/k8s-rdma-sriov-dev-plugin/issues/18</a></p>
<blockquote>
<p>instead of calico, you should use macvlan cni where those virtual devices are child of enp175s0. RoCE can make use of those netdevices.</p>
<p>Other users are using multus plugin, which allows you to have multiple netdev interfaces in a Pod. Such as first managed default veth interface via your existing plugin, and second macvlan or sriov interface via 2nd cni.<br>This way you get both of both world for performance and functionality.</p>
</blockquote>
<p>根据 multus-cni quick start 文档，假若 multus 实测可兼容目前 k8s 集群默认的 cni 插件的情况下，需要额外增加 macvlan RoCE 网络设备的 crd 资源配置（假若主机上有多个 RoCE 网络设备，则可分别创建多个 crd 资源配置，每个资源配置对应其中一个 RoCE 网络设备）</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF | kubectl create -f -</span><br><span class="line">apiVersion: &quot;k8s.cni.cncf.io/v1&quot;</span><br><span class="line">kind: NetworkAttachmentDefinition</span><br><span class="line">metadata:</span><br><span class="line">  name: macvlan-conf</span><br><span class="line">spec:</span><br><span class="line">  config: &#x27;&#123;</span><br><span class="line">      &quot;cniVersion&quot;: &quot;0.3.0&quot;,</span><br><span class="line">      &quot;type&quot;: &quot;macvlan&quot;,</span><br><span class="line">      &quot;master&quot;: &quot;eth0&quot;,</span><br><span class="line">      &quot;mode&quot;: &quot;bridge&quot;,</span><br><span class="line">      &quot;ipam&quot;: &#123;</span><br><span class="line">        &quot;type&quot;: &quot;host-local&quot;,</span><br><span class="line">        &quot;subnet&quot;: &quot;192.168.1.0/24&quot;,</span><br><span class="line">        &quot;rangeStart&quot;: &quot;192.168.1.200&quot;,</span><br><span class="line">        &quot;rangeEnd&quot;: &quot;192.168.1.216&quot;,</span><br><span class="line">        &quot;routes&quot;: [</span><br><span class="line">          &#123; &quot;dst&quot;: &quot;0.0.0.0/0&quot; &#125;</span><br><span class="line">        ],</span><br><span class="line">        &quot;gateway&quot;: &quot;192.168.1.1&quot;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;&#x27;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p><strong>当然前提是 k8s 集群中已安装了 macvlan cni</strong></p>
<blockquote>
<p>type: This tells CNI which binary to call on disk. Each CNI plugin is a binary that’s called. Typically, these binaries are stored in /opt/cni/bin on each node, and CNI executes this binary. In this case we’ve specified the loopback binary (which create a loopback-type network interface). <strong>If this is your first time installing Multus, you might want to verify that the plugins that are in the “type” field are actually on disk in the /opt/cni/bin directory.</strong></p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/">https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cni.dev/plugins/current/main/macvlan/">https://www.cni.dev/plugins/current/main/macvlan/</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/network/macvlan/">https://docs.docker.com/network/macvlan/</a></p>
<blockquote>
<p>Some applications, especially legacy applications or applications which monitor network traffic, expect to be directly connected to the physical network. In this type of situation, you can use the macvlan network driver to assign a MAC address to each container’s virtual network interface, making it appear to be a physical network interface directly connected to the physical network.</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://docs.docker.com/network/network-tutorial-macvlan/">https://docs.docker.com/network/network-tutorial-macvlan/</a></p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/infiniband/" rel="tag"># infiniband</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/archives/dfdab12d.html" rel="prev" title="golang memory model">
                  <i class="fa fa-chevron-left"></i> golang memory model
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/archives/71008a70.html" rel="next" title="k8s-crd-clientsets">
                  k8s-crd-clientsets <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Zrss</span>
</div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">273k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">4:08</span>
  </span>
</div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  


  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":"forest","js":{"url":"https://cdn.jsdelivr.net/npm/mermaid@8.11.0/dist/mermaid.min.js","integrity":"sha256-sVAx+v/Q7v0Q2xm5vN7h5ccSna6gaLREhG9sF8pKT6I="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>


  





</body>
</html>
